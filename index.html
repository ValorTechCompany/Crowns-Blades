<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crowns & Blades - Alpha Loop</title>
    <style>
        /* --- Global Styles & CK3 Aesthetic (From Code 2 - More Comprehensive) --- */
        :root {
            --bg-color: #2e2e3f; /* Darker purple/blue */
            --panel-bg: #3a3a4d; /* Slightly lighter panel bg */
            --border-color: #5a5a70;
            --text-color: #e0e0e0;
            --text-muted: #a0a0b0;
            --accent-color: #d4af37; /* Gold accent */
            --accent-hover: #f0c840;
            --danger-color: #b03030;
            --danger-hover: #d9534f;
            --success-color: #4cae4c;
            --success-hover: #5cb85c;
            --info-color: #31708f;
            --intrigue-color: #8a4a8a; /* Purple for intrigue */
            --font-main: 'Garamond', 'Times New Roman', serif; /* CK3-like serif */
            --font-heading: 'Trajan Pro', 'Cinzel', serif; /* More evocative heading font (fallback) */

            --portrait-bg-1: #6a4a3a;
            --portrait-bg-2: #4a5a6a;
            --portrait-bg-3: #7a6a4a;
            --portrait-text: #fff;

             /* Battle Colors */
             --player-color: #4a7a9a; /* Blueish */
             --enemy-color: #a05050; /* Reddish */
             --selected-border-color: var(--accent-hover);

             /* Creator Styles */
             --creator-bg: rgba(0,0,0, 0.85);
             --creator-content-bg: var(--panel-bg);
             --creator-border: var(--accent-color);
             --creator-option-hover: var(--bg-color);

             /* Plot/Scheme Colors */
             --plot-murder: #c04040;
             --plot-abduct: #a060a0;
             --plot-hook: #31708f;
             --scheme-discover: #8a4a8a;
             --scheme-fabricate: #d4af37;
             --scheme-spy: #5a5a70;
             --scheme-disband: #b03030;
             --scheme-sway: #4cae4c;

             /* News Feed */
             --news-item-bg: rgba(0,0,0, 0.15);
             --news-item-border: var(--border-color);
             --news-item-hover: rgba(0,0,0, 0.25);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 15px;
            display: flex; /* Changed for creator */
            justify-content: center;
            align-items: center; /* Changed for creator */
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Game UI Container (Hidden initially) --- */
        #game-ui {
            width: 100%;
            max-width: 1800px; /* Wider layout */
            background-color: var(--panel-bg);
            border: 2px solid var(--border-color);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            display: none; /* Start hidden, shown after creation */
            flex-direction: column;
            max-height: calc(100vh - 30px);
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background-color: var(--bg-color);
            padding: 8px 15px; /* Slightly smaller padding */
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        header h1 { font-family: var(--font-heading); color: var(--accent-color); font-size: 1.8em; /* Slightly smaller */ letter-spacing: 1px; text-shadow: 1px 1px 2px #000; margin: 0; }
        .game-state-info { display: flex; gap: 12px; font-size: 0.9em; /* Slightly smaller */ flex-wrap: wrap; align-items: center; }
        .game-state-info span { background-color: var(--panel-bg); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color); white-space: nowrap; }
        .game-state-info strong { color: var(--accent-hover); margin-left: 5px; }

        /* Game Controls Area */
        .game-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto; /* Push controls to the right */
            padding-left: 20px;
        }

        .game-controls button {
            font-family: var(--font-main);
            padding: 4px 10px;
            font-size: 0.85em;
            background-color: var(--accent-color);
            color: var(--bg-color);
            border: 1px solid var(--accent-hover);
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .game-controls button:hover { background-color: var(--accent-hover); }
        .game-controls button:disabled { background-color: #555; color: #999; cursor: not-allowed; border-color: #444; opacity: 0.6; }
        .game-controls label { font-size: 0.85em; color: var(--text-muted); margin-right: -5px; }
        .game-controls select {
             font-size: 0.85em;
             padding: 3px 6px;
             background-color: var(--panel-bg);
             border: 1px solid var(--border-color);
             color: var(--text-color);
             border-radius: 3px;
             margin-left: 5px;
        }

        /* --- Main Content Area --- */
         .main-content-wrapper {
            display: flex; flex-direction: row; flex-grow: 1; overflow: hidden;
         }

        /* --- Tabs --- */
        nav.main-tabs { background-color: var(--bg-color); border-bottom: 2px solid var(--border-color); padding: 0 10px; flex-shrink: 0; }
        nav.main-tabs ul { list-style: none; display: flex; flex-wrap: wrap; }
        nav.main-tabs li button { font-family: var(--font-heading); background: none; border: none; border-bottom: 4px solid transparent; color: var(--text-muted); padding: 12px 15px; font-size: 0.95em; cursor: pointer; transition: color 0.2s ease, border-color 0.2s ease; margin-bottom: -2px; letter-spacing: 1px; white-space: nowrap; }
        nav.main-tabs li button:hover { color: var(--text-color); }
        nav.main-tabs li button.active { color: var(--accent-color); border-bottom-color: var(--accent-color); font-weight: bold; }

        /* --- Tab Content --- */
         .main-tab-content {
             flex-grow: 1; overflow-y: auto;
             padding: 20px;
         }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-content h2 { font-family: var(--font-heading); color: var(--accent-color); margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .tab-content h3 { font-family: var(--font-heading); color: var(--text-muted); font-size: 1.3em; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px; }
        .tab-content h4 { font-family: var(--font-heading); color: var(--text-muted); margin-bottom: 10px; font-size: 1.1em; }

        /* Clickable links */
        .clickable {
            color: var(--accent-hover);
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold; /* Make them stand out a bit more */
        }
        .clickable:hover { color: var(--accent-color); }
        .list-item strong.clickable { font-weight: bold; } /* Ensure list item names remain bold */

        /* --- Politics Section Specifics --- */
        #politics-content .ideology-sliders { margin-bottom: 30px; background-color: rgba(0,0,0, 0.1); padding: 20px; border: 1px solid var(--border-color); border-radius: 5px; }
        .slider-group { margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; gap: 15px; }
        .slider-group label { flex-basis: 100px; flex-shrink: 0; text-align: right; font-size: 1.0em; color: var(--text-muted); }
        .slider-container { flex-grow: 1; display: flex; align-items: center; }
        .slider-labels { font-size: 0.85em; color: var(--text-muted); margin: 0 8px; flex-basis: 80px; text-align: center; }
        .slider-labels:first-child { text-align: left; } .slider-labels:last-child { text-align: right; }
        input[type="range"] { flex-grow: 1; cursor: pointer; height: 6px; background: linear-gradient(to right, var(--accent-color), var(--text-muted), var(--accent-color)); border-radius: 3px; appearance: none; -webkit-appearance: none;}
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: var(--accent-hover); border: 2px solid var(--bg-color); border-radius: 50%; cursor: pointer; margin-top: -5px; box-shadow: 0 0 4px rgba(0,0,0,0.4); }
        input[type="range"]::-moz-range-thumb { width: 14px; height: 14px; background: var(--accent-hover); border: 2px solid var(--bg-color); border-radius: 50%; cursor: pointer; box-shadow: 0 0 4px rgba(0,0,0,0.4); }
        .slider-value { font-weight: bold; font-size: 1.0em; color: var(--accent-color); min-width: 30px; text-align: right; }
        .peasantry-approval { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); text-align: center; font-size: 1.2em; }
        .peasantry-approval strong { color: var(--accent-hover); font-size: 1.4em; margin-left: 8px; }
        .peasantry-approval strong.low-approval { color: var(--danger-color); animation: pulse-danger 1.5s infinite; }
        @keyframes pulse-danger { 0% { text-shadow: 0 0 3px var(--danger-color); } 50% { text-shadow: 0 0 10px var(--danger-hover); } 100% { text-shadow: 0 0 3px var(--danger-color); } }

        /* --- Factions & Vassals Lists --- */
        .list-section { margin-bottom: 20px; padding: 15px; background-color: rgba(0,0,0, 0.1); border: 1px solid var(--border-color); border-radius: 4px; }
        .scrollable-list { max-height: 250px; /* Slightly taller */ overflow-y: auto; padding-right: 10px; border: 1px solid rgba(0,0,0, 0.2); background-color: rgba(0,0,0, 0.1); padding: 8px; border-radius: 3px; }
        .list-item { background-color: var(--panel-bg); border: 1px solid var(--border-color); padding: 8px 12px; margin-bottom: 6px; border-radius: 3px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; flex-wrap: wrap; /* Allow wrapping */ gap: 5px;} /* Add gap */
        .list-item:hover { background-color: var(--bg-color); }
        /* Removed strong selector for color, handled by .clickable */
        .list-item .opinion { font-weight: bold; padding: 2px 6px; border-radius: 3px; min-width: 40px; text-align: center; font-size: 0.9em;}
        .opinion.positive { background-color: var(--success-color); color: #fff; }
        .opinion.neutral { background-color: var(--text-muted); color: var(--bg-color); }
        .opinion.negative { background-color: var(--danger-color); color: #fff; }
        .faction-details { color: var(--text-muted); font-size: 0.85em; }
        .faction-details span { margin-left: 10px; } /* Removed .clickable specific margin */
        .faction-details .strength { font-weight: bold; color: var(--text-color); }
        .faction-info { flex-grow: 1; margin-right: 10px; } /* Added for better spacing in faction list */

        /* --- Military: Wars & Mercs --- */
        #military-content .war-list .list-item { flex-direction: column; align-items: flex-start; gap: 4px; }
        .war-info { width: 100%; display: flex; justify-content: space-between; align-items: center; }
        .war-score { font-weight: bold; font-size: 1.0em; }
        .war-score.winning { color: var(--success-color); } .war-score.losing { color: var(--danger-color); }
        .war-participants { font-size: 0.8em; color: var(--text-muted); width: 100%; }
        .war-participants strong { color: var(--text-color); } /* Keep Attacker/Defender labels clear */
        .view-battle-btn, .generic-action-btn {
             font-family: var(--font-main); font-size: 0.8em; padding: 3px 7px; background-color: var(--border-color); color: var(--text-color); border: 1px solid var(--bg-color); border-radius: 3px; cursor: pointer; transition: background-color 0.2s; margin-left: 8px;
             vertical-align: middle;
        }
        .generic-action-btn:disabled { background-color: #555; color: #999; cursor: not-allowed; border-color: #444; opacity: 0.6; }
        .generic-action-btn.cost::after { content: " (" attr(data-cost-display) ")"; font-size: 0.9em; color: var(--accent-color); }
        .generic-action-btn.intrigue-action { background-color: var(--intrigue-color); border-color: #a060a0; }
        .generic-action-btn.intrigue-action:hover:not(:disabled) { background-color: #b070b0; }
        .generic-action-btn.danger-action { background-color: var(--danger-color); border-color: var(--danger-hover);}
        .generic-action-btn.danger-action:hover:not(:disabled) { background-color: var(--danger-hover); }
        .disabled-reason-span { color:var(--danger-color); font-size:0.9em; margin-left: 5px; font-style: italic;}
        .view-battle-btn:hover, .generic-action-btn:not(:disabled):hover { background-color: var(--text-muted); color: var(--bg-color); }
        .hire-mercenary-btn { background-color: var(--success-color); color: white; }
        .hire-mercenary-btn:hover:not(:disabled) { background-color: var(--success-hover); }
        #mercenaries-content .list-item { flex-direction: row; /* Back to row for mercs */ align-items: center; gap: 10px; }
        .mercenary-details { display: flex; flex-wrap: wrap; font-size: 0.85em; gap: 5px 10px; flex-grow: 1; /* Take available space */}
        .mercenary-details span { color: var(--text-muted); }
        .mercenary-details strong { color: var(--text-color); } /* Keep details clear */


        /* --- Diplomacy Tab --- */
        .relations-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 15px;}
        .relation-card { background-color: rgba(0,0,0, 0.1); border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; text-align: center; cursor: pointer; transition: background-color 0.2s; }
        .relation-card:hover { background-color: rgba(0,0,0, 0.2); }
        .relation-card h5 { font-family: var(--font-heading); color: var(--accent-color); margin-bottom: 5px; font-size: 1.0em;} /* Made clickable via JS */
        .relation-card p { font-size: 0.9em; margin-bottom: 3px; }
        .relation-card .opinion { display: inline-block; margin-top: 4px; font-size: 0.85em; padding: 2px 5px;}
        #diplomacy-content .list-item span { color: var(--text-muted); font-size: 0.9em; }

        /* --- Laws Tab --- */
        .laws-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .law-card { background-color: rgba(0,0,0, 0.1); border: 1px solid var(--border-color); padding: 15px; border-radius: 4px; cursor: pointer; }
        .law-card:hover { background-color: rgba(0,0,0, 0.2); }
        .law-card h4 { color: var(--accent-color); margin-bottom: 8px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; } /* Made clickable via JS */
        .law-card p { font-size: 0.9em; color: var(--text-muted); margin-bottom: 10px; }
        .law-card .effects { font-size: 0.85em; margin-bottom: 12px; font-style: italic; }
        .law-card .requirements { font-size: 0.8em; color: var(--text-muted); margin-bottom: 12px; }
        .law-card .status { font-weight: bold; font-size: 0.95em; margin-bottom: 10px; }
        .law-card .status.active { color: var(--success-color); }
        .law-card .status.inactive { color: var(--text-muted); }

        /* --- Intrigue Tab --- */
        #intrigue-content .plot-list-item { flex-direction: column; align-items: flex-start; gap: 5px; }
        .plot-details { font-size: 0.9em; color: var(--text-muted); }
        .plot-progress { width: 100%; background-color: var(--bg-color); border-radius: 3px; overflow: hidden; height: 10px; margin-top: 5px; border: 1px solid var(--border-color); }
        .plot-progress-bar { height: 100%; background-color: var(--intrigue-color); width: 0%; transition: width 0.5s ease; }
        /* Color coding progress bars */
        .plot-progress-bar.type-murder { background-color: var(--plot-murder); }
        .plot-progress-bar.type-abduct { background-color: var(--plot-abduct); }
        .plot-progress-bar.type-fabricate_hook { background-color: var(--plot-hook); }
        .plot-progress-bar.type-discover_plots { background-color: var(--scheme-discover); }
        .plot-progress-bar.type-fabricate_claim { background-color: var(--scheme-fabricate); }
        .plot-progress-bar.type-build_spy_network { background-color: var(--scheme-spy); }
        .plot-progress-bar.type-disband_faction { background-color: var(--scheme-disband); }
        .plot-progress-bar.type-sway { background-color: var(--scheme-sway); }

        .plot-chances { font-size: 0.8em; display: flex; justify-content: space-between; width: 100%; margin-top: 3px; }
        .scheme-timer { margin-top: 5px; font-size: 0.85em; color: var(--text-muted); }
        #intrigue-content .generic-action-btn { margin-bottom: 5px; }

        /* --- Dynasty Tab --- */
        .unimplemented-feature {
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.9em;
            margin-top: 5px;
            display: block; /* Ensure it takes its own line */
        }

        /* --- Ruler Info Panel --- */
        .ruler-panel {
            background-color: var(--bg-color); border-left: 2px solid var(--border-color); padding: 15px; width: 300px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; max-height: calc(100vh - 100px); /* Adjusted height */ overflow-y: auto;
        }
        .ruler-panel h3 { font-family: var(--font-heading); color: var(--accent-color); margin-bottom: 10px; text-align: center; font-size: 1.2em; }
        .ruler-portrait { width: 100px; height: 125px; background-color: #555; border: 2px solid var(--border-color); margin-bottom: 8px; display: flex; justify-content: center; align-items: center; font-size: 1.3em; font-weight: bold; color: var(--portrait-text); text-align: center; overflow: hidden; position: relative; }
        .ruler-portrait img { max-width: 100%; max-height: 100%; object-fit: cover; display: none; }
        .ruler-portrait .placeholder-initials { font-family: var(--font-heading); }
        .ruler-title { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; text-align: center; } /* Made clickable via JS */
        .key-characters { width: 100%; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); }
        .key-characters h4 { font-family: var(--font-heading); font-size: 1.0em; color: var(--text-muted); margin-bottom: 8px; text-align: center; }
        .key-characters ul { list-style: none; }
        .key-characters li { margin-bottom: 5px; font-size: 0.9em; }
        .key-characters li strong { color: var(--text-color); margin-right: 5px; display: inline-block; min-width: 70px; font-weight: normal;} /* Role text normal */
        .key-characters li span.clickable { margin-right: 5px; } /* Spacing for clickable name */


        /* --- Notifications & Alerts --- */
        .notifications-alerts-container { padding: 10px 0; width: 100%; margin-top: 10px; border-top: 1px solid var(--border-color); }
        .notifications-alerts-container h4 { font-family: var(--font-heading); color: var(--text-muted); font-size: 1.0em; margin-bottom: 8px; text-align: center; }
        .notification-area { max-height: 150px; overflow-y: auto; padding-right: 5px; margin-bottom: 10px; }
        .notification, .alert { background-color: var(--panel-bg); border: 1px solid var(--border-color); border-left: 4px solid var(--accent-color); padding: 8px 10px; margin-bottom: 6px; border-radius: 3px; position: relative; font-size: 0.85em; transition: opacity 0.3s ease-out; }
        .alert { border-left-color: var(--danger-color); background-color: rgba(176, 48, 48, 0.1); }
        .notification.success { border-left-color: var(--success-color); background-color: rgba(76, 174, 76, 0.1); }
        .notification.info { border-left-color: var(--info-color); background-color: rgba(49, 112, 143, 0.1); }
        .notification.warning { border-left-color: var(--accent-hover); background-color: rgba(212, 175, 55, 0.1); }
        .notification.intrigue { border-left-color: var(--intrigue-color); background-color: rgba(138, 74, 138, 0.1); }
        .notification h5, .alert h5 { font-family: var(--font-heading); margin-bottom: 3px; color: var(--text-color); font-size: 0.95em; }
        .alert h5 { color: var(--danger-color); } .notification.success h5 { color: var(--success-color); } .notification.info h5 { color: var(--info-color); } .notification.warning h5 { color: var(--accent-hover); } .notification.intrigue h5 { color: var(--intrigue-color); }
        .dismiss-btn { position: absolute; top: 3px; right: 4px; background: none; border: none; color: var(--text-muted); font-size: 1.1em; cursor: pointer; line-height: 1; padding: 2px 4px; }
        .dismiss-btn:hover { color: var(--text-color); }
        .alert p .clickable { color: var(--danger-hover); font-weight: bold;} /* Clickables inside alerts */
        .alert p .clickable:hover { color: var(--danger-color); }


        /* --- Event Trigger Button (Now in Right Panel, Manual backup) --- */
         #event-trigger-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border-color); text-align: center; }
         #trigger-event-btn { font-family: var(--font-main); background-color: var(--accent-color); color: var(--bg-color); border: 1px solid var(--accent-hover); padding: 6px 12px; font-size: 0.9em; cursor: pointer; border-radius: 4px; transition: background-color 0.2s ease; }
         #trigger-event-btn:hover { background-color: var(--accent-hover); border-color: var(--accent-color); }

        /* --- Modal Styles (Generic & Event) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--creator-bg); /* Darker for creators */ display: none; /* Managed by JS */ justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal-content { background-color: var(--creator-content-bg); border: 3px solid var(--creator-border); border-radius: 5px; padding: 25px; width: 90%; max-width: 700px; box-shadow: 0 5px 20px rgba(0,0,0,0.6); color: var(--text-color); max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-close-btn { position: absolute; top: 8px; right: 12px; background: none; border: none; color: var(--text-muted); font-size: 1.6em; line-height: 1; cursor: pointer; }
        .modal-close-btn:hover { color: var(--text-color); }
        .modal-content h2 { font-family: var(--font-heading); color: var(--accent-color); text-align: center; margin-bottom: 15px; font-size: 1.6em; }
        .modal-content h3 { font-family: var(--font-heading); color: var(--text-muted); font-size: 1.2em; margin-top: 18px; margin-bottom: 8px; border-bottom: 1px dashed var(--border-color); padding-bottom: 4px; }
        .modal-content p { margin-bottom: 12px; line-height: 1.6; font-size: 1.0em; }
        .modal-section { margin-bottom: 18px; }
        .modal-section ul { list-style: inside; margin-left: 10px; }
        .modal-section li { margin-bottom: 4px; font-size: 0.95em; }
        .modal-portrait { float: right; width: 90px; height: 115px; background-color: #444; border: 2px solid var(--border-color); margin-left: 15px; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; font-size: 1.1em; font-weight: bold; color: var(--portrait-text); text-align: center; overflow: hidden; }
        .modal-portrait .placeholder-initials { font-family: var(--font-heading); }
        .modal-options { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .modal-options button { font-family: var(--font-main); background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 10px 15px; font-size: 1.0em; cursor: pointer; border-radius: 4px; transition: background-color 0.2s ease, border-color 0.2s ease; text-align: left; }
        .modal-options button:hover:not(:disabled) { background-color: var(--accent-color); border-color: var(--accent-hover); color: var(--bg-color); }
        .modal-options button:disabled { background-color: #555; color: #999; cursor: not-allowed; border-color: #444; opacity: 0.6;}
        .modal-options button .outcome-hint { display: block; font-size: 0.8em; color: var(--text-muted); margin-top: 3px; font-style: italic; }
        .modal-options button:hover:not(:disabled) .outcome-hint { color: var(--bg-color); opacity: 0.9; }

        /* --- Detail Modal Specifics --- */
        #detail-modal-overlay .modal-content { max-width: 750px; } /* Slightly wider */
        #detail-modal-content .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-top: 10px; }
        #detail-modal-content .detail-card { background-color: rgba(0,0,0, 0.1); padding: 8px; border-radius: 3px; border: 1px solid var(--border-color); }
        #detail-modal-content .detail-card h4 { font-family: var(--font-heading); color: var(--text-muted); font-size: 0.95em; margin-bottom: 4px; }
        #detail-modal-content p .clickable, #detail-modal-content li .clickable { /* Ensure clickables inside modal text are styled */
            color: var(--accent-hover); text-decoration: underline; cursor: pointer; font-weight: bold;
        }
        #detail-modal-content p .clickable:hover, #detail-modal-content li .clickable:hover { color: var(--accent-color); }
        #detail-actions { display: flex; flex-wrap: wrap; flex-direction: row; gap: 8px; margin-top: 20px; }
        #detail-actions button { margin: 0; flex-basis: calc(50% - 4px); }

         /* --- Battle Modal Specifics --- */
         #battle-modal-overlay .modal-content { max-width: 950px; }
         .battle-display { display: flex; flex-direction: column; gap: 15px; }
         #battle-canvas {
            width: 100%;
            height: 450px;
            background-color: #667d6a; /* More battlefield-like green/brown */
            border: 2px solid var(--border-color);
            cursor: crosshair;
            position: relative; /* Needed for drawing */
         }
         .battle-controls { width: 100%; }
         .battle-log { height: 100px; background-color: rgba(0,0,0,0.2); border: 1px solid var(--border-color); padding: 10px; overflow-y: auto; font-size: 0.85em; color: var(--text-muted); margin-top: 10px; }
         .battle-log p { margin-bottom: 3px; }
         .battle-outcome { text-align: center; margin-top: 15px; font-size: 1.1em; font-weight: bold; }
         .battle-outcome.win { color: var(--success-color); } .battle-outcome.loss { color: var(--danger-color); } .battle-outcome.stalemate { color: var(--text-muted); }

         /* Canvas Icons */
        .canvas-icon {
             font-family: 'Arial', sans-serif; /* Simple font for icons */
             font-weight: bold;
             font-size: 14px; /* Adjust as needed */
             fill: white; /* Default color */
             text-anchor: middle;
             dominant-baseline: middle;
        }


         /* --- Message Modal --- */
         #message-modal-content .message-recipient { margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
         #message-modal-content h4 { color: var(--text-muted); font-size: 1.1em; }
         #message-modal-content .message-options button { text-align: left; }

        /* --- Creator Modal Styles --- */
        .creator-modal { display: flex; } /* Start displayed */
        .creator-modal .modal-content { max-width: 600px; border-color: var(--accent-color); }
        .creator-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .creator-section h3 { color: var(--accent-color); margin-bottom: 10px; }
        .creator-options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .creator-option { background-color: var(--bg-color); border: 2px solid var(--border-color); padding: 10px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .creator-option:hover { background-color: var(--creator-option-hover); border-color: var(--text-muted); }
        .creator-option.selected { background-color: var(--accent-color); border-color: var(--accent-hover); color: var(--bg-color); font-weight: bold; }
        .creator-option.selected .benefit { color: var(--bg-color); }
        .creator-option h4 { font-family: var(--font-heading); margin-bottom: 5px; font-size: 1.1em; }
        .creator-option p { font-size: 0.9em; margin-bottom: 5px; }
        .creator-option .benefit { font-size: 0.8em; color: var(--accent-hover); font-style: italic; }
        .creator-input-group { margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .creator-input-group label { flex-basis: 100px; text-align: right; color: var(--text-muted); flex-shrink: 0;}
        .creator-input-group input[type="text"],
        .creator-input-group input[type="number"],
        .creator-input-group select { /* Added select */
            flex-grow: 1; padding: 6px 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 3px; font-family: var(--font-main); font-size: 0.95em;
        }
        /* Specific styling for select */
        .creator-input-group select {
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23${'a0a0b0'.substring(1)}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); /* Simple gray arrow */
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 10px 10px;
            padding-right: 30px; /* Space for arrow */
        }
        .creator-input-group input[type="number"] { -moz-appearance: textfield; } /* Hide number spinners */
        .creator-input-group input[type="number"]::-webkit-outer-spin-button,
        .creator-input-group input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .stat-allocation-group { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
        .stat-allocation-group label { flex-basis: 60px; }
        .stat-allocation-group button { font-size: 0.8em; padding: 1px 6px; margin: 0 3px; background-color: var(--border-color); color: var(--text-color); border: 1px solid var(--bg-color); }
        .stat-allocation-group .stat-value { font-weight: bold; color: var(--accent-color); min-width: 20px; text-align: center; }
        #points-remaining { font-weight: bold; color: var(--accent-hover); }
        /* --- Trait Selection Styles --- */
        .trait-selection { /* Container for trait options */
             display: grid; /* Use grid for better layout */
             grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Responsive columns */
             gap: 10px;
             max-height: 200px; /* Limit height and allow scrolling */
             overflow-y: auto;
             padding: 10px;
             background-color: rgba(0,0,0, 0.1);
             border: 1px solid var(--border-color);
             border-radius: 4px;
        }
        .trait-option { /* Individual trait option */
             display: flex;
             align-items: center;
             gap: 8px;
             padding: 5px;
             border-radius: 3px;
             cursor: pointer; /* Make the whole label clickable */
             transition: background-color 0.2s;
        }
        .trait-option:hover {
             background-color: var(--creator-option-hover);
        }
        .trait-option input[type="checkbox"] {
             margin: 0; /* Reset margin */
             accent-color: var(--accent-color); /* Style checkbox color */
             cursor: pointer;
        }
        .trait-option label { /* Trait name */
             flex-grow: 1;
             font-size: 0.95em;
             cursor: pointer;
        }
        .trait-option .trait-effect { /* Hint for effects */
             font-size: 0.8em;
             color: var(--text-muted);
             font-style: italic;
             margin-left: auto; /* Push hint to the right */
             text-align: right;
             white-space: nowrap;
        }
        .trait-option input[type="checkbox"]:disabled + label {
             color: var(--text-muted);
             cursor: not-allowed;
             text-decoration: line-through;
        }
        .trait-option input[type="checkbox"]:disabled ~ .trait-effect {
             color: var(--text-muted);
             opacity: 0.6;
        }
        /* --- End Trait Selection Styles --- */
        .creator-confirm-btn { display: block; width: 100%; padding: 12px 20px; background-color: var(--accent-color); color: var(--bg-color); border: none; border-radius: 4px; font-family: var(--font-heading); font-size: 1.1em; cursor: pointer; transition: background-color 0.2s; margin-top: 20px; }
        .creator-confirm-btn:hover:not(:disabled) { background-color: var(--accent-hover); }
        .creator-confirm-btn:disabled { background-color: #555; color: #999; cursor: not-allowed; }
        /* Dynasty details display area (REMOVED) */

        /* --- News Tab --- */
        #news-feed {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px; /* Give news feed a max height */
            overflow-y: auto; /* Allow scrolling */
        }
        .news-item {
            background-color: var(--news-item-bg);
            border: 1px solid var(--news-item-border);
            border-left: 4px solid var(--info-color); /* Default color */
            padding: 12px 15px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .news-item:hover { background-color: var(--news-item-hover); }
        .news-item.type-event { border-left-color: var(--accent-color); }
        .news-item.type-opportunity { border-left-color: var(--success-color); }
        .news-item.type-completed { border-left-color: var(--text-muted); }
        .news-item.type-warning { border-left-color: var(--danger-color); }
        .news-item h4 {
            font-family: var(--font-heading);
            color: var(--text-color);
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        .news-item.type-event h4 { color: var(--accent-color); }
        .news-item.type-opportunity h4 { color: var(--success-color); }
        .news-item.type-warning h4 { color: var(--danger-color); }
        .news-item p { font-size: 0.95em; margin-bottom: 10px; color: var(--text-muted); }
        .news-item .news-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .news-item .news-actions button { margin-left: 0; } /* Override default margin */

        /* --- Scrollbar Styling --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    </style>
</head>
<body>

    <!-- Kingdom Create Modal -->
    <div class="modal-overlay creator-modal" id="kingdom-create-modal">
         <div class="modal-content">
            <h2>Define Your Kingdom</h2>
            <div class="creator-section">
                 <div class="creator-input-group">
                    <label for="dynasty-name">Dynasty Name:</label>
                    <input type="text" id="dynasty-name" placeholder="e.g., Volkov" value="Eldor">
                 </div>
                 <div class="creator-input-group">
                    <label for="kingdom-name">Kingdom Name:</label>
                    <input type="text" id="kingdom-name" placeholder="e.g., Eldoria" value="Eldoria">
                 </div>
            </div>
             <div class="creator-section">
                 <h3>Kingdom Focus</h3>
                 <p>What legacy will your kingdom pursue?</p>
                 <div class="creator-options-grid" id="kingdom-focus-options">
                     <!-- Focus options populated by JS -->
                 </div>
             </div>
             <button class="creator-confirm-btn" id="confirm-kingdom-btn" disabled>Found Kingdom</button>
        </div>
    </div>

    <!-- Ruler Create Modal -->
    <div class="modal-overlay creator-modal" id="ruler-create-modal" style="display: none;">
         <div class="modal-content">
            <h2>Create Your Ruler</h2>
             <div class="creator-section">
                 <div class="creator-input-group">
                     <label for="ruler-name">Ruler Name:</label>
                     <input type="text" id="ruler-name" placeholder="e.g., Aldric" value="Aldric">
                 </div>
                 <div class="creator-input-group">
                    <label for="ruler-epithet">Epithet:</label>
                    <input type="text" id="ruler-epithet" placeholder="e.g., the Wise" value="the Bold">
                </div>
             </div>
              <div class="creator-section">
                  <h3>Allocate Stats (<span id="points-remaining">X</span> Points Left)</h3>
                  <div id="ruler-stats-allocator">
                      <!-- Stat inputs populated by JS -->
                  </div>
              </div>
              <!-- *** RE-ADDED TRAIT SELECTION SECTION *** -->
              <div class="creator-section">
                  <h3>Select Traits (Choose <span id="traits-to-select">X</span>)</h3>
                  <div class="trait-selection scrollable-list" id="ruler-trait-selector">
                      <!-- Trait checkboxes populated by JS -->
                  </div>
              </div>
             <button class="creator-confirm-btn" id="confirm-ruler-btn" disabled>Begin Your Reign</button>
        </div>
    </div>

    <!-- Main Game UI (Initially Hidden) -->
    <div id="game-ui">
        <header>
            <h1 id="game-title">Crown & Blade</h1>
            <div class="game-state-info">
                <span id="game-date">Date: 100 / 01</span>
                <span id="game-gold">Gold: <strong>500</strong></span>
                <span id="game-prestige">Prestige: <strong>1000</strong></span>
                <span id="game-manpower">Manpower: <strong>15000</strong></span>
                <span id="game-income">Income: <strong>+5/m</strong></span>
                <span id="game-dynasty-prestige">Dynasty Prestige: <strong id="dynasty-prestige-display">0</strong></span>
            </div>
             <div class="game-controls">
                 <button id="pause-button">Pause</button>
                 <label for="game-speed">Speed:</label>
                 <select id="game-speed">
                     <option value="2000">Slow (2s/m)</option>
                     <option value="1000" selected>Normal (1s/m)</option>
                     <option value="500">Fast (0.5s/m)</option>
                     <option value="250">Faster (0.25s/m)</option>
                 </select>
             </div>
        </header>

        <nav class="main-tabs">
             <ul>
                <li><button class="tab-button active" data-tab="news">News</button></li> <!-- News Tab First -->
                <li><button class="tab-button" data-tab="politics">Politics</button></li>
                <li><button class="tab-button" data-tab="military">Military</button></li>
                <li><button class="tab-button" data-tab="diplomacy">Diplomacy</button></li>
                <li><button class="tab-button" data-tab="laws">Laws</button></li>
                <li><button class="tab-button" data-tab="intrigue">Intrigue</button></li>
                <li><button class="tab-button" data-tab="dynasty">Dynasty</button></li>
                <li><button class="tab-button" data-tab="mercenaries">Mercenaries</button></li>
            </ul>
        </nav>

        <div class="main-content-wrapper">
            <div class="main-tab-content">
                 <!-- News Tab Content -->
                 <div id="news-content" class="tab-content active">
                     <h2>News & Developments</h2>
                     <p style="color: var(--text-muted); font-style: italic; margin-bottom: 15px;">Events, opportunities, and alerts appear here. Some require action.</p>
                     <div id="news-feed" class="scrollable-list"> <!-- Added scrollable list class -->
                         <!-- Populated by JS with news items -->
                     </div>
                 </div>

                <!-- Politics Tab Content -->
                <div id="politics-content" class="tab-content">
                    <h2>Politics & Ideology</h2>
                    <div class="ideology-sliders">
                         <h3>Realm Ideology</h3>
                         <div class="slider-group">
                            <label for="order-freedom-slider">Authority:</label>
                            <div class="slider-container"> <span class="slider-labels">Order</span> <input type="range" id="order-freedom-slider" min="0" max="100" value="65" step="1"> <span class="slider-labels">Freedom</span> </div> <span class="slider-value" id="order-freedom-value">65</span>
                        </div>
                        <div class="slider-group">
                            <label for="central-decentral-slider">Governance:</label>
                            <div class="slider-container"> <span class="slider-labels">Centralized</span> <input type="range" id="central-decentral-slider" min="0" max="100" value="70" step="1"> <span class="slider-labels">Decentralized</span> </div> <span class="slider-value" id="central-decentral-value">70</span>
                        </div>
                        <div class="slider-group">
                            <label for="aristo-egal-slider">Society:</label>
                            <div class="slider-container"> <span class="slider-labels">Aristocratic</span> <input type="range" id="aristo-egal-slider" min="0" max="100" value="30" step="1"> <span class="slider-labels">Egalitarian</span> </div> <span class="slider-value" id="aristo-egal-value">30</span>
                        </div>
                         <div class="peasantry-approval">
                            Peasantry Approval: <strong id="peasantry-approval-value">59%</strong>
                        </div>
                        <!-- Removed unimplemented tag -->
                    </div>

                    <h3>Active Factions (<span id="faction-count">0</span>)</h3>
                    <div class="list-section scrollable-list" id="faction-list">
                        <!-- Populated by JS -->
                    </div>

                    <h3>Vassals</h3>
                     <div class="list-section">
                        <h4>Direct Vassals (<span id="vassal-count">0</span>)</h4>
                         <div class="scrollable-list" id="vassal-list">
                             <!-- Populated by JS -->
                         </div>
                     </div>
                </div>

                 <!-- Military Tab Content -->
                <div id="military-content" class="tab-content">
                    <h2>Military Overview</h2>
                    <h3>Current Wars</h3>
                     <div class="list-section war-list scrollable-list" id="military-war-list">
                          <!-- Populated by JS -->
                    </div>
                    <h3>Armies & Levies</h3>
                     <p>Total Potential Levies: <strong id="total-levies">7500</strong> (Vassal Contribution)</p>
                     <p>Retinues: <strong id="retinues-size">500</strong> (Standing Army)</p>
                     <p>Hired Mercenaries: <strong id="hired-mercs-size">0</strong></p>
                     <p>Total Available Manpower: <strong id="manpower-pool">15000</strong> (<span id="manpower-change">N/A</span>)</p>
                     <p style="color: var(--text-muted); font-style: italic; font-size: 0.9em">Levies cost upkeep when raised and drain manpower when fighting.</p>
                     <button class="generic-action-btn" data-action="mil_raise_levies" id="raise-levies-btn" data-cost-data='{"prestige": 5}'>Raise Levies</button>
                     <button class="generic-action-btn" data-action="mil_disband_levies" id="disband-levies-btn" disabled>Disband Levies</button>
                     <button class="generic-action-btn cost" data-action="mil_reinforce_retinues" data-cost-data='{"gold": 100, "manpower": 500}' id="reinforce-retinues-btn">Reinforce Retinues (100)</button>
                    <h3>Generals</h3>
                    <div class="list-section">
                        <div class="scrollable-list" id="generals-list">
                             <!-- Populated by JS -->
                        </div>
                        <span class="unimplemented-feature">(Assigning generals to armies/command limits simplified.)</span>
                    </div>
                </div>

                 <!-- Diplomacy Tab Content -->
                <div id="diplomacy-content" class="tab-content">
                    <h2>Diplomacy & Relations</h2>
                    <span class="unimplemented-feature">(AI diplomatic actions are basic/random.)</span>
                    <h3>Relations Overview</h3>
                    <div class="relations-overview" id="relations-overview-grid">
                         <!-- Populated by JS -->
                    </div>
                     <h3>Alliances</h3>
                     <div class="list-section scrollable-list" id="alliances-list">
                         <!-- Populated by JS -->
                    </div>
                     <h3>Truces</h3>
                     <div class="list-section" id="truces-list">
                         <h4>Active Truces</h4>
                         <div class="scrollable-list" id="truce-details">
                              <!-- Populated by JS -->
                         </div>
                    </div>
                     <h3>Enemies & Rivals</h3>
                     <div class="list-section scrollable-list" id="enemies-list">
                           <!-- Populated by JS -->
                    </div>
                     <h3>Neighboring Realms & Tribes</h3>
                     <div class="list-section">
                          <h4>Known Realms</h4>
                         <div class="scrollable-list" id="neighbors-list">
                            <!-- Populated by JS -->
                         </div>
                     </div>
                </div>

                <!-- Laws Tab Content -->
                <div id="laws-content" class="tab-content">
                    <h2>Laws & Edicts</h2>
                    <h3>Realm Laws</h3>
                    <p style="color: var(--text-muted); font-style: italic; margin-bottom: 15px;">Enacting laws costs prestige and requires certain conditions. Click a law for details and enactment options. Effects apply monthly.</p>
                    <div id="laws-container" class="laws-grid">
                         <!-- Populated by JS -->
                    </div>
                     <h3>Edicts</h3>
                     <p style="color: var(--text-muted); font-style: italic;">Temporary realm-wide buffs/debuffs that expire over time.</p>
                     <button class="generic-action-btn cost" data-action="edict_taxes" data-cost-data='{"prestige": 100}'>Enact Harsh Taxes (-10 Appr, +5 Inc, 24m Dur)</button>
                     <button class="generic-action-btn cost" data-action="edict_fortify" data-cost-data='{"gold": 50}'>Improve Fortifications (+10% Def, 36m Dur)</button>
                     <button class="generic-action-btn cost" data-action="edict_festivals" data-cost-data='{"gold": 75}'>Hold Festivals (+5 Appr, 12m Dur)</button>
                </div>

                <!-- Intrigue Tab Content -->
                <div id="intrigue-content" class="tab-content">
                    <h2>Intrigue & Plots</h2>
                    <p>Your base Plot Power: <strong id="plot-power">15</strong> | Discovery Chance: <strong id="discovery-chance">10%</strong></p>
                    <p>Current Scheme: <strong id="current-scheme">None</strong> <span id="scheme-timer" class="scheme-timer"></span></p>
                    <h3>Your Active Plots</h3>
                    <div class="list-section">
                        <div class="scrollable-list" id="active-plots-list">
                           <!-- Populated by JS -->
                        </div>
                         <button class="generic-action-btn cost" data-action="intrigue_advance_plots" data-cost-data='{"prestige": 10}' style="margin-top: 10px;">Boost All Plot Progress (10 P)</button>
                         <span class="unimplemented-feature">(Plots also progress automatically each month.)</span>
                    </div>
                    <h3>Known Plots Against You</h3>
                     <div class="list-section">
                         <div class="scrollable-list" id="plots-against-you-list">
                             <!-- Populated by JS -->
                         </div>
                     </div>
                     <h3>Potential Actions</h3>
                      <button class="generic-action-btn intrigue-action" data-action="intrigue_discover_plots" data-cost-data='{}'>Scheme to Discover Plots</button>
                      <button class="generic-action-btn intrigue-action cost" data-action="intrigue_fabricate_claim" data-cost-data='{"gold": 100}' disabled>Scheme: Fabricate Claim (NYI)</button>
                      <button class="generic-action-btn intrigue-action cost" data-action="intrigue_build_spy_network" data-cost-data='{"gold": 50}' disabled>Scheme: Build Spy Network (NYI)</button>
                      <!-- Removed NYI span -->
                </div>


                <!-- Dynasty Tab Content -->
                <div id="dynasty-content" class="tab-content">
                    <h2>Dynasty & Legacy</h2>
                    <h3 id="dynasty-name">House [Dynasty Name]</h3>
                     <p>Dynasty Head: <span class="clickable" data-type="character" data-id="player" id="dynasty-head">King Aldric 'the Wise'</span></p>
                     <p>Members: <span id="dynasty-members">0</span> | Cadet Branches: <span id="dynasty-cadets">0</span></p>
                     <p>Dynasty Prestige: <strong id="dynasty-prestige">0</strong></p>
                     <h3>Dynasty Legacy</h3>
                     <p style="color: var(--text-muted); font-style: italic;">Unlocking legacies costs dynasty prestige and provides permanent bonuses.</p>
                     <button class="generic-action-btn cost" id="unlock-legacy-btn" data-action="dynasty_unlock_legacy" data-cost-data='{"dynastyPrestige": 500}'>Unlock Legacy Perk (+5% Prestige)</button>
                     <button class="generic-action-btn" disabled>View Legacy Tree (N/A)</button>
                     <h3>Family Tree</h3>
                     <p style="color: var(--text-muted); font-style: italic;">Visual representation of the family.</p>
                     <button class="generic-action-btn" disabled>View Family Tree (N/A)</button>
                     <h3>Dynasty Interactions</h3>
                     <div style="margin-top: 20px;">
                        <button class="generic-action-btn cost" data-action="dynasty_arrange_marriage" data-cost-data='{"prestige": 50}' disabled>Arrange Marriage (NYI)</button>
                        <button class="generic-action-btn" data-action="dynasty_educate_child" data-cost-data='{}' disabled>Educate Child (NYI)</button>
                        <button class="generic-action-btn cost" data-action="dynasty_request_claim" data-cost-data='{"prestige": 150}' disabled>Request Claim From Head (NYI)</button>
                        <button class="generic-action-btn cost" data-action="dynasty_grant_title" data-cost-data='{"prestige": -10}' disabled>Grant Title to Member (NYI)</button>
                        <button class="generic-action-btn danger-action cost" data-action="dynasty_denounce" data-cost-data='{"prestige": 25}' disabled>Denounce Member (NYI)</button>
                        <button class="generic-action-btn cost" data-action="dynasty_legitimize_bastard" data-cost-data='{"dynastyPrestige": 100}' disabled>Legitimize Bastard (NYI)</button>
                         <!-- Removed NYI span -->
                     </div>
                </div>

                 <!-- Mercenaries Tab Content -->
                <div id="mercenaries-content" class="tab-content">
                    <h2>Available Mercenaries</h2>
                    <div class="list-section scrollable-list" id="mercenary-list">
                        <!-- Populated by JS -->
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.9em;">Mercenaries cost gold to hire and require upkeep. Hired mercenaries add to your total army strength but drain manpower if used in battle. Availability refreshes over time.</p>
                </div>

            </div>

            <!-- Right Panel: Ruler Info, Notifications, Alerts -->
            <aside class="ruler-panel">
                <div class="ruler-portrait" id="ruler-portrait-container" style="background-color: var(--portrait-bg-1);">
                    <span class="placeholder-initials" id="ruler-initials">AW</span>
                    <img src="" alt="Ruler Portrait" id="ruler-portrait-img">
                </div>
                 <!-- Title is now clickable -->
                <h3 class="ruler-title clickable" id="ruler-name-title" data-type="character" data-id="player">King Aldric 'the Wise'</h3>
                 <p style="text-align: center; font-size: 0.9em; color: var(--text-muted);" id="ruler-stats">Diplo: 7 | Mart: 5 | Stew: 8 | Intr: 6 | Learn: 9</p>
                 <p style="text-align: center; font-size: 0.8em; color: var(--text-muted);" id="ruler-traits">Traits: Just, Cautious, Educated</p>

                <div class="key-characters">
                    <h4>Council & Court</h4>
                    <ul id="council-court-list"></ul>
                </div>

                <div class="notifications-alerts-container">
                    <div id="alerts">
                         <h4>Alerts</h4>
                         <div class="notification-area">
                             <div class="alert" id="alert-rebellion" style="display: none;">
                                <button class="dismiss-btn" data-target="alert-rebellion">×</button>
                                <h5>Rebellion Warning!</h5>
                                <p>Low Peasantry Approval (<span class="alert-approval-value">N/A</span>%) causes high unrest!</p>
                                <span class="unimplemented-feature">(High risk of rebellion event!)</span>
                             </div>
                              <div class="alert" id="alert-faction-danger" style="display: none;">
                                <button class="dismiss-btn" data-target="alert-faction-danger">×</button>
                                <h5>Dangerous Faction!</h5>
                                <p>The <span class="alert-faction-name">Faction</span> is powerful (<span class="alert-faction-strength">N/A</span>%)!</p>
                                <span class="unimplemented-feature">(May issue ultimatum!)</span>
                             </div>
                             <div class="alert" id="alert-low-gold" style="display: none;">
                                <button class="dismiss-btn" data-target="alert-low-gold">×</button>
                                <h5>Low Gold Reserves!</h5>
                                <p>Treasury (<span class="alert-gold-value">N/A</span> Gold) is critically low!</p>
                             </div>
                              <div class="alert" id="alert-low-manpower" style="display: none;">
                                <button class="dismiss-btn" data-target="alert-low-manpower">×</button>
                                <h5>Low Manpower!</h5>
                                <p>Manpower (<span class="alert-manpower-value">N/A</span>) is critically low!</p>
                             </div>
                             <div class="alert" id="alert-war-losing" style="display: none;">
                                <button class="dismiss-btn" data-target="alert-war-losing">×</button>
                                <h5>Losing War!</h5>
                                <p>The war for <span class="alert-war-name">War</span> is going poorly (<span class="alert-war-score">N/A</span>%)!</p>
                             </div>
                             <div class="alert" id="alert-plot-discovered" style="display: none;">
                                <button class="dismiss-btn" data-target="alert-plot-discovered">×</button>
                                <h5>Plot Discovered!</h5>
                                <p>A plot targeting <span class="alert-plot-target">you</span> has been discovered!</p>
                             </div>
                         </div>
                    </div>
                    <div id="notifications" style="margin-top: 15px;">
                        <h4>Notifications</h4>
                         <div class="notification-area" id="notification-log">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div id="event-trigger-section">
                        <button id="trigger-event-btn">Trigger Random Event (Manual)</button>
                        <span class="unimplemented-feature">(Events also trigger automatically.)</span>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Event Modal Structure -->
    <div class="modal-overlay" id="event-modal-overlay">
        <div class="modal-content" id="event-modal-content">
            <button class="modal-close-btn" onclick="closeModal('eventModalOverlay')">×</button>
            <h2 id="event-title">Event Title</h2>
             <div id="event-portrait" class="modal-portrait" style="display: none;">
                 <span class="placeholder-initials">??</span>
             </div>
            <p id="event-description">Event description goes here.</p>
            <div class="modal-options" id="event-options">
                <!-- Option buttons added by JS -->
            </div>
        </div>
    </div>

     <!-- Detail Modal Structure -->
    <div class="modal-overlay" id="detail-modal-overlay">
        <div class="modal-content" id="detail-modal-content">
             <button class="modal-close-btn" onclick="closeModal('detailModalOverlay')">×</button>
             <h2 id="detail-title">Detail View</h2>
             <div id="detail-portrait" class="modal-portrait" style="display: none;">
                 <span class="placeholder-initials">??</span>
             </div>
             <p id="detail-description">Details will load here.</p>
             <div id="detail-specific-content">
                 <!-- Specific sections added by JS -->
             </div>
             <div id="detail-actions" class="modal-options">
                 <!-- Action buttons added by JS -->
             </div>
        </div>
    </div>

    <!-- Battle Modal Structure -->
    <div class="modal-overlay" id="battle-modal-overlay">
        <div class="modal-content" id="battle-modal-content">
             <button class="modal-close-btn" onclick="closeBattleModal()">×</button>
             <h2 id="battle-title">Battle Simulation</h2>
             <span class="unimplemented-feature">(Battle simulation is turn-based. Click unit, then target/tile.)</span>
            <div class="battle-display">
                 <canvas id="battle-canvas"></canvas>
                 <div class="battle-controls">
                    <p>Unit Shapes: Square(Inf), Rectangle(Cav), Circle(Arch). Click unit (blue) to select, click empty space to move or enemy (red) to attack.</p>
                     <button id="battle-end-turn-btn" class="generic-action-btn" data-action="battle_end_turn" style="width: 100%; margin-top: 10px;" disabled>End Player Turn</button>
                      <div class="battle-log" id="battle-log">
                         <p>Battle initiated. Select a unit.</p>
                     </div>
                      <div class="battle-outcome" id="battle-outcome-display"></div>
                 </div>
            </div>
        </div>
    </div>

    <!-- Message Modal Structure -->
    <div class="modal-overlay" id="message-modal-overlay">
        <div class="modal-content" id="message-modal-content">
            <button class="modal-close-btn" onclick="closeModal('messageModalOverlay')">×</button>
            <h2>Send Message</h2>
            <div class="message-recipient">
                <h4>To: <span id="message-recipient-name">Recipient</span></h4>
            </div>
            <p>Select a message to send:</p>
            <div class="modal-options message-options" id="message-options-list">
                {/* Message options populated by JS */}
            </div>
            <span class="unimplemented-feature">(AI responses are basic.)</span>
        </div>
    </div>




```html
    <script>
        // --- Constants ---
        const REBELLION_THRESHOLD = 30;
        const FACTION_DANGER_THRESHOLD = 65;
        const FACTION_ULTIMATUM_THRESHOLD = 80;
        const FACTION_ULTIMATUM_CHANCE_PER_MONTH = 0.05; // Chance per month *above* threshold
        const LOW_GOLD_THRESHOLD = 50;
        const LOW_MANPOWER_THRESHOLD = 1000;
        const LOSING_WAR_THRESHOLD = -25;
        const MONTHS_PER_YEAR = 12;
        const MONTH_NAMES = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const BASE_PLOT_POWER = 10;
        const BASE_PLOT_DISCOVERY = 5; // Base percentage
        const PLOT_PROGRESS_PER_MONTH = 3; // Base progress per month auto
        const SCHEME_PROGRESS_PER_MONTH = 100 / 12; // Approx monthly progress for 12m scheme
        const SCHEME_BASE_DURATION_MONTHS = 12;
        const MAX_ACTIVE_PLOTS = 3;
        const TRUCE_DURATION_MONTHS = 60; // 5 years
        const BATTLE_GRID_SIZE = 20; // Size of each grid square in pixels
        const BATTLE_CANVAS_PADDING = 10;
        const TARGET_FACTION_COUNT = 15; // Reduced slightly
        const RULER_STAT_POINTS = 30;
        const RULER_TRAITS_TO_PICK = 3;
        const REBELLION_EVENT_CHANCE_LOW_APPROVAL = 0.15; // Chance per month when below threshold
        const BATTLE_WARSCORE_IMPACT = 20; // Slightly reduced impact per battle
        const EVENT_CHANCE_PER_MONTH = 0.1; // 10% chance of a random event per month
        const BASE_GAME_SPEED = 1000; // ms per month (Normal speed)

        // --- Game Setup State ---
        let setupState = { dynastyName: "Eldor", kingdomName: "Eldoria", selectedFocus: null, rulerName: "Aldric", rulerEpithet: "the Bold", rulerStats: { dip: 5, mar: 5, ste: 5, int: 5, lrn: 5 }, rulerTraits: [], setupComplete: false };

        // --- Game State ---
        let gameState = {
            gold: 500,
            prestige: 1000,
            monthlyIncomeBase: 15,
            monthlyExpensesBase: 10,
            monthlyIncomeModifiers: 0,
            monthlyExpensesModifiers: 0,
            date: { year: 100, month: 0 }, // Only year/month now
            gameTime: 0, // Global month counter from start
            currentPeasantApproval: 59,
            activeEdicts: {}, // { edictId: expiryGlobalMonth }
            manpower: 15000,
            maxManpower: 25000,
            manpowerGainPerMonth: 150,
            leviesRaised: false,
            raisedLevyUpkeep: 15,
            retinues: 500,
            hiredMercIds: [],
            activePlots: [], // { id, type, targetId, progress, discoveryChance, successChance, plotterId }
            discoveredPlots: [], // { id, type, targetId, plotterId, handled }
            currentScheme: null, // { type, targetId, progress, duration, startTime }
            plotPower: BASE_PLOT_POWER,
            plotDiscoveryChance: BASE_PLOT_DISCOVERY,
            activeLaws: ["law_succession_primo", "law_authority_high", "law_obligation_balanced", "law_coinage_standard", "law_council_ruler", "law_investiture_free"],
            activeTruces: {}, // { targetId: expiryGlobalMonth }
            messageLog: [],
            activeBattle: null, // { warId, playerUnits: [], enemyUnits: [], turn: 0, playerTurn: true, gridSize, gridPixelSize }
            selectedUnitId: null,
            dynastyId: null,
            dynastyPrestige: 0,
            dynastyMembers: 0, // Updated dynamically
            dynastyCadets: 0,
            dynastyUnlockedLegacies: [], // Store IDs of unlocked legacies
            newsFeedItems: [],
            newsIdCounter: 0,
            gamePaused: true, // Start paused
            gameSpeedMs: BASE_GAME_SPEED, // ms per month
            gameLoopInterval: null, // Holds the setInterval ID
        };

        // --- Mock Data ---
        const availableKingdomFocuses = {
            "expansionist": { name: "Expansionist", description: "A focus on conquest and growing the borders of the realm.", benefit: { prestige: 100, manpowerGain: 25, relationBonus: -5 } },
            "administrative": { name: "Administrative", description: "Efficient bureaucracy and infrastructure are the priorities.", benefit: { gold: 200, income: 2 } },
            "military": { name: "Military Tradition", description: "A strong army and skilled generals are the backbone of the kingdom.", benefit: { retinues: 200, manpowerGain: 15 } },
            "diplomatic": { name: "Diplomatic Acumen", description: "Building alliances and navigating the intricacies of courtly life.", benefit: { prestige: 150, relationBonus: 10 } },
            "intrigue": { name: "Shadowy Dealings", description: "Secrets, plots, and spycraft are the preferred tools of statecraft.", benefit: { gold: 100, plotPowerBonus: 5, plotDiscoveryBonus: 5 } }
        };
        const availableRulerTraits = [
            { id: "just", name: "Just", description: "Fair and righteous.", effects: { stats: { dip: 1}, generalOpinion: 10, vassalOpinion: 15, plotPower: -2 } },
            { id: "ambitious", name: "Ambitious", description: "Always seeking more power and prestige.", effects: { stats: { int: 2 }, prestigePerMonth: 1, generalOpinion: -5 } },
            { id: "content", name: "Content", description: "Happy with their lot, less likely to cause trouble.", effects: { stats: { int: -1 }, generalOpinion: 5, vassalOpinion: 5, prestigePerMonth: -0.5 } },
            { id: "brave", name: "Brave", description: "Courageous in the face of danger.", effects: { stats: { mar: 2 }, generalOpinion: 5 } },
            { id: "craven", name: "Craven", description: "Easily frightened and cowardly.", effects: { stats: { mar: -2 }, generalOpinion: -10, vassalOpinion: -10 } },
            { id: "generous", name: "Generous", description: "Free with their wealth and praise.", effects: { stats: { ste: -1 }, generalOpinion: 10, incomePercent: -0.05 } },
            { id: "greedy", name: "Greedy", description: "Desires wealth above all else.", effects: { stats: { ste: 2 }, generalOpinion: -10, incomePercent: 0.10 } },
            { id: "diligent", name: "Diligent", description: "Hardworking and focused.", effects: { stats: { ste: 1, lrn: 1 }, prestigePerMonth: 0.5 } },
            { id: "lazy", name: "Lazy", description: "Prefers leisure over labor.", effects: { stats: { ste: -1, lrn: -1 }, prestigePerMonth: -0.5 } },
            { id: "kind", name: "Kind", description: "Compassionate and merciful.", effects: { stats: { dip: 1 }, generalOpinion: 10 } },
            { id: "wrathful", name: "Wrathful", description: "Prone to fits of anger.", effects: { stats: { mar: 1, dip: -2 }, generalOpinion: -10 } },
            { id: "patient", name: "Patient", description: "Calm and enduring.", effects: { stats: { dip: 1, ste: 1 }, plotPower: -1 } },
            { id: "impatient", name: "Impatient", description: "Easily frustrated, wants results now.", effects: { stats: { mar: 1, ste: -1 }} },
            { id: "paranoid", name: "Paranoid", description: "Suspicious of everyone.", effects: { stats: { int: 2, dip: -1 }, generalOpinion: -5, plotDiscoveryBonus: 10 } },
            { id: "trusting", name: "Trusting", description: "Believes the best of people.", effects: { stats: { dip: 1, int: -2 }, generalOpinion: 5, plotDiscoveryBonus: -10 } },
            { id: "deceitful", name: "Deceitful", description: "A natural liar and manipulator.", effects: { stats: { int: 3, dip: -1 }, generalOpinion: -10 } },
            { id: "honest", name: "Honest", description: "Truthful, perhaps to a fault.", effects: { stats: { dip: 1, int: -2 }, generalOpinion: 5 } },
            { id: "educated", name: "Educated", description: "Possesses formal learning.", effects: { stats: { lrn: 3 }, prestigePerMonth: 0.5 } },
            { id: "shrewd", name: "Shrewd", description: "Astute and cunning in practical matters.", effects: { stats: { ste: 2, int: 1 }} },
            { id: "loyal", name: "Loyal", description: "(As Vassal) Less likely to join factions.", effects: { liegeOpinion: 15 } },
            { id: "zealous", name: "Zealous", description: "Deeply devoted to their faith.", effects: { stats: { lrn: 1 }, generalOpinion: 5 } },
            { id: "cynical", name: "Cynical", description: "Distrustful of ideals and motives.", effects: { stats: { lrn: 1 }, generalOpinion: -5 } },
        ];
        let gameData = {
            characters: {
                "borin": { id: "borin", name: "Borin", title: "Duke", portraitSeed: "BO", opinion: 15, stats: { dip: 6, mar: 7, ste: 5, int: 4, lrn: 3 }, traits: ["Brave", "Honest"], description: "A sturdy, traditionalist duke.", relations: ["Liege: player"], dynasty: "Stonehand", hidden: false },
                "emeric": { id: "emeric", name: "Emeric", title: "Count", portraitSeed: "EM", opinion: -10, stats: { dip: 4, mar: 4, ste: 7, int: 6, lrn: 5 }, traits: ["Greedy", "Shrewd"], description: "A wealthy count focused on his coffers.", relations: ["Liege: player"], dynasty: "Goldfeather", hidden: false },
                "anais": { id: "anais", name: "Anais", title: "Duchess", portraitSeed: "AN", opinion: 30, stats: { dip: 7, mar: 3, ste: 6, int: 7, lrn: 6 }, traits: ["Kind", "Patient", "Trusting"], description: "A well-liked duchess, perhaps too trusting.", relations: ["Liege: player"], dynasty: "Bloomwood", hidden: false },
                "rhys": { id: "rhys", name: "Rhys", title: "Count", portraitSeed: "RH", opinion: -25, stats: { dip: 5, mar: 8, ste: 3, int: 5, lrn: 2 }, traits: ["Ambitious", "Wrathful"], description: "An ambitious count with a fiery temper.", relations: ["Liege: player"], dynasty: "Blackiron", hidden: false },
                "gautier": { id: "gautier", name: "Gautier", title: "Duke", portraitSeed: "GA", opinion: -40, stats: { dip: 3, mar: 9, ste: 4, int: 4, lrn: 1 }, traits: ["Brave", "Ambitious", "Craven"], description: "A rebellious Duke currently leading an uprising.", relations: ["Liege: player", "Status: In Rebellion"], dynasty: "Ironfist", hidden: false, councilRole: null },
                "isolde_n": { id: "isolde_n", name: "Isolde", title: "Countess", portraitSeed: "IS", opinion: 5, stats: { dip: 6, mar: 5, ste: 5, int: 8, lrn: 7 }, traits: ["Deceitful", "Patient"], description: "A quiet countess with watchful eyes.", relations: ["Liege: player"], dynasty: "Shadowmere", hidden: false },
                "gregor": { id: "gregor", name: "Gregor", title: "Baron", portraitSeed: "GR", opinion: 55, stats: { dip: 5, mar: 6, ste: 6, int: 3, lrn: 4 }, traits: ["Loyal", "Content", "Brave"], description: "A loyal and dependable baron.", relations: ["Liege: player"], dynasty: "Oakenshield", hidden: false },
                "lyra": { id: "lyra", name: "Lyra", title: "Baroness", portraitSeed: "LY", opinion: -5, stats: { dip: 7, mar: 4, ste: 4, int: 7, lrn: 8 }, traits: ["Educated", "Cynical"], description: "A learned but cynical minor noble.", relations: ["Liege: player"], dynasty: "Starfall", hidden: false },
                "finnian": { id: "finnian", name: "Finnian", title: "Count", portraitSeed: "FI", opinion: 10, stats: { dip: 8, mar: 2, ste: 7, int: 5, lrn: 6 }, traits: ["Generous", "Kind"], description: "A well-meaning but militarily weak count.", relations: ["Liege: player"], dynasty: "Silverstream", hidden: false },
                "kael": { id: "kael", name: "Kael", title: "Duke", portraitSeed: "KA", opinion: 20, stats: { dip: 6, mar: 8, ste: 5, int: 6, lrn: 5 }, traits: ["Ambitious", "Brave", "Shrewd"], description: "A powerful and ambitious duke, watches the throne closely.", relations: ["Liege: player"], dynasty: "Stormblade", hidden: false },
                "theron": { id: "theron", name: "Theron", title: "Count", portraitSeed: "TH", opinion: -15, stats: { dip: 4, mar: 7, ste: 3, int: 9, lrn: 3 }, traits: ["Paranoid", "Wrathful"], description: "A paranoid and easily angered count, prone to plotting.", relations: ["Liege: player"], dynasty: "Gloomhaven", hidden: false },
                "elara": { id: "elara", name: "Elara", title: "Queen", portraitSeed: "EL", opinion: 75, stats: { dip: 8, mar: 4, ste: 7, int: 6, lrn: 7 }, traits: ["Generous", "Kind", "Educated"], description: "Your spouse.", relations: [], dynasty: null, hidden: false, councilRole: "Spouse" },
                "edgar": { id: "edgar", name: "Edgar", title: "Prince", portraitSeed: "ED", opinion: 40, stats: { dip: 5, mar: 6, ste: 5, int: 5, lrn: 5 }, traits: ["Ambitious"], description: "Your heir.", relations: [], dynasty: null, hidden: false, councilRole: "Heir" },
                "vassal_gen_1": { id: "vassal_gen_1", name: "Generic Vassal 1", title: "Baron", portraitSeed: "V1", opinion: 0, stats: { dip: 5, mar: 5, ste: 5, int: 5, lrn: 5 }, traits: ["Content"], relations: ["Liege: player"], dynasty: "GenericDyn1", hidden: false },
                "vassal_gen_2": { id: "vassal_gen_2", name: "Generic Vassal 2", title: "Count", portraitSeed: "V2", opinion: 0, stats: { dip: 5, mar: 5, ste: 5, int: 5, lrn: 5 }, traits: ["Content"], relations: ["Liege: player"], dynasty: "GenericDyn2", hidden: false },
                "vassal_gen_3": { id: "vassal_gen_3", name: "Generic Vassal 3", title: "Baron", portraitSeed: "V3", opinion: 0, stats: { dip: 5, mar: 5, ste: 5, int: 5, lrn: 5 }, traits: ["Content"], relations: ["Liege: player"], dynasty: "GenericDyn3", hidden: false },
                "vassal_gen_4": { id: "vassal_gen_4", name: "Generic Vassal 4", title: "Count", portraitSeed: "V4", opinion: 0, stats: { dip: 5, mar: 5, ste: 5, int: 5, lrn: 5 }, traits: ["Content"], relations: ["Liege: player"], dynasty: "GenericDyn4", hidden: false },
                "vassal_gen_5": { id: "vassal_gen_5", name: "Generic Vassal 5", title: "Baron", portraitSeed: "V5", opinion: 0, stats: { dip: 5, mar: 5, ste: 5, int: 5, lrn: 5 }, traits: ["Content"], relations: ["Liege: player"], dynasty: "GenericDyn5", hidden: false },
                "vassal_gen_6": { id: "vassal_gen_6", name: "Generic Vassal 6", title: "Count", portraitSeed: "V6", opinion: 0, stats: { dip: 5, mar: 5, ste: 5, int: 5, lrn: 5 }, traits: ["Content"], relations: ["Liege: player"], dynasty: "GenericDyn6", hidden: false },
                "vassal_gen_7": { id: "vassal_gen_7", name: "Generic Vassal 7", title: "Baron", portraitSeed: "V7", opinion: 0, stats: { dip: 5, mar: 5, ste: 5, int: 5, lrn: 5 }, traits: ["Content"], relations: ["Liege: player"], dynasty: "GenericDyn7", hidden: false },
                "vassal_gen_8": { id: "vassal_gen_8", name: "Generic Vassal 8", title: "Count", portraitSeed: "V8", opinion: 0, stats: { dip: 5, mar: 5, ste: 5, int: 5, lrn: 5 }, traits: ["Content"], relations: ["Liege: player"], dynasty: "GenericDyn8", hidden: false },
                "vassal_gen_9": { id: "vassal_gen_9", name: "Generic Vassal 9", title: "Baron", portraitSeed: "V9", opinion: 0, stats: { dip: 5, mar: 5, ste: 5, int: 5, lrn: 5 }, traits: ["Content"], relations: ["Liege: player"], dynasty: "GenericDyn9", hidden: false },
                "vassal_gen_10": { id: "vassal_gen_10", name: "Generic Vassal 10", title: "Count", portraitSeed: "VA", opinion: 0, stats: { dip: 5, mar: 5, ste: 5, int: 5, lrn: 5 }, traits: ["Content"], relations: ["Liege: player"], dynasty: "GenericDyn10", hidden: false },
                "vassal_gen_11": { id: "vassal_gen_11", name: "Generic Vassal 11", title: "Baron", portraitSeed: "VB", opinion: 0, stats: { dip: 5, mar: 5, ste: 5, int: 5, lrn: 5 }, traits: ["Content"], relations: ["Liege: player"], dynasty: "GenericDyn11", hidden: false },
                "vassal_gen_12": { id: "vassal_gen_12", name: "Generic Vassal 12", title: "Count", portraitSeed: "VC", opinion: 0, stats: { dip: 5, mar: 5, ste: 5, int: 5, lrn: 5 }, traits: ["Content"], relations: ["Liege: player"], dynasty: "GenericDyn12", hidden: false },
                "peasant_leader": { id: "peasant_leader", name: "Wat Tyler", title: "Rebel Leader", portraitSeed: "WT", opinion: -100, stats: { dip: 3, mar: 6, ste: 2, int: 4, lrn: 1 }, traits: ["Wrathful", "Brave"], description: "Leader of the peasant revolt.", hidden: true }, // Hidden until revolt
                "merc_golden_company": { id: "merc_golden_company", name: "Myles Toyne", title: "Captain-General", portraitSeed: "MT", opinion: 0, stats: { dip: 6, mar: 9, ste: 7, int: 5, lrn: 6 }, traits: ["Brave", "Shrewd", "Greedy"], description: "Leader of the Golden Company.", hidden: false },
                "merc_stormcrows": { id: "merc_stormcrows", name: "Daario Naharis", title: "Captain", portraitSeed: "DN", opinion: 0, stats: { dip: 7, mar: 8, ste: 5, int: 7, lrn: 4 }, traits: ["Ambitious", "Deceitful", "Brave"], description: "Leader of the Stormcrows.", hidden: false },
                "merc_iron_legion": { id: "merc_iron_legion", name: "Gnaeus Varro", title: "Legate", portraitSeed: "GV", opinion: 0, stats: { dip: 5, mar: 8, ste: 8, int: 4, lrn: 5 }, traits: ["Diligent", "Just", "Brave"], description: "Commander of the Iron Legion.", hidden: false },
                "merc_whispering_blades": { id: "merc_whispering_blades", name: "Shadow Kestrel", title: "Mistress of Whispers", portraitSeed: "SK", opinion: 0, stats: { dip: 6, mar: 6, ste: 5, int: 9, lrn: 7 }, traits: ["Paranoid", "Deceitful", "Shrewd"], description: "Elusive leader of the Whispering Blades.", hidden: false },
            },
            factions: {}, // Populated by generateFactions()
            wars: {
                "rebellion_gautier": { id: "rebellion_gautier", name: "Gautier's Rebellion", type: "Vassal Rebellion", score: -15, attackers: ["gautier"], defenders: ["player"], goal: "Independence for Duke Gautier", active: true }
            },
            diplomacy: {
                "nordheim": { id: "nordheim", name: "Kingdom of Nordheim", type: "Kingdom", relationValue: -30, status: "Wary", atWar: false, alliance: false, stats: { military: 7, economy: 5, stability: 6 }, aiPersonality: 'Aggressive' },
                "silverpeaks": { id: "silverpeaks", name: "Silverpeaks Confederacy", type: "Confederacy", relationValue: 20, status: "Amicable", atWar: false, alliance: false, stats: { military: 5, economy: 8, stability: 7 }, aiPersonality: 'Cautious' },
                "sunken_isles": { id: "sunken_isles", name: "Pirates of the Sunken Isles", type: "Pirate Stronghold", relationValue: -70, status: "Hostile", atWar: false, alliance: false, stats: { military: 4, economy: 3, stability: 3 }, aiPersonality: 'Aggressive' },
                "merchant_republic_sarea": { id: "merchant_republic_sarea", name: "Merchant Republic of Sarea", type: "Republic", relationValue: 10, status: "Neutral", atWar: false, alliance: false, stats: { military: 3, economy: 9, stability: 8 }, aiPersonality: 'Opportunistic' },
                "khalasar_dothrak": { id: "khalasar_dothrak", name: "The Great Khalasar", type: "Nomadic Horde", relationValue: -50, status: "Hostile", atWar: false, alliance: false, stats: { military: 9, economy: 2, stability: 4 }, aiPersonality: 'Expansionist' },
            },
            mercenaries: {
                "golden_company": { id: "golden_company", name: "Golden Company", size: 5000, type: "infantry", costHire: 300, costMonth: 50, leaderId: "merc_golden_company", available: true, hired: false, availableAgainMonth: 0, unavailableReason: '' },
                "stormcrows": { id: "stormcrows", name: "Stormcrows", size: 3000, type: "cavalry", costHire: 200, costMonth: 40, leaderId: "merc_stormcrows", available: true, hired: false, availableAgainMonth: 0, unavailableReason: '' },
                "iron_legion": { id: "iron_legion", name: "Iron Legion", size: 6000, type: "infantry", costHire: 350, costMonth: 55, leaderId: "merc_iron_legion", available: false, hired: false, availableAgainMonth: 110, unavailableReason: 'Recruiting' },
                "whispering_blades": { id: "whispering_blades", name: "Whispering Blades", size: 1000, type: "archer", costHire: 400, costMonth: 60, leaderId: "merc_whispering_blades", available: true, hired: false, availableAgainMonth: 0, unavailableReason: '' },
            },
            laws: [
                { id: "law_succession_primo", name: "Primogeniture Succession", category: "Succession", description: "The eldest child inherits all titles.", effectsText: "Ensures realm stability but can lead to unhappy younger siblings.", requirements: {}, effects: {}, reqLevel: 0 },
                { id: "law_succession_confed", name: "Confederate Partition", category: "Succession", description: "Titles are divided among eligible children. New kingdoms may be formed if possible.", effectsText: "Keeps children happy but can fracture the realm.", requirements: {}, effects: {}, reqLevel: 0 },
                { id: "law_authority_low", name: "Low Crown Authority", category: "Crown", description: "Vassals have significant autonomy.", effectsText: "-10 Vassal Opinion, +1 Max Factions, Vassals can wage internal wars.", requirements: {}, effects: { vassalOpinion: -5, maxFactions: 1 }, reqLevel: 1 },
                { id: "law_authority_medium", name: "Medium Crown Authority", category: "Crown", description: "Ruler can revoke titles from vassals of different religion.", effectsText: "+0 Vassal Opinion, Ruler can retract vassals, Vassals cannot wage internal wars without hook.", requirements: { law_authority_level: 1 }, effects: { vassalOpinion: 0 }, reqLevel: 2 },
                { id: "law_authority_high", name: "High Crown Authority", category: "Crown", description: "Ruler can revoke titles from any vassal.", effectsText: "+10 Vassal Opinion, -1 Max Factions, Vassals cannot wage internal wars.", requirements: { law_authority_level: 2 }, effects: { vassalOpinion: 5, maxFactions: -1 }, reqLevel: 3 },
                { id: "law_obligation_low", name: "Low Vassal Obligations", category: "Obligation", description: "Vassals provide minimal levies and taxes.", effectsText: "+15 Vassal Opinion, -20% Levies, -10% Tax.", requirements: {}, effects: { vassalOpinion: 15, rulerLevyMod: -0.20, vassalTaxMod: -0.10 }, reqLevel: 0 },
                { id: "law_obligation_balanced", name: "Balanced Vassal Obligations", category: "Obligation", description: "Vassals provide standard levies and taxes.", effectsText: "+0 Vassal Opinion.", requirements: {}, effects: { vassalOpinion: 0 }, reqLevel: 0 },
                { id: "law_obligation_high", name: "High Vassal Obligations", category: "Obligation", description: "Vassals provide significant levies and taxes.", effectsText: "-15 Vassal Opinion, +20% Levies, +10% Tax.", requirements: {}, effects: { vassalOpinion: -15, rulerLevyMod: 0.20, vassalTaxMod: 0.10 }, reqLevel: 0 },
                { id: "law_coinage_standard", name: "Standard Coinage", category: "Economic", description: "Realm uses a standardized currency.", effectsText: "+5% Income, -5 Vassal Opinion (if decentralized).", requirements: {}, effects: { incomePercent: 0.05 }, reqLevel: 0 },
                { id: "law_coinage_debased", name: "Debased Coinage", category: "Economic", description: "Temporarily boost income by debasing currency.", effectsText: "+15% Income for 5 years, -10 Vassal Opinion, Risk of inflation event.", requirements: {}, effects: { incomePercent: 0.15 /* Temp */ }, reqLevel: 0 },
                { id: "law_council_ruler", name: "Ruler Appoints Council", category: "Council", description: "The ruler has sole authority to appoint council members.", effectsText: "Ensures loyal council but may anger powerful vassals.", requirements: {}, effects: {}, reqLevel: 0 },
                { id: "law_council_empowered", name: "Empowered Council", category: "Council", description: "Powerful vassals have a say in council appointments and realm decisions.", effectsText: "-10% Ruler Income, +10 Vassal Opinion, Council members get voting rights on certain actions.", requirements: {}, effects: { vassalOpinion: 10, incomePercent: -0.10 }, reqLevel: 0 },
                { id: "law_investiture_free", name: "Free Investiture", category: "Religious", description: "Ruler appoints religious leaders.", effectsText: "+5 Prestige/month, -10 Piety/month, -10 Religious Vassal Opinion.", requirements: {}, effects: { prestigePerMonth: 5, pietyPerMonth: -10 }, reqLevel: 0 },
                { id: "law_investiture_papal", name: "Papal Investiture", category: "Religious", description: "Religious head (e.g., Pope) appoints religious leaders.", effectsText: "+10 Piety/month, +10 Religious Vassal Opinion.", requirements: {}, effects: { pietyPerMonth: 10 }, reqLevel: 0 },
                { id: "law_religious_tolerant", name: "Religious Tolerance", category: "Religious", description: "All faiths are tolerated within the realm.", effectsText: "+10 Different Faith Opinion, -5% Tax from wrong faith provinces.", requirements: {}, effects: {}, reqLevel: 0 },
                { id: "law_religious_zealous", name: "Religious Zealotry", category: "Religious", description: "Only the state religion is permitted; others are persecuted.", effectsText: "-20 Different Faith Opinion, +10% Conversion Speed, +5% Same Faith Province Tax.", requirements: {}, effects: {}, reqLevel: 0 },
            ],
            vassals: ["borin", "emeric", "anais", "rhys", "gautier", "isolde_n", "gregor", "lyra", "finnian", "vassal_gen_1", "vassal_gen_2", "vassal_gen_3", "vassal_gen_4", "vassal_gen_5", "vassal_gen_6", "vassal_gen_7", "vassal_gen_8", "vassal_gen_9", "vassal_gen_10", "vassal_gen_11", "vassal_gen_12", "kael", "theron"]
        };


        // --- DOM Elements Cache ---
        const uiElements = {
            // Creator elements
             kingdomCreateModal: document.getElementById('kingdom-create-modal'),
             dynastyNameInput: document.getElementById('dynasty-name'),
             kingdomNameInput: document.getElementById('kingdom-name'),
             kingdomFocusOptionsContainer: document.getElementById('kingdom-focus-options'),
             confirmKingdomBtn: document.getElementById('confirm-kingdom-btn'),
             rulerCreateModal: document.getElementById('ruler-create-modal'),
             rulerNameInput: document.getElementById('ruler-name'),
             rulerEpithetInput: document.getElementById('ruler-epithet'),
             rulerStatsAllocator: document.getElementById('ruler-stats-allocator'),
             pointsRemainingDisplay: document.getElementById('points-remaining'),
             rulerTraitSelector: document.getElementById('ruler-trait-selector'),
             traitsToSelectDisplay: document.getElementById('traits-to-select'),
             confirmRulerBtn: document.getElementById('confirm-ruler-btn'),
             // Main UI
             gameUI: document.getElementById('game-ui'),
             gameTitle: document.getElementById('game-title'),
             gameDate: document.getElementById('game-date'),
             gameGold: document.getElementById('game-gold'),
             gamePrestige: document.getElementById('game-prestige'),
             gameManpower: document.getElementById('game-manpower'),
             gameIncome: document.getElementById('game-income'),
             gameDynastyPrestige: document.getElementById('game-dynasty-prestige'), // In header
             dynastyPrestigeDisplay: document.getElementById('dynasty-prestige-display'), // In header specific strong tag
             pauseButton: document.getElementById('pause-button'),
             gameSpeedSelect: document.getElementById('game-speed'),
             // Tabs & Content
             tabButtons: document.querySelectorAll('.tab-button'),
             tabContents: document.querySelectorAll('.tab-content'),
             newsFeedContainer: document.getElementById('news-feed'),
             // Politics
             peasantryApprovalDisplay: document.getElementById('peasantry-approval-value'),
             vassalList: document.getElementById('vassal-list'),
             vassalCount: document.getElementById('vassal-count'),
             factionList: document.getElementById('faction-list'),
             factionCount: document.getElementById('faction-count'),
             // Military
             militaryWarList: document.getElementById('military-war-list'),
             totalLevies: document.getElementById('total-levies'),
             retinuesSize: document.getElementById('retinues-size'),
             hiredMercsSize: document.getElementById('hired-mercs-size'),
             manpowerPool: document.getElementById('manpower-pool'),
             manpowerChange: document.getElementById('manpower-change'),
             raiseLeviesBtn: document.getElementById('raise-levies-btn'),
             disbandLeviesBtn: document.getElementById('disband-levies-btn'),
             reinforceRetinuesBtn: document.getElementById('reinforce-retinues-btn'),
             generalsList: document.getElementById('generals-list'),
             // Diplomacy
             relationsOverviewGrid: document.getElementById('relations-overview-grid'),
             alliancesList: document.getElementById('alliances-list'),
             trucesList: document.getElementById('truce-details'),
             enemiesList: document.getElementById('enemies-list'),
             neighborsList: document.getElementById('neighbors-list'),
             // Laws & Intrigue
             lawsContainer: document.getElementById('laws-container'),
             activePlotsList: document.getElementById('active-plots-list'),
             plotsAgainstYouList: document.getElementById('plots-against-you-list'),
             plotPowerDisplay: document.getElementById('plot-power'),
             plotDiscoveryChanceDisplay: document.getElementById('discovery-chance'),
             currentSchemeDisplay: document.getElementById('current-scheme'),
             schemeTimerDisplay: document.getElementById('scheme-timer'),
             // Dynasty & Mercs
             dynastyNameDisplay: document.getElementById('dynasty-name'), // In Dynasty Tab
             dynastyHead: document.getElementById('dynasty-head'),
             dynastyPrestige: document.getElementById('dynasty-prestige'), // In Dynasty Tab
             dynastyMembers: document.getElementById('dynasty-members'),
             dynastyCadets: document.getElementById('dynasty-cadets'),
             unlockLegacyBtn: document.getElementById('unlock-legacy-btn'),
             mercenaryList: document.getElementById('mercenary-list'),
             // Right Panel
             rulerPortraitContainer: document.getElementById('ruler-portrait-container'),
             rulerInitials: document.getElementById('ruler-initials'),
             rulerNameTitle: document.getElementById('ruler-name-title'),
             rulerStats: document.getElementById('ruler-stats'),
             rulerTraits: document.getElementById('ruler-traits'),
             councilCourtList: document.getElementById('council-court-list'),
             alertsContainer: document.getElementById('alerts').querySelector('.notification-area'),
             notificationsContainer: document.getElementById('notification-log'),
             triggerEventButton: document.getElementById('trigger-event-btn'),
             // Alerts
             rebellionAlert: document.getElementById('alert-rebellion'),
             factionDangerAlert: document.getElementById('alert-faction-danger'),
             lowGoldAlert: document.getElementById('alert-low-gold'),
             lowManpowerAlert: document.getElementById('alert-low-manpower'),
             losingWarAlert: document.getElementById('alert-war-losing'),
             plotDiscoveredAlert: document.getElementById('alert-plot-discovered'),
             // Modals
             eventModalOverlay: document.getElementById('event-modal-overlay'),
             eventTitle: document.getElementById('event-title'),
             eventDescription: document.getElementById('event-description'),
             eventOptionsContainer: document.getElementById('event-options'),
             eventPortrait: document.getElementById('event-portrait'),
             detailModalOverlay: document.getElementById('detail-modal-overlay'),
             detailTitle: document.getElementById('detail-title'),
             detailDescription: document.getElementById('detail-description'),
             detailPortrait: document.getElementById('detail-portrait'),
             detailSpecificContent: document.getElementById('detail-specific-content'),
             detailActions: document.getElementById('detail-actions'),
             battleModalOverlay: document.getElementById('battle-modal-overlay'),
             battleTitle: document.getElementById('battle-title'),
             battleCanvas: document.getElementById('battle-canvas'),
             battleEndTurnBtn: document.getElementById('battle-end-turn-btn'),
             battleLog: document.getElementById('battle-log'),
             battleOutcomeDisplay: document.getElementById('battle-outcome-display'),
             messageModalOverlay: document.getElementById('message-modal-overlay'),
             messageRecipientName: document.getElementById('message-recipient-name'),
             messageOptionsList: document.getElementById('message-options-list'),
        };

        let notificationIdCounter = 10;
        let plotIdCounter = 0;
        let battleUnitIdCounter = 0;
        let factionIdCounter = 0;
        let battleCtx = null; // Canvas context for battle

        // --- Utility Functions ---
        function showModal(modalKey) { if (uiElements[modalKey]) uiElements[modalKey].style.display = 'flex'; else console.error(`showModal Error: uiElements key "${modalKey}" not found.`); }
        function closeModal(modalKey) { if (uiElements[modalKey]) uiElements[modalKey].style.display = 'none'; else console.error(`closeModal Error: uiElements key "${modalKey}" not found.`); }
        function getOpinionClass(opinion) { if (opinion >= 25) return 'positive'; if (opinion > -25) return 'neutral'; return 'negative'; }
        function getPortraitBgColor(seed) { const hash = (seed || "XYZ").split('').reduce((acc, char) => char.charCodeAt(0) + ((acc << 5) - acc), 0); const index = Math.abs(hash) % 3; return `var(--portrait-bg-${index + 1})`; }
        function formatOpinion(opinion) { return opinion >= 0 ? `+${opinion}` : `${opinion}`; }
        function formatCost(costObj) { if (!costObj || Object.keys(costObj).length === 0) return ''; return Object.entries(costObj).map(([res, val]) => { const displayVal = Math.abs(val); let suffix = ''; if (res === 'gold') suffix = 'g'; else if (res === 'prestige') suffix = 'p'; else if (res === 'manpower') suffix = 'm'; else if (res === 'dynastyPrestige') suffix = 'dp'; else suffix = ` ${res}`; return `${val < 0 ? '-' : ''}${displayVal}${suffix}`; }).join(', '); }
        function getGlobalMonth() { return gameState.gameTime; }
        function getParticipantName(id, useTitle = false) {
            if (!id) return 'Unknown';
            if (id === 'player') return gameData.characters.player?.name || setupState.rulerName || 'You';
            if (id === 'peasant_leader') return 'Peasant Rebel Leader';
            const char = gameData.characters[id];
            if (char) return useTitle && char.title ? `${char.title} ${char.name}` : char.name;
            if (gameData.diplomacy[id]) return gameData.diplomacy[id].name;
            if (gameData.factions[id]) return gameData.factions[id].name;
            if (gameData.mercenaries[id]) return gameData.mercenaries[id].name;
            if (gameData.laws.find(l => l.id === id)) return gameData.laws.find(l => l.id === id).name;
            return id;
        }
        function getParticipantType(id) { if (gameData.characters[id]) return 'character'; if (gameData.diplomacy[id]) return 'diplomacy'; if (gameData.factions[id]) return 'faction'; if (gameData.mercenaries[id]) return 'mercenary'; if (gameData.laws.find(l => l.id === id)) return 'law'; return 'unknown'; }
        function getWarScoreClass(score) { if (score > 10) return 'winning'; if (score < -10) return 'losing'; return ''; }
        function createClickableSpan(type, id, text = null) { const name = text ?? getParticipantName(id); return `<span class="clickable" data-type="${type}" data-id="${id}">${name}</span>`; }
        function calculatePlotSuccessChance(plot) {
            let chance = 30 + gameState.plotPower; // Base
            const plotter = gameData.characters[plot.plotterId];
            const target = gameData.characters[plot.targetId];
            if (plotter) chance += plotter.stats.int * 2;
            if (target) chance -= target.stats.int * 1.5; // Target intrigue helps resist
            chance += plot.progress / 5; // Progress bonus
            // Trait modifiers
            if (plotter && plotter.traits.includes('Deceitful')) chance += 10;
            if (target && target.traits.includes('Paranoid')) chance -= 15;
            return Math.max(5, Math.min(95, Math.floor(chance)));
        }
        function calculatePlotDiscoveryChance(plot) {
            let chance = gameState.plotDiscoveryChance; // Base from ruler + scheme
            const target = gameData.characters[plot.targetId];
            const plotter = gameData.characters[plot.plotterId];
            if (target) chance += target.stats.int * 1.5; // Target intrigue helps discover
            if (plotter) chance -= plotter.stats.int; // Plotter intrigue helps hide
            chance += plot.progress / 10; // More progress, higher chance of leaks
            // Trait modifiers
            if (target && target.traits.includes('Paranoid')) chance += 15;
            if (plotter && plotter.traits.includes('Deceitful')) chance -= 10;
            if (plotter && plotter.traits.includes('Careless')) chance += 20; // Example new trait
            return Math.max(1, Math.min(50, Math.floor(chance))); // Harder to discover than succeed
        }
        function getSchemeColorVar(type) {
            if (!type) return 'var(--intrigue-color)';
            const typeClean = type.toLowerCase().replace(/[\s_]+/g, '-');
            switch (typeClean) {
                case 'murder': return 'var(--plot-murder)';
                case 'abduct': return 'var(--plot-abduct)';
                case 'fabricate-hook': return 'var(--plot-hook)';
                case 'discover-plots': return 'var(--scheme-discover)';
                case 'fabricate-claim': return 'var(--scheme-fabricate)';
                case 'build-spy-network': return 'var(--scheme-spy)';
                case 'disband-faction': return 'var(--scheme-disband)';
                case 'sway': return 'var(--scheme-sway)';
                default: return 'var(--intrigue-color)';
            }
        }
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            initializeSetupScreens();
        });

        // --- Setup Screen Logic ---
        function initializeSetupScreens() {
            populateKingdomFocusOptions();
            populateRulerStatAllocator();
            populateRulerTraitSelector();
            setupCreatorInteractions();
            showModal('kingdomCreateModal');
        }
        function populateKingdomFocusOptions() {
            const container = uiElements.kingdomFocusOptionsContainer;
            container.innerHTML = ''; // Clear existing options
            Object.entries(availableKingdomFocuses).forEach(([key, focus]) => {
                const optionDiv = document.createElement('div');
                optionDiv.classList.add('creator-option');
                optionDiv.dataset.focusKey = key;
                optionDiv.innerHTML = `
                    <h4>${focus.name}</h4>
                    <p>${focus.description}</p>
                    <span class="benefit">${Object.entries(focus.benefit || {}).map(([k, v]) => `${k.charAt(0).toUpperCase() + k.slice(1)}: ${v > 0 ? '+' : ''}${v}`).join(', ')}</span>
                `;
                optionDiv.addEventListener('click', () => {
                    selectCreatorOption(container, optionDiv, 'focus');
                    setupState.selectedFocus = focus; // Store the full focus object
                    checkKingdomConfirmButton();
                });
                container.appendChild(optionDiv);
            });
        }
        function selectCreatorOption(container, selectedElement, type) {
            const options = container.querySelectorAll('.creator-option');
            options.forEach(opt => opt.classList.remove('selected'));
            selectedElement.classList.add('selected');
            if (type === 'focus') setupState.selectedFocus = availableKingdomFocuses[selectedElement.dataset.focusKey];
            checkKingdomConfirmButton();
            checkRulerConfirmButton();
        }
        function checkKingdomConfirmButton() {
            const dynastyName = uiElements.dynastyNameInput.value.trim();
            const kingdomName = uiElements.kingdomNameInput.value.trim();
            uiElements.confirmKingdomBtn.disabled = !(dynastyName && kingdomName && setupState.selectedFocus);
        }
        function populateRulerStatAllocator() {
            const allocator = uiElements.rulerStatsAllocator;
            allocator.innerHTML = '';
            uiElements.pointsRemainingDisplay.textContent = RULER_STAT_POINTS - calculateSpentStatPoints();
            ['dip', 'mar', 'ste', 'int', 'lrn'].forEach(stat => {
                const group = document.createElement('div');
                group.classList.add('stat-allocation-group');
                group.innerHTML = `
                    <label>${stat.charAt(0).toUpperCase() + stat.slice(1)}:</label>
                    <button data-stat="${stat}" data-delta="-1">-</button>
                    <span class="stat-value" id="stat-value-${stat}">${setupState.rulerStats[stat]}</span>
                    <button data-stat="${stat}" data-delta="1">+</button>
                `;
                allocator.appendChild(group);
            });
            updateStatButtons();
        }
        function updateStatValue(stat, delta) {
            const currentPoints = calculateSpentStatPoints();
            const currentStatVal = setupState.rulerStats[stat];
            if (delta > 0 && currentPoints >= RULER_STAT_POINTS) return; // No points left
            if (delta < 0 && currentStatVal <= 0) return; // Cannot go below 0

            setupState.rulerStats[stat] += delta;
            setupState.rulerStats[stat] = Math.max(0, Math.min(15, setupState.rulerStats[stat])); // Clamp 0-15
            document.getElementById(`stat-value-${stat}`).textContent = setupState.rulerStats[stat];
            uiElements.pointsRemainingDisplay.textContent = RULER_STAT_POINTS - calculateSpentStatPoints();
            updateStatButtons();
            checkRulerConfirmButton();
        }
        function calculateSpentStatPoints() {
            return Object.values(setupState.rulerStats).reduce((sum, val) => sum + val, 0);
        }
        function updateStatButtons() {
            const pointsLeft = RULER_STAT_POINTS - calculateSpentStatPoints();
            document.querySelectorAll('#ruler-stats-allocator button').forEach(btn => {
                const delta = parseInt(btn.dataset.delta);
                const stat = btn.dataset.stat;
                if (delta > 0) btn.disabled = (pointsLeft <= 0 || setupState.rulerStats[stat] >= 15);
                if (delta < 0) btn.disabled = (setupState.rulerStats[stat] <= 0);
            });
        }
        function populateRulerTraitSelector() {
            const selector = uiElements.rulerTraitSelector;
            selector.innerHTML = '';
            uiElements.traitsToSelectDisplay.textContent = RULER_TRAITS_TO_PICK;
            availableRulerTraits.forEach(trait => {
                const optionDiv = document.createElement('div'); // Changed from label to div for better structure
                optionDiv.classList.add('trait-option');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `trait-${trait.id}`;
                checkbox.value = trait.id;
                checkbox.addEventListener('change', updateSelectedTraits);

                const label = document.createElement('label');
                label.htmlFor = `trait-${trait.id}`;
                label.textContent = trait.name;

                const effectSpan = document.createElement('span');
                effectSpan.classList.add('trait-effect');
                effectSpan.title = trait.description; // Tooltip for full description
                // Simplified effect hint
                let hint = '';
                if(trait.effects.stats) hint += Object.entries(trait.effects.stats).map(([s,v]) => `${s.toUpperCase()}${v > 0 ? '+' : ''}${v}`).join(', ');
                if(trait.effects.generalOpinion) hint += (hint ? ', ' : '') + `Op${trait.effects.generalOpinion > 0 ? '+' : ''}${trait.effects.generalOpinion}`;

                effectSpan.textContent = hint || trait.description.substring(0, 20) + (trait.description.length > 20 ? '...' : '');


                optionDiv.appendChild(checkbox);
                optionDiv.appendChild(label);
                optionDiv.appendChild(effectSpan);
                selector.appendChild(optionDiv);
            });
        }
        function updateSelectedTraits() {
            const selectedCheckboxes = document.querySelectorAll('#ruler-trait-selector input[type="checkbox"]:checked');
            setupState.rulerTraits = Array.from(selectedCheckboxes).map(cb => cb.value);

            const remainingToSelect = RULER_TRAITS_TO_PICK - setupState.rulerTraits.length;
            uiElements.traitsToSelectDisplay.textContent = remainingToSelect;

            document.querySelectorAll('#ruler-trait-selector input[type="checkbox"]').forEach(cb => {
                cb.disabled = (selectedCheckboxes.length >= RULER_TRAITS_TO_PICK && !cb.checked);
            });
            checkRulerConfirmButton();
        }
        function checkRulerConfirmButton() {
            const rulerName = uiElements.rulerNameInput.value.trim();
            const pointsSpent = calculateSpentStatPoints();
            uiElements.confirmRulerBtn.disabled = !(
                rulerName &&
                pointsSpent === RULER_STAT_POINTS &&
                setupState.rulerTraits.length === RULER_TRAITS_TO_PICK
            );
        }
        function setupCreatorInteractions() {
            uiElements.dynastyNameInput.addEventListener('input', checkKingdomConfirmButton);
            uiElements.kingdomNameInput.addEventListener('input', checkKingdomConfirmButton);
            uiElements.confirmKingdomBtn.addEventListener('click', () => {
                closeModal('kingdomCreateModal');
                showModal('rulerCreateModal');
            });

            uiElements.rulerNameInput.addEventListener('input', checkRulerConfirmButton);
            uiElements.rulerEpithetInput.addEventListener('input', checkRulerConfirmButton); // Epithet optional, but good practice
            uiElements.rulerStatsAllocator.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    updateStatValue(e.target.dataset.stat, parseInt(e.target.dataset.delta));
                }
            });
            uiElements.confirmRulerBtn.addEventListener('click', finalizeSetupAndStartGame);
        }
        function finalizeSetupAndStartGame() {
             console.log("Finalizing Setup...", setupState);
             setupState.setupComplete = true;

             // --- Apply Setup State to Game State ---
             gameState.dynastyId = setupState.dynastyName;
             gameState.dynastyPrestige = 0;
             gameState.prestige = 1000 + (setupState.selectedFocus?.benefit?.prestige || 0);
             gameState.gold = 500 + (setupState.selectedFocus?.benefit?.gold || 0);
             gameState.monthlyIncomeBase = 10 + (setupState.selectedFocus?.benefit?.income || 0);
             gameState.manpowerGainPerMonth = 150 + (setupState.selectedFocus?.benefit?.manpowerGain || 0);
             gameState.retinues = 500 + (setupState.selectedFocus?.benefit?.retinues || 0);
             gameState.plotPower = BASE_PLOT_POWER + (setupState.selectedFocus?.benefit?.plotPowerBonus || 0);
             gameState.plotDiscoveryChance = BASE_PLOT_DISCOVERY + (setupState.selectedFocus?.benefit?.plotDiscoveryBonus || 0);
             if(setupState.selectedFocus?.benefit?.relationBonus) { Object.keys(gameData.diplomacy).forEach(id => updateDiplomacyRelation(id, setupState.selectedFocus.benefit.relationBonus, "Initial Focus")); }

             // --- Create Player Character ---
             const playerStats = { ...setupState.rulerStats };
             let playerTraits = [...setupState.rulerTraits];
             let prestigePerMonthBonus = 0;

              playerTraits.forEach(traitId => {
                   const trait = availableRulerTraits.find(t => t.id === traitId);
                   if (!trait || !trait.effects) return;
                   if (trait.effects.stats) { Object.entries(trait.effects.stats).forEach(([stat, val]) => playerStats[stat] = (playerStats[stat] || 0) + val); }
                   if (trait.effects.incomePercent) gameState.monthlyIncomeModifiers += (gameState.monthlyIncomeBase * trait.effects.incomePercent);
                   if (trait.effects.plotPower) gameState.plotPower += trait.effects.plotPower;
                   if (trait.effects.plotDiscoveryBonus) gameState.plotDiscoveryChance += trait.effects.plotDiscoveryBonus;
                   if (trait.effects.prestigePerMonth) prestigePerMonthBonus += trait.effects.prestigePerMonth;
              });
              Object.keys(playerStats).forEach(stat => playerStats[stat] = Math.max(0, Math.min(15, playerStats[stat])));

             gameData.characters.player = {
                id: "player",
                name: setupState.rulerName,
                epithet: setupState.rulerEpithet,
                title: "King",
                portraitSeed: setupState.rulerName.substring(0,1).toUpperCase() + (setupState.rulerEpithet ? setupState.rulerEpithet.substring(0,1).toUpperCase() : (setupState.rulerName.length > 1 ? setupState.rulerName.substring(1,2).toUpperCase() : 'X')),
                opinion: null, // Player has no opinion of self
                stats: playerStats,
                traits: playerTraits,
                description: `Ruler of the Kingdom of ${setupState.kingdomName}.`,
                relations: [],
                history: [`Founded the Kingdom of ${setupState.kingdomName} in ${gameState.date.year}.`],
                dynasty: gameState.dynastyId,
                hidden: false,
                prestigePerMonthBonus: prestigePerMonthBonus,
                councilRole: "Ruler"
             };

             if (gameData.characters.elara) {
                gameData.characters.elara.relations = [`Spouse: player`, `Son: edgar`];
                gameData.characters.player.relations.push("Spouse: elara");
                gameData.characters.elara.dynasty = gameState.dynastyId;
             }
             if (gameData.characters.edgar) {
                gameData.characters.edgar.relations = [`Father: player`, `Mother: elara`];
                gameData.characters.player.relations.push("Son: edgar");
                gameData.characters.edgar.dynasty = gameState.dynastyId;
             }

              applyTraitOpinionModifiers();
              uiElements.gameTitle.textContent = setupState.kingdomName;
              generateFactions(TARGET_FACTION_COUNT);
              closeModal('rulerCreateModal');
              uiElements.gameUI.style.display = 'flex';
              setupMainGameUI();
              addInitialNews();
              console.log("Game Started with State:", structuredClone(gameState));
              console.log("Game Data:", structuredClone(gameData));
         }
         function applyTraitOpinionModifiers() {
            const playerTraits = gameData.characters.player.traits;

            playerTraits.forEach(traitId => {
                const trait = availableRulerTraits.find(t => t.id === traitId);
                if (!trait || !trait.effects) return;
                const generalOpinionEffect = trait.effects.generalOpinion || 0;
                const vassalOpinionEffect = trait.effects.vassalOpinion || 0;

                Object.keys(gameData.characters).forEach(charId => {
                    if (charId !== 'player' && gameData.characters[charId].opinion !== null) {
                        let totalChange = generalOpinionEffect;
                        if (gameData.vassals.includes(charId)) {
                            totalChange += vassalOpinionEffect;
                        }
                        if(totalChange !== 0) updateCharacterOpinion(charId, totalChange, `Ruler is ${trait.name}`);
                    }
                });
            });

            Object.entries(gameData.characters).forEach(([charId, char]) => {
                 if (charId !== 'player' && char.opinion !== null && char.traits) {
                     char.traits.forEach(traitId => {
                         const trait = availableRulerTraits.find(t => t.id === traitId);
                          if (!trait || !trait.effects) return;
                         const generalOpinionEffect = trait.effects.generalOpinion || 0;
                         const liegeOpinionEffect = trait.effects.liegeOpinion || 0;
                         if (generalOpinionEffect !== 0) updateCharacterOpinion(charId, generalOpinionEffect, `Character is ${trait.name}`);
                          if (liegeOpinionEffect !== 0 && (gameData.vassals.includes(charId) || char.relations.some(r => r.includes('Liege: player')))) {
                              updateCharacterOpinion(charId, liegeOpinionEffect, `Character is ${trait.name}`);
                         }
                    });
                 }
            });
         }
         function addInitialNews() {
            addNewsItem({
                 type: 'event',
                 title: 'Your Reign Begins!',
                 description: `You have founded the Kingdom of ${setupState.kingdomName} as ${gameData.characters.player.title} ${gameData.characters.player.name} of House ${gameState.dynastyId}. Manage your realm through the tabs above. Good luck!`,
                 persistent: false
            });
            addNewsItem({
                 type: 'info',
                 title: 'Game Paused',
                 description: `The game starts paused. Use the controls in the header to unpause and adjust speed.`,
                 persistent: false
            });
            if (gameData.wars['rebellion_gautier']?.active) {
                 addNewsItem({
                      type: 'warning',
                      title: 'Ongoing Rebellion',
                      description: `You inherit an ongoing conflict: ${createClickableSpan('war', 'rebellion_gautier', gameData.wars['rebellion_gautier'].name)}. Check the Military tab.`,
                      persistent: false
                 });
            }
         }

        // --- Main Game Setup ---
         function setupMainGameUI() {
            setupTabs();
            setupSliders();
            setupDismissals();
            setupClickHandlers();
            setupBattleCanvasInteraction();
            setupGameControls();
            applyInitialLawEffects();
            populateAllUI();
            updateResourceDisplay();
            uiElements.triggerEventButton.addEventListener('click', () => triggerRandomEvent(true));
            startGameloop();
         }

        // --- Setup Functions ---
        function setupTabs() {
            uiElements.tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    uiElements.tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    uiElements.tabContents.forEach(content => {
                        content.classList.toggle('active', content.id === `${targetTab}-content`);
                    });
                    // Re-populate relevant content if needed, or ensure dynamic updates handle it
                    populateAllUI(); // For simplicity, refresh all. Could be optimized.
                });
            });
        }
        function setupSliders() {
            document.querySelectorAll('.ideology-sliders input[type="range"]').forEach(slider => {
                const valueDisplay = document.getElementById(`${slider.id.replace('-slider', '-value')}`);
                if (valueDisplay) valueDisplay.textContent = slider.value; // Initial display
                slider.addEventListener('input', () => {
                    if (valueDisplay) valueDisplay.textContent = slider.value;
                    calculatePeasantryApproval();
                });
            });
        }
        function setupDismissals() {
            document.body.addEventListener('click', function(event) {
                if (event.target.classList.contains('dismiss-btn')) {
                    const targetId = event.target.dataset.target;
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        if (targetElement.classList.contains('news-item') && !targetElement.dataset.persistent) {
                             removeNewsItem(targetId);
                        } else if (targetElement.classList.contains('alert')) {
                             targetElement.style.display = 'none';
                        } else if (targetElement.classList.contains('notification')) {
                             targetElement.style.opacity = '0';
                             setTimeout(() => targetElement.remove(), 300);
                        }
                    }
                }
            });
        }
        function setupClickHandlers() { // General handler for dynamic elements
            document.body.addEventListener('click', function(event) {
                const target = event.target.closest('.clickable, .generic-action-btn, .view-battle-btn, .law-card, .relation-card h5');
                if (!target) return;

                if (target.classList.contains('clickable')) {
                    showDetailModal(target.dataset.type, target.dataset.id);
                } else if (target.classList.contains('law-card')) {
                    showDetailModal('law', target.dataset.lawId);
                } else if (target.tagName === 'H5' && target.closest('.relation-card')) {
                    showDetailModal('diplomacy', target.closest('.relation-card').dataset.realmId);
                } else if (target.classList.contains('generic-action-btn') || target.classList.contains('view-battle-btn')) {
                    const action = target.dataset.action;
                    const id = target.dataset.id;
                    const costData = JSON.parse(target.dataset.costData || '{}');

                    if (target.disabled) {
                        addNotification('warning', 'Action Unavailable', target.dataset.disabledReason || 'This action cannot be performed right now.');
                        return;
                    }
                    if (Object.keys(costData).length > 0 && !checkResourceCost(costData, true)) return; // Cost check logs error

                    // Apply cost if action proceeds (unless it's a "dummy" or view action)
                    let costApplied = false;
                    if (Object.keys(costData).length > 0 && !['dummy', 'view_battle', 'news_dismiss', 'event_option_click'].includes(action)) { // Don't apply cost for view/dummy/event option clicks here
                         applyResourceCost(costData);
                         costApplied = true;
                    }

                    // --- Handle actions ---
                    switch (action) {
                        // Politics/Vassal
                        case 'char_send_gift': updateCharacterOpinion(id, 15 + Math.floor(Math.random() * 15), "Sent Gift"); addNotification('success', 'Gift Sent', `Sent a gift to ${getParticipantName(id)}.`); break;
                        case 'char_send_message': showMessageModal('character', id); if(costApplied) refundCost(costData); break; // Refund as modal handles its own costs
                        case 'char_declare_rivalry': addRival('player', id); break;
                        case 'char_end_rivalry': removeRival('player', id); break;
                        case 'char_imprison': if(gameData.characters[id]){ gameData.characters[id].status = "Imprisoned"; updateCharacterOpinion(id, -50, "Imprisoned by Ruler"); addNotification('intrigue','Imprisoned!',`${getParticipantName(id)} is now in your dungeons.`); populateAllUI(); } break;
                        case 'char_ransom': if(gameData.characters[id]){ gameData.characters[id].status = undefined; updateCharacterOpinion(id, 10, "Ransomed"); updatePlayerResource('gold', 50 + (gameData.characters[id].stats?.ste || 0)*5); addNotification('success','Ransom Paid',`${getParticipantName(id)} released for gold.`); populateAllUI(); } break;
                        case 'char_release': if(gameData.characters[id]){ gameData.characters[id].status = undefined; updateCharacterOpinion(id, 25, "Released from Prison"); addNotification('info','Prisoner Released',`${getParticipantName(id)} has been freed.`); populateAllUI(); } break;
                        case 'char_execute': if(gameData.characters[id]){ gameData.characters[id].status = "Deceased (Executed)"; gameData.characters[id].hidden = true; addNotification('danger','Executed!',`${getParticipantName(id)} has been executed! This is seen as tyrannical.`); gameData.vassals.forEach(vId => updateCharacterOpinion(vId, -15, "Executed Prisoner")); populateAllUI(); } break;

                        // Military
                        case 'mil_raise_levies': gameState.leviesRaised = true; addNotification('info', 'Levies Raised', 'Your levies are gathering.'); break;
                        case 'mil_disband_levies': gameState.leviesRaised = false; addNotification('info', 'Levies Disbanded', 'Your levies have returned home.'); break;
                        case 'mil_reinforce_retinues': gameState.retinues += 100; addNotification('success', 'Retinues Reinforced', `Your retinues increased by 100 to ${gameState.retinues}.`); break;
                        case 'view_battle': /* Falls through to dummy if no specific battle modal implemented */
                        case 'battle_engage': initiateBattleSimulation(target.dataset.warId || id); if(costApplied) refundCost(costData); break;
                        case 'battle_end_turn': handleBattleEndTurn(); break;

                        // Mercenaries
                        case 'merc_hire':
                            if (gameData.mercenaries[id] && gameData.mercenaries[id].available && !gameData.mercenaries[id].hired) {
                                gameData.mercenaries[id].hired = true;
                                gameData.mercenaries[id].available = false; // Not immediately available again
                                gameState.hiredMercIds.push(id);
                                addNotification('success', 'Mercenaries Hired', `${gameData.mercenaries[id].name} are now in your service.`);
                            } else { addNotification('warning', 'Hire Failed', 'Could not hire mercenaries.'); if(costApplied) refundCost(costData); }
                            populateMercenaries();
                            break;
                        case 'merc_dismiss':
                            if (gameData.mercenaries[id] && gameData.mercenaries[id].hired) {
                                gameData.mercenaries[id].hired = false;
                                gameData.mercenaries[id].availableAgainMonth = getGlobalMonth() + 12; // Cooldown
                                gameData.mercenaries[id].unavailableReason = 'Recently Dismissed';
                                gameState.hiredMercIds = gameState.hiredMercIds.filter(mercId => mercId !== id);
                                addNotification('info', 'Mercenaries Dismissed', `${gameData.mercenaries[id].name} have left your service.`);
                            }
                            populateMercenaries();
                            break;

                        // Diplomacy
                        case 'diplo_send_gift': updateDiplomacyRelation(id, 10 + Math.floor(Math.random() * 10), "Received Gift"); addNotification('success', 'Gift Sent', `Sent a gift to ${getParticipantName(id)}.`); break;
                        case 'diplo_send_message': showMessageModal('diplomacy', id); if(costApplied) refundCost(costData); break;
                        case 'diplo_offer_alliance': handleOfferAlliance(id, false); break; // false = player offered
                        case 'diplo_break_alliance': if(gameData.diplomacy[id]) { gameData.diplomacy[id].alliance = false; updateDiplomacyRelation(id, -50, "Broke Alliance"); addNotification('warning','Alliance Broken',`Alliance with ${getParticipantName(id)} ended.`); populateDiplomacy(); } break;
                        case 'diplo_break_truce': if(gameState.activeTruces[id]) { delete gameState.activeTruces[id]; updateDiplomacyRelation(id, -75, "Broke Truce"); addNotification('danger','Truce Broken!',`You broke the truce with ${getParticipantName(id)}! (-150 Prestige)`); populateDiplomacy(); populateTrucesList(); } break;
                        case 'diplo_declare_war': handleDeclareWar(id, false); break;
                        case 'war_sue_for_peace': handleOfferPeace(id); break;
                        case 'war_call_ally': handleCallAlly(id, target.dataset.allyId); break;
                        case 'war_surrender': endWar(id, 'surrender', false); break;


                        // Laws & Edicts
                        case 'law_enact': handleEnactLaw(id); break;
                        case 'edict_taxes': handleEnactEdict('edict_taxes', 24, { approvalMod: -10, incomeMod: 5 }); break;
                        case 'edict_fortify': handleEnactEdict('edict_fortify', 36, { defenseMod: 0.10 }); break;
                        case 'edict_festivals': handleEnactEdict('edict_festivals', 12, { approvalMod: 5 }); break;

                        // Intrigue
                        case 'intrigue_start_plot':
                            if(!startPlot(target.dataset.plotType, id)) { if(costApplied) refundCost(costData); } // Refund if plot not started
                            break;
                        case 'intrigue_execute_plot':
                            const plot = gameState.activePlots.find(p => p.id === id);
                            if (plot) {
                                const successChance = calculatePlotSuccessChance(plot);
                                resolvePlot(id, Math.random() * 100 < successChance);
                                removeNewsItemByRelatedPlotId(id); // Remove the "ready to execute" news
                            }
                            break;
                        case 'intrigue_cancel_plot':
                            gameState.activePlots = gameState.activePlots.filter(p => p.id !== id);
                            addNotification('info','Plot Cancelled',`Cancelled plot ${id}.`);
                            removeNewsItemByRelatedPlotId(id);
                            populateIntrigue();
                            break;
                        case 'intrigue_advance_plots':
                             gameState.activePlots.forEach(p => {
                                 p.progress += 10 + (gameState.plotPower / 5);
                                 p.progress = Math.min(100, p.progress);
                                 // Check for discovery on manual advance too
                                 if (Math.random() * 100 < (calculatePlotDiscoveryChance(p) / 2)) discoverPlot(p);
                             });
                             addNotification('intrigue','Plots Advanced','Progress boosted for all active plots.');
                             populateIntrigue();
                             break;
                        case 'intrigue_expose_plot': handleDiscoveredPlot(id, 'expose'); break;
                        case 'intrigue_end_plot': handleDiscoveredPlot(id, 'end'); break;
                        case 'intrigue_start_scheme':
                        case 'intrigue_discover_plots': // Also a scheme
                        case 'intrigue_fabricate_claim':
                        case 'intrigue_build_spy_network':
                            const schemeType = target.dataset.schemeType || action.replace('intrigue_', ''); // Get type from data-attribute or action
                            const schemeTargetId = action === 'intrigue_discover_plots' ? 'player' : id; // Discover plots targets self by default
                            if(!startScheme(schemeType, schemeTargetId)) { if(costApplied) refundCost(costData); }
                            break;
                        case 'intrigue_resolve_scheme': // Called from news item
                            resolveScheme(id); // ID here is the scheme TYPE from the news item's targetId
                            removeNewsItemByRelatedSchemeType(id);
                            break;

                        // Dynasty
                        case 'dynasty_unlock_legacy': unlockDynastyLegacy(); break;

                        // News & Events
                        case 'news_dismiss': removeNewsItem(id); break;
                        case 'event_option_click': // Special handler for news items with embedded event options
                            const newsItemId = target.dataset.newsItemId || id; // id is targetId from news item action
                            const optionIndex = parseInt(target.dataset.optionIndex);
                            const newsItem = gameState.newsFeedItems.find(item => item.id === newsItemId);
                            if (newsItem && newsItem.actions && newsItem.actions[optionIndex] && typeof newsItem.actions[optionIndex].outcome === 'function') {
                                if (costApplied) { // Cost was already applied by generic handler, we need to apply specific cost for *this* option
                                    refundCost(costData); // Refund generic cost first
                                    const optionCost = newsItem.actions[optionIndex].cost || {};
                                    if (Object.keys(optionCost).length > 0 && !checkResourceCost(optionCost, true)) return; // Check specific cost
                                    applyResourceCost(optionCost); // Apply specific cost
                                }
                                newsItem.actions[optionIndex].outcome();
                                if (!newsItem.persistent) removeNewsItem(newsItemId); // Remove if not persistent
                            } else {
                                console.error("Could not find outcome for news event option:", newsItemId, optionIndex);
                                if(costApplied) refundCost(costData);
                            }
                            break;

                        // Dummy / Unimplemented
                        case 'dummy':
                        default:
                            console.warn(`Action "${action}" (ID: ${id}) not fully implemented or recognized.`);
                            addNotification('info', 'Action Incomplete', `Action '${action}' is a placeholder or not yet fully functional.`);
                            if (costApplied) refundCost(costData); // Refund if it was a true dummy
                            break;
                    }
                    updateResourceDisplay(); // Refresh resources after action
                    // Refresh relevant UI sections (can be more specific)
                    if (['char_send_gift', 'char_declare_rivalry', 'char_end_rivalry', 'law_enact', 'diplo_send_gift', 'diplo_offer_alliance', 'diplo_break_alliance', 'diplo_break_truce'].some(a => action.startsWith(a))) {
                        populateAllUI(); // Broad refresh for impactful actions
                        refreshDetailModalIfOpen(null, id); // Refresh modal if open and matches
                    }
                    updateActionButtonStates(); // Refresh button states globally
                }
            });
        }
        function setupBattleCanvasInteraction() {
            uiElements.battleCanvas.addEventListener('click', handleBattleCanvasClick);
        }
        function setupGameControls() {
            uiElements.pauseButton.addEventListener('click', togglePause);
            uiElements.gameSpeedSelect.addEventListener('change', changeGameSpeed);
            uiElements.pauseButton.textContent = gameState.gamePaused ? 'Resume' : 'Pause';
        }

        // --- Game Loop ---
        function startGameloop() {
             if (gameState.gameLoopInterval) clearInterval(gameState.gameLoopInterval);
             gameState.gameLoopInterval = setInterval(() => {
                if (!gameState.gamePaused) {
                    progressTime();
                }
             }, gameState.gameSpeedMs);
             console.log(`Game loop started with interval: ${gameState.gameSpeedMs}ms`);
        }
        function togglePause() {
             gameState.gamePaused = !gameState.gamePaused;
             uiElements.pauseButton.textContent = gameState.gamePaused ? 'Resume' : 'Pause';
             console.log(`Game ${gameState.gamePaused ? 'Paused' : 'Resumed'}`);
              if(!gameState.gamePaused && !gameState.gameLoopInterval) { startGameloop(); }
        }
        function changeGameSpeed() {
            gameState.gameSpeedMs = parseInt(uiElements.gameSpeedSelect.value, 10);
             console.log(`Game speed changed to: ${gameState.gameSpeedMs}ms`);
             if (gameState.gameLoopInterval) { startGameloop(); }
        }
        function progressTime(months = 1) {
             if (!setupState.setupComplete || gameState.gamePaused) return;

             for (let i = 0; i < months; i++) {
                  gameState.date.month++;
                  if (gameState.date.month >= MONTHS_PER_YEAR) {
                     gameState.date.month = 0;
                     gameState.date.year++;
                  }
                  gameState.gameTime++;

                  applyActiveLawMonthlyEffects(); // Calculates income/expense modifiers from laws/traits/levies

                  let netIncome = gameState.monthlyIncomeBase + gameState.monthlyIncomeModifiers;
                  let netExpenses = gameState.monthlyExpensesBase + gameState.monthlyExpensesModifiers;
                  let prestigeGain = (gameData.characters.player?.prestigePerMonthBonus || 0);
                   gameState.activeLaws.forEach(lawId => { // Add prestige from laws
                       const law = gameData.laws.find(l => l.id === lawId);
                       if(law?.effects?.prestigePerMonth) prestigeGain += law.effects.prestigePerMonth;
                   });

                  let manpowerGain = gameState.manpowerGainPerMonth;

                  updatePlayerResource('gold', netIncome - netExpenses, false);
                  updatePlayerResource('prestige', prestigeGain, false);
                  updatePlayerResource('manpower', manpowerGain, false);

                  updatePlotsAndSchemes();
                  updateFactionStrengths();
                  checkFactionUltimatums();
                  calculatePeasantryApproval(false); // false = don't trigger revolt check here, done in main loop

                  updateWarScoresPassive();
                  checkExpiredTruces();
                  checkExpiredEdicts();
                  checkMercenaryAvailability();
                  simulateBasicAI();

                  if (Math.random() < EVENT_CHANCE_PER_MONTH) { triggerRandomEvent(); }
                  checkLowApprovalConsequences();
             }
             updateResourceDisplay();
             populateAllUI();
             if (gameState.activeBattle && !gameState.activeBattle.playerTurn) { drawBattlefield(); }
         }
         function applyActiveLawMonthlyEffects() {
             gameState.monthlyIncomeModifiers = 0;
             gameState.monthlyExpensesModifiers = 0;
             let traitIncomePercentMod = 0;
             (gameData.characters.player?.traits || []).forEach(traitId => {
                 const trait = availableRulerTraits.find(t => t.id === traitId);
                 if(trait?.effects?.incomePercent) traitIncomePercentMod += trait.effects.incomePercent;
             });
              gameState.monthlyIncomeModifiers += gameState.monthlyIncomeBase * traitIncomePercentMod;

              gameState.activeLaws.forEach(lawId => {
                  const law = gameData.laws.find(l => l.id === lawId);
                  if (law && law.effects) {
                      if(law.effects.incomePercent) gameState.monthlyIncomeModifiers += gameState.monthlyIncomeBase * law.effects.incomePercent;
                  }
              });
              if (gameState.leviesRaised) {
                  gameState.monthlyExpensesModifiers += gameState.raisedLevyUpkeep;
              }
              gameState.hiredMercIds.forEach(mercId => {
                  const merc = gameData.mercenaries[mercId];
                  if(merc) gameState.monthlyExpensesModifiers += merc.costMonth;
              });
         }

        // --- Faction Generation ---
        function generateFactions(count) {
            gameData.factions = {}; // Clear existing
            factionIdCounter = 0;
            const potentialLeaders = gameData.vassals.filter(vId => gameData.characters[vId] && (gameData.characters[vId].traits.includes('Ambitious') || gameData.characters[vId].opinion < -10));
            const factionGoals = [
                "Lower Crown Authority", "Empowered Council", "Religious Zeal", "Reduce Taxes", "Install Claimant [NYI]", "Independence [NYI]"
            ];

            for (let i = 0; i < count; i++) {
                factionIdCounter++;
                const id = `faction_${factionIdCounter}`;
                let leaderId = getRandomElement(potentialLeaders.filter(lId => !Object.values(gameData.factions).some(f => f.leader === lId))) || getRandomElement(gameData.vassals);
                if (!leaderId && gameData.vassals.length > 0) leaderId = gameData.vassals[0]; // Fallback if no good leaders
                else if (!leaderId) continue; // No vassals to lead factions

                const leaderChar = gameData.characters[leaderId];
                const factionNameBase = leaderChar ? leaderChar.dynasty || leaderChar.name.split(' ')[0] : `Rebel${i+1}`;

                const newFaction = {
                    id: id,
                    name: `${factionNameBase}'s League`,
                    leader: leaderId,
                    goal: getRandomElement(factionGoals),
                    strength: Math.floor(Math.random() * 40) + 10, // Initial random strength 10-50
                    members: [leaderId], // Leader is always a member
                    ultimatumSent: false,
                    hidden: Math.random() > 0.7, // Some factions start hidden/minor
                    description: `A faction led by ${getParticipantName(leaderId)}.`
                };
                // Add a few more random members
                for(let j=0; j < Math.floor(Math.random()*3)+1; j++) {
                    const potentialMember = getRandomElement(gameData.vassals.filter(vId => vId !== leaderId && !newFaction.members.includes(vId) && gameData.characters[vId] && gameData.characters[vId].opinion < 20));
                    if(potentialMember) newFaction.members.push(potentialMember);
                }
                gameData.factions[id] = newFaction;
            }
            // Specific faction example if Prince Edgar exists
            if(gameData.characters.edgar && !gameData.characters.edgar.hidden) {
                factionIdCounter++;
                const edgarFactionId = `faction_${factionIdCounter}`;
                gameData.factions[edgarFactionId] = {
                    id: edgarFactionId, name: "Loyalists of Prince Edgar", leader: "edgar", goal: "Secure Prince Edgar's Inheritance", strength: 25, members: ["edgar"], ultimatumSent: false, hidden: false, description: "Supporters of the heir apparent."
                };
            }
        }


        // --- UI Population Functions ---
        function populateAllUI() {
            if (!setupState.setupComplete) return;
            populateRulerPanel();
            populateVassalList();
            populateFactionList();
            populateWarLists();
            populateGeneralsList();
            populateDiplomacy();
            populateMercenaries();
            populateLaws();
            populateIntrigue();
            populateDynastyTab();
            populateTrucesList();
            updateResourceDisplay();
            populateNewsFeed();
        }
        function populateRulerPanel() {
            const player = gameData.characters.player;
            if (!player) return;
            uiElements.rulerInitials.textContent = player.portraitSeed;
            uiElements.rulerPortraitContainer.style.backgroundColor = getPortraitBgColor(player.portraitSeed);
            uiElements.rulerNameTitle.innerHTML = createClickableSpan('character', 'player', `${player.title} ${player.name} '${player.epithet}'`);
            uiElements.rulerStats.textContent = `Dip: ${player.stats.dip} | Mar: ${player.stats.mar} | Ste: ${player.stats.ste} | Intr: ${player.stats.int} | Lrn: ${player.stats.lrn}`;
            uiElements.rulerTraits.textContent = `Traits: ${player.traits.join(', ') || 'None'}`;

            // Populate Council & Court (Simplified)
            const councilList = uiElements.councilCourtList;
            councilList.innerHTML = '';
            const councilRoles = ["Spouse", "Heir", "Chancellor", "Marshal", "Steward", "Spymaster", "Chaplain"];
            councilRoles.forEach(role => {
                let holderId = null;
                // Find character explicitly assigned this role via relations
                const assigned = Object.entries(gameData.characters).find(([id, char]) => !char.hidden && char.relations && char.relations.some(r => r.trim() === `Council Position: ${role}`));
                if(assigned) holderId = assigned[0];

                // Fallback for Spouse/Heir if not explicitly council but in relations
                if (!holderId && role === "Spouse") {
                    const spouseRel = player.relations.find(r => r.startsWith("Spouse:"));
                    if (spouseRel) holderId = spouseRel.split(":")[1]?.trim();
                }
                if (!holderId && role === "Heir") {
                    const heirRel = player.relations.find(r => r.startsWith("Son:") || r.startsWith("Daughter:") || r.startsWith("Heir:"));
                     if (heirRel) holderId = heirRel.split(":")[1]?.trim();
                }


                const li = document.createElement('li');
                if (holderId && gameData.characters[holderId] && !gameData.characters[holderId].hidden) {
                    const holder = gameData.characters[holderId];
                    li.innerHTML = `<strong>${role}:</strong> ${createClickableSpan('character', holderId, holder.name)} (Op: ${formatOpinion(holder.opinion || 0)})`;
                } else {
                    li.innerHTML = `<strong>${role}:</strong> <span style="color:var(--text-muted);"><i>Vacant</i></span>`;
                }
                councilList.appendChild(li);
            });
        }
        function populateVassalList() {
            const list = uiElements.vassalList;
            list.innerHTML = '';
            let count = 0;
            gameData.vassals.forEach(id => {
                const vassal = gameData.characters[id];
                if (vassal && !vassal.hidden) {
                    count++;
                    const item = document.createElement('div');
                    item.classList.add('list-item');
                    item.innerHTML = `
                        <strong class="clickable" data-type="character" data-id="${id}">${vassal.title} ${vassal.name}</strong>
                        <div>
                             <span class="faction-details">${vassal.traits.slice(0,2).join(', ')}</span>
                             <span class="opinion ${getOpinionClass(vassal.opinion)}">${formatOpinion(vassal.opinion)}</span>
                        </div>
                    `;
                    list.appendChild(item);
                }
            });
            uiElements.vassalCount.textContent = count;
            if (count === 0) list.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">You have no direct vassals.</p>';
        }
        function populateFactionList() {
            const list = uiElements.factionList;
            list.innerHTML = '';
            let count = 0;
            Object.values(gameData.factions).forEach(faction => {
                if (!faction.hidden) {
                    count++;
                    const leader = gameData.characters[faction.leader];
                    const item = document.createElement('div');
                    item.classList.add('list-item');
                    let ultimatumClass = faction.ultimatumSent ? 'style="color:var(--danger-color); font-weight:bold;"' : '';
                    item.innerHTML = `
                        <div class="faction-info">
                            <strong class="clickable" data-type="faction" data-id="${faction.id}">${faction.name}</strong> <span ${ultimatumClass}>${faction.ultimatumSent ? '(Ultimatum!)' : ''}</span><br>
                            <span class="faction-details">Leader: ${leader ? createClickableSpan('character', faction.leader) : getParticipantName(faction.leader)} | Goal: ${faction.goal.length > 30 ? faction.goal.substring(0,27)+'...' : faction.goal}</span>
                        </div>
                        <span class="faction-details strength">Strength: ${faction.strength.toFixed(1)}%</span>
                    `;
                    list.appendChild(item);
                }
            });
            uiElements.factionCount.textContent = count;
            if (count === 0) list.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No active factions in your realm.</p>';
        }
        function populateWarLists() {
            const warList = uiElements.militaryWarList;
            warList.innerHTML = '';
            let activeWarCount = 0;
            Object.values(gameData.wars).forEach(war => {
                if (war.active) {
                    activeWarCount++;
                    const item = document.createElement('div');
                    item.classList.add('list-item');
                    const isPlayerAttacker = war.attackers.includes('player');
                    const playerScore = isPlayerAttacker ? war.score : -war.score; // Score from player's perspective
                    const attackers = war.attackers.map(id => createClickableSpan(getParticipantType(id), id)).join(', ');
                    const defenders = war.defenders.map(id => createClickableSpan(getParticipantType(id), id)).join(', ');

                    item.innerHTML = `
                        <div class="war-info">
                            <strong class="clickable" data-type="war" data-id="${war.id}">${war.name}</strong>
                            <span class="war-score ${getWarScoreClass(playerScore)}">${playerScore.toFixed(1)}%</span>
                        </div>
                        <p class="war-participants"><strong>Goal:</strong> ${war.goal}</p>
                        <p class="war-participants"><strong>Att:</strong> ${attackers} vs <strong>Def:</strong> ${defenders}</p>
                        <div><button class="view-battle-btn" data-action="battle_engage" data-war-id="${war.id}">Engage Battle</button></div>
                    `;
                    warList.appendChild(item);
                }
            });
            if (activeWarCount === 0) warList.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">Your realm is at peace.</p>';
        }
        function populateGeneralsList() {
            const list = uiElements.generalsList;
            list.innerHTML = '';
            // Find characters with high martial who are not leading armies yet (simplified)
            const potentialGenerals = Object.values(gameData.characters)
                .filter(c => !c.hidden && c.stats.mar >= 7 && (gameData.vassals.includes(c.id) || c.id === 'player' || c.relations?.some(r=>r.includes("Council Position: Marshal"))))
                .sort((a, b) => b.stats.mar - a.stats.mar)
                .slice(0, 5); // Show top 5

            if (potentialGenerals.length > 0) {
                potentialGenerals.forEach(gen => {
                    const item = document.createElement('div');
                    item.classList.add('list-item');
                    item.innerHTML = `
                        <strong class="clickable" data-type="character" data-id="${gen.id}">${getParticipantName(gen.id, true)}</strong>
                        <span>Martial: ${gen.stats.mar} | Traits: ${gen.traits.slice(0,2).join(', ')}</span>
                        <button class="generic-action-btn" data-action="dummy" data-id="${gen.id}" disabled>Assign (NYI)</button>
                    `;
                    list.appendChild(item);
                });
            } else {
                list.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No notable generals available.</p>';
            }
        }
        function populateDiplomacy() {
            const overviewGrid = uiElements.relationsOverviewGrid;
            const alliancesList = uiElements.alliancesList;
            const enemiesList = uiElements.enemiesList;
            const neighborsList = uiElements.neighborsList;

            overviewGrid.innerHTML = ''; alliancesList.innerHTML = ''; enemiesList.innerHTML = ''; neighborsList.innerHTML = '';
            let allianceCount = 0, enemyCount = 0, neighborCount = 0;

            Object.entries(gameData.diplomacy).forEach(([id, realm]) => {
                neighborCount++;
                // Overview Card
                const card = document.createElement('div');
                card.classList.add('relation-card');
                card.dataset.realmId = id; // For clickable H5
                card.innerHTML = `
                    <h5 class="clickable" data-type="diplomacy" data-id="${id}">${realm.name}</h5>
                    <p>${realm.type}</p>
                    <p><span class="opinion ${getOpinionClass(realm.relationValue)}">${formatOpinion(realm.relationValue)}</span> (${realm.status})</p>
                    ${realm.atWar ? '<p style="color:var(--danger-color);">At War!</p>' : ''}
                    ${realm.alliance ? '<p style="color:var(--success-color);">Ally</p>' : ''}
                    ${gameState.activeTruces[id] > getGlobalMonth() ? '<p style="color:var(--info-color);">Truce</p>' : ''}
                `;
                overviewGrid.appendChild(card);

                // Lists
                const listItem = document.createElement('div');
                listItem.classList.add('list-item');
                listItem.innerHTML = `
                    <strong class="clickable" data-type="diplomacy" data-id="${id}">${realm.name}</strong>
                    <span>${realm.type} | Rel: <span class="opinion ${getOpinionClass(realm.relationValue)}">${formatOpinion(realm.relationValue)}</span></span>
                `;

                if (realm.alliance) { alliancesList.appendChild(listItem.cloneNode(true)); allianceCount++; }
                if (realm.relationValue < -50 || realm.atWar) { enemiesList.appendChild(listItem.cloneNode(true)); enemyCount++; }
                neighborsList.appendChild(listItem);
            });
             // Add player's rivals to enemies list
             (gameData.characters.player?.relations || []).filter(r => r.startsWith("Rival:")).forEach(rivalRel => {
                const rivalId = rivalRel.split(":")[1]?.trim();
                const rivalChar = gameData.characters[rivalId];
                if (rivalChar && !rivalChar.hidden) {
                    enemyCount++;
                    const rivalItem = document.createElement('div');
                    rivalItem.classList.add('list-item');
                    rivalItem.innerHTML = `
                        <strong class="clickable" data-type="character" data-id="${rivalId}">${getParticipantName(rivalId, true)} (Rival)</strong>
                        <span>Opinion: <span class="opinion ${getOpinionClass(rivalChar.opinion)}">${formatOpinion(rivalChar.opinion)}</span></span>
                    `;
                    enemiesList.appendChild(rivalItem);
                }
             });


            if (allianceCount === 0) alliancesList.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No active alliances.</p>';
            if (enemyCount === 0) enemiesList.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No declared enemies or rivals.</p>';
            if (neighborCount === 0) {overviewGrid.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No known realms.</p>'; neighborsList.innerHTML = overviewGrid.innerHTML;}
        }
        function populateMercenaries() {
             const list = uiElements.mercenaryList;
             list.innerHTML = '';
             const currentMonth = getGlobalMonth();
             Object.entries(gameData.mercenaries).forEach(([id, merc]) => {
                const item = document.createElement('div');
                item.classList.add('list-item');
                const leaderExists = !!gameData.characters[merc.leaderId];
                let availabilityHTML = '';
                 const isAvailable = merc.available && currentMonth >= merc.availableAgainMonth && !merc.hired;

                if (merc.hired) {
                     availabilityHTML = `<button class="generic-action-btn danger-action" data-action="merc_dismiss" data-id="${id}">Dismiss (${merc.costMonth}g/m)</button>`;
                } else if (isAvailable) {
                    availabilityHTML = `<button class="generic-action-btn hire-mercenary-btn cost" data-action="merc_hire" data-id="${id}" data-cost-data='{"gold": ${merc.costHire}}'>Hire</button>`;
                } else {
                     const availableInMonths = merc.availableAgainMonth - currentMonth;
                     const availableDate = new Date(gameState.date.year, gameState.date.month + availableInMonths);
                     availabilityHTML = `<span style="color: var(--text-muted); font-size: 0.8em;">Unavailable (${merc.unavailableReason || 'On Cooldown'} - Until ${availableDate.getFullYear()}/${(availableDate.getMonth() + 1).toString().padStart(2, '0')})</span>`;
                }

                item.innerHTML = `
                    <div class="mercenary-details">
                        <strong>${merc.name}</strong> ${merc.hired ? '<strong style="color:var(--success-color)">(Hired)</strong>' : ''}<br>
                         <span>Size: <strong>${merc.size}</strong></span>
                         <span>Type: <strong>${merc.type.charAt(0).toUpperCase() + merc.type.slice(1)}</strong></span>
                         <span>Upkeep: <strong>${merc.costMonth}g/m</strong></span>
                         <span>Hire: <strong>${merc.costHire}g</strong></span>
                         <span>Leader: ${leaderExists ? createClickableSpan('character', merc.leaderId) : getParticipantName(merc.leaderId)}</span>
                    </div>
                    <div class="mercenary-actions" style="margin-left: auto;">
                        ${availabilityHTML}
                    </div>
                `;
                list.appendChild(item);
             });
              if(list.children.length === 0) list.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No mercenary companies available.</p>';
              updateActionButtonStates(list);
        }
        function populateLaws() {
            const container = uiElements.lawsContainer;
            container.innerHTML = '';
            gameData.laws.forEach(law => {
                const card = document.createElement('div');
                card.classList.add('law-card');
                card.dataset.lawId = law.id; // For click handler
                const isActive = gameState.activeLaws.includes(law.id);
                const requirementsCheck = checkLawRequirements(law.id);

                card.innerHTML = `
                    <h4 class="clickable" data-type="law" data-id="${law.id}">${law.name}</h4>
                    <p>${law.description}</p>
                    <div class="effects">Effects: ${law.effectsText || 'Varies.'}</div>
                    ${!isActive ? `<div class="requirements">Req: ${getLawRequirementsText(law.id) || 'None'}</div>` : ''}
                    <div class="status ${isActive ? 'active' : 'inactive'}">${isActive ? 'Active' : (requirementsCheck.met ? 'Can Enact' : 'Cannot Enact')}</div>
                    ${!isActive ? `<button class="generic-action-btn cost" data-action="law_enact" data-id="${law.id}" data-cost-data='{"prestige":150}' ${!requirementsCheck.met ? 'disabled' : ''} data-disabled-reason="${requirementsCheck.met ? '' : requirementsCheck.reason}">Enact</button>` : ''}
                `;
                container.appendChild(card);
            });
            updateActionButtonStates(container);
        }
        function populateIntrigue() {
             calculatePlotPower(); // Recalculate before display
             uiElements.plotPowerDisplay.textContent = gameState.plotPower;
             uiElements.plotDiscoveryChanceDisplay.textContent = `${gameState.plotDiscoveryChance.toFixed(0)}%`;

             if(gameState.currentScheme) {
                  const scheme = gameState.currentScheme;
                  const targetName = getParticipantName(scheme.targetId);
                   const schemeProgress = Math.min(100, Math.max(0, ((getGlobalMonth() - scheme.startTime) / scheme.duration) * 100));
                   const monthsRemaining = Math.max(0, scheme.duration - (getGlobalMonth() - scheme.startTime));
                   const completionDate = new Date(gameState.date.year, gameState.date.month + monthsRemaining);

                  uiElements.currentSchemeDisplay.innerHTML = `${scheme.type.replace(/_/g, ' ')} vs ${createClickableSpan(getParticipantType(scheme.targetId), scheme.targetId)}`;
                  uiElements.schemeTimerDisplay.textContent = `(${schemeProgress.toFixed(0)}% - ${monthsRemaining}m left, finishes ${completionDate.getFullYear()}/${(completionDate.getMonth() + 1).toString().padStart(2,'0')})`;

                   const schemeProgressHTML = `
                       <div class="plot-progress" style="margin-top: 5px;">
                           <div class="plot-progress-bar type-${scheme.type.toLowerCase().replace(/[\s_]+/g, '-')}" style="width: ${schemeProgress}%; background-color: ${getSchemeColorVar(scheme.type)};"></div>
                       </div>`;
                   const oldBar = uiElements.currentSchemeDisplay.parentElement.querySelector('.plot-progress');
                   if(oldBar) oldBar.remove();
                   uiElements.schemeTimerDisplay.insertAdjacentHTML('afterend', schemeProgressHTML);
             } else {
                 uiElements.currentSchemeDisplay.textContent = 'None';
                 uiElements.schemeTimerDisplay.textContent = '';
                 const oldBar = uiElements.currentSchemeDisplay.parentElement?.querySelector('.plot-progress');
                 if(oldBar) oldBar.remove();
             }

             const activeList = uiElements.activePlotsList;
             activeList.innerHTML = '';
             if (gameState.activePlots.length > 0) {
                 gameState.activePlots.forEach(plot => {
                     const item = document.createElement('div');
                     item.classList.add('list-item', 'plot-list-item');
                     const currentDiscoveryChance = calculatePlotDiscoveryChance(plot);
                     const currentSuccessChance = calculatePlotSuccessChance(plot);
                      const plotProgress = Math.min(100, Math.max(0, plot.progress));
                     item.innerHTML = `
                         <div>
                             <strong>Plot: ${plot.type.replace(/_/g, ' ')}</strong> vs ${createClickableSpan(getParticipantType(plot.targetId), plot.targetId)}
                             <div class="plot-details">
                                 <div class="plot-progress">
                                     <div class="plot-progress-bar type-${plot.type.toLowerCase().replace(/[\s_]+/g, '-')}" style="width: ${plotProgress}%; background-color: ${getSchemeColorVar(plot.type)};"></div>
                                 </div>
                                 <div class="plot-chances">
                                      <span>Progress: ${plotProgress.toFixed(0)}%</span>
                                      <span>Discovery%: ${currentDiscoveryChance}%</span>
                                      <span>Success%: ${currentSuccessChance}%</span>
                                 </div>
                             </div>
                         </div>
                         <div>
                             <button class="generic-action-btn intrigue-action" data-action="intrigue_execute_plot" data-id="${plot.id}" style="font-size: 0.75em; padding: 2px 5px;" ${plotProgress < 100 ? 'disabled' : ''} title="Execute plot (Needs 100%)">Execute!</button>
                             <button class="generic-action-btn danger-action" data-action="intrigue_cancel_plot" data-id="${plot.id}" style="font-size: 0.75em; padding: 2px 5px;">Cancel</button>
                         </div>
                     `;
                     activeList.appendChild(item);
                 });
             } else {
                 activeList.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">You have no active plots.</p>';
             }

              const againstList = uiElements.plotsAgainstYouList;
              againstList.innerHTML = '';
               const discovered = gameState.discoveredPlots.filter(p => !p.handled);
              if (discovered.length > 0) {
                  discovered.forEach(plot => {
                      const item = document.createElement('div');
                      item.classList.add('list-item', 'plot-list-item');
                      const plotterName = plot.plotterId ? createClickableSpan(getParticipantType(plot.plotterId), plot.plotterId) : 'Unknown';
                      item.innerHTML = `
                          <div>
                              <strong>Discovered Plot: ${plot.type.replace(/_/g, ' ')}</strong>
                              <div class="plot-details">
                                 Target: ${createClickableSpan(getParticipantType(plot.targetId), plot.targetId)} | Plotter: ${plotterName}
                              </div>
                          </div>
                          <div>
                              <button class="generic-action-btn intrigue-action" data-action="intrigue_expose_plot" data-id="${plot.id}" style="font-size: 0.75em; padding: 2px 5px;">Expose</button>
                              <button class="generic-action-btn danger-action" data-action="intrigue_end_plot" data-id="${plot.id}" style="font-size: 0.75em; padding: 2px 5px;">End Plot</button>
                          </div>
                      `;
                      againstList.appendChild(item);
                  });
              } else {
                  againstList.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No known plots targeting you or your family.</p>';
              }
              updateActionButtonStates(document.getElementById('intrigue-content'));
        }
        function populateDynastyTab() {
             const dynastyName = gameState.dynastyId || "Unknown Dynasty";
             const player = gameData.characters.player;
             if (!player) return;

             uiElements.dynastyNameDisplay.textContent = `House ${dynastyName}`;
             uiElements.dynastyHead.innerHTML = createClickableSpan('character', 'player');
             uiElements.dynastyPrestige.textContent = gameState.dynastyPrestige;
             uiElements.dynastyMembers.textContent = Object.values(gameData.characters).filter(c => c.dynasty === gameState.dynastyId && !c.hidden).length;
             uiElements.dynastyCadets.textContent = gameState.dynastyCadets;
             uiElements.unlockLegacyBtn.disabled = gameState.dynastyUnlockedLegacies.includes('base_prestige');
              document.querySelectorAll('#dynasty-content .unimplemented-feature').forEach(el => {
                   if (!el.textContent.includes('(N/A)')) el.remove();
              });
             updateActionButtonStates(document.getElementById('dynasty-content'));
         }
        function populateTrucesList() {
             const list = uiElements.trucesList;
             list.innerHTML = '';
             let count = 0;
             const currentMonth = getGlobalMonth();
             Object.entries(gameState.activeTruces).forEach(([targetId, expiryMonth]) => {
                if (expiryMonth > currentMonth) {
                    count++;
                    const item = document.createElement('div');
                    item.classList.add('list-item');
                    const expiryDate = new Date(gameState.date.year, gameState.date.month + (expiryMonth - currentMonth));
                    item.innerHTML = `
                        <span>With: ${createClickableSpan(getParticipantType(targetId), targetId)}</span>
                        <span style="color: var(--info-color);">Expires: ${expiryDate.getFullYear()}/${(expiryDate.getMonth() + 1).toString().padStart(2,'0')}</span>
                    `;
                    list.appendChild(item);
                }
             });
             if (count === 0) list.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No active truces.</p>';
        }

        // --- News Feed System ---
        function addNewsItem(itemData) {
             if (itemData.persistent && gameState.newsFeedItems.some(item => item.id === itemData.id)) {
                 console.log(`Skipping duplicate persistent news item: ${itemData.id}`);
                 return;
             }
            gameState.newsIdCounter++;
            const newItem = {
                id: `news-${itemData.id || gameState.newsIdCounter}`,
                timestamp: getGlobalMonth(),
                persistent: false,
                ...itemData
            };
            gameState.newsFeedItems.push(newItem);
            populateNewsFeed();
         }
        function removeNewsItem(itemId) {
             gameState.newsFeedItems = gameState.newsFeedItems.filter(item => item.id !== itemId);
             const itemElement = document.getElementById(itemId);
             if (itemElement) {
                 itemElement.style.opacity = '0';
                 setTimeout(() => {
                    itemElement.remove();
                    if (uiElements.newsFeedContainer.children.length === 0) {
                         uiElements.newsFeedContainer.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No current news or developments.</p>';
                     }
                 }, 300);
             } else if (gameState.newsFeedItems.length === 0 && uiElements.newsFeedContainer.children.length === 0) {
                       uiElements.newsFeedContainer.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No current news or developments.</p>';
             }
         }
        function removeNewsItemByRelatedPlotId(plotId) { // Helper to remove plot-related news
             const newsItem = gameState.newsFeedItems.find(item => item.relatedPlotId === plotId);
             if (newsItem) removeNewsItem(newsItem.id);
         }
        function removeNewsItemByRelatedSchemeType(schemeType) { // Helper
             const newsItem = gameState.newsFeedItems.find(item => item.relatedSchemeType === schemeType && item.type === 'completed');
             if (newsItem) removeNewsItem(newsItem.id);
         }
        function populateNewsFeed() {
             const container = uiElements.newsFeedContainer;
             container.innerHTML = '';
             if (gameState.newsFeedItems.length === 0) {
                 container.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No current news or developments.</p>';
                 return;
             }
             gameState.newsFeedItems.sort((a, b) => b.timestamp - a.timestamp);
             gameState.newsFeedItems.forEach(item => {
                 const itemDiv = document.createElement('div');
                 itemDiv.classList.add('news-item', `type-${item.type || 'info'}`);
                 itemDiv.id = item.id;
                 if (item.persistent) itemDiv.dataset.persistent = 'true';

                 let actionsHTML = '<div class="news-actions">';
                 if (item.actions && item.actions.length > 0) {
                     item.actions.forEach((action, index) => {
                          const button = createActionButtonElement(
                              action.text,
                              action.action,
                              action.targetId || item.id,
                              action.cost || {},
                              action.classes || '',
                              action.disabled || false,
                              action.disabledReason || ''
                          );
                          if(action.dataset) Object.entries(action.dataset).forEach(([key, value]) => button.dataset[key] = value);
                          if(action.action === 'event_option_click') { // Special handling for event options in news
                              button.dataset.optionIndex = index;
                              button.dataset.newsItemId = item.id;
                          }
                          if(action.hint) button.title = action.hint;
                         actionsHTML += button.outerHTML;
                     });
                 }
                  if (!item.persistent && !item.actions?.some(a => a.action === 'news_dismiss')) {
                       actionsHTML += `<button class="generic-action-btn" data-action="news_dismiss" data-id="${item.id}" style="margin-left: auto; background-color: var(--text-muted); color: var(--bg-color);" title="Dismiss this notification">Dismiss</button>`;
                  }
                  actionsHTML += '</div>';

                 itemDiv.innerHTML = `
                     <h4>${item.title}</h4>
                     <p>${item.description}</p>
                     ${actionsHTML}
                 `;
                 container.appendChild(itemDiv);
             });
             updateActionButtonStates(container);
         }

         // --- Loop-Driven Updates ---
         function updatePlotsAndSchemes() {
              const currentMonth = getGlobalMonth();
              let plotDiscoveredThisTick = false;

              gameState.activePlots.forEach(plot => {
                   const target = gameData.characters[plot.targetId];
                   let progressIncrease = PLOT_PROGRESS_PER_MONTH + (gameState.plotPower / 10);
                   if (target) progressIncrease -= Math.max(0, (target.stats.int - 5) / 5);
                   progressIncrease = Math.max(0.5, progressIncrease);
                   plot.progress = Math.min(100, plot.progress + progressIncrease);

                   plot.discoveryChance = calculatePlotDiscoveryChance(plot);
                   plot.successChance = calculatePlotSuccessChance(plot);

                   if (Math.random() * 100 < (plot.discoveryChance / 8)) { // Discovery check in loop (lower chance than manual boost)
                        discoverPlot(plot);
                        plotDiscoveredThisTick = true;
                        gameState.activePlots = gameState.activePlots.filter(p => p.id !== plot.id); // Remove discovered plot
                        return;
                   }
                    if (plot.progress >= 100 && !gameState.newsFeedItems.some(n => n.relatedPlotId === plot.id)) {
                        const successChance = calculatePlotSuccessChance(plot);
                         addNewsItem({
                             type: 'completed', title: `Plot Ready: ${plot.type.replace(/_/g,' ')}`,
                             description: `Your plot to ${plot.type.replace(/_/g,' ')} ${getParticipantName(plot.targetId)} is ready! Success: ${successChance}%`,
                             relatedPlotId: plot.id,
                             actions: [
                                 { text: 'Execute Plot!', action: 'intrigue_execute_plot', targetId: plot.id, classes: 'intrigue-action' },
                                 { text: 'Wait', action: 'news_dismiss' }
                             ]
                         });
                    }
              });

              if (gameState.currentScheme) {
                   const scheme = gameState.currentScheme;
                   const timeProgress = ((currentMonth - scheme.startTime) / scheme.duration) * 100;
                   scheme.progress = Math.min(100, Math.max(scheme.progress, timeProgress)); // Progress based on time elapsed

                   if (scheme.progress >= 100 && !gameState.newsFeedItems.some(n => n.relatedSchemeType === scheme.type && n.type === 'completed')) {
                       addNewsItem({
                            type: 'completed', title: `Scheme Finished: ${scheme.type.replace(/_/g,' ')}`,
                            description: `Your scheme to ${scheme.type.replace(/_/g,' ')} ${getParticipantName(scheme.targetId)} has concluded.`,
                            relatedSchemeType: scheme.type,
                            actions: [ { text: 'See Results', action: 'intrigue_resolve_scheme', targetId: scheme.type } ]
                       });
                   }
              }
              if (uiElements.tabContents[5].classList.contains('active') || plotDiscoveredThisTick) { populateIntrigue(); }
         }
         function updateFactionStrengths() {
              Object.values(gameData.factions).forEach(faction => {
                   if (faction.hidden) return;
                    let strength = 0; let totalRealmPower = 1;
                    gameData.vassals.forEach(vId => { const v = gameData.characters[vId]; if (v && !v.hidden && v.opinion !== null) totalRealmPower += Math.max(1, (v.stats?.mar || 3)); });
                     totalRealmPower += Math.max(1, gameData.characters.player.stats.mar);
                    faction.members.forEach(memberId => {
                        const member = gameData.characters[memberId];
                        if (member && !member.hidden && member.opinion !== null) {
                            let memberPower = Math.max(1, (member.stats?.mar || 3));
                             memberPower *= (1 + Math.max(-0.5, -member.opinion / 100));
                             if (memberId === faction.leader) memberPower *= 1.5;
                             if (member.traits.includes('Ambitious')) memberPower *= 1.2;
                             if (member.traits.includes('Loyal')) memberPower *= 0.8;
                             strength += memberPower;
                        }
                    });
                    let targetStrength = Math.max(0, Math.min(150, Math.floor((strength / totalRealmPower) * 100)));
                     if (faction.id === 'populist_faction_placeholder') targetStrength = Math.max(10, Math.min(150, 70 + (50 - gameState.currentPeasantApproval)));
                    faction.strength += (targetStrength - faction.strength) * 0.1;
                    faction.strength = Math.round(faction.strength * 10) / 10;
              });
              checkAlerts();
              if (uiElements.tabContents[1].classList.contains('active')) populateFactionList();
         }
         function checkFactionUltimatums() {
              Object.entries(gameData.factions).forEach(([id, faction]) => {
                  if (!faction.hidden && !faction.ultimatumSent && faction.strength >= FACTION_ULTIMATUM_THRESHOLD) {
                        if (Math.random() < FACTION_ULTIMATUM_CHANCE_PER_MONTH) { sendFactionUltimatum(id); }
                  }
              });
         }
         function sendFactionUltimatum(id) {
             const faction = gameData.factions[id];
             if (!faction || faction.ultimatumSent || faction.hidden) return;
             faction.ultimatumSent = true;
              const eventId = `faction_ultimatum_${id.replace(/\W/g, '_')}`;
              addNewsItem({
                  id: eventId, type: 'warning', title: `Ultimatum: ${faction.name}`,
                  description: `The ${createClickableSpan('faction', id, faction.name)}, led by ${createClickableSpan('character', faction.leader)}, demands you meet their goal: "${faction.goal}". Refusal means war!`,
                  persistent: true, relatedFactionId: id,
                   actions: [
                        { text: "Accept demands", action: 'event_option_click', outcome: () => acceptFactionDemands(id), hint: "(-150 Prestige, Avoids war, Goal met)"},
                        { text: "Refuse! To arms!", action: 'event_option_click', outcome: () => refuseFactionDemands(id), hint: "(Starts civil war!)", classes: "danger-action" },
                        { text: `Attempt Imprison ${getParticipantName(faction.leader)}`, action: 'event_option_click', cost: { prestige: 50 }, outcome: () => attemptImprisonFactionLeader(id), hint: "(Risky Intrigue check)", classes: "intrigue-action" }
                   ]
             });
              addNotification('danger', 'Faction Ultimatum!', `${faction.name} has issued an ultimatum! Check News.`);
              if (uiElements.tabContents[1].classList.contains('active')) populateFactionList();
              checkAlerts(); refreshDetailModalIfOpen('faction', id);
         }
        function updateWarScoresPassive() {
            Object.values(gameData.wars).forEach(war => {
                if (war.active) { updateWarScore(war.id, (Math.random() - 0.45) * 1); }
            });
            if (uiElements.tabContents[2].classList.contains('active')) { populateWarLists(); }
        }
         function checkExpiredTruces() {
              const currentMonth = getGlobalMonth(); let changed = false;
              Object.keys(gameState.activeTruces).forEach(targetId => {
                 if (gameState.activeTruces[targetId] <= currentMonth) {
                    delete gameState.activeTruces[targetId];
                    addNotification('info', 'Truce Expired', `Truce with ${getParticipantName(targetId)} expired.`);
                    changed = true;
                 }
              });
               if (changed) { populateTrucesList(); populateDiplomacy(); refreshDetailModalIfOpen('diplomacy'); }
          }
         function checkExpiredEdicts() {
              const currentMonth = getGlobalMonth(); let changed = false;
               Object.keys(gameState.activeEdicts).forEach(edictId => {
                   if (gameState.activeEdicts[edictId] <= currentMonth) {
                       delete gameState.activeEdicts[edictId];
                       addNotification('info', 'Edict Expired', `${edictId.replace('edict_','')} edict expired.`);
                       changed = true; calculatePeasantryApproval();
                   }
               });
              if(changed) { updateActionButtonStates(document.getElementById('laws-content')); }
         }
         function checkMercenaryAvailability() {
            const currentMonth = getGlobalMonth(); let changed = false;
             Object.values(gameData.mercenaries).forEach(merc => {
                 if (!merc.available && currentMonth >= merc.availableAgainMonth) {
                     merc.available = true; merc.unavailableReason = '';
                     addNotification('success', 'Mercs Available', `${merc.name} ready for hire.`);
                     changed = true;
                 }
             });
              if (changed && uiElements.tabContents[7].classList.contains('active')) { populateMercenaries(); }
         }
         function simulateBasicAI() {
               Object.entries(gameData.diplomacy).forEach(([id, realm]) => {
                  if (realm.relationValue < -75 && !realm.atWar && !gameState.activeTruces[id]) {
                        if (realm.aiPersonality === 'Aggressive' && Math.random() < 0.01) {
                            if (checkResourceCost({ prestige: -100 }, false)) { handleDeclareWar(id, true); addNotification('danger', 'War!', `${realm.name} declared war!`); }
                       } else if (realm.aiPersonality === 'Expansionist' && Math.random() < 0.005) {
                           if (checkResourceCost({ prestige: -100 }, false)) { handleDeclareWar(id, true); addNotification('danger', 'War!', `${realm.name} declared war!`); }
                       }
                  } else if (realm.relationValue > 50 && realm.aiPersonality === 'Cautious' && !realm.alliance && Math.random() < 0.02) {
                      addNewsItem({
                            id: `alliance_offer_${id}`, type: 'opportunity', title: `Alliance Offer: ${realm.name}`,
                            description: `${realm.name} (${realm.status}) proposes an alliance.`, persistent: true,
                            actions: [
                                { text: `Accept (+50 Prestige)`, action: 'event_option_click', outcome: () => { handleOfferAlliance(id, true); }, cost: {prestige: -50} },
                                { text: `Decline (-10 Rel)`, action: 'event_option_click', outcome: () => { updateDiplomacyRelation(id, -10, 'Declined Alliance'); addNotification('info','Alliance Declined',`Declined alliance from ${realm.name}.`); removeNewsItem(`alliance_offer_${id}`); } }
                            ]
                      });
                  }
                   updateDiplomacyRelation(id, (Math.random() - 0.5) * 0.5, 'Relations drifted');
               });
              gameData.vassals.forEach(vassalId => {
                  if (gameData.characters[vassalId] && gameData.characters[vassalId].opinion !== null) {
                        let drift = (Math.random() - 0.5) * 0.5 + (gameData.characters.player.stats.dip - 7) * 0.05;
                       updateCharacterOpinion(vassalId, drift, 'Opinion drifted');
                  }
              });
         }
         function checkLowApprovalConsequences() {
              if (gameState.currentPeasantApproval < REBELLION_THRESHOLD) {
                  if (Math.random() < REBELLION_EVENT_CHANCE_LOW_APPROVAL) {
                       if (!gameData.wars['peasant_revolt']?.active && !gameState.newsFeedItems.some(n=> n.id === 'revolt_event')) {
                          triggerRebellionEvent();
                       }
                  }
              }
         }

        // --- Event System ---
        const randomEvents = [ /* Same as before, ensure getCouncilMemberId is defined if used */
             {
                id: "good_harvest", title: "Bountiful Harvest",
                description: "The gods have smiled upon us! This year's harvest is exceptionally plentiful.",
                trigger: () => Math.random() < 0.1,
                options: [
                    { text: "Excellent news!", hint: "(+150 Gold, +5 Peasant Approval)", outcome: () => { updatePlayerResource('gold', 150); calculatePeasantryApproval(false, 5); } },
                    { text: "Lower taxes for a year.", hint: "(-5% Income Mod, +10 Peasant Approval)", outcome: () => { handleEnactEdict('edict_tax_relief', 12, { incomeModPercent: -0.05, approvalMod: 10}); } }
                ]
            },
            {
                id: "border_skirmish", title: "Border Skirmish",
                description: () => {
                     const hostileNeighbors = Object.entries(gameData.diplomacy) .filter(([id, realm]) => realm.relationValue < -20 && !realm.atWar) .map(([id, realm]) => id);
                     if (hostileNeighbors.length === 0) return null;
                    const neighborId = getRandomElement(hostileNeighbors);
                     return `Raiders from ${createClickableSpan('diplomacy', neighborId)} have attacked a border village!`; },
                 trigger: () => Object.values(gameData.diplomacy).some(realm => realm.relationValue < -20 && !realm.atWar) && Math.random() < 0.1,
                 condition: () => Object.values(gameData.diplomacy).some(realm => realm.relationValue < -20 && !realm.atWar),
                options: [
                     { text: "Send reinforcements.", hint: "(-250 Manpower, -5 Relation)", outcome: (eventData) => { updatePlayerResource('manpower', -250); const nId = eventData.description.match(/data-id="([^"]+)"/)[1]; if(nId) updateDiplomacyRelation(nId, -5, "Retaliated raid");} },
                    { text: "Strengthen defenses.", hint: "(-75 Gold)", outcome: () => { updatePlayerResource('gold', -75); } },
                    { text: "Demand reparations.", hint: "(Risky)", outcome: (eventData) => { addNotification('info','Demand Sent','Diplomatic demand sent (NYI)'); const nId = eventData.description.match(/data-id="([^"]+)"/)[1]; if(nId) updateDiplomacyRelation(nId, -10, "Demanded reparations"); } }
                ]
            },
             {
                 id: "merchant_caravan", title: "Rich Merchant Caravan",
                 description: "A wealthy merchant caravan seeks permission to trade in your capital.",
                 trigger: () => Math.random() < 0.08,
                 options: [
                     { text: "Grant permission and tax them.", hint: "(+75 Gold, +1 Income/m for 12m)", outcome: () => { updatePlayerResource('gold', 75); handleEnactEdict('edict_merchant_trade', 12, { incomeMod: 1 }); } },
                     { text: "Refuse entry.", hint: "(-5 Prestige)", outcome: () => updatePlayerResource('prestige', -5) },
                     { text: "Seize their goods! (Tyranny)", hint: "(-20 Vassal Op, +200 Gold)", outcome: () => { updatePlayerResource('gold', 200); gameData.vassals.forEach(vId => updateCharacterOpinion(vId, -20, "Seized merchant goods")); addNotification('warning','Tyranny!','Seizing goods angers vassals!'); } }
                 ]
             },
              {
                  id: "courtier_scandal", title: "Courtier Scandal",
                  description: () => {
                       const courtiers = Object.entries(gameData.characters).filter(([id, c]) => !c.hidden && !gameData.vassals.includes(id) && c.opinion !== null && id !== 'player' && !c.councilRole && !c.relations?.some(r => r.startsWith('Spouse') || r.startsWith('Heir')));
                       if (courtiers.length === 0) return null;
                       const [courtierId, courtier] = getRandomElement(courtiers);
                       return `Whispers fill the court regarding ${createClickableSpan('character', courtierId)}. How do you respond?`;
                  },
                  trigger: () => Object.keys(gameData.characters).some(id => !gameData.vassals.includes(id) && gameData.characters[id].opinion !== null && id !== 'player' && !gameData.characters[id].councilRole) && Math.random() < 0.07,
                  condition: () => Object.keys(gameData.characters).some(id => !gameData.vassals.includes(id) && gameData.characters[id].opinion !== null && id !== 'player' && !gameData.characters[id].councilRole),
                  options: [
                       { text: "Ignore rumors.", hint: "(-5 Prestige)", outcome: () => updatePlayerResource('prestige', -5) },
                       { text: "Publicly rebuke them.", hint: `(-15 Opinion with courtier)`, outcome: (eventData) => { const cId = eventData.description.match(/data-id="([^"]+)"/)[1]; if(cId) updateCharacterOpinion(cId, -15, "Publicly rebuked"); addNotification('info','Scandal Addressed', 'Rebuked courtier.');} },
                       { text: "Gain leverage (Intrigue).", hint: "(Attempt Hook - NYI)", outcome: (eventData) => { const cId = eventData.description.match(/data-id="([^"]+)"/)[1]; if(cId) addNotification('intrigue','Leverage Attempted',`Attempt hook on ${getParticipantName(cId)} (NYI)`); } }
                   ]
             },
            {
                id: "rebellion_event", title: "The Peasants Revolt!",
                description: "Driven to desperation, the peasantry has risen up in open rebellion!",
                trigger: () => false, // Called specifically
                options: [
                    { text: "Crush them!", hint: "(Starts Peasant Revolt War)", outcome: () => { startPeasantRevoltWar(); } },
                    { text: "Offer concessions.", hint: "(-100 Prestige, +15 Approval, Revolt ends)", outcome: () => { updatePlayerResource('prestige', -100); calculatePeasantryApproval(false, 15); if(gameData.factions.rebel_peasant) gameData.factions.rebel_peasant.hidden = true; addNotification('success', 'Revolt Averted', 'Concessions pacified peasantry.'); } }
                ]
            },
             {
                id: "kaels_ambition", title: "A Duke's Ambition",
                description: () => `Duke ${createClickableSpan('character', 'kael')} requests a seat on your council.`,
                trigger: () => gameData.characters['kael'] && !gameData.characters['kael'].hidden && !gameData.characters['kael'].councilRole && Math.random() < 0.05,
                 condition: () => gameData.characters['kael'] && !gameData.characters['kael'].hidden && !gameData.characters['kael'].councilRole,
                 portraitCharId: 'kael',
                options: [
                    { text: "Grant him Chancellor.", hint: `(-10 Op with current, +20 Op Kael)`, outcome: () => { const currentChancellorId = getCouncilMemberId('Chancellor'); if(currentChancellorId) updateCharacterOpinion(currentChancellorId, -10, 'Replaced'); updateCharacterOpinion('kael', 20, 'Appointed Chancellor'); assignCouncilPosition('kael', 'Chancellor'); } },
                    { text: "Politely refuse.", hint: `(-15 Op Kael)`, outcome: () => { updateCharacterOpinion('kael', -15, 'Refused council'); } },
                    { text: "Accuse him of overreach!", hint: `(-30 Op Kael, +5 Prestige)`, outcome: () => { updateCharacterOpinion('kael', -30, 'Accused of overreach'); updatePlayerResource('prestige', 5); } },
                ]
             },
        ];
        function triggerRandomEvent(manual = false) {
             if(!manual && gameState.gamePaused) return;
             const possibleEvents = randomEvents.filter(event => (event.trigger && event.trigger()) && (!event.condition || event.condition()) && event.id !== 'rebellion_event');
             if (possibleEvents.length > 0) {
                 const selectedEvent = getRandomElement(possibleEvents);
                 displayEvent(selectedEvent);
                 if (!manual) { gameState.gamePaused = true; uiElements.pauseButton.textContent = 'Resume'; }
             } else if (manual) { addNotification('info', 'No Event', 'No random event occurred.'); }
        }
         function displayEvent(eventData) {
              let finalDescription = (typeof eventData.description === 'function') ? eventData.description() : eventData.description;
               if (finalDescription === null) { console.log(`Event ${eventData.id} condition fail.`); return; }
              eventData.resolvedDescription = finalDescription; // Store for outcome

              uiElements.eventTitle.textContent = eventData.title;
              uiElements.eventDescription.innerHTML = finalDescription;
              uiElements.eventOptionsContainer.innerHTML = '';

               const portraitCharId = eventData.portraitCharId || finalDescription.match(/data-type="character" data-id="([^"]+)"/)?.[1];
              if(portraitCharId && gameData.characters[portraitCharId]) {
                   const char = gameData.characters[portraitCharId];
                   uiElements.eventPortrait.style.display = 'flex';
                   uiElements.eventPortrait.querySelector('.placeholder-initials').textContent = char.portraitSeed;
                   uiElements.eventPortrait.style.backgroundColor = getPortraitBgColor(char.portraitSeed);
               } else { uiElements.eventPortrait.style.display = 'none'; }

              eventData.options.forEach((option, index) => {
                  const button = document.createElement('button');
                   button.innerHTML = `${option.text} ${option.hint ? `<span class="outcome-hint">${option.hint}</span>` : ''}`;
                  if (option.cost && !checkResourceCost(option.cost)) {
                      button.disabled = true;
                       button.innerHTML += ` <span style='color: var(--danger-color); font-size: 0.8em;'>(${formatCost(option.cost)} - Too Costly)</span>`;
                  } else if (option.cost) {
                       button.innerHTML += ` <span style='color: var(--accent-color); font-size: 0.8em;'>(${formatCost(option.cost)})</span>`;
                  }
                  button.onclick = () => {
                      if (option.cost && !checkResourceCost(option.cost, true)) return; // Re-check and log if cannot afford
                      if (option.cost) applyResourceCost(option.cost);
                       option.outcome({ description: eventData.resolvedDescription }); // Pass resolved data
                      closeModal('eventModalOverlay');
                      updateResourceDisplay(); populateAllUI();
                  };
                  uiElements.eventOptionsContainer.appendChild(button);
              });
              showModal('eventModalOverlay');
         }
         function triggerRebellionEvent() {
             const event = randomEvents.find(e => e.id === 'rebellion_event');
             if (event) { displayEvent(event); gameState.gamePaused = true; uiElements.pauseButton.textContent = 'Resume'; }
         }
        function startPeasantRevoltWar() {
             const revoltWarId = 'peasant_revolt';
             if (!gameData.wars[revoltWarId]) { gameData.wars[revoltWarId] = { id: "peasant_revolt", name: "Peasant Revolt", type: "Rebellion", score: 0, attackers: ["rebel_peasant"], defenders: ["player"], goal: "Lower Taxes", active: false }; }
             if (!gameData.factions.rebel_peasant) { gameData.factions['rebel_peasant'] = { id: "rebel_peasant", name: "Peasant Rebellion", leader: "peasant_leader", goal: "Lower Taxes", strength: 0, members: ["peasant_leader"], hidden: true }; }
             gameData.wars[revoltWarId].active = true; gameData.wars[revoltWarId].score = 0;
             gameData.factions.rebel_peasant.hidden = false; gameData.factions.rebel_peasant.strength = 100 + Math.random() * 50;
             addNotification('danger', 'Rebellion!', 'Peasants have taken up arms! Check Military tab.');
             populateWarLists(); populateFactionList();
         }
         function getCouncilMemberId(role) {
             const member = Object.values(gameData.characters).find(c => !c.hidden && c.relations?.some(r => r.trim() === `Council Position: ${role}`));
             return member ? member.id : null;
         }
         function assignCouncilPosition(charId, role) {
             const currentHolderId = getCouncilMemberId(role);
             if (currentHolderId && gameData.characters[currentHolderId]) {
                 gameData.characters[currentHolderId].relations = gameData.characters[currentHolderId].relations.filter(r => r.trim() !== `Council Position: ${role}`);
                 gameData.characters[currentHolderId].councilRole = null;
                  addNotification('info', 'Council Change', `${getParticipantName(currentHolderId)} no longer ${role}.`);
             }
              if (gameData.characters[charId]) {
                   gameData.characters[charId].relations = (gameData.characters[charId].relations || []).filter(r => !r.startsWith('Council Position:'));
                   gameData.characters[charId].relations.push(`Council Position: ${role}`);
                   gameData.characters[charId].councilRole = role;
                    addNotification('success', 'Council Appointed', `${getParticipantName(charId)} is now ${role}.`);
              }
              populateRulerPanel();
         }

        // --- Law Implementation ---
        function applyInitialLawEffects() { gameState.activeLaws.forEach(lawId => applyLawEffects(lawId, true, false)); updateResourceDisplay(); }
        function getLawRequirementsText(lawId) {
             const law = gameData.laws.find(l => l.id === lawId); if (!law || !law.requirements || Object.keys(law.requirements).length === 0) return 'None';
             let reqText = [];
              if (law.requirements.prestige) reqText.push(`${law.requirements.prestige} P`);
              if (law.requirements.gold) reqText.push(`${law.requirements.gold} G`);
              if (law.requirements.law_authority_level) {
                   const activeAuthLaw = gameData.laws.find(l => l.category === 'Crown' && gameState.activeLaws.includes(l.id));
                   const currentLevel = activeAuthLaw ? activeAuthLaw.reqLevel : 0;
                  reqText.push(`Authority Lvl ${law.requirements.law_authority_level} (Cur: ${currentLevel})`);
              }
               if (law.requirements.prerequisite_law) {
                  const prereq = gameData.laws.find(l=>l.id === law.requirements.prerequisite_law);
                   reqText.push(`Req: ${prereq ? prereq.name : law.requirements.prerequisite_law} (${gameState.activeLaws.includes(law.requirements.prerequisite_law) ? 'Act' : 'Inact'})`);
               }
             return reqText.join(', ') || 'None';
         }
        function checkLawRequirements(lawId) {
            const law = gameData.laws.find(l => l.id === lawId); if (!law) return { met: false, reason: 'Law not found.' };
            const req = law.requirements || {}; let reasons = [];
             if (req.prestige && gameState.prestige < req.prestige) reasons.push(`Needs ${req.prestige} Prestige`);
             if (req.gold && gameState.gold < req.gold) reasons.push(`Needs ${req.gold} Gold`);
             if (req.law_authority_level) {
                 const activeAuthLaw = gameData.laws.find(l => l.category === 'Crown' && gameState.activeLaws.includes(l.id));
                 const currentLevel = activeAuthLaw ? activeAuthLaw.reqLevel : 0;
                 if (currentLevel < req.law_authority_level) reasons.push(`Needs Crown Auth Lvl ${req.law_authority_level}`);
             }
             if (req.prerequisite_law && !gameState.activeLaws.includes(req.prerequisite_law)) {
                  const prereq = gameData.laws.find(l=>l.id === req.prerequisite_law);
                  reasons.push(`Needs Law: ${prereq ? prereq.name : req.prerequisite_law}`);
             }
            return { met: reasons.length === 0, reason: reasons.join(', ') || 'Met' };
        }
         function applyLawEffects(lawId, enacting, updateUI = true) {
            const law = gameData.laws.find(l => l.id === lawId); if (!law || !law.effects) return;
             const multiplier = enacting ? 1 : -1;
            if (law.effects.vassalOpinion) { gameData.vassals.forEach(vId => { if (gameData.characters[vId]) updateCharacterOpinion(vId, law.effects.vassalOpinion * multiplier, enacting ? `Enacted ${law.name}` : `Repealed ${law.name}`); }); }
            if (updateUI) { populateVassalList(); updateResourceDisplay(); }
        }
         function handleEnactLaw(lawId) {
            const law = gameData.laws.find(l => l.id === lawId); if (!law) return;
             const cost = { prestige: 150 };
             const requirementsCheck = checkLawRequirements(lawId);
             if (!checkResourceCost(cost, true) || !requirementsCheck.met) { if(requirementsCheck.met === false) addNotification('warning', 'Cannot Enact', `Req not met: ${requirementsCheck.reason}`); return; }

             const activeLawInCategory = gameData.laws.find(l => l.category === law.category && gameState.activeLaws.includes(l.id));
             if (activeLawInCategory) { applyLawEffects(activeLawInCategory.id, false); gameState.activeLaws = gameState.activeLaws.filter(id => id !== activeLawInCategory.id); }
             applyResourceCost(cost); gameState.activeLaws.push(lawId); applyLawEffects(lawId, true);
             addNotification('success', 'Law Enacted', `${law.name} is now law.`);
             populateLaws(); if (law.category === "Crown") calculatePeasantryApproval();
              refreshDetailModalIfOpen('law', lawId);
         }

        // --- Faction Demand Handling ---
        function acceptFactionDemands(factionId) {
            const faction = gameData.factions[factionId]; if (!faction) return;
            updatePlayerResource('prestige', -150);
            addNotification('warning', 'Demands Accepted', `Yielded to ${faction.name}.`);
            applyFactionGoal(factionId, faction.goal);
            faction.ultimatumSent = false; faction.strength = Math.max(10, faction.strength - 50);
             faction.hidden = faction.strength < 10;
             removeNewsItem(`faction_ultimatum_${factionId.replace(/\W/g, '_')}`);
             populateFactionList(); checkAlerts(); refreshDetailModalIfOpen('faction', factionId);
        }
        function refuseFactionDemands(factionId) {
            const faction = gameData.factions[factionId]; if (!faction) return;
            addNotification('danger', 'Civil War!', `Refusal drove ${faction.name} to rebellion!`);
            const warId = `civil_war_${factionId.replace(/\W/g, '_')}`;
             gameData.wars[warId] = {
                id: warId, name: `${faction.name} Rebellion`, type: 'Vassal Rebellion', score: 0,
                attackers: [faction.leader, ...faction.members.filter(m => m !== faction.leader && Math.random() > 0.1)],
                defenders: ['player', ...gameData.vassals.filter(vId => gameData.characters[vId]?.opinion > 30 && !faction.members.includes(vId))],
                goal: `Crush ${faction.name}`, active: true
             };
             faction.members.forEach(mId => { if(gameData.characters[mId]) gameData.characters[mId].status = "In Rebellion"; });
             faction.hidden = true; faction.ultimatumSent = false;
             removeNewsItem(`faction_ultimatum_${factionId.replace(/\W/g, '_')}`);
             populateWarLists(); populateFactionList(); checkAlerts();
              refreshDetailModalIfOpen('faction', factionId); refreshDetailModalIfOpen('war', warId);
         }
        function applyFactionGoal(factionId, goal) {
            const faction = gameData.factions[factionId];
            addNotification('info', 'Goal Applied', `Applying: ${faction.name} - ${goal}`);
             if (goal.includes("Lower Crown Authority")) {
                 const currentAuthLaw = gameData.laws.find(l => l.category === 'Crown' && gameState.activeLaws.includes(l.id));
                 const currentLevel = currentAuthLaw ? currentAuthLaw.reqLevel : 0;
                 const lowerLevelLaw = gameData.laws.find(l => l.category === 'Crown' && l.reqLevel === currentLevel - 1);
                  if (lowerLevelLaw && checkLawRequirements(lowerLevelLaw.id).met) { handleEnactLaw(lowerLevelLaw.id); }
                  else { addNotification('warning','Cannot Lower Auth','No valid lower auth law or req met.'); }
             } else if (goal.includes("Empowered Council")) { const law = gameData.laws.find(l => l.id === "law_council_empowered"); if (law && checkLawRequirements(law.id).met) handleEnactLaw(law.id); }
             else if (goal.includes("Religious Zeal")) { const law = gameData.laws.find(l => l.id === "law_religious_zealous"); if (law && checkLawRequirements(law.id).met) handleEnactLaw(law.id); }
             else if (goal.includes("Reduce taxes")) { handleEnactEdict('edict_tax_relief', 24, { incomeModPercent: -0.05, approvalMod: 10 }); }
             else { addNotification('info','Goal Applied (NYI)', `Goal '${goal}' placeholder effects.`); }
        }
        function attemptImprisonFactionLeader(factionId) {
             const faction = gameData.factions[factionId]; const leader = gameData.characters[faction.leader]; if (!leader) return;
             const playerIntrigue = gameData.characters.player.stats.int; const leaderIntrigue = leader.stats.int;
              const successChance = Math.max(5, Math.min(95, 40 + (playerIntrigue - leaderIntrigue) * 4));
              if (Math.random() * 100 < successChance) {
                  leader.status = "Imprisoned"; leader.opinion -= 50;
                  addNotification('success', 'Imprisoned!', `${leader.name} captured! ${faction.name} weakened.`);
                  faction.ultimatumSent = false; updateFactionStrength(factionId, -40);
                   if(faction.strength < 15) faction.hidden = true;
                   removeNewsItem(`faction_ultimatum_${factionId.replace(/\W/g, '_')}`);
                   populateFactionList(); refreshDetailModalIfOpen('character', faction.leader);
              } else {
                   addNotification('danger', 'Imprisonment Failed!', `Attempt to imprison ${leader.name} failed! Faction enraged!`);
                  updateCharacterOpinion(faction.leader, -25, "Failed Imprisonment"); faction.strength += 20;
                    checkFactionUltimatums();
              }
              checkAlerts(); refreshDetailModalIfOpen('faction', factionId);
        }

        // --- Intrigue: Plots & Schemes ---
        function calculatePlotPower() {
             let power = BASE_PLOT_POWER; const player = gameData.characters.player;
             if(player) { power += player.stats.int / 2; player.traits.forEach(tId => { const t = availableRulerTraits.find(tr => tr.id === tId); if (t?.effects?.plotPower) power += t.effects.plotPower; }); }
             const spymasterId = getCouncilMemberId('Spymaster'); if (spymasterId && gameData.characters[spymasterId]) { power += gameData.characters[spymasterId].stats.int / 3; }
             gameState.plotPower = Math.max(5, Math.floor(power));
        }
        function startPlot(type, targetId) {
             if (gameState.activePlots.length >= MAX_ACTIVE_PLOTS) { addNotification('warning', 'Max Plots', `Max ${MAX_ACTIVE_PLOTS} active plots.`); return false; }
             if (gameState.activePlots.some(p => p.targetId === targetId && p.type === type)) { addNotification('info', 'Plot Exists', `Already have ${type} plot vs ${getParticipantName(targetId)}.`); return false; }
             plotIdCounter++;
             gameState.activePlots.push({ id: `plot_${plotIdCounter}`, type: type, targetId: targetId, progress: 0, discoveryChance: 5, successChance: 5, plotterId: 'player' });
             addNotification('intrigue', 'Plot Started', `Started ${type} plot vs ${getParticipantName(targetId)}.`);
             populateIntrigue(); return true;
         }
         function resolvePlot(plotId, success) {
            const plot = gameState.activePlots.find(p => p.id === plotId); if (!plot) return;
             const targetName = getParticipantName(plot.targetId); const targetChar = gameData.characters[plot.targetId];
             gameState.activePlots = gameState.activePlots.filter(p => p.id !== plotId);
            if (success) {
                 addNotification('success', `Plot Success: ${plot.type}`, `Plot vs ${targetName} succeeded!`);
                 switch(plot.type) {
                     case 'murder': if (targetChar) { addNotification('danger', `${targetName} Assassinated!`, `${targetName} killed.`); targetChar.hidden = true; targetChar.status = 'Deceased (Assassinated)'; gameState.prestige += 50; } break;
                     case 'abduct': if (targetChar) { addNotification('intrigue', `${targetName} Abducted!`, `${targetName} captured!`); targetChar.status = 'Imprisoned (Abducted)'; updateCharacterOpinion(plot.targetId, -100, 'Abducted'); gameState.prestige += 25; } break;
                     case 'fabricate_hook': addNotification('intrigue', `Hook Fabricated`, `Gained hook on ${targetName}. (NYI)`); gameState.prestige += 10; break;
                 }
             } else {
                  addNotification('warning', `Plot Failed: ${plot.type}`, `Plot vs ${targetName} failed.`); updatePlayerResource('prestige', -20);
                  if(targetChar && Math.random() < 0.3) updateCharacterOpinion(plot.targetId, -10, "Suspected Plot");
             }
             populateIntrigue(); populateAllUI();
         }
        function discoverPlot(plot) {
             addNotification('danger', 'Plot Discovered!', `Your ${plot.type} plot vs ${getParticipantName(plot.targetId)} discovered!`);
             const targetChar = gameData.characters[plot.targetId];
              if (plot.targetId === 'player' || (targetChar && targetChar.dynasty === gameState.dynastyId && !targetChar.hidden)) {
                   gameState.discoveredPlots.push({ id: plot.id, type: plot.type, targetId: plot.targetId, plotterId: plot.plotterId, handled: false });
                    showAlert('alert-plot-discovered', `A ${plot.type} plot targeting ${getParticipantName(plot.targetId)} discovered! Check Intrigue.`, true);
              } else { if (targetChar) updateCharacterOpinion(plot.targetId, -40, `Discovered ${plot.type} Plot`); }
             populateIntrigue();
         }
         function handleDiscoveredPlot(plotId, action) {
            const plotIndex = gameState.discoveredPlots.findIndex(p => p.id === plotId); if (plotIndex === -1) return;
            const plot = gameState.discoveredPlots[plotIndex]; const plotter = gameData.characters[plot.plotterId];
            if (action === 'expose') {
                 addNotification('intrigue', 'Plot Exposed!', `Exposed ${plot.type} plot by ${plotter ? getParticipantName(plotter.id) : 'Unknown'}!`);
                 if (plotter) { updateCharacterOpinion(plot.plotterId, -30, "Plot Exposed"); updatePlayerResource('prestige', 25); }
                  plot.handled = true;
             } else if (action === 'end') {
                 addNotification('intrigue', 'Plot Ended', `Demanded end to plot vs ${getParticipantName(plot.targetId)}.`);
                 if (plotter) { updateCharacterOpinion(plot.plotterId, -10, "Forced to End Plot"); }
                  plot.handled = true;
             }
             populateIntrigue(); checkAlerts();
         }
        function startScheme(type, targetId) {
             if (gameState.currentScheme) { addNotification('warning', 'Scheme Busy', `Already running: ${gameState.currentScheme.type}.`); return false; }
              if (!targetId || (targetId === 'player' && !['discover_plots'].includes(type))) { addNotification('warning', 'Invalid Target', `Valid target required for ${type} scheme.`); return false; }
             const duration = SCHEME_BASE_DURATION_MONTHS;
             gameState.currentScheme = { type: type, targetId: targetId, progress: 0, duration: duration, startTime: getGlobalMonth() };
             addNotification('intrigue', 'Scheme Started', `Started ${type} vs ${getParticipantName(targetId)}. Approx ${duration} months.`);
             populateIntrigue(); return true;
         }
        function resolveScheme(schemeType) {
             const scheme = gameState.currentScheme;
             if (!scheme || scheme.type !== schemeType) { addNotification('warning', 'Scheme Error', `Cannot resolve: ${schemeType}.`); return; }
             const targetName = getParticipantName(scheme.targetId);
             const timeElapsed = getGlobalMonth() - scheme.startTime; const progressFactor = Math.min(1, Math.max(0, (timeElapsed / scheme.duration)));
              let finalSuccessChance = 15 + progressFactor * 70;
             const player = gameData.characters.player; const target = gameData.characters[scheme.targetId] || gameData.diplomacy[scheme.targetId];
             if (player && target?.stats) { finalSuccessChance += (player.stats.int - target.stats.int) * 2; } else if (player) { finalSuccessChance += player.stats.int; }
              finalSuccessChance = Math.max(5, Math.min(95, finalSuccessChance));
             let success = Math.random() * 100 < finalSuccessChance;
             addNotification('info', 'Scheme Resolved', `Scheme '${scheme.type}' vs ${targetName} resolved. Success: ${finalSuccessChance.toFixed(0)}% -> ${success ? 'Success!' : 'Failure!'}`);
             switch(scheme.type) {
                 case 'discover_plots': addNotification('intrigue', 'Discover Plots Results', `Spymaster reported. (System NYI)`); break;
                 case 'fabricate_claim': addNotification('warning','NYI',`Outcome for Fabricate Claim NYI.`); break;
                 case 'build_spy_network': addNotification('warning','NYI',`Outcome for Build Spy Network NYI.`); break;
                 case 'disband_faction':
                      const faction = gameData.factions[scheme.targetId];
                      if(faction && success) { updateFactionStrength(scheme.targetId, -30 - Math.random() * 30); addNotification('success', 'Faction Weakened', `Scheme weakened ${faction.name}.`); if(faction.strength < 15 && faction.members.length <= 1) { faction.hidden = true; addNotification('info','Faction Dissolved',`${faction.name} disbanded.`); }}
                      else if (faction) { addNotification('warning', 'Scheme Failed', `Failed to weaken ${faction.name}.`); updateCharacterOpinion(faction.leader, -10, "Detected failed disband scheme"); }
                     break;
                 case 'sway':
                      const targetChar = gameData.characters[scheme.targetId];
                     if(targetChar && success) { updateCharacterOpinion(scheme.targetId, 15 + Math.floor(Math.random() * 15), 'Successfully Swayed'); addNotification('success', 'Sway Successful', `${targetName} looks upon you more favorably.`); }
                     else if (targetChar) { updateCharacterOpinion(scheme.targetId, -5 - Math.floor(Math.random() * 10), 'Failed Sway'); addNotification('warning', 'Sway Failed', `Attempts to sway ${targetName} failed.`); }
                     break;
             }
             gameState.currentScheme = null; populateIntrigue();
         }

        // --- Other Functions ---
        function updatePlayerResource(resource, amount, updateUI = true) {
             if (amount === 0 || isNaN(amount)) return;
             gameState[resource] = (gameState[resource] || 0) + amount;
            if (resource === 'manpower') gameState.manpower = Math.max(0, Math.min(gameState.manpower, gameState.maxManpower));
             else if (resource === 'prestige' || resource === 'dynastyPrestige') gameState[resource] = Math.max(0, gameState[resource]);
             if (updateUI) updateResourceDisplay();
        }
        function updateCharacterOpinion(charId, change, reason = "Unknown") {
             if (change === 0 || !gameData.characters[charId] || gameData.characters[charId].opinion === null || isNaN(change)) return;
             gameData.characters[charId].opinion += change;
             gameData.characters[charId].opinion = Math.round(Math.max(-100, Math.min(100, gameData.characters[charId].opinion)));
              refreshDetailModalIfOpen('character', charId);
              if (uiElements.tabContents[1].classList.contains('active')) populateVassalList();
             populateRulerPanel();
        }
        function updateDiplomacyRelation(realmId, change, reason = "Unknown") {
             if (change === 0 || !gameData.diplomacy[realmId] || isNaN(change)) return;
             gameData.diplomacy[realmId].relationValue += change;
             gameData.diplomacy[realmId].relationValue = Math.round(Math.max(-100, Math.min(100, gameData.diplomacy[realmId].relationValue)));
             const newVal = gameData.diplomacy[realmId].relationValue;
             if (newVal >= 75) gameData.diplomacy[realmId].status = "Ally"; else if (newVal >= 40) gameData.diplomacy[realmId].status = "Friendly";
             else if (newVal >= 10) gameData.diplomacy[realmId].status = "Amicable"; else if (newVal > -10) gameData.diplomacy[realmId].status = "Neutral";
             else if (newVal > -40) gameData.diplomacy[realmId].status = "Wary"; else if (newVal > -75) gameData.diplomacy[realmId].status = "Poor";
             else gameData.diplomacy[realmId].status = "Hostile";
              if (uiElements.tabContents[3].classList.contains('active')) populateDiplomacy();
              refreshDetailModalIfOpen('diplomacy', realmId);
         }
        function updateFactionStrength(factionId, change) {
             if (!gameData.factions[factionId] || isNaN(change)) return;
             gameData.factions[factionId].strength += change;
             gameData.factions[factionId].strength = Math.round(Math.max(0, Math.min(200, gameData.factions[factionId].strength)));
             if (uiElements.tabContents[1].classList.contains('active')) populateFactionList();
             checkAlerts(); refreshDetailModalIfOpen('faction', factionId);
         }
         function calculatePeasantryApproval(triggerRevoltCheck = true, directChange = 0) {
             let approval = gameState.currentPeasantApproval + directChange;
             if (directChange === 0) {
                 let totalDeviation = 0;
                 const orderFreedom = parseInt(document.getElementById('order-freedom-slider').value, 10);
                 const centralDecentral = parseInt(document.getElementById('central-decentral-slider').value, 10);
                 const aristoEgal = parseInt(document.getElementById('aristo-egal-slider').value, 10);
                  let baseApproval = 75;
                 totalDeviation += Math.max(0, orderFreedom - 40); totalDeviation += Math.max(0, centralDecentral - 30);
                 totalDeviation += Math.max(0, 50 - aristoEgal);
                 approval = Math.round(baseApproval - (totalDeviation / (60 + 70 + 50)) * 100);
             }
             let warWeariness = 0; Object.values(gameData.wars).forEach(war => { if (war.active) warWeariness += 2; }); approval -= warWeariness;
             const currentMonth = getGlobalMonth();
             Object.keys(gameState.activeEdicts).forEach(edictId => {
                 if (gameState.activeEdicts[edictId] > currentMonth) {
                    if (edictId === 'edict_taxes') approval -= 10; // Assuming only harsh taxes edict
                    if (edictId === 'edict_festivals') approval += 5;
                    if (edictId === 'edict_tax_relief') approval += 10; // Specific benefit from tax relief
                 }
             });
             approval = Math.max(0, Math.min(100, Math.round(approval))); gameState.currentPeasantApproval = approval;
             uiElements.peasantryApprovalDisplay.textContent = `${approval}%`;
             uiElements.peasantryApprovalDisplay.classList.toggle('low-approval', approval < REBELLION_THRESHOLD);
          }
         function addNotification(type, title, message) {
             notificationIdCounter++; const notifId = `notif-${notificationIdCounter}`;
             const notification = document.createElement('div');
             notification.classList.add('notification', type); notification.id = notifId;
             notification.innerHTML = `<button class="dismiss-btn" data-target="${notifId}">×</button><h5>${title}</h5><p>${message}</p>`;
             uiElements.notificationsContainer.insertBefore(notification, uiElements.notificationsContainer.firstChild);
             while (uiElements.notificationsContainer.children.length > 20) { uiElements.notificationsContainer.removeChild(uiElements.notificationsContainer.lastChild); }
         }
         function showMessageModal(targetType, targetId) {
             const recipientName = getParticipantName(targetId);
             uiElements.messageRecipientName.textContent = recipientName;
             const optionsContainer = uiElements.messageOptionsList;
             optionsContainer.innerHTML = ''; // Clear old options
             const messageOptions = getMessageOptions(targetType, targetId);
             if (messageOptions.length === 0) {
                 optionsContainer.innerHTML = "<p>No available messages for this recipient.</p>";
             } else {
                 messageOptions.forEach(opt => {
                     const button = document.createElement('button');
                     button.textContent = opt.text;
                     if (opt.cost && !checkResourceCost(opt.cost)) {
                         button.disabled = true;
                         button.title = `Cannot afford: ${formatCost(opt.cost)}`;
                     } else if (opt.cost) {
                         button.title = `Cost: ${formatCost(opt.cost)}`;
                     }
                     button.dataset.action = 'message_send'; // Generic action
                     button.dataset.messageKey = opt.key;
                     button.dataset.targetType = targetType;
                     button.dataset.targetId = targetId;
                     if(opt.cost) button.dataset.costData = JSON.stringify(opt.cost);
                     button.addEventListener('click', () => handleSendMessage(button));
                     optionsContainer.appendChild(button);
                 });
             }
             showModal('messageModalOverlay');
         }
         function getMessageOptions(targetType, targetId) {
             let options = [];
             if (targetType === 'character') {
                 const char = gameData.characters[targetId];
                 if (char) {
                     options.push({ key: "greet", text: "Send formal greetings.", cost: { prestige: 1 } });
                     if (char.opinion < 0) options.push({ key: "apologize", text: "Offer an apology.", cost: { prestige: 5 } });
                     if (char.opinion > 25) options.push({ key: "praise", text: "Praise their recent deeds.", cost: { prestige: -5 } }); // Gain prestige
                     if (gameData.vassals.includes(targetId)) options.push({ key: "demand_levies", text: "Demand increased levies (Temporary).", cost: { prestige: 10 }});
                 }
             } else if (targetType === 'diplomacy') {
                 const realm = gameData.diplomacy[targetId];
                 if (realm) {
                     options.push({ key: "propose_trade", text: "Propose trade agreement (NYI).", cost: { gold: 20 } });
                     if (realm.relationValue < 0 && !realm.atWar) options.push({ key: "issue_warning", text: "Issue a stern warning.", cost: { prestige: 15 } });
                 }
             } else if (targetType === 'faction') {
                  const faction = gameData.factions[targetId];
                  if(faction) {
                      options.push({key: "faction_negotiate", text: `Attempt to negotiate with ${getParticipantName(faction.leader)}. (NYI)`, cost: {prestige: 20}});
                      if(faction.strength > 50) options.push({key: "faction_threaten", text: `Threaten the faction with dire consequences. (NYI)`, cost: {prestige: -10}, classes: 'danger-action'});
                  }
             }
             return options;
         }
         function handleSendMessage(button) {
             const messageKey = button.dataset.messageKey;
             const targetType = button.dataset.targetType;
             const targetId = button.dataset.targetId;
             const costData = JSON.parse(button.dataset.costData || '{}');

             if (Object.keys(costData).length > 0 && !checkResourceCost(costData, true)) return;
             if (Object.keys(costData).length > 0) applyResourceCost(costData);

             let responseText = "Message sent.";
             // Simulate basic responses
             if (targetType === 'character') {
                 const char = gameData.characters[targetId];
                 switch(messageKey) {
                     case "greet": updateCharacterOpinion(targetId, 2, "Received Greetings"); responseText = `${char.name} acknowledges your greetings.`; break;
                     case "apologize": updateCharacterOpinion(targetId, 5 + Math.floor(char.stats.dip/2), "Received Apology"); responseText = `${char.name} considers your apology.`; break;
                     case "praise": updateCharacterOpinion(targetId, 10, "Received Praise"); responseText = `${char.name} is pleased by your praise.`; break;
                     case "demand_levies": updateCharacterOpinion(targetId, -10, "Levies Demanded"); responseText = `${char.name} grudgingly agrees to provide more levies for a time. (Effect NYI)`; break;
                 }
             } else if (targetType === 'diplomacy') {
                 const realm = gameData.diplomacy[targetId];
                 switch(messageKey) {
                     case "propose_trade": updateDiplomacyRelation(targetId, 5, "Trade Proposed"); responseText = `${realm.name} will consider your trade proposal.`; break;
                     case "issue_warning": updateDiplomacyRelation(targetId, -10, "Warning Issued"); responseText = `A stern warning was delivered to ${realm.name}.`; break;
                 }
             }
             addNotification('info', 'Message Sent', responseText);
             closeModal('messageModalOverlay');
             updateResourceDisplay();
             populateAllUI(); // Refresh relevant UIs
         }
         function checkResourceCost(costData, logError = false) {
              let canAfford = true; let reasons = [];
               if (costData.gold && gameState.gold < costData.gold) { canAfford = false; reasons.push('Gold'); }
               if (costData.prestige && gameState.prestige < costData.prestige) { canAfford = false; reasons.push('Prestige'); }
               if (costData.manpower && gameState.manpower < costData.manpower) { canAfford = false; reasons.push('Manpower'); }
               if (costData.dynastyPrestige && gameState.dynastyPrestige < costData.dynastyPrestige) { canAfford = false; reasons.push('Dynasty Prestige'); }
              if (!canAfford && logError) { addNotification('warning', 'Cannot Afford', `Insufficient: ${reasons.join(', ')}.`); }
              return canAfford;
         }
         function applyResourceCost(costData) {
             if (costData.gold) updatePlayerResource('gold', -costData.gold);
             if (costData.prestige) updatePlayerResource('prestige', -costData.prestige);
             if (costData.manpower) updatePlayerResource('manpower', -costData.manpower);
             if (costData.dynastyPrestige) updatePlayerResource('dynastyPrestige', -costData.dynastyPrestige);
         }
         function refundCost(costData) {
             if (costData.gold) updatePlayerResource('gold', costData.gold);
             if (costData.prestige) updatePlayerResource('prestige', costData.prestige);
             if (costData.manpower) updatePlayerResource('manpower', costData.manpower);
             if (costData.dynastyPrestige) updatePlayerResource('dynastyPrestige', costData.dynastyPrestige);
              console.log("Refunded:", costData); addNotification('info','Cost Refunded', `Resources refunded.`);
         }
        function updateActionButtonStates(container = document) {
            container.querySelectorAll('.generic-action-btn.cost, .hire-mercenary-btn.cost').forEach(btn => {
                const costData = JSON.parse(btn.dataset.costData || '{}');
                 let disabledReason = btn.dataset.disabledReason || '';
                 let baseDisabled = btn.dataset.baseDisabled === 'true';
                if (baseDisabled) { btn.disabled = true; }
                 else if (Object.keys(costData).length > 0 && !checkResourceCost(costData)) { btn.disabled = true; disabledReason = '(Insufficient Resources)'; }
                 else { if (!btn.dataset.originalDisabledReason) btn.disabled = false; disabledReason = btn.dataset.originalDisabledReason || ''; }
                 let reasonSpan = btn.nextElementSibling;
                 if (reasonSpan && reasonSpan.classList.contains('disabled-reason-span')) {
                      if (btn.disabled && disabledReason) { reasonSpan.textContent = disabledReason; reasonSpan.style.display = 'inline'; } else { reasonSpan.style.display = 'none'; }
                 } else if (btn.disabled && disabledReason) { reasonSpan = document.createElement('span'); reasonSpan.classList.add('disabled-reason-span'); reasonSpan.textContent = disabledReason; btn.insertAdjacentElement('afterend', reasonSpan); }
                 if (!btn.dataset.originalDisabledReason && btn.dataset.disabledReason) { btn.dataset.originalDisabledReason = btn.dataset.disabledReason; }
             });
            if (container.id === 'intrigue-content' || container.id === 'detail-actions') {
                const canStartPlot = gameState.activePlots.length < MAX_ACTIVE_PLOTS;
                container.querySelectorAll('[data-action="intrigue_start_plot"]').forEach(btn => {
                    if (!canStartPlot && !btn.disabled) {
                        btn.disabled = true; let reasonSpan = btn.nextElementSibling; const reasonText = `(Max ${MAX_ACTIVE_PLOTS} Plots)`;
                         if (reasonSpan?.classList.contains('disabled-reason-span')) { reasonSpan.textContent = reasonText; reasonSpan.style.display = 'inline'; }
                         else { reasonSpan = document.createElement('span'); reasonSpan.classList.add('disabled-reason-span'); reasonSpan.textContent = reasonText; btn.insertAdjacentElement('afterend', reasonSpan); }
                    } else if (canStartPlot && btn.disabled && btn.nextElementSibling?.classList.contains('disabled-reason-span') && btn.nextElementSibling.textContent.includes('Max')) {
                         const costData = JSON.parse(btn.dataset.costData || '{}');
                         if (checkResourceCost(costData)) { btn.disabled = false; let reasonSpan = btn.nextElementSibling; if(reasonSpan) reasonSpan.style.display = 'none'; }
                    }
                });
                  const canStartScheme = !gameState.currentScheme;
                  container.querySelectorAll('[data-action^="intrigue_start_scheme"], [data-action="intrigue_discover_plots"]').forEach(btn => {
                     if (!canStartScheme && !btn.disabled) {
                          btn.disabled = true; let reasonSpan = btn.nextElementSibling; const reasonText = '(Scheme Active)';
                           if (reasonSpan?.classList.contains('disabled-reason-span')) { reasonSpan.textContent = reasonText; reasonSpan.style.display = 'inline'; }
                           else { reasonSpan = document.createElement('span'); reasonSpan.classList.add('disabled-reason-span'); reasonSpan.textContent = reasonText; btn.insertAdjacentElement('afterend', reasonSpan); }
                      } else if (canStartScheme && btn.disabled && btn.nextElementSibling?.classList.contains('disabled-reason-span') && btn.nextElementSibling.textContent.includes('Scheme Active')) {
                           const costData = JSON.parse(btn.dataset.costData || '{}');
                           if (checkResourceCost(costData)) { btn.disabled = false; let reasonSpan = btn.nextElementSibling; if(reasonSpan) reasonSpan.style.display = 'none'; }
                      }
                  });
            }
         }
        function createActionButtonElement(text, action, targetId, costData = {}, classes = '', disabled = false, disabledReason = '') {
            const button = document.createElement('button');
            button.classList.add('generic-action-btn');
            if (classes) button.classList.add(...classes.split(' '));
            if (Object.keys(costData).length > 0) { button.classList.add('cost'); button.dataset.costDisplay = formatCost(costData); }
            button.dataset.action = action;
            if (targetId !== null && targetId !== undefined) button.dataset.id = targetId;
            button.dataset.costData = JSON.stringify(costData);
             button.disabled = disabled; button.dataset.baseDisabled = disabled ? 'true' : 'false';
            if(disabled && disabledReason) button.dataset.disabledReason = disabledReason;
            button.textContent = text;
            return button;
        }
        function refreshDetailModalIfOpen(type = null, id = null) {
             if (uiElements.detailModalOverlay.style.display === 'flex') {
                 const currentType = uiElements.detailModalOverlay.dataset.currentType;
                 const currentId = uiElements.detailModalOverlay.dataset.currentId;
                 if (currentType && (type === null || currentType === type || (currentId && currentId === id))) {
                      showDetailModal(currentType, currentId);
                 }
             }
         }
         function calculateTotalLevies() {
             let total = 0;
             gameData.vassals.forEach(vId => { const v = gameData.characters[vId]; if (v && v.opinion > -50) { total += 100 + (v.stats?.mar || 0) * 20 * Math.max(0, (v.opinion + 50) / 100); } });
              total += 500 + (gameData.characters.player.stats.mar || 0) * 50;
             gameState.activeLaws.forEach(lawId => { const law = gameData.laws.find(l => l.id === lawId); if (law?.effects?.rulerLevyMod) total *= (1 + law.effects.rulerLevyMod); });
             return Math.max(0, Math.floor(total));
         }
        function calculateHiredMercSize() { return gameState.hiredMercIds.reduce((sum, mercId) => sum + (gameData.mercenaries[mercId]?.size || 0), 0); }
         function addRival(charId1, charId2) {
             const c1 = gameData.characters[charId1]; const c2 = gameData.characters[charId2]; if (!c1 || !c2) return;
             if (!c1.relations.includes(`Rival: ${charId2}`)) c1.relations.push(`Rival: ${charId2}`);
             if (!c2.relations.includes(`Rival: ${charId1}`)) c2.relations.push(`Rival: ${charId1}`);
              updateCharacterOpinion(charId1, -50, `Rivalry with ${c2.name}`); updateCharacterOpinion(charId2, -50, `Rivalry by ${c1.name}`);
              addNotification('intrigue','Rivalry Declared',`${c1.name} and ${c2.name} now rivals.`);
              refreshDetailModalIfOpen('character', charId1); refreshDetailModalIfOpen('character', charId2); populateDiplomacy();
         }
         function removeRival(charId1, charId2) {
              const c1 = gameData.characters[charId1]; const c2 = gameData.characters[charId2]; if (!c1 || !c2) return;
              c1.relations = c1.relations.filter(r => r !== `Rival: ${charId2}`); c2.relations = c2.relations.filter(r => r !== `Rival: ${charId1}`);
              updateCharacterOpinion(charId1, 10, `Ended Rivalry with ${c2.name}`); updateCharacterOpinion(charId2, 10, `Ended Rivalry with ${c1.name}`);
               addNotification('info','Rivalry Ended',`Rivalry between ${c1.name} and ${c2.name} ended.`);
               refreshDetailModalIfOpen('character', charId1); refreshDetailModalIfOpen('character', charId2); populateDiplomacy();
         }
        function handleOfferPeace(warId) {
              const war = gameData.wars[warId]; if (!war) return;
              const isPlayerAttacker = war.attackers.includes('player'); const warScore = war.score;
               let acceptChance = isPlayerAttacker ? Math.max(0, Math.min(100, 50 + warScore)) : Math.max(0, Math.min(100, 50 - warScore));
               if (Math.random() * 100 < acceptChance) { addNotification('success','Peace Accepted!', 'Enemy accepted peace!'); endWar(warId, 'white_peace', false); }
               else { addNotification('warning','Peace Rejected!', 'Enemy rejected peace.'); updatePlayerResource('prestige', -10); }
         }
         function handleCallAlly(warId, allyId) {
            const war = gameData.wars[warId]; const ally = gameData.diplomacy[allyId];
            if (!war || !ally || !ally.alliance || war.attackers.includes(allyId) || war.defenders.includes(allyId)) { addNotification('warning','Cannot Call Ally', 'Invalid conditions.'); refundCost({prestige: 25}); return; }
             let acceptChance = 20 + ally.relationValue / 2;
             const isPlayerAttacker = war.attackers.includes('player'); const currentScore = isPlayerAttacker ? war.score : -war.score;
             acceptChance += currentScore / 4; acceptChance = Math.max(5, Math.min(95, acceptChance));
              if (Math.random() * 100 < acceptChance) {
                   addNotification('success', 'Ally Joined!', `${ally.name} accepted call to arms!`);
                    if (isPlayerAttacker) war.attackers.push(allyId); else war.defenders.push(allyId);
                     populateWarLists(); refreshDetailModalIfOpen('war', warId); refreshDetailModalIfOpen('diplomacy', allyId);
              } else { addNotification('warning', 'Ally Declined!', `${ally.name} refused call.`); updateDiplomacyRelation(allyId, -20, 'Refused Call'); refundCost({prestige: 25}); }
         }
         function handleDeclareWar(targetId, aiDeclared = false) {
              if (!aiDeclared && gameState.activeTruces[targetId] > getGlobalMonth()) { addNotification('danger', 'Cannot Declare War!', `Active truce with ${getParticipantName(targetId)}!`); return; }
              const hasCB = gameData.diplomacy[targetId]?.relationValue < -50 || Math.random() < 0.2; // Placeholder CB
               if (!aiDeclared && !hasCB) { addNotification('warning', 'Cannot Declare War!', `No valid Casus Belli vs ${getParticipantName(targetId)}.`); return; }
              if (gameData.diplomacy[targetId].atWar) { addNotification('info', 'Already at War', `Already at war with ${getParticipantName(targetId)}.`); return; }
             const warId = `war_${(aiDeclared ? 'def_' : 'atk_')}${targetId.replace(/\W/g, '_')}_${gameState.gameTime}`;
             gameData.wars[warId] = {
                id: warId, name: `War for ${targetId}`, type: aiDeclared ? 'Defensive' : 'Offensive', score: 0,
                 attackers: aiDeclared ? [targetId] : ['player'], defenders: aiDeclared ? ['player'] : [targetId],
                 goal: aiDeclared ? `Defend vs ${getParticipantName(targetId)}` : `Conquer ${targetId}`, active: true
             };
             gameData.diplomacy[targetId].atWar = true; addNotification('danger', 'War Declared!', `War begun with ${getParticipantName(targetId)}!`);
             updateDiplomacyRelation(targetId, -100 - gameData.diplomacy[targetId].relationValue, "War Declared");
              populateWarLists(); populateDiplomacy();
              refreshDetailModalIfOpen('war', warId); refreshDetailModalIfOpen('diplomacy', targetId);
         }
        function handleEnactEdict(edictId, durationMonths, effects) {
             if (gameState.activeEdicts[edictId] > getGlobalMonth()) { addNotification('info', 'Edict Active', `${edictId.replace('edict_','')} already active.`); refundCost(JSON.parse(event.target.dataset.costData || '{}')); return; }
             gameState.activeEdicts[edictId] = getGlobalMonth() + durationMonths;
             addNotification('success', 'Edict Enacted', `Enacted ${edictId.replace('edict_','')} for ${durationMonths}m.`);
             if (effects.approvalMod) calculatePeasantryApproval(false, effects.approvalMod);
             updateActionButtonStates(document.getElementById('laws-content'));
         }
        function updateWarScore(warId, change) {
             if (gameData.wars[warId]?.active && !isNaN(change)) {
                  gameData.wars[warId].score = Math.max(-100, Math.min(100, gameData.wars[warId].score + change));
                  if (gameData.wars[warId].score >= 100) { endWar(warId, 'victory', true); }
                  else if (gameData.wars[warId].score <= -100) { endWar(warId, 'defeat', false); }
                  else { checkAlerts(); }
              }
        }
        function endWar(warId, outcome, playerEnforcesDemands) {
             const war = gameData.wars[warId]; if (!war || !war.active) return; war.active = false;
              let outcomeDesc = ''; const isPlayerAttacker = war.attackers.includes('player'); const isPlayerDefender = war.defenders.includes('player');
              let playerWon = false;
             if (outcome === 'victory' && isPlayerAttacker && playerEnforcesDemands) playerWon = true;
             if (outcome === 'defeat' && isPlayerDefender && playerEnforcesDemands) playerWon = true;

             if (outcome === 'surrender') { outcomeDesc = `Surrendered war for ${war.name}.`; updatePlayerResource('prestige', -100); }
             else if (outcome === 'white_peace') { outcomeDesc = `War for ${war.name} ended in white peace.`; updatePlayerResource('prestige', Math.round((isPlayerAttacker ? war.score : -war.score) / 5)); }
             else if (playerWon) { outcomeDesc = `Victorious in war for ${war.name}!`; updatePlayerResource('prestige', 100); }
             else { outcomeDesc = `Lost war for ${war.name}. Enemy enforces demands.`; updatePlayerResource('prestige', -75); }
             addNotification('info', 'War Concluded', outcomeDesc);

              const participants = [...war.attackers, ...war.defenders].filter(id => id !== 'player');
              participants.forEach(id => { if (gameData.diplomacy[id]) gameData.diplomacy[id].atWar = false; gameState.activeTruces[id] = getGlobalMonth() + TRUCE_DURATION_MONTHS; });
              if (war.type === "Vassal Rebellion" || war.id.startsWith("civil_war_") || war.id === 'peasant_revolt') {
                  war.attackers.forEach(rebelId => { const char = gameData.characters[rebelId]; if(char) { if (playerWon) { char.status = 'Imprisoned (Defeated Rebel)'; char.opinion -= 50; } else { char.status = undefined; }}});
                  if(war.id === 'peasant_revolt' && gameData.factions.rebel_peasant) gameData.factions.rebel_peasant.hidden = true;
              }
              populateWarLists(); populateDiplomacy(); populateTrucesList(); checkAlerts();
               refreshDetailModalIfOpen('war', warId); participants.forEach(pId => refreshDetailModalIfOpen(getParticipantType(pId), pId));
          }

        // --- Detail Modal Logic ---
        function showDetailModal(type, id) {
            let data, portraitSeed = null, title, description = '', specificHTML = '', actionsHTML = '';
            uiElements.detailSpecificContent.innerHTML = ''; uiElements.detailActions.innerHTML = '';
            uiElements.detailModalOverlay.dataset.currentType = type; uiElements.detailModalOverlay.dataset.currentId = id;
             try {
                switch (type) {
                    case 'character': data = gameData.characters[id]; break; case 'faction': data = gameData.factions[id]; break;
                    case 'war': data = gameData.wars[id]; break; case 'diplomacy': data = gameData.diplomacy[id]; break;
                    case 'law': data = gameData.laws.find(l => l.id === id); break; default: throw new Error(`Unknown type: ${type}`);
                }
                if (!data || (type === 'character' && data.hidden)) { throw new Error(`Data not found/hidden for ${type} ID: ${id}`); }
             } catch (error) { uiElements.detailTitle.textContent = "Error"; uiElements.detailDescription.textContent = error.message; showModal('detailModalOverlay'); return; }

             function createDetAct(txt, act, tId=id, cst={}, cls='', dis=false, disRsn='', dset={}) { const btn=createActionButtonElement(txt,act,tId,cst,cls,dis,disRsn); Object.entries(dset).forEach(([k,v])=>btn.dataset[k]=v); uiElements.detailActions.appendChild(btn); return btn; }

             switch (type) {
                 case 'character':
                     title = `${data.title || ''} ${data.name} ${data.epithet ? "'" + data.epithet + "'" : ''}`;
                     description = data.description || "No description."; if (data.status) description += ` Status: <strong style="color: ${data.status.includes('Imprisoned') ? 'var(--danger-color)' : 'var(--warning-color)'};">${data.status}</strong>`;
                     portraitSeed = data.portraitSeed;
                      specificHTML += `<h3>Details</h3><div class="detail-grid">`;
                      specificHTML += `<div class="detail-card"><h4>Stats</h4><p>Dip: ${data.stats.dip}|Mar: ${data.stats.mar}|Ste: ${data.stats.ste}|Intr: ${data.stats.int}|Lrn: ${data.stats.lrn}</p></div>`;
                      specificHTML += `<div class="detail-card"><h4>Traits</h4><p>${data.traits.join(', ')||'None'}</p></div>`;
                      if(data.dynasty) specificHTML += `<div class="detail-card"><h4>Dynasty</h4><p>${data.dynasty}</p></div>`;
                      if(data.opinion !== null) specificHTML += `<div class="detail-card"><h4>Opinion</h4><p><span class="opinion ${getOpinionClass(data.opinion)}">${formatOpinion(data.opinion)}</span></p></div>`;
                      let factionMemberOf = 'None'; Object.entries(gameData.factions).forEach(([fid, f]) => { if (!f.hidden && f.members.includes(id)) { factionMemberOf = createClickableSpan('faction', fid, f.name); if (f.leader === id) factionMemberOf += ' (Leader)'; } });
                      specificHTML += `<div class="detail-card"><h4>Faction</h4><p>${factionMemberOf}</p></div></div>`;
                      specificHTML += `<h3>Relationships</h3><ul>${(data.relations||[]).map(rel => {const [rt, tiR]=rel.split(':'); const ti=tiR?.trim(); if(!ti)return''; const tc=gameData.characters[ti]; if(tc&&!tc.hidden)return`<li>${rt}: ${createClickableSpan('character',ti)}</li>`; if(getParticipantType(ti)!=='unknown'&&ti!=='player')return`<li>${rt}: ${createClickableSpan(getParticipantType(ti),ti)}</li>`; if(ti)return`<li>${rt}: ${ti}</li>`; return '';}).join('') || '<li>None</li>'}</ul>`;
                     if (id !== 'player') {
                         createDetAct('Send Gift', 'char_send_gift', id, { gold: 25 }); createDetAct('Sway', 'intrigue_start_scheme', id, { prestige: 50 }, 'intrigue-action', false, '', { schemeType: 'sway' });
                         createDetAct('Send Message', 'char_send_message', id); const isRival = data.relations?.includes(`Rival: player`) || gameData.characters.player?.relations?.includes(`Rival: ${id}`);
                         createDetAct(isRival?'End Rivalry':'Declare Rivalry', isRival?'char_end_rivalry':'char_declare_rivalry', id, {prestige:isRival?10:-25}, isRival?'':'danger-action');
                         createDetAct('Plot: Murder', 'intrigue_start_plot', id, { prestige: 100 }, 'intrigue-action danger-action', false, '', { plotType: 'murder'}); createDetAct('Plot: Abduct', 'intrigue_start_plot', id, { prestige: 75 }, 'intrigue-action', false, '', { plotType: 'abduct' });
                           if (gameData.vassals.includes(id)) { const canImpr = data.status?.includes('Rebellion') || gameState.discoveredPlots.some(p => p.plotterId === id && !p.handled && p.targetId === 'player'); createDetAct('Imprison', 'char_imprison', id, {prestige:20}, 'danger-action', !canImpr, !canImpr?'(Needs Cause)':''); }
                           if (data.status?.includes('Imprisoned')) { createDetAct('Ransom', 'char_ransom', id, {prestige:10}); createDetAct('Release', 'char_release', id); createDetAct('Execute', 'char_execute', id, {prestige:-50}, 'danger-action'); }
                     } break;
                 case 'faction':
                     const leader = gameData.characters[data.leader]; title = data.name; description = data.description || `Goal: ${data.goal}. Strength: ${data.strength.toFixed(1)}%.`; if(data.ultimatumSent) description += ' <strong style="color:var(--danger-color)">Ultimatum!</strong>';
                     specificHTML += `<h3>Leader</h3><p>${leader&&!leader.hidden?createClickableSpan('character',data.leader)+` (Op: ${formatOpinion(leader.opinion)})`:'Unknown'}</p>`;
                     specificHTML += `<h3>Members (${data.members.length})</h3><ul>${data.members.map(mId => {const mem=gameData.characters[mId]; if(mem&&!mem.hidden&&mId!==data.leader) return `<li>${createClickableSpan('character',mId)} (Op: ${formatOpinion(mem.opinion)})</li>`; return '';}).join('') || '<li>Leader only.</li>'}</ul>`;
                     specificHTML += `<h3>Goal</h3><p>${data.goal}</p>`;
                      if (data.ultimatumSent) { const ultNewsId = `faction_ultimatum_${id.replace(/\W/g,'_')}`; if(gameState.newsFeedItems.some(it=>it.id===ultNewsId)){ createDetAct('Accept', 'event_option_click', ultNewsId,{},'',false,'',{optionIndex:0}); createDetAct('Refuse!', 'event_option_click', ultNewsId,{},'danger-action',false,'',{optionIndex:1}); if(leader&&!leader.hidden&&!leader.status?.includes('Imprisoned')) createDetAct('Imprison Leader', 'event_option_click', ultNewsId,{prestige:50},'intrigue-action',false,'',{optionIndex:2}); } else { specificHTML+="<p><i>Ultimatum handled.</i></p>";}}
                      else { createDetAct('Scheme: Disband', 'intrigue_start_scheme', id, {prestige:75}, 'intrigue-action', false, '', {schemeType:'disband_faction'}); if(leader&&!leader.hidden&&!leader.status?.includes('Imprisoned')) createDetAct(`Sway ${leader.name}`, 'intrigue_start_scheme', data.leader, {gold:50}, 'intrigue-action', false, '', {schemeType:'sway'}); createDetAct('Send Message', 'faction_send_message', id); }
                      break;
                case 'war':
                     title = data.name; const isPlAtk = data.attackers.includes('player'); const plScore = isPlAtk ? data.score : -data.score;
                     description = `Type: ${data.type}. War Score: <strong class="${getWarScoreClass(plScore)}">${plScore.toFixed(1)}%</strong>. ${!data.active?'(Concluded) ':''}`;
                     specificHTML += `<h3>Participants</h3><p><strong>Att:</strong> ${data.attackers.map(p=>createClickableSpan(getParticipantType(p),p)).join(', ')}</p><p><strong>Def:</strong> ${data.defenders.map(p=>createClickableSpan(getParticipantType(p),p)).join(', ')}</p>`;
                     specificHTML += `<h3>Goal (${isPlAtk?'Attackers':'Defenders'})</h3><p>${data.goal}</p>`;
                     if (data.active) { createDetAct("Engage Battle", "battle_engage", id, {}, 'view-battle-btn', false, '', {warId: id}); createDetAct('Offer Peace', 'war_sue_for_peace', id, {prestige:50}); let pAlly=Object.entries(gameData.diplomacy).find(([aId,a])=>a.alliance&&!data.attackers.includes(aId)&&!data.defenders.includes(aId)); createDetAct(`Call Ally (${pAlly?pAlly[1].name:'N/A'})`, 'war_call_ally', id, {prestige:25}, '', !pAlly, '(None/Called)', {allyId:pAlly?pAlly[0]:null}); createDetAct('Surrender', 'war_surrender', id, {prestige:-100}, 'danger-action');}
                     break;
                case 'diplomacy':
                     title = data.name; const hasTruce = gameState.activeTruces[id] > getGlobalMonth(); description = `${data.type}. Rel: ${data.status} (${formatOpinion(data.relationValue)}). ${data.atWar?'<strong style="color:var(--danger-color)">At War!</strong>':''} ${data.alliance?'<strong style="color:var(--success-color)">Ally</strong>':''} ${hasTruce?'<strong style="color:var(--info-color)">Truce</strong>':''}`;
                      specificHTML += `<h3>Details</h3><div class="detail-grid"><div class="detail-card"><h4>Military</h4><p>${data.stats?.military||'N/A'}</p></div><div class="detail-card"><h4>Economy</h4><p>${data.stats?.economy||'N/A'}</p></div><div class="detail-card"><h4>Stability</h4><p>${data.stats?.stability||'N/A'}</p></div></div>`;
                      if(hasTruce){const expD=new Date(gameState.date.year, gameState.date.month + (gameState.activeTruces[id]-getGlobalMonth())); specificHTML+=`<p><strong>Truce Expires:</strong> ${MONTH_NAMES[expD.getMonth()]} ${expD.getFullYear()}</p>`;}
                       createDetAct('Send Gift', 'diplo_send_gift', id, {gold:50}); createDetAct('Send Message', 'diplo_send_message', id);
                       if(!data.alliance&&!data.atWar&&!hasTruce) createDetAct('Offer Alliance', 'diplo_offer_alliance', id, {prestige:50},'',data.relationValue<25,'(Rel < 25)');
                       if(data.alliance) createDetAct('Break Alliance', 'diplo_break_alliance', id, {prestige:-50},'danger-action');
                       if(hasTruce) createDetAct('Break Truce', 'diplo_break_truce', id, {prestige:-150},'danger-action');
                        if(!data.atWar) { const canDecWar=!hasTruce; createDetAct('Declare War', 'diplo_declare_war',id,{},'danger-action',!canDecWar,(hasTruce?'(Truce)':''));} else {const wId=Object.keys(gameData.wars).find(wid=>gameData.wars[wid].active&&(gameData.wars[wid].attackers.includes(id)||gameData.wars[wid].defenders.includes(id))&&(gameData.wars[wid].attackers.includes('player')||gameData.wars[wid].defenders.includes('player'))); if(wId)createDetAct('Offer Peace','war_sue_for_peace',wId,{prestige:50});}
                     break;
                case 'law':
                     title = data.name; description = data.description; const isActive = gameState.activeLaws.includes(id); const canEnactCheck = checkLawRequirements(id);
                     specificHTML += `<h3>Details</h3><p><strong>Category:</strong> ${data.category}</p><p><strong>Status:</strong> <span class="status ${isActive?'active':'inactive'}">${isActive?'Active':(canEnactCheck.met?'Can Enact':'Cannot Enact')}</span></p><p><strong>Effects:</strong> ${data.effectsText||'Varies.'}</p>`;
                     if(!isActive){specificHTML+=`<p><strong>Reqs:</strong> ${getLawRequirementsText(id)||'None'}</p>`; createDetAct('Enact', 'law_enact', id, {prestige:150}, '', !canEnactCheck.met, canEnactCheck.reason);}
                      break;
            }
             uiElements.detailTitle.textContent = title; uiElements.detailDescription.innerHTML = description; uiElements.detailSpecificContent.innerHTML = specificHTML;
             if (portraitSeed && gameData.characters[id]) { uiElements.detailPortrait.style.display = 'flex'; uiElements.detailPortrait.querySelector('.placeholder-initials').textContent = portraitSeed; uiElements.detailPortrait.style.backgroundColor = getPortraitBgColor(portraitSeed); } else { uiElements.detailPortrait.style.display = 'none'; }
             updateActionButtonStates(uiElements.detailActions); showModal('detailModalOverlay');
         }

        // --- Battle Simulation ---
         function initiateBattleSimulation(warId) {
             const war = gameData.wars[warId]; if (!war?.active) { addNotification('warning', 'Cannot Battle', 'War inactive.'); return; }
             const playerArmySize = (calculateTotalLevies() * (gameState.leviesRaised ? 1 : 0)) + gameState.retinues + calculateHiredMercSize();
             const pInf = Math.floor(playerArmySize*0.5/100), pCav = Math.floor(playerArmySize*0.2/100), pArc = Math.floor(playerArmySize*0.3/100);
              const enemyLeaderId = war.attackers.includes('player') ? war.defenders[0] : war.attackers[0]; let enemyArmySize = 0;
              if (gameData.characters[enemyLeaderId]) { enemyArmySize = (100 + (gameData.characters[enemyLeaderId].stats?.mar||0)*20)*(war.attackers.length); }
              else if (gameData.diplomacy[enemyLeaderId]) { enemyArmySize = (gameData.diplomacy[enemyLeaderId].stats?.military||5)*1500; }
              enemyArmySize = Math.max(500, enemyArmySize); const eInf=Math.floor(enemyArmySize*0.6/100), eCav=Math.floor(enemyArmySize*0.15/100), eArc=Math.floor(enemyArmySize*0.25/100);
             const gridSize = Math.max(15, Math.ceil(Math.sqrt(Math.max(1,pInf+pCav+pArc,eInf+eCav+eArc)*2))+4);
             battleUnitIdCounter = 0;
             gameState.activeBattle = { warId:warId, playerUnits:[], enemyUnits:[], turn:0, playerTurn:true, gridSize:gridSize, gridPixelSize:BATTLE_GRID_SIZE, selectedUnitId:null, playerMovesMade:0, aiMovesMade:0 };
             for(let i=0;i<pInf;i++)addBattleUnit('player','infantry',gameState.activeBattle.playerUnits,gridSize); for(let i=0;i<pCav;i++)addBattleUnit('player','cavalry',gameState.activeBattle.playerUnits,gridSize); for(let i=0;i<pArc;i++)addBattleUnit('player','archer',gameState.activeBattle.playerUnits,gridSize);
             for(let i=0;i<eInf;i++)addBattleUnit('enemy','infantry',gameState.activeBattle.enemyUnits,gridSize); for(let i=0;i<eCav;i++)addBattleUnit('enemy','cavalry',gameState.activeBattle.enemyUnits,gridSize); for(let i=0;i<eArc;i++)addBattleUnit('enemy','archer',gameState.activeBattle.enemyUnits,gridSize);
             uiElements.battleTitle.textContent = `Battle: ${war.name}`; uiElements.battleOutcomeDisplay.textContent=''; uiElements.battleLog.innerHTML='<p>Battle. Your turn.</p>'; uiElements.battleEndTurnBtn.disabled=false; gameState.selectedUnitId=null;
             battleCtx = uiElements.battleCanvas.getContext('2d'); uiElements.battleCanvas.width = gridSize*BATTLE_GRID_SIZE+2*BATTLE_CANVAS_PADDING; uiElements.battleCanvas.height = gridSize*BATTLE_GRID_SIZE+2*BATTLE_CANVAS_PADDING;
             drawBattlefield(); showModal('battleModalOverlay');
         }
         function addBattleUnit(side, type, unitArray, gridSize) {
             battleUnitIdCounter++; let unit = { id:battleUnitIdCounter, side:side, type:type, hp:100, maxHp:100, attack:10, range:1, movesRemaining:1, attacksRemaining:1, x:0, y:0 };
              switch(type){case 'infantry':unit.hp=120;unit.maxHp=120;unit.attack=12;break; case 'cavalry':unit.attack=15;unit.movesRemaining=2;break; case 'archer':unit.hp=80;unit.maxHp=80;unit.attack=8;unit.range=5;break;}
               const sideLine = (side==='player')?1:gridSize-2; let placed=false;
               while(!placed){ unit.x=Math.floor(Math.random()*gridSize); unit.y=sideLine+(Math.random()>0.5?0:(side==='player'?1:-1)); unit.x=Math.max(0,Math.min(gridSize-1,unit.x)); unit.y=Math.max(0,Math.min(gridSize-1,unit.y)); if(!isTileOccupied(unit.x,unit.y)){placed=true;} }
             unitArray.push(unit);
         }
         function isTileOccupied(x,y,currentBattle){ const b=currentBattle||gameState.activeBattle; if(!b)return false; return [...b.playerUnits,...b.enemyUnits].some(u=>u.hp>0&&u.x===x&&u.y===y); }
         function drawBattlefield() { /* ... Same logic as before, with icon drawing */
            if (!battleCtx || !gameState.activeBattle) return;
            const battle = gameState.activeBattle; const { gridSize, gridPixelSize } = battle; const canvas = uiElements.battleCanvas;
            battleCtx.clearRect(0, 0, canvas.width, canvas.height);
            battleCtx.strokeStyle = 'rgba(255,255,255,0.1)'; battleCtx.lineWidth = 0.5;
            for (let i=0;i<=gridSize;i++){ battleCtx.beginPath(); battleCtx.moveTo(BATTLE_CANVAS_PADDING+i*gridPixelSize, BATTLE_CANVAS_PADDING); battleCtx.lineTo(BATTLE_CANVAS_PADDING+i*gridPixelSize, BATTLE_CANVAS_PADDING+gridSize*gridPixelSize); battleCtx.stroke(); battleCtx.beginPath(); battleCtx.moveTo(BATTLE_CANVAS_PADDING, BATTLE_CANVAS_PADDING+i*gridPixelSize); battleCtx.lineTo(BATTLE_CANVAS_PADDING+gridSize*gridPixelSize, BATTLE_CANVAS_PADDING+i*gridPixelSize); battleCtx.stroke(); }
            battle.playerUnits.forEach(drawUnit); battle.enemyUnits.forEach(drawUnit);
            if(battle.selectedUnitId){ const selU=findUnitById(battle.selectedUnitId); if(selU&&selU.hp>0){ const pX=BATTLE_CANVAS_PADDING+selU.x*gridPixelSize; const pY=BATTLE_CANVAS_PADDING+selU.y*gridPixelSize; battleCtx.strokeStyle='var(--selected-border-color)'; battleCtx.lineWidth=2; battleCtx.strokeRect(pX,pY,gridPixelSize,gridPixelSize); if(selU.movesRemaining>0){battleCtx.fillStyle='rgba(212,175,55,0.2)'; for(let dx=-selU.movesRemaining;dx<=selU.movesRemaining;dx++){for(let dy=-selU.movesRemaining;dy<=selU.movesRemaining;dy++){if(Math.abs(dx)+Math.abs(dy)<=selU.movesRemaining&&(dx!==0||dy!==0)){const tX=selU.x+dx; const tY=selU.y+dy; if(tX>=0&&tX<gridSize&&tY>=0&&tY<gridSize&&!isTileOccupied(tX,tY)){battleCtx.fillRect(BATTLE_CANVAS_PADDING+tX*gridPixelSize,BATTLE_CANVAS_PADDING+tY*gridPixelSize,gridPixelSize,gridPixelSize);}}}}} if(selU.attacksRemaining>0){battleCtx.fillStyle='rgba(176,48,48,0.3)'; const opps=selU.side==='player'?battle.enemyUnits:battle.playerUnits; opps.forEach(op=>{if(op.hp>0&&getDistance(selU,op)<=selU.range){battleCtx.fillRect(BATTLE_CANVAS_PADDING+op.x*gridPixelSize,BATTLE_CANVAS_PADDING+op.y*gridPixelSize,gridPixelSize,gridPixelSize);}});}}}
         }
        function drawUnit(unit) { /* ... Same logic as before, with icon drawing */
            if(!battleCtx||!gameState.activeBattle||unit.hp<=0)return; const{gridPixelSize}=gameState.activeBattle; const pX=BATTLE_CANVAS_PADDING+unit.x*gridPixelSize; const pY=BATTLE_CANVAS_PADDING+unit.y*gridPixelSize; const uS=gridPixelSize*0.8; const off=(gridPixelSize-uS)/2; battleCtx.fillStyle=unit.side==='player'?'var(--player-color)':'var(--enemy-color)';
            switch(unit.type){case 'infantry':battleCtx.fillRect(pX+off,pY+off,uS,uS);drawIcon(battleCtx,pX+gridPixelSize/2,pY+gridPixelSize/2,'sword');break; case 'cavalry':const cH=uS*0.7;battleCtx.fillRect(pX+off,pY+(gridPixelSize-cH)/2,uS,cH);drawIcon(battleCtx,pX+gridPixelSize/2,pY+gridPixelSize/2,'spear');break; case 'archer':battleCtx.beginPath();battleCtx.arc(pX+gridPixelSize/2,pY+gridPixelSize/2,uS/2,0,Math.PI*2);battleCtx.fill();drawIcon(battleCtx,pX+gridPixelSize/2,pY+gridPixelSize/2,'bow');break;}
            const hpBH=4; const hpP=unit.hp/unit.maxHp; battleCtx.fillStyle='#333';battleCtx.fillRect(pX+off,pY+uS+1,uS,hpBH); battleCtx.fillStyle=hpP>0.5?'var(--success-color)':(hpP>0.2?'var(--accent-color)':'var(--danger-color)'); battleCtx.fillRect(pX+off,pY+uS+1,uS*hpP,hpBH);
        }
         function drawIcon(ctx,x,y,iconType){ ctx.fillStyle='white';ctx.strokeStyle='black';ctx.lineWidth=1;ctx.font=`${gameState.activeBattle.gridPixelSize*0.5}px Arial`;ctx.textAlign='center';ctx.textBaseline='middle'; let sym='?'; switch(iconType){case 'sword':sym='⚔️';break;case 'spear':sym='→';break;case 'bow':sym='🏹';break;} ctx.fillText(sym,x,y); }
         function findUnitById(id){ if(!gameState.activeBattle)return null; return [...gameState.activeBattle.playerUnits,...gameState.activeBattle.enemyUnits].find(u=>u.id===id); }
         function findUnitAt(x,y){ if(!gameState.activeBattle)return null; return [...gameState.activeBattle.playerUnits,...gameState.activeBattle.enemyUnits].find(u=>u.hp>0&&u.x===x&&u.y===y); }
         function handleBattleCanvasClick(event) { /* ... Same logic as before */
            if(!gameState.activeBattle||!gameState.activeBattle.playerTurn)return; const battle=gameState.activeBattle; const canvas=uiElements.battleCanvas; const rect=canvas.getBoundingClientRect(); const cX=event.clientX-rect.left-BATTLE_CANVAS_PADDING; const cY=event.clientY-rect.top-BATTLE_CANVAS_PADDING; const gX=Math.floor(cX/battle.gridPixelSize); const gY=Math.floor(cY/battle.gridPixelSize); if(gX<0||gX>=battle.gridSize||gY<0||gY>=battle.gridSize)return; const clkU=findUnitAt(gX,gY);
            if(battle.selectedUnitId){const selU=findUnitById(battle.selectedUnitId); if(!selU||selU.hp<=0){battle.selectedUnitId=null;return;} if(clkU){if(clkU.side!==selU.side){handleAttackCommand(selU,clkU);}else{battle.selectedUnitId=clkU.id;addBattleLogEntry(`Selected ${clkU.type} (${clkU.id})`);}}else{handleMoveCommand(selU,gX,gY);}}else{if(clkU&&clkU.side==='player'&&clkU.hp>0){battle.selectedUnitId=clkU.id;addBattleLogEntry(`Selected ${clkU.type} (${clkU.id})`);}}
            drawBattlefield(); checkIfPlayerTurnOver();
         }
         function getDistance(u1,u2){return Math.abs(u1.x-u2.x)+Math.abs(u1.y-u2.y);}
        function handleMoveCommand(unit,tX,tY){if(!unit||unit.movesRemaining<=0||isTileOccupied(tX,tY)){addBattleLogEntry(`Cannot move ${unit.type}(${unit.id})`);return false;} const dist=Math.abs(unit.x-tX)+Math.abs(unit.y-tY); if(dist>unit.movesRemaining){addBattleLogEntry(`Cannot move ${unit.type}(${unit.id}) (Too far)`);return false;} unit.x=tX;unit.y=tY;unit.movesRemaining-=dist;unit.movesRemaining=Math.max(0,unit.movesRemaining);unit.attacksRemaining=0;gameState.activeBattle.playerMovesMade++;addBattleLogEntry(`Moved ${unit.type}(${unit.id})`);gameState.activeBattle.selectedUnitId=null;return true;}
        function handleAttackCommand(atk,def){if(!atk||atk.attacksRemaining<=0||!def||def.hp<=0){addBattleLogEntry(`Cannot attack.`);return false;} const dist=getDistance(atk,def); if(dist>atk.range){addBattleLogEntry(`${atk.type}(${atk.id}) out of range.`);return false;} let dmg=Math.max(1,Math.floor(atk.attack*(0.8+Math.random()*0.4))); def.hp=Math.max(0,def.hp-dmg); atk.attacksRemaining-=1;atk.movesRemaining=0;gameState.activeBattle.playerMovesMade++;addBattleLogEntry(`${atk.type}(${atk.id}) attacks ${def.type}(${def.id}) for ${dmg}. HP: ${def.hp}`); if(def.hp<=0)addBattleLogEntry(`${def.type}(${def.id}) defeated!`);gameState.activeBattle.selectedUnitId=null;checkBattleEndCondition();return true;}
        function checkIfPlayerTurnOver(){if(!gameState.activeBattle)return; const plUA=gameState.activeBattle.playerUnits.filter(u=>u.hp>0); const allAct=plUA.every(u=>u.movesRemaining===0&&u.attacksRemaining===0); if(allAct&&plUA.length>0)addBattleLogEntry('All units acted.'); uiElements.battleEndTurnBtn.disabled=!(plUA.some(u=>u.movesRemaining>0||u.attacksRemaining>0));}
         function handleBattleEndTurn(){if(!gameState.activeBattle||!gameState.activeBattle.playerTurn)return; addBattleLogEntry("Player Turn Ended");gameState.activeBattle.playerTurn=false;gameState.activeBattle.selectedUnitId=null;uiElements.battleEndTurnBtn.disabled=true;gameState.activeBattle.aiMovesMade=0;addBattleLogEntry("Enemy Turn");drawBattlefield();setTimeout(simulateAIBattleTurn,750);}
         function simulateAIBattleTurn() { /* ... Same logic as before */
            if(!gameState.activeBattle||gameState.activeBattle.playerTurn)return; const battle=gameState.activeBattle; const aiU=battle.enemyUnits.filter(u=>u.hp>0); const plU=battle.playerUnits.filter(u=>u.hp>0); if(aiU.length===0||plU.length===0){checkBattleEndCondition();return;}
            for(const unit of aiU){if(unit.movesRemaining>0||unit.attacksRemaining>0){let nearT=null;letminD=Infinity;plU.forEach(pU=>{const d=getDistance(unit,pU);if(d<minD){minD=d;nearT=pU;}}); if(!nearT)continue; if(unit.attacksRemaining>0&&minD<=unit.range){let dmg=Math.max(1,Math.floor(unit.attack*(0.8+Math.random()*0.4)));nearT.hp=Math.max(0,nearT.hp-dmg);unit.attacksRemaining=0;unit.movesRemaining=0;addBattleLogEntry(`Enemy ${unit.type}(${unit.id}) attacks ${nearT.type}(${nearT.id}) for ${dmg}. HP:${nearT.hp}`);if(nearT.hp<=0)addBattleLogEntry(`Player ${nearT.type}(${nearT.id}) defeated!`);}else if(unit.movesRemaining>0){let moved=false;const dx=nearT.x-unit.x;const dy=nearT.y-unit.y;if(Math.abs(dx)>Math.abs(dy)){const mX=unit.x+Math.sign(dx);if(mX>=0&&mX<battle.gridSize&&!isTileOccupied(mX,unit.y,battle)){unit.x=mX;moved=true;}}else if(Math.abs(dy)>0){const mY=unit.y+Math.sign(dy);if(mY>=0&&mY<battle.gridSize&&!isTileOccupied(unit.x,mY,battle)){unit.y=mY;moved=true;}} if(!moved&&Math.abs(dx)>0){const mX=unit.x+Math.sign(dx);if(mX>=0&&mX<battle.gridSize&&!isTileOccupied(mX,unit.y,battle)){unit.x=mX;moved=true;}}else if(!moved&&Math.abs(dy)>0){const mY=unit.y+Math.sign(dy);if(mY>=0&&mY<battle.gridSize&&!isTileOccupied(unit.x,mY,battle)){unit.y=mY;moved=true;}} if(moved){unit.movesRemaining-=1;addBattleLogEntry(`Enemy ${unit.type}(${unit.id}) moves.`);if(unit.attacksRemaining>0&&getDistance(unit,nearT)<=unit.range){let dmg=Math.max(1,Math.floor(unit.attack*(0.8+Math.random()*0.4)));nearT.hp=Math.max(0,nearT.hp-dmg);unit.attacksRemaining=0;addBattleLogEntry(`Enemy ${unit.type}(${unit.id}) attacks ${nearT.type}(${nearT.id}) after move for ${dmg}. HP:${nearT.hp}`);if(nearT.hp<=0)addBattleLogEntry(`Player ${nearT.type}(${nearT.id}) defeated!`);}}else{unit.movesRemaining=0;}}else{unit.movesRemaining=0;unit.attacksRemaining=0;} if(checkBattleEndCondition())return;}}
            addBattleLogEntry("Enemy Turn Ended");gameState.activeBattle.playerTurn=true;gameState.activeBattle.turn++; battle.playerUnits.forEach(u=>{if(u.hp>0){u.movesRemaining=(u.type==='cavalry'?2:1);u.attacksRemaining=1;}});battle.enemyUnits.forEach(u=>{if(u.hp>0){u.movesRemaining=(u.type==='cavalry'?2:1);u.attacksRemaining=1;}}); uiElements.battleEndTurnBtn.disabled=false;addBattleLogEntry(`Player Turn ${gameState.activeBattle.turn+1}`);drawBattlefield();
         }
         function checkBattleEndCondition() { /* ... Same logic as before */
            if(!gameState.activeBattle)return false; const b=gameState.activeBattle; const pUA=b.playerUnits.filter(u=>u.hp>0).length; const eUA=b.enemyUnits.filter(u=>u.hp>0).length;
            if(pUA===0||eUA===0){uiElements.battleEndTurnBtn.disabled=true; const pW=eUA===0; const oTxt=pW?'Victory!':'Defeat!'; uiElements.battleOutcomeDisplay.textContent=oTxt; uiElements.battleOutcomeDisplay.className=`battle-outcome ${pW?'win':'loss'}`; addBattleLogEntry(`Battle Over: ${oTxt}`); const wsC=pW?BATTLE_WARSCORE_IMPACT:-BATTLE_WARSCORE_IMPACT; updateWarScore(b.warId,wsC); addBattleLogEntry(`War score change: ${wsC}`); const pL=(b.playerUnits.length-pUA)*50; updatePlayerResource('manpower',-pL); addBattleLogEntry(`Lost ${pL} manpower.`); populateWarLists(); checkAlerts(); return true;} return false;
         }
         function addBattleLogEntry(msg){if(!uiElements.battleLog)return; const p=document.createElement('p');p.textContent=msg;uiElements.battleLog.appendChild(p);uiElements.battleLog.scrollTop=uiElements.battleLog.scrollHeight;}
         function closeBattleModal(){gameState.activeBattle=null;gameState.selectedUnitId=null;if(battleCtx){battleCtx.clearRect(0,0,uiElements.battleCanvas.width,uiElements.battleCanvas.height);}closeModal('battleModalOverlay');populateWarLists();}

         // --- Resource Display & Alerts ---
         function updateResourceDisplay() { /* ... Same logic as before */
            if(!setupState.setupComplete)return; const player=gameData.characters.player; uiElements.gameDate.textContent=`Date: ${gameState.date.year}/${(gameState.date.month+1).toString().padStart(2,'0')}`; uiElements.gameGold.querySelector('strong').textContent=gameState.gold.toLocaleString();uiElements.gamePrestige.querySelector('strong').textContent=gameState.prestige.toLocaleString();uiElements.gameManpower.querySelector('strong').textContent=`${gameState.manpower.toLocaleString()}/${gameState.maxManpower.toLocaleString()}`;uiElements.gameDynastyPrestige.querySelector('strong').textContent=gameState.dynastyPrestige.toLocaleString();
            let netInc=gameState.monthlyIncomeBase+gameState.monthlyIncomeModifiers; let netExp=gameState.monthlyExpensesBase+gameState.monthlyExpensesModifiers; if(gameState.leviesRaised){netExp+=gameState.raisedLevyUpkeep;}gameState.hiredMercIds.forEach(mId=>{const merc=gameData.mercenaries[mId];if(merc)netExp+=merc.costMonth;}); const mGoldChg=netInc-netExp; uiElements.gameIncome.querySelector('strong').textContent=`${mGoldChg>=0?'+':''}${mGoldChg.toFixed(1)}/m`;
            uiElements.manpowerChange.textContent=`+${gameState.manpowerGainPerMonth}/m`; uiElements.dynastyPrestigeDisplay.textContent=gameState.dynastyPrestige.toLocaleString();
            uiElements.totalLevies.textContent=calculateTotalLevies().toLocaleString(); uiElements.retinuesSize.textContent=gameState.retinues.toLocaleString(); uiElements.hiredMercsSize.textContent=calculateHiredMercSize().toLocaleString(); uiElements.manpowerPool.textContent=gameState.manpower.toLocaleString(); uiElements.raiseLeviesBtn.disabled=gameState.leviesRaised; uiElements.disbandLeviesBtn.disabled=!gameState.leviesRaised; checkAlerts(); updateActionButtonStates();
         }
         function checkAlerts() { /* ... Same logic as before, ensure createClickableSpan is used for faction/war names */
            if(!setupState.setupComplete)return; const currentMonth=getGlobalMonth();
            showAlert('alert-low-gold',`Treasury (${gameState.gold.toLocaleString()} Gold) low!`, gameState.gold<LOW_GOLD_THRESHOLD);
            showAlert('alert-low-manpower',`Manpower (${gameState.manpower.toLocaleString()}) low!`, gameState.manpower<LOW_MANPOWER_THRESHOLD);
            const lowApproval=gameState.currentPeasantApproval<REBELLION_THRESHOLD; showAlert('alert-rebellion',`Low Peasant Approval (${gameState.currentPeasantApproval}%)!`,lowApproval); if(lowApproval)uiElements.rebellionAlert.querySelector('.alert-approval-value').textContent=gameState.currentPeasantApproval;
            let dFaction=null; Object.values(gameData.factions).forEach(f=>{if(!f.hidden&&f.strength>=FACTION_DANGER_THRESHOLD){if(!dFaction||f.strength>dFaction.strength)dFaction=f;}}); showAlert('alert-faction-danger',`Faction ${dFaction?createClickableSpan('faction',dFaction.id,dFaction.name):'Faction'} powerful (${dFaction?dFaction.strength.toFixed(1):'N/A'}%)!`,!!dFaction); if(dFaction){uiElements.factionDangerAlert.querySelector('.alert-faction-name').innerHTML=createClickableSpan('faction',dFaction.id,dFaction.name);uiElements.factionDangerAlert.querySelector('.alert-faction-strength').textContent=dFaction.strength.toFixed(1);}
            let lWar=null; Object.values(gameData.wars).forEach(w=>{if(w.active){const effScore=w.attackers.includes('player')?w.score:-w.score; if(effScore<=LOSING_WAR_THRESHOLD){if(!lWar||effScore<(lWar.attackers.includes('player')?lWar.score:-lWar.score))lWar=w;}}}); showAlert('alert-war-losing',`War for ${lWar?createClickableSpan('war',lWar.id,lWar.name):'War'} going poorly (${lWar?lWar.score.toFixed(1):'N/A'}%)!`,!!lWar); if(lWar){uiElements.losingWarAlert.querySelector('.alert-war-name').innerHTML=createClickableSpan('war',lWar.id,lWar.name);uiElements.losingWarAlert.querySelector('.alert-war-score').textContent=lWar.score.toFixed(1);}
            const discPlot=gameState.discoveredPlots.find(p=>!p.handled&&p.targetId==='player'); showAlert('alert-plot-discovered',`Plot vs ${getParticipantName(discPlot?.targetId||'you')} discovered!`,!!discPlot); if(discPlot)uiElements.plotDiscoveredAlert.querySelector('.alert-plot-target').innerHTML=createClickableSpan(getParticipantType(discPlot.targetId),discPlot.targetId);
         }
         function showAlert(alertId, message, show) { const el=document.getElementById(alertId); if(!el)return; if(show){const msgEl=el.querySelector('p');if(msgEl)msgEl.innerHTML=message;el.style.display='block';}else{el.style.display='none';} }

         // --- Dynasty Functions ---
         function unlockDynastyLegacy(legacyId = 'base_prestige') {
             if(gameState.dynastyUnlockedLegacies.includes(legacyId)) { addNotification('info','Legacy Unlocked','Legacy perk already active.'); return; }
             if(legacyId === 'base_prestige') { gameData.characters.player.prestigePerMonthBonus = (gameData.characters.player.prestigePerMonthBonus || 0) + 2; gameState.dynastyUnlockedLegacies.push(legacyId); addNotification('success', 'Legacy Unlocked!', 'Dynasty Perk: +2 Prestige/month!'); uiElements.unlockLegacyBtn.disabled = true; }
             else { addNotification('warning', 'Legacy Not Found', `Legacy '${legacyId}' not defined.`); refundCost({dynastyPrestige: 500}); }
              updateResourceDisplay(); populateDynastyTab();
         }

        // --- Dummy Handler ---
        function handleDummyClick(element) { addNotification('info', 'Not Implemented', `Interacting with ${element.dataset.type} (${element.dataset.id}) NYI.`); if(['character','faction','war','diplomacy','law'].includes(element.dataset.type)) showDetailModal(element.dataset.type,element.dataset.id); }

    </script>
</body>
</html>