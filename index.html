<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crown & Blade - Interactive Expanded Mockup</title>
    <style>
        /* --- Global Styles & CK3 Aesthetic --- */
        :root {
            --bg-color: #2e2e3f; /* Darker purple/blue */
            --panel-bg: #3a3a4d; /* Slightly lighter panel bg */
            --border-color: #5a5a70;
            --text-color: #e0e0e0;
            --text-muted: #a0a0b0;
            --accent-color: #d4af37; /* Gold accent */
            --accent-hover: #f0c840;
            --danger-color: #b03030;
            --danger-hover: #d9534f;
            --success-color: #4cae4c;
            --info-color: #31708f;
            --font-main: 'Garamond', 'Times New Roman', serif; /* CK3-like serif */
            --font-heading: 'Trajan Pro', 'Cinzel', serif; /* More evocative heading font (fallback) */

            --portrait-bg-1: #6a4a3a;
            --portrait-bg-2: #4a5a6a;
            --portrait-bg-3: #7a6a4a;
            --portrait-text: #fff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        #game-ui {
            width: 100%;
            max-width: 1600px; /* Even wider for more content */
            background-color: var(--panel-bg);
            border: 2px solid var(--border-color);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        header { background-color: var(--bg-color); padding: 15px 25px; border-bottom: 2px solid var(--border-color); text-align: center; position: relative; }
        header h1 { font-family: var(--font-heading); color: var(--accent-color); font-size: 2.5em; letter-spacing: 2px; text-shadow: 1px 1px 2px #000; }

        /* --- Main Content Area --- */
        .main-content-wrapper { display: flex; flex-direction: row; }

        /* --- Tabs --- */
        nav.main-tabs { background-color: var(--bg-color); border-bottom: 2px solid var(--border-color); padding: 0 10px; }
        nav.main-tabs ul { list-style: none; display: flex; flex-wrap: wrap; }
        nav.main-tabs li button { font-family: var(--font-heading); background: none; border: none; border-bottom: 4px solid transparent; color: var(--text-muted); padding: 15px 18px; font-size: 1.0em; cursor: pointer; transition: color 0.2s ease, border-color 0.2s ease; margin-bottom: -2px; letter-spacing: 1px; white-space: nowrap; }
        nav.main-tabs li button:hover { color: var(--text-color); }
        nav.main-tabs li button.active { color: var(--accent-color); border-bottom-color: var(--accent-color); font-weight: bold; }

        /* --- Tab Content --- */
        .main-tab-content { flex-grow: 1; overflow-y: auto; max-height: calc(100vh - 150px); }
        .tab-content { display: none; padding: 25px; min-height: 500px; }
        .tab-content.active { display: block; }
        .tab-content h2 { font-family: var(--font-heading); color: var(--accent-color); margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .tab-content h3 { font-family: var(--font-heading); color: var(--text-muted); font-size: 1.3em; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px; }

        /* Clickable links */
        .clickable {
            color: var(--accent-hover);
            text-decoration: underline;
            cursor: pointer;
        }
        .clickable:hover { color: var(--accent-color); }


        /* --- Politics Section Specifics --- */
        #politics-content .ideology-sliders { margin-bottom: 30px; background-color: rgba(0,0,0, 0.1); padding: 20px; border: 1px solid var(--border-color); border-radius: 5px; }
        .slider-group { margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; gap: 15px; }
        .slider-group label { flex-basis: 120px; flex-shrink: 0; text-align: right; font-size: 1.1em; color: var(--text-muted); }
        .slider-container { flex-grow: 1; display: flex; align-items: center; }
        .slider-labels { font-size: 0.9em; color: var(--text-muted); margin: 0 10px; flex-basis: 100px; text-align: center; }
        .slider-labels:first-child { text-align: left; } .slider-labels:last-child { text-align: right; }
        input[type="range"] { flex-grow: 1; cursor: pointer; height: 8px; -webkit-appearance: none; appearance: none; background: linear-gradient(to right, var(--accent-color), var(--text-muted), var(--accent-color)); border-radius: 5px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--accent-hover); border: 2px solid var(--bg-color); border-radius: 50%; cursor: pointer; margin-top: -6px; box-shadow: 0 0 5px rgba(0,0,0,0.4); }
        input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; background: var(--accent-hover); border: 2px solid var(--bg-color); border-radius: 50%; cursor: pointer; box-shadow: 0 0 5px rgba(0,0,0,0.4); }
        .slider-value { font-weight: bold; font-size: 1.1em; color: var(--accent-color); min-width: 40px; text-align: right; }
        .peasantry-approval { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center; font-size: 1.3em; }
        .peasantry-approval strong { color: var(--accent-hover); font-size: 1.5em; margin-left: 10px; }
        .peasantry-approval strong.low-approval { color: var(--danger-color); animation: pulse-danger 1.5s infinite; }

        @keyframes pulse-danger { 0% { text-shadow: 0 0 3px var(--danger-color); } 50% { text-shadow: 0 0 10px var(--danger-hover); } 100% { text-shadow: 0 0 3px var(--danger-color); } }

        /* --- Factions & Vassals Lists --- */
        .list-section { margin-bottom: 25px; padding: 15px; background-color: rgba(0,0,0, 0.1); border: 1px solid var(--border-color); border-radius: 4px; }
        .list-section h4 { font-family: var(--font-heading); color: var(--text-muted); margin-bottom: 10px; font-size: 1.1em; }
        .scrollable-list { max-height: 250px; overflow-y: auto; padding-right: 10px; border: 1px solid rgba(0,0,0, 0.2); background-color: rgba(0,0,0, 0.1); padding: 10px; border-radius: 3px; }
        .list-item { background-color: var(--panel-bg); border: 1px solid var(--border-color); padding: 8px 12px; margin-bottom: 8px; border-radius: 3px; display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; }
        .list-item:hover { background-color: var(--bg-color); }
        .list-item strong { color: var(--accent-color); margin-right: 10px; }
        .list-item .opinion { font-weight: bold; padding: 2px 6px; border-radius: 3px; min-width: 40px; text-align: center; font-size: 0.9em;}
        .opinion.positive { background-color: var(--success-color); color: #fff; }
        .opinion.neutral { background-color: var(--text-muted); color: var(--bg-color); }
        .opinion.negative { background-color: var(--danger-color); color: #fff; }

        .faction-details { color: var(--text-muted); font-size: 0.9em; }
        .faction-details span { margin-left: 15px; }
        .faction-details .strength { font-weight: bold; color: var(--text-color); }

        /* --- Military: Wars & Mercs --- */
         #military-content .war-list .list-item { flex-direction: column; align-items: flex-start; }
         .war-info { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;}
         .war-score { font-weight: bold; font-size: 1.1em; }
         .war-score.winning { color: var(--success-color); } .war-score.losing { color: var(--danger-color); }
         .war-participants { font-size: 0.85em; color: var(--text-muted); width: 100%; }
         .war-participants strong { color: var(--text-color); }
         .view-battle-btn, .generic-action-btn {
             font-family: var(--font-main); font-size: 0.85em; padding: 4px 8px; background-color: var(--border-color); color: var(--text-color); border: 1px solid var(--bg-color); border-radius: 3px; cursor: pointer; transition: background-color 0.2s; margin-left: 10px;
         }
         .view-battle-btn:hover, .generic-action-btn:hover { background-color: var(--text-muted); }
         .hire-mercenary-btn { background-color: var(--success-color); color: white; }
         .hire-mercenary-btn:hover { background-color: #5cb85c; }

         #mercenaries-content .list-item { flex-direction: column; align-items: flex-start; }
         .mercenary-details { display: flex; justify-content: space-between; width: 100%; margin-bottom: 5px; font-size: 0.9em; }
         .mercenary-details span { margin-right: 15px; color: var(--text-muted); }
         .mercenary-details strong { color: var(--text-color); }


        /* --- Diplomacy Tab --- */
        .relations-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;}
        .relation-card { background-color: rgba(0,0,0, 0.1); border: 1px solid var(--border-color); padding: 15px; border-radius: 4px; text-align: center; cursor: pointer; transition: background-color 0.2s; }
        .relation-card:hover { background-color: rgba(0,0,0, 0.2); }
        .relation-card h5 { font-family: var(--font-heading); color: var(--accent-color); margin-bottom: 8px; }
        .relation-card p { font-size: 0.95em; margin-bottom: 5px; }
        .relation-card .opinion { display: inline-block; margin-top: 5px; }
        #diplomacy-content .list-item span { color: var(--text-muted); font-size: 0.9em; }

        /* --- Ruler Info Panel --- */
        .ruler-panel { background-color: var(--bg-color); border-left: 2px solid var(--border-color); padding: 20px; width: 350px; /* Wider */ flex-shrink: 0; display: flex; flex-direction: column; align-items: center; max-height: calc(100vh - 110px); overflow-y: auto; }
        .ruler-panel h3 { font-family: var(--font-heading); color: var(--accent-color); margin-bottom: 15px; text-align: center; }
        .ruler-portrait { width: 120px; height: 150px; background-color: #555; border: 3px solid var(--border-color); margin-bottom: 10px; display: flex; justify-content: center; align-items: center; font-size: 1.5em; font-weight: bold; color: var(--portrait-text); text-align: center; overflow: hidden; position: relative; }
        .ruler-portrait img { max-width: 100%; max-height: 100%; object-fit: cover; display: none; /* Initially hidden */ } /* Hide img if using placeholder div */
        .ruler-portrait .placeholder-initials { font-family: var(--font-heading); } /* Style the placeholder */
        .ruler-title { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .key-characters { width: 100%; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .key-characters h4 { font-family: var(--font-heading); font-size: 1.1em; color: var(--text-muted); margin-bottom: 10px; text-align: center; }
        .key-characters ul { list-style: none; }
        .key-characters li { margin-bottom: 8px; font-size: 0.95em; }
        .key-characters li strong { color: var(--text-color); margin-right: 5px; display: inline-block; min-width: 90px; } /* Align names */

        /* --- Notifications & Alerts --- */
        .notifications-alerts-container { padding: 15px 0; width: 100%; margin-top: 15px; border-top: 1px solid var(--border-color); }
        .notifications-alerts-container h4 { font-family: var(--font-heading); color: var(--text-muted); font-size: 1.1em; margin-bottom: 10px; text-align: center; }
        .notification, .alert { background-color: var(--panel-bg); border: 1px solid var(--border-color); border-left: 5px solid var(--accent-color); padding: 10px 15px; margin-bottom: 10px; border-radius: 3px; position: relative; font-size: 0.9em; transition: opacity 0.3s ease-out; }
        .alert { border-left-color: var(--danger-color); background-color: rgba(176, 48, 48, 0.1); }
        .notification.success { border-left-color: var(--success-color); background-color: rgba(76, 174, 76, 0.1); }
        .notification.info { border-left-color: var(--info-color); background-color: rgba(49, 112, 143, 0.1); }
        .notification.warning { border-left-color: var(--accent-hover); background-color: rgba(212, 175, 55, 0.1); }
        .notification h5, .alert h5 { font-family: var(--font-heading); margin-bottom: 5px; color: var(--text-color); font-size: 1em; }
        .alert h5 { color: var(--danger-color); } .notification.success h5 { color: var(--success-color); } .notification.info h5 { color: var(--info-color); } .notification.warning h5 { color: var(--accent-hover); }
        .dismiss-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; color: var(--text-muted); font-size: 1.2em; cursor: pointer; line-height: 1; padding: 2px 5px; }
        .dismiss-btn:hover { color: var(--text-color); }

        /* --- Event Trigger Button --- */
         #event-trigger-section { margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border-color); text-align: center; }
         #trigger-event-btn { font-family: var(--font-main); background-color: var(--accent-color); color: var(--bg-color); border: 1px solid var(--accent-hover); padding: 8px 15px; font-size: 1em; cursor: pointer; border-radius: 4px; transition: background-color 0.2s ease; }
         #trigger-event-btn:hover { background-color: var(--accent-hover); border-color: var(--accent-color); }

        /* --- Modal Styles (Generic & Event) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.75); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; /* Add padding for smaller screens */ }
        .modal-content { background-color: var(--panel-bg); border: 3px solid var(--border-color); border-radius: 5px; padding: 30px; width: 90%; max-width: 650px; /* Slightly wider */ box-shadow: 0 5px 20px rgba(0,0,0,0.6); color: var(--text-color); max-height: 90vh; overflow-y: auto; position: relative; /* For close button */ }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; color: var(--text-muted); font-size: 1.8em; line-height: 1; cursor: pointer; }
        .modal-close-btn:hover { color: var(--text-color); }
        .modal-content h2 { font-family: var(--font-heading); color: var(--accent-color); text-align: center; margin-bottom: 20px; font-size: 1.8em; }
        .modal-content h3 { font-family: var(--font-heading); color: var(--text-muted); font-size: 1.3em; margin-top: 20px; margin-bottom: 10px; border-bottom: 1px dashed var(--border-color); padding-bottom: 5px; }
        .modal-content p { margin-bottom: 15px; line-height: 1.7; font-size: 1.05em; }
        .modal-section { margin-bottom: 20px; }
        .modal-section ul { list-style: inside; margin-left: 10px; }
        .modal-section li { margin-bottom: 5px; }
        .modal-portrait { float: right; width: 100px; height: 125px; background-color: #444; border: 2px solid var(--border-color); margin-left: 20px; margin-bottom: 15px; display: flex; justify-content: center; align-items: center; font-size: 1.2em; font-weight: bold; color: var(--portrait-text); text-align: center; overflow: hidden; }
        .modal-portrait .placeholder-initials { font-family: var(--font-heading); }

        .modal-options { display: flex; flex-direction: column; gap: 15px; margin-top: 25px; }
        .modal-options button { font-family: var(--font-main); background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 12px 20px; font-size: 1.05em; cursor: pointer; border-radius: 4px; transition: background-color 0.2s ease, border-color 0.2s ease; text-align: left; }
        .modal-options button:hover { background-color: var(--accent-color); border-color: var(--accent-hover); color: var(--bg-color); }
        .modal-options button .outcome-hint { display: block; font-size: 0.85em; color: var(--text-muted); margin-top: 4px; font-style: italic; }
        .modal-options button:hover .outcome-hint { color: var(--bg-color); opacity: 0.9; }

        /* --- Detail Modal Specifics --- */
        #detail-modal-content .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        #detail-modal-content .detail-card { background-color: rgba(0,0,0, 0.1); padding: 10px; border-radius: 3px; border: 1px solid var(--border-color); }
        #detail-modal-content .detail-card h4 { font-family: var(--font-heading); color: var(--text-muted); font-size: 1em; margin-bottom: 5px; }

         /* --- Battle Modal Specifics --- */
         #battle-modal-overlay .modal-content { max-width: 900px; /* Wider for battle */ }
         .battle-map { height: 400px; background-color: #5a6e5a; /* Greenish field */ border: 2px solid var(--border-color); margin-bottom: 20px; position: relative; overflow: hidden; /* Prevent units going outside */ }
         .battle-unit { position: absolute; border: 1px solid black; display: flex; justify-content: center; align-items: center; font-size: 0.7em; color: white; cursor: pointer; transition: border-color 0.2s, transform 0.1s; }
         .battle-unit.infantry { width: 30px; height: 30px; background-color: #4682B4; /* Steel Blue */ }
         .battle-unit.cavalry { width: 45px; height: 25px; background-color: #8B4513; /* Saddle Brown */ }
         .battle-unit.archer { width: 28px; height: 28px; background-color: #228B22; /* Forest Green */ }
         .battle-unit.player { border: 2px solid var(--accent-hover); }
         .battle-unit.enemy { border: 2px solid var(--danger-color); }
         .battle-unit.selected { border: 3px solid yellow; transform: scale(1.1); z-index: 10; }
         /* Simple positions (replace with dynamic later) */
         .battle-unit[data-unit-id="p_inf1"] { bottom: 20px; left: 100px; }
         .battle-unit[data-unit-id="p_inf2"] { bottom: 20px; left: 150px; }
         .battle-unit[data-unit-id="p_cav1"] { bottom: 20px; left: 220px; }
         .battle-unit[data-unit-id="p_arc1"] { bottom: 60px; left: 125px; }
         .battle-unit[data-unit-id="e_inf1"] { top: 20px; right: 100px; }
         .battle-unit[data-unit-id="e_inf2"] { top: 20px; right: 150px; }
         .battle-unit[data-unit-id="e_cav1"] { top: 20px; right: 220px; }

         .battle-commands { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;}
         .battle-commands button { font-family: var(--font-main); background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 8px 15px; font-size: 0.95em; cursor: pointer; border-radius: 4px; }
         .battle-commands button:hover { background-color: var(--text-muted); color: var(--bg-color); }
         .battle-log { height: 100px; background-color: rgba(0,0,0,0.2); border: 1px solid var(--border-color); padding: 10px; overflow-y: auto; font-size: 0.85em; color: var(--text-muted); margin-top: 15px; }
         .battle-log p { margin-bottom: 3px; }

        /* --- Scrollbar Styling --- */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    </style>
</head>
<body>

    <div id="game-ui">
        <header>
            <h1>Crown & Blade</h1>
            <!-- Date/Speed controls could go here -->
        </header>

        <nav class="main-tabs">
            <ul>
                <li><button class="tab-button" data-tab="military">Military</button></li>
                <li><button class="tab-button active" data-tab="politics">Politics</button></li>
                <li><button class="tab-button" data-tab="diplomacy">Diplomacy</button></li>
                <li><button class="tab-button" data-tab="laws">Laws</button></li>
                <li><button class="tab-button" data-tab="dynasty">Dynasty</button></li>
                <li><button class="tab-button" data-tab="mercenaries">Mercenaries</button></li>
                 <!-- Add more tabs like Council, Intrigue, Religion if needed -->
            </ul>
        </nav>

        <div class="main-content-wrapper">
            <div class="main-tab-content">
                <!-- Military Tab Content -->
                <div id="military-content" class="tab-content">
                    <h2>Military Overview</h2>

                    <h3>Current Wars</h3>
                     <div class="list-section war-list" id="military-war-list">
                         <!-- Wars will be populated by JS -->
                    </div>

                    <h3>Armies & Levies</h3>
                    <p style="color: var(--text-muted); font-style: italic;">Details about levies (size, replenishment), retinues/men-at-arms (composition, stats), garrisons, and recruitment options would appear here.</p>

                    <h3>Generals</h3>
                    <div class="list-section">
                        <div class="scrollable-list" id="generals-list">
                            <div class="list-item">
                                <span><strong class="clickable" data-type="character" data-id="generic_general_1">Commander Valerius</strong> (Loyal, Cautious Tactician)</span>
                                <span class="opinion positive">+80 Loyalty</span>
                            </div>
                             <div class="list-item">
                                <span><strong class="clickable" data-type="character" data-id="generic_general_2">Lord Marshal Evard</strong> (Ambitious, Aggressive Attacker)</span>
                                <span class="opinion neutral">+15 Loyalty</span>
                            </div>
                            <div class="list-item">
                                <span><strong class="clickable" data-type="character" data-id="generic_general_3">Ser Kaelen</strong> (Inexperienced, Brave)</span>
                                <span class="opinion positive">+55 Loyalty</span>
                            </div>
                            <!-- More Generals -->
                        </div>
                    </div>
                </div>

                <!-- Politics Tab Content (Active by default) -->
                <div id="politics-content" class="tab-content active">
                    <h2>Politics & Ideology</h2>
                    <div class="ideology-sliders">
                         <h3>Realm Ideology</h3>
                         <!-- Sliders remain the same -->
                         <div class="slider-group">
                            <label for="order-freedom-slider">Authority:</label>
                            <div class="slider-container"> <span class="slider-labels">Order</span> <input type="range" id="order-freedom-slider" min="0" max="100" value="65" step="1"> <span class="slider-labels">Freedom</span> </div> <span class="slider-value" id="order-freedom-value">65</span>
                        </div>
                        <div class="slider-group">
                            <label for="central-decentral-slider">Governance:</label>
                            <div class="slider-container"> <span class="slider-labels">Centralized</span> <input type="range" id="central-decentral-slider" min="0" max="100" value="70" step="1"> <span class="slider-labels">Decentralized</span> </div> <span class="slider-value" id="central-decentral-value">70</span>
                        </div>
                        <div class="slider-group">
                            <label for="aristo-egal-slider">Society:</label>
                            <div class="slider-container"> <span class="slider-labels">Aristocratic</span> <input type="range" id="aristo-egal-slider" min="0" max="100" value="30" step="1"> <span class="slider-labels">Egalitarian</span> </div> <span class="slider-value" id="aristo-egal-value">30</span>
                        </div>
                         <div class="peasantry-approval">
                            Peasantry Approval: <strong id="peasantry-approval-value">59%</strong>
                        </div>
                    </div>

                    <h3>Active Factions</h3>
                    <div class="list-section" id="faction-list">
                        <!-- Factions populated by JS -->
                    </div>

                    <h3>Vassals</h3>
                     <div class="list-section">
                        <h4>Direct Vassals (<span id="vassal-count">0</span>)</h4>
                         <div class="scrollable-list" id="vassal-list">
                             <!-- Vassals populated by JS -->
                         </div>
                     </div>
                </div>

                 <!-- Diplomacy Tab Content -->
                <div id="diplomacy-content" class="tab-content">
                    <h2>Diplomacy & Relations</h2>
                    <h3>Relations Overview</h3>
                    <div class="relations-overview" id="relations-overview-grid">
                        <!-- Relation cards populated by JS -->
                    </div>

                     <h3>Alliances</h3>
                     <div class="list-section" id="alliances-list">
                         <!-- Alliances populated by JS -->
                    </div>

                     <h3>Enemies & Rivals</h3>
                     <div class="list-section" id="enemies-list">
                          <!-- Enemies populated by JS -->
                    </div>

                     <h3>Neighboring Realms & Tribes</h3>
                     <div class="list-section">
                         <div class="scrollable-list" id="neighbors-list">
                            <!-- Neighbors populated by JS -->
                         </div>
                     </div>
                </div>

                <!-- Laws Tab Content -->
                <div id="laws-content" class="tab-content">
                    <h2>Laws & Edicts</h2>
                     <h3>Realm Laws</h3>
                     <p>Crown Authority: <strong style="color: var(--accent-hover);">High (Level 3)</strong></p>
                     <p>Succession Law: <strong style="color: var(--accent-hover);">Primogeniture</strong></p>
                     <p>Vassal Obligations: <strong style="color: var(--accent-hover);">Balanced Tax/Levy</strong></p>
                     <p style="color: var(--text-muted); font-style: italic; margin-top: 10px;">Further details and options to change laws would appear here.</p>
                     <h3>Edicts</h3>
                     <p style="color: var(--text-muted); font-style: italic;">Temporary realm-wide or province-specific buffs/debuffs (e.g., Increased Fortification, Harsh Taxes).</p>
                     <button class="generic-action-btn">Issue Edict (Placeholder)</button>
                </div>

                <!-- Dynasty Tab Content -->
                <div id="dynasty-content" class="tab-content">
                    <h2>Dynasty & Legacy</h2>
                    <h3>House Eldor</h3>
                     <p>Dynasty Head: <strong class="clickable" data-type="character" data-id="player">King Aldric 'the Wise'</strong></p>
                     <p>Members: 35 | Cadet Branches: 2 (House Corvin, House Ashwood)</p>
                     <p>Dynasty Prestige: 1250</p>

                     <h3>Dynasty Legacy</h3>
                     <p style="color: var(--text-muted); font-style: italic;">Tree showing unlocked dynasty perks (e.g., Bloodlines: +1 Prowess, Warfare Focus: +5% Levy Size, Intrigue Focus: +1 Intrigue Skill).</p>
                     <button class="generic-action-btn">View Legacy Tree (Placeholder)</button>

                     <h3>Family Tree</h3>
                     <p style="color: var(--text-muted); font-style: italic;">Visual representation of the family.</p>
                     <button class="generic-action-btn">View Family Tree (Placeholder)</button>

                     <h3>Dynasty Interactions</h3>
                     <div style="margin-top: 20px;">
                        <button class="generic-action-btn" data-action="dynasty_arrange_marriage">Arrange Marriage</button>
                        <button class="generic-action-btn" data-action="dynasty_educate_child">Educate Child</button>
                        <button class="generic-action-btn" data-action="dynasty_request_claim">Request Claim</button>
                        <button class="generic-action-btn" data-action="dynasty_grant_title">Grant Title to Member</button>
                     </div>
                </div>

                 <!-- Mercenaries Tab Content -->
                <div id="mercenaries-content" class="tab-content">
                    <h2>Available Mercenaries</h2>
                    <div class="list-section" id="mercenary-list">
                        <!-- Mercenaries populated by JS -->
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.9em;">Mercenary availability and cost may fluctuate based on realm stability and ongoing wars.</p>
                </div>

            </div>

            <!-- Right Panel: Ruler Info, Notifications, Alerts -->
            <aside class="ruler-panel">
                <div class="ruler-portrait" id="ruler-portrait-container" style="background-color: var(--portrait-bg-1);">
                    <!-- Placeholder for actual portrait -->
                    <span class="placeholder-initials" id="ruler-initials">AW</span>
                    <img src="" alt="Ruler Portrait" id="ruler-portrait-img"> <!-- Img tag for potential future use -->
                </div>
                <h3 class="ruler-title" id="ruler-name-title">King Aldric 'the Wise'</h3>

                <div class="key-characters">
                    <h4>Council & Court</h4>
                    <ul id="council-court-list">
                        <!-- Populated by JS -->
                    </ul>
                </div>

                <div class="notifications-alerts-container">
                    <div id="notifications">
                        <h4>Notifications</h4>
                        <!-- Notifications will be added dynamically by JS -->
                         <div class="notification info" id="notif-default-1">
                            <button class="dismiss-btn" data-target="notif-default-1">×</button>
                            <h5>Trade Route Established</h5>
                            <p>New trade route with Port Azure increases income.</p>
                        </div>
                    </div>
                    <div id="alerts" style="margin-top: 20px;">
                         <h4>Alerts</h4>
                         <div class="alert" id="alert-rebellion" style="display: none;">
                            <button class="dismiss-btn" data-target="alert-rebellion">×</button>
                            <h5>Rebellion Warning!</h5>
                            <p>Low Peasantry Approval (<span class="alert-approval-value">N/A</span>%) causes unrest! Risk of revolt soon!</p>
                         </div>
                          <div class="alert" id="alert-faction-danger" style="display: none;"> <!-- Initially hidden, shown by JS if needed -->
                            <button class="dismiss-btn" data-target="alert-faction-danger">×</button>
                            <h5>Dangerous Faction!</h5>
                            <p>The <span class="alert-faction-name">Faction</span> is powerful (<span class="alert-faction-strength">N/A</span>%) and may issue an ultimatum!</p>
                         </div>
                         <div class="alert" id="alert-low-gold" style="opacity: 0.7;">
                            <button class="dismiss-btn" data-target="alert-low-gold">×</button>
                            <h5>Low Gold Reserves</h5>
                            <p>Your treasury (55 Gold) is running low!</p>
                         </div>
                    </div>
                    <div id="event-trigger-section">
                        <button id="trigger-event-btn">Trigger Random Event</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Event Modal Structure -->
    <div class="modal-overlay" id="event-modal-overlay">
        <div class="modal-content" id="event-modal-content">
            <button class="modal-close-btn" onclick="closeModal('event-modal-overlay')">×</button>
            <h2 id="event-title">Event Title</h2>
            <p id="event-description">Event description goes here.</p>
            <div class="modal-options" id="event-options">
                <!-- Option buttons added by JS -->
            </div>
        </div>
    </div>

     <!-- Detail Modal Structure (for Characters, Factions, Wars, Diplomacy) -->
    <div class="modal-overlay" id="detail-modal-overlay">
        <div class="modal-content" id="detail-modal-content">
             <button class="modal-close-btn" onclick="closeModal('detail-modal-overlay')">×</button>
             <h2 id="detail-title">Detail View</h2>
             <div id="detail-portrait" class="modal-portrait" style="display: none;">
                 <span class="placeholder-initials">??</span>
             </div>
             <p id="detail-description">Details will load here.</p>
             <div id="detail-specific-content">
                 <!-- Specific sections (like alliances, members, history) added by JS -->
             </div>
             <div id="detail-actions" class="modal-options" style="margin-top: 25px;">
                 <!-- Action buttons relevant to the detail view (e.g., Diplomacy options) added by JS -->
             </div>
        </div>
    </div>

    <!-- Battle Modal Structure -->
    <div class="modal-overlay" id="battle-modal-overlay">
        <div class="modal-content" id="battle-modal-content">
             <button class="modal-close-btn" onclick="closeModal('battle-modal-overlay')">×</button>
             <h2 id="battle-title">Battle Simulation</h2>
             <div class="battle-map" id="battle-map">
                 <!-- Units Added by JS -->
                  <div class="battle-unit player infantry selected" data-unit-id="p_inf1" style="bottom: 30px; left: 15%;">I</div>
                  <div class="battle-unit player infantry" data-unit-id="p_inf2" style="bottom: 30px; left: 25%;">I</div>
                  <div class="battle-unit player cavalry" data-unit-id="p_cav1" style="bottom: 30px; left: 5%;">C</div>
                  <div class="battle-unit player archer" data-unit-id="p_arc1" style="bottom: 70px; left: 20%;">A</div>

                  <div class="battle-unit enemy infantry" data-unit-id="e_inf1" style="top: 30px; right: 15%;">I</div>
                  <div class="battle-unit enemy infantry" data-unit-id="e_inf2" style="top: 30px; right: 25%;">I</div>
                  <div class="battle-unit enemy cavalry" data-unit-id="e_cav1" style="top: 30px; right: 5%;">C</div>
             </div>
             <div class="battle-commands">
                <button onclick="battleCommand('select_all')">Select All</button>
                <button onclick="battleCommand('attack')">Attack</button>
                <button onclick="battleCommand('charge')">Charge</button>
                <button onclick="battleCommand('defend')">Defend</button>
                <button onclick="battleCommand('formation_line')">Formation: Line</button>
                <button onclick="battleCommand('formation_wedge')">Formation: Wedge</button>
                <button onclick="battleCommand('delegate')">Delegate to General</button>
             </div>
             <p><strong>Selected Unit:</strong> <span id="selected-unit-info">Infantry 1</span></p>
             <p style="font-size: 0.9em; color: var(--text-muted)">Right-click on map to issue move order (visual simulation only).</p>
             <div class="battle-log" id="battle-log">
                 <p>Battle Start! War for the Duchy of Edessa.</p>
             </div>
        </div>
    </div>


    <script>
        // --- Mock Data --- (Ideally loaded from elsewhere)
        const gameData = {
            characters: {
                "player": { name: "Aldric", epithet: "the Wise", title: "King", portraitSeed: "AW", opinion: null, description: "The current ruler of Eldoria. Known for his calculated decisions, though some find him overly cautious.", relations: [], history: ["Ascended the throne after his father's untimely death.", "Successfully navigated the Great Famine of year 10.", "Currently facing pressure from internal factions and external threats."] },
                "elara": { name: "Elara", title: "Queen", portraitSeed: "QE", opinion: 85, description: "King Aldric's wife. Diplomatic and well-liked at court.", relations: ["Spouse: King Aldric"], history: ["Marriage secured an alliance with a powerful duchy (now integrated)."] },
                "edgar": { name: "Edgar", title: "Prince", portraitSeed: "PE", opinion: 60, description: "Heir to the throne. Young and eager, but lacks experience.", relations: ["Father: King Aldric", "Mother: Queen Elara"], history: ["Currently undergoing tutelage by Maester Loras."] },
                "borin": { name: "Borin", title: "Duke", location: "Iron Hills", portraitSeed: "DB", opinion: 75, description: "Loyal and stalwart vassal, Chancellor of the realm.", relations: ["Liege: King Aldric", "Council Position: Chancellor"], history: ["Fought alongside Aldric's father.", "Holds significant military power."] },
                "emeric": { name: "Emeric", title: "Count", location: "Silverford", portraitSeed: "CE", opinion: 42, description: "Competent military commander, currently serving as Marshal.", relations: ["Liege: King Aldric", "Council Position: Marshal"], history: ["Won distinction in the last border skirmish."] },
                "theron": { name: "Theron", title: "Bishop", location: "Holy See", portraitSeed: "BT", opinion: 50, description: "Influential religious figure, serves as Steward.", relations: ["Liege: King Aldric", "Council Position: Steward"], history: ["Balances realm finances with religious duties."] },
                "anais": { name: "Anais", title: "Baroness", location: "Riverbend", portraitSeed: "BA", opinion: 25, description: "Cunning and discreet, the realm's Spymaster.", relations: ["Liege: King Aldric", "Council Position: Spymaster"], history: ["Uncovered several plots against the crown."] },
                "loras": { name: "Loras", title: "Maester", portraitSeed: "ML", opinion: 70, description: "Learned scholar, Court Tutor.", relations: ["Employer: King Aldric"], history: ["Educated many nobles of the realm."] },
                "morwen": { name: "Morwen", title: "Wicte", portraitSeed: "WM", opinion: 40, description: "Skilled healer, Court Physician, knowledgeable in old ways.", relations: ["Employer: King Aldric"], history: ["Her methods are effective but sometimes viewed with suspicion."] },
                "rhys": { name: "Rhys", title: "Duke", location: "Corvia", portraitSeed: "DR", opinion: -65, description: "Ambitious and disgruntled vassal, leads the Independence Faction.", relations: ["Liege: King Aldric", "Faction Leader: Independence", "Rival: King Aldric"], history: ["Believes his duchy deserves more autonomy.", "Constantly tests the limits of crown authority."] },
                "gautier": { name: "Gautier", title: "Duke", location: "Edessa", portraitSeed: "DG", opinion: -100, description: "Rebellious vassal currently at war with the crown.", relations: ["Liege: King Aldric (Nominally)", "Status: In Rebellion"], history: ["Claimed independence over a succession dispute."] },
                "isolde_n": { name: "Isolde", title: "Duchess", location: "Northmarch", portraitSeed: "DN", opinion: 30, description: "Powerful northern vassal, leads a claimant faction.", relations: ["Liege: King Aldric", "Faction Leader: Claimant (Prince Edgar)"], history: ["Related to the royal family through a cadet branch."] },
                "gregor": { name: "Gregor", title: "Mayor", location: "Oakhaven", portraitSeed: "MG", opinion: -22, description: "Represents the interests of commoners and burghers, leads the Populist Faction.", relations: ["Liege: King Aldric", "Faction Leader: Populist"], history: ["Rose from humble beginnings.", "Advocates for lower taxes and more rights."] },
                "lyra": { name: "Lyra", title: "Countess", location: "Greenwater", portraitSeed: "CL", opinion: -5, description: "Vassal known for managing her lands effectively.", relations: ["Liege: King Aldric"], history: ["Involved in minor disputes with neighbors."] },
                "finnian": { name: "Finnian", title: "Baron", location: "Blackwood", portraitSeed: "BF", opinion: -40, description: "Grumpy and isolated vassal.", relations: ["Liege: King Aldric"], history: ["Feels ignored by the crown."] },
                "generic_general_1": { name: "Valerius", title: "Commander", portraitSeed: "CV", opinion: 80, description: "A loyal and experienced general, known for his cautious approach.", relations: [], history: ["Served for 20 years."] },
                "generic_general_2": { name: "Evard", title: "Lord Marshal", portraitSeed: "LE", opinion: 15, description: "Highly ambitious but skilled commander, favors aggressive tactics.", relations: [], history: ["Gained renown quickly."] },
                "generic_general_3": { name: "Kaelen", title: "Ser", portraitSeed: "SK", opinion: 55, description: "Young knight recently promoted to command, brave but lacks experience.", relations: [], history: ["Distinguished himself in a recent duel."] },
            },
            factions: {
                "independence": { name: "Independence Faction", leader: "rhys", goal: "Lower Crown Authority", strength: 115, members: ["rhys", "finnian", "gautier"] },
                "claimant_edgar": { name: "Claimant Faction (Prince Edgar)", leader: "isolde_n", goal: "Install Prince Edgar as King", strength: 45, members: ["isolde_n"] },
                "populist": { name: "Populist Faction", leader: "gregor", goal: "Increase Peasant Rights & Lower Taxes", strength: 60, members: ["gregor"] },
                "rebel_peasant": { name: "Peasant Rebellion", leader: "Unknown", goal: "Overthrow Oppressive Rule", strength: 0, members: [], hidden: true} // Initially hidden
            },
            wars: {
                "edessa_war": { name: "War for the Duchy of Edessa", type: "Offensive Rebellion Suppression", score: 35, attackers: ["player"], defenders: ["gautier"], goal: "Reassert Control over Edessa", active: true },
                "valorian_war": { name: "Border Skirmish with Valorian Tribes", type: "Defensive Border War", score: -12, attackers: ["valorian_tribes"], defenders: ["player"], goal: "Defend Borders / Repel Invaders", active: true },
                 "peasant_revolt": { name: "The Great Peasant Revolt", type: "Defensive Rebellion Suppression", score: 0, attackers: ["rebel_peasant"], defenders: ["player"], goal: "Crush the Peasant Uprising", active: false } // Initially inactive
            },
            diplomacy: {
                "solara": { name: "Empire of Solara", type: "Neighboring Power", relationValue: -25, status: "Wary", opinionClass: "neutral" },
                "aeridor": { name: "Kingdom of Aeridor", type: "Ally", relationValue: 60, status: "Friendly", opinionClass: "positive", alliance: true, allianceType: "Marriage: Your sister to their King" },
                "valorian_tribes": { name: "Valorian Tribes", type: "Hostile Neighbor", relationValue: -80, status: "Hostile", opinionClass: "negative", atWar: true },
                "free_cities": { name: "Free Cities of the Coast", type: "Trade Partners", relationValue: 40, status: "Amicable", opinionClass: "positive" },
                "northern_clans": { name: "Northern Clans", type: "Tribal Neighbors", relationValue: -5, status: "Neutral", opinionClass: "neutral" },
                "sylvani": { name: "Kingdom of Sylvani", type: "Feudal Neighbor", relationValue: 0, status: "Neutral", opinionClass: "neutral"},
            },
             mercenaries: {
                "golden_company": { name: "Golden Company", size: 5000, composition: "Heavy Infantry, Crossbows", costHire: 300, costMonth: 50, leader: "Captain Valerius", available: true },
                "stormcrows": { name: "Stormcrows", size: 3000, composition: "Light Cavalry, Archers", costHire: 200, costMonth: 40, leader: "Commander Zara", available: true },
                "iron_legion": { name: "Iron Legion", size: 6000, composition: "Pikemen, Heavy Infantry", costHire: 350, costMonth: 55, leader: "Centurion Marius", available: false }, // Example unavailable
                "whispering_blades": { name: "Whispering Blades", size: 1000, composition: "Skirmishers, Assassins (Intrigue bonus?)", costHire: 400, costMonth: 60, leader: "Shadowmaster Kael", available: true },
            },
            vassals: [ // Array for easier listing
                "gautier", "rhys", "isolde_n", "borin", "emeric", "lyra", "finnian", "gregor", "theron", // Simplified list for example
                // Add more character IDs here if defined above
            ]
        };

        // --- Global State (Very Simple) ---
        let currentPeasantApproval = 59;
        const REBELLION_THRESHOLD = 30; // Lowered threshold for easier testing
        const FACTION_DANGER_THRESHOLD = 80;
        let notificationIdCounter = 10;
        let lowApprovalTurns = 0; // Counter for consecutive low approval

        // --- DOM Elements ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const peasantryApprovalDisplay = document.getElementById('peasantry-approval-value');
        const rebellionAlert = document.getElementById('alert-rebellion');
        const alertApprovalValueSpan = rebellionAlert.querySelector('.alert-approval-value');
        const factionDangerAlert = document.getElementById('alert-faction-danger');
        const alertFactionNameSpan = factionDangerAlert.querySelector('.alert-faction-name');
        const alertFactionStrengthSpan = factionDangerAlert.querySelector('.alert-faction-strength');
        const notificationsContainer = document.getElementById('notifications');
        const alertsContainer = document.getElementById('alerts');
        const triggerEventButton = document.getElementById('trigger-event-btn');

        const eventModalOverlay = document.getElementById('event-modal-overlay');
        const eventTitle = document.getElementById('event-title');
        const eventDescription = document.getElementById('event-description');
        const eventOptionsContainer = document.getElementById('event-options');

        const detailModalOverlay = document.getElementById('detail-modal-overlay');
        const detailTitle = document.getElementById('detail-title');
        const detailDescription = document.getElementById('detail-description');
        const detailPortrait = document.getElementById('detail-portrait');
        const detailSpecificContent = document.getElementById('detail-specific-content');
        const detailActions = document.getElementById('detail-actions');

        const battleModalOverlay = document.getElementById('battle-modal-overlay');
        const battleTitle = document.getElementById('battle-title');
        const battleMap = document.getElementById('battle-map');
        const battleLog = document.getElementById('battle-log');
        const selectedUnitInfo = document.getElementById('selected-unit-info');

        const rulerPortraitContainer = document.getElementById('ruler-portrait-container');
        const rulerInitials = document.getElementById('ruler-initials');
        const rulerNameTitle = document.getElementById('ruler-name-title');
        const councilCourtList = document.getElementById('council-court-list');

        // --- Utility Functions ---
        function showModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        function getOpinionClass(opinion) {
            if (opinion > 25) return 'positive';
            if (opinion < -25) return 'negative';
            return 'neutral';
        }
         function getPortraitBgColor(seed) {
            // Simple hash function for variety
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                hash = seed.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % 3 + 1; // Use 3 predefined colors
            return `var(--portrait-bg-${index})`;
         }

         function addBattleLogEntry(message) {
            const p = document.createElement('p');
            p.textContent = message;
            battleLog.appendChild(p);
            battleLog.scrollTop = battleLog.scrollHeight; // Scroll to bottom
         }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            setupTabs();
            setupSliders();
            setupDismissals();
            setupClickHandlers(); // For clickable names/wars etc.
            populateRulerPanel();
            populateVassalList();
            populateFactionList();
            populateWarLists();
            populateDiplomacy();
            populateMercenaries();
            updatePeasantryApproval(0); // Initial calculation and alert check
            setupBattleMapInteraction();

            triggerEventButton.addEventListener('click', triggerRandomEvent);
        });

        // --- Setup Functions ---
        function setupTabs() {
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(targetTab + '-content').classList.add('active');
                });
            });
        }

        function setupSliders() {
            const sliders = [
                { id: 'order-freedom-slider', valueId: 'order-freedom-value' },
                { id: 'central-decentral-slider', valueId: 'central-decentral-value' },
                { id: 'aristo-egal-slider', valueId: 'aristo-egal-value' }
            ];
            sliders.forEach(sliderInfo => {
                const sliderElement = document.getElementById(sliderInfo.id);
                const valueDisplay = document.getElementById(sliderInfo.valueId);
                if (sliderElement && valueDisplay) {
                    valueDisplay.textContent = sliderElement.value; // Initial display
                    sliderElement.addEventListener('input', () => {
                        valueDisplay.textContent = sliderElement.value;
                        calculatePeasantryApproval(); // Recalculate based on slider values
                    });
                }
            });
        }

        function setupDismissals() {
             const notificationsAlertsContainer = document.querySelector('.notifications-alerts-container');
             notificationsAlertsContainer.addEventListener('click', function(event) {
                if (event.target.classList.contains('dismiss-btn')) {
                    const targetId = event.target.getAttribute('data-target');
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                         targetElement.style.opacity = '0';
                         setTimeout(() => targetElement.remove(), 300);
                    }
                }
            });
        }

         function setupClickHandlers() {
            const mainContent = document.querySelector('.main-content-wrapper'); // Delegate from a higher parent

            mainContent.addEventListener('click', (event) => {
                const target = event.target;

                // Handle clickable names (characters/factions)
                if (target.classList.contains('clickable') && target.dataset.id) {
                    const type = target.dataset.type; // 'character', 'faction', 'war', 'diplomacy'
                    const id = target.dataset.id;
                    showDetailModal(type, id);
                }
                // Handle "View Battle" button
                else if (target.classList.contains('view-battle-btn') && target.dataset.warId) {
                    const warId = target.dataset.warId;
                    showBattleModal(warId);
                }
                 // Handle generic action buttons (like diplomacy, hire merc)
                 else if (target.classList.contains('generic-action-btn') || target.classList.contains('hire-mercenary-btn')) {
                     handleGenericAction(target);
                 }
            });
        }

        function setupBattleMapInteraction() {
             battleMap.addEventListener('click', (event) => {
                if (event.target.classList.contains('battle-unit')) {
                    // Select unit
                    battleMap.querySelectorAll('.battle-unit.selected').forEach(el => el.classList.remove('selected'));
                    event.target.classList.add('selected');
                    selectedUnitInfo.textContent = `${event.target.classList.contains('infantry') ? 'Infantry' : event.target.classList.contains('cavalry') ? 'Cavalry' : 'Archer'} (${event.target.dataset.unitId})`;
                    addBattleLogEntry(`Unit ${event.target.dataset.unitId} selected.`);
                }
            });

            battleMap.addEventListener('contextmenu', (event) => {
                event.preventDefault(); // Prevent browser context menu
                const selectedUnit = battleMap.querySelector('.battle-unit.selected');
                if (selectedUnit) {
                     // Simulate move order visually (just log it)
                    const rect = battleMap.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    addBattleLogEntry(`Move order issued for ${selectedUnit.dataset.unitId} to coordinates (${Math.round(x)}, ${Math.round(y)}). (Simulation only)`);
                     // In a real game, you'd calculate pathfinding or target position here.
                }
            });
        }


        // --- Population Functions ---
        function populateRulerPanel() {
            const player = gameData.characters["player"];
            rulerInitials.textContent = player.portraitSeed;
            rulerPortraitContainer.style.backgroundColor = getPortraitBgColor(player.portraitSeed);
            rulerNameTitle.textContent = `${player.title} ${player.name} '${player.epithet}'`;

            const council = [
                { role: "Ruler", id: "player" },
                { role: "Spouse", id: "elara" },
                { role: "Heir", id: "edgar" },
                { role: "Chancellor", id: "borin" },
                { role: "Marshal", id: "emeric" },
                { role: "Steward", id: "theron" },
                { role: "Spymaster", id: "anais" },
                { role: "Court Tutor", id: "loras" },
                { role: "Wicte/Physician", id: "morwen" },
                { role: "Antagonist", id: "rhys" }, // Example
            ];

            councilCourtList.innerHTML = '';
            council.forEach(member => {
                const char = gameData.characters[member.id];
                if (char) {
                    const li = document.createElement('li');
                    const opinionStr = char.opinion !== null ? `(${char.opinion > 0 ? '+' : ''}${char.opinion})` : '';
                    li.innerHTML = `<strong>${member.role}:</strong> <span class="clickable" data-type="character" data-id="${member.id}">${char.name}</span> ${opinionStr}`;
                    councilCourtList.appendChild(li);
                }
            });
        }

        function populateVassalList() {
            const list = document.getElementById('vassal-list');
            list.innerHTML = ''; // Clear existing
            let count = 0;
            gameData.vassals.forEach(vassalId => {
                const vassal = gameData.characters[vassalId];
                if (vassal) {
                    count++;
                    const item = document.createElement('div');
                    item.classList.add('list-item');
                    const opinionClass = getOpinionClass(vassal.opinion);
                    const status = vassal.status === 'In Rebellion' ? ' (Rebelling)' : '';
                    item.innerHTML = `
                        <span><strong class="clickable" data-type="character" data-id="${vassalId}">${vassal.title} ${vassal.name}</strong> of ${vassal.location}${status}</span>
                        <span class="opinion ${opinionClass}">${vassal.opinion > 0 ? '+' : ''}${vassal.opinion}</span>
                    `;
                    list.appendChild(item);
                }
            });
            document.getElementById('vassal-count').textContent = count;
        }

         function populateFactionList() {
            const list = document.getElementById('faction-list');
            list.innerHTML = '';
            let dangerousFactionFound = false;
            Object.entries(gameData.factions).forEach(([id, faction]) => {
                if (faction.hidden) return; // Skip hidden factions like inactive rebellions

                const leader = gameData.characters[faction.leader];
                if (!leader) return; // Skip if leader doesn't exist

                const item = document.createElement('div');
                item.classList.add('list-item');

                 const isDangerous = faction.strength >= FACTION_DANGER_THRESHOLD;
                 if (isDangerous) dangerousFactionFound = true;

                 let statusHTML = '';
                 if (isDangerous) {
                     statusHTML = `<button class="generic-action-btn" style="background-color: var(--danger-color); color: white; font-size: 0.8em;">Ultimatum Soon!</button>`;
                     // Update alert if this is the most dangerous one shown
                      if(parseFloat(factionDangerAlert.querySelector('.alert-faction-strength').textContent) < faction.strength || factionDangerAlert.style.display === 'none') {
                           alertFactionNameSpan.textContent = faction.name;
                           alertFactionStrengthSpan.textContent = `${faction.strength}%`;
                           factionDangerAlert.style.display = 'block';
                      }
                 } else {
                      statusHTML = `<span class="opinion neutral">Watching</span>`; // Placeholder status
                 }


                item.innerHTML = `
                    <div class="faction-info" style="flex-grow: 1;">
                        <strong class="clickable" data-type="faction" data-id="${id}">${faction.name}</strong>
                        <div class="faction-details">
                            Leader: <span class="clickable" data-type="character" data-id="${faction.leader}">${leader.title} ${leader.name}</span> | Goal: ${faction.goal}
                            <span class="strength">Strength: ${faction.strength}%</span>
                        </div>
                    </div>
                    ${statusHTML}
                `;
                list.appendChild(item);
            });
             // Hide alert if no dangerous factions are visible
             if (!dangerousFactionFound) {
                 factionDangerAlert.style.display = 'none';
             }
         }

        function populateWarLists() {
            const militaryWarList = document.getElementById('military-war-list');
            militaryWarList.innerHTML = ''; // Clear

            Object.entries(gameData.wars).forEach(([id, war]) => {
                if (!war.active) return; // Only show active wars

                const item = document.createElement('div');
                item.classList.add('list-item');
                const scoreClass = war.score > 0 ? 'winning' : (war.score < 0 ? 'losing' : '');
                const scoreSign = war.score > 0 ? '+' : '';

                 // Simple participant string generation
                 const attackers = war.attackers.map(pId => pId === 'player' ? "You" : (gameData.characters[pId]?.name || gameData.diplomacy[pId]?.name || pId)).join(', ');
                 const defenders = war.defenders.map(pId => pId === 'player' ? "You" : (gameData.characters[pId]?.name || gameData.diplomacy[pId]?.name || pId)).join(', ');

                item.innerHTML = `
                    <div class="war-info">
                        <strong class="clickable" data-type="war" data-id="${id}">${war.name}</strong>
                        <span class="war-score ${scoreClass}">${scoreSign}${war.score}%</span>
                    </div>
                    <div class="war-participants">
                        <strong>Attackers:</strong> ${attackers} | <strong>Defenders:</strong> ${defenders}
                    </div>
                     <div style="margin-top: 5px;">
                         <button class="view-battle-btn" data-war-id="${id}">View Battle</button>
                         <button class="generic-action-btn" data-action="war_sue_for_peace" data-id="${id}">Sue for Peace</button>
                     </div>
                `;
                militaryWarList.appendChild(item);
            });
        }

         function populateDiplomacy() {
            const grid = document.getElementById('relations-overview-grid');
            const alliancesList = document.getElementById('alliances-list');
            const enemiesList = document.getElementById('enemies-list');
            const neighborsList = document.getElementById('neighbors-list');
            grid.innerHTML = '';
            alliancesList.innerHTML = '<h4>Alliances</h4>'; // Add header
            enemiesList.innerHTML = '<h4>Enemies & Rivals</h4>';
            neighborsList.innerHTML = '';

             Object.entries(gameData.diplomacy).forEach(([id, realm]) => {
                // Add to overview grid
                const card = document.createElement('div');
                card.classList.add('relation-card');
                card.dataset.type = 'diplomacy'; // Set type for modal
                card.dataset.id = id; // Set id for modal
                card.innerHTML = `
                    <h5>${realm.name}</h5>
                    <p>${realm.type}</p>
                    <p>Relations: ${realm.status} (${realm.relationValue > 0 ? '+' : ''}${realm.relationValue})</p>
                    <span class="opinion ${realm.opinionClass}">${realm.atWar ? 'At War' : (realm.alliance ? 'Allied' : realm.opinionClass)}</span>
                `;
                grid.appendChild(card);

                 // Add to specific lists
                 if (realm.alliance) {
                     const item = document.createElement('div');
                     item.classList.add('list-item');
                     item.innerHTML = `
                        <span><strong class="clickable" data-type="diplomacy" data-id="${id}">${realm.name}</strong> (${realm.allianceType || 'Mutual Defense'})</span>
                        <span style="color: var(--success-color);">Active</span>
                     `;
                     alliancesList.appendChild(item);
                 }
                 if (realm.relationValue <= -50 || realm.atWar) { // Simple condition for enemy/rival
                     const item = document.createElement('div');
                     item.classList.add('list-item');
                      const status = realm.atWar ? 'At War' : (realm.relationValue <= -75 ? 'Enemy' : 'Rival'); // Example distinction
                     item.innerHTML = `
                         <span><strong class="clickable" data-type="diplomacy" data-id="${id}">${realm.name}</strong> (${realm.type})</span>
                         <span class="opinion negative">${status}</span>
                     `;
                     enemiesList.appendChild(item);
                 }
                 // Add to neighbors list
                 const neighborItem = document.createElement('div');
                 neighborItem.classList.add('list-item');
                 neighborItem.innerHTML = `
                    <span><strong class="clickable" data-type="diplomacy" data-id="${id}">${realm.name}</strong> (${realm.type})</span>
                    <span class="opinion ${realm.opinionClass}">${realm.status}</span>
                 `;
                 neighborsList.appendChild(neighborItem);
            });
             // Add character rivals to Enemies list
             Object.entries(gameData.characters).forEach(([id, char]) => {
                 if(char.relations?.includes("Rival: King Aldric")) {
                      const item = document.createElement('div');
                      item.classList.add('list-item');
                      item.innerHTML = `
                         <span><strong class="clickable" data-type="character" data-id="${id}">${char.title} ${char.name}</strong> (Personal Rival)</span>
                         <span class="opinion negative">Rival</span>
                      `;
                      enemiesList.appendChild(item);
                 }
             });
         }

          function populateMercenaries() {
             const list = document.getElementById('mercenary-list');
             list.innerHTML = '';
             Object.entries(gameData.mercenaries).forEach(([id, merc]) => {
                const item = document.createElement('div');
                item.classList.add('list-item');
                const availability = merc.available ? `<button class="generic-action-btn hire-mercenary-btn" data-action="hire_mercenary" data-id="${id}">Hire (${merc.costHire}g)</button>` : `<span style="color: var(--text-muted);">Unavailable</span>`;

                item.innerHTML = `
                    <div>
                         <strong>${merc.name}</strong>
                         <div class="mercenary-details">
                             <span>Size: <strong>${merc.size}</strong></span>
                             <span>Composition: <strong>${merc.composition}</strong></span>
                             <span>Upkeep: <strong>${merc.costMonth}g/month</strong></span>
                              <span>Leader: <strong class="clickable" data-type="character" data-id="merc_${id}">${merc.leader}</strong></span>
                         </div>
                    </div>
                    ${availability}
                `;
                list.appendChild(item);
                 // Add placeholder character data for merc leaders if needed for clicking
                 if (!gameData.characters[`merc_${id}`]) {
                     gameData.characters[`merc_${id}`] = { name: merc.leader, title: "Mercenary Captain", portraitSeed: merc.leader.substring(0,2).toUpperCase(), opinion: 0, description: `Leader of the ${merc.name}.`, relations: [], history: ["Professional soldier of fortune."] };
                 }
             });
          }


        // --- Core Logic Functions ---
        function calculatePeasantryApproval() {
            let totalDeviation = 0;
            const orderFreedom = parseInt(document.getElementById('order-freedom-slider').value, 10);
            const centralDecentral = parseInt(document.getElementById('central-decentral-slider').value, 10);
            const aristoEgal = parseInt(document.getElementById('aristo-egal-slider').value, 10);

            // Example logic: Peasants prefer Freedom, Decentralized, Egalitarian
            totalDeviation += Math.max(0, orderFreedom - 50); // Penalty for Order
            totalDeviation += Math.max(0, centralDecentral - 30); // Penalty for Centralized (beyond 30)
            totalDeviation += Math.max(0, aristoEgal - 20); // Penalty for Aristocratic (beyond 20)

            // Base approval + penalties
            let baseApproval = 80;
            let approvalReduction = (totalDeviation / (50 + 70 + 80)) * 100; // Normalize reduction based on max possible deviation penalty side
            let approval = Math.round(baseApproval - approvalReduction);

            // Add other factors (Placeholder - e.g., war weariness, taxes, events)
            // approval -= 5; // Example: War weariness penalty

            approval = Math.max(5, Math.min(100, approval)); // Clamp
            updatePeasantryApproval(approval - currentPeasantApproval); // Pass the change
        }

        function updatePeasantryApproval(change) {
            currentPeasantApproval = Math.max(5, Math.min(100, currentPeasantApproval + change));

            peasantryApprovalDisplay.textContent = `${currentPeasantApproval}%`;
            peasantryApprovalDisplay.classList.toggle('low-approval', currentPeasantApproval < REBELLION_THRESHOLD);

            alertApprovalValueSpan.textContent = currentPeasantApproval;
            const showRebellionAlert = currentPeasantApproval < REBELLION_THRESHOLD;
            rebellionAlert.style.display = showRebellionAlert ? 'block' : 'none';

            // --- Rebellion Trigger Logic ---
            if (showRebellionAlert) {
                lowApprovalTurns++;
                if (lowApprovalTurns >= 3) { // Trigger after 3 'turns' (simulated by updates) of low approval
                    triggerRebellionEvent();
                    lowApprovalTurns = 0; // Reset counter
                }
            } else {
                lowApprovalTurns = 0; // Reset if approval recovers
            }

             // Update populist faction strength (simple inverse relation)
             const populistFaction = gameData.factions['populist'];
             if (populistFaction) {
                 populistFaction.strength = Math.max(10, Math.min(150, 70 + (50 - currentPeasantApproval))); // Base 70, +1 strength for each % below 50 approval
                 populateFactionList(); // Refresh the list to show updated strength & potentially danger status
             }
        }

        function triggerRebellionEvent() {
             // Check if rebellion war is already active
             if (gameData.wars['peasant_revolt']?.active) {
                 addNotification('warning', 'Rebellion Intensifies', 'Continued low approval fuels the ongoing peasant revolt!');
                 return;
             }

             // Show event modal for the outbreak
             displayEvent({
                 title: "Rebellion Erupts!",
                 description: `Years of hardship and perceived injustice have boiled over! Peasants across several provinces have taken up arms, led by charismatic figures promising change. They demand immediate concessions! Peasantry Approval: ${currentPeasantApproval}%`,
                 options: [
                     { text: "Attempt to crush the rebellion with force.", hint: "(Initiates 'Great Peasant Revolt' war)", outcome: () => { startPeasantRevoltWar(); } },
                     { text: "Offer major concessions immediately.", hint: "(Costly: -200 Gold, +20 Peasantry Approval, Avoids war for now)", outcome: () => { console.log("Gold -200"); updatePeasantryApproval(20); addNotification('success', 'Concessions Made', 'War averted for now, but at great cost. The underlying issues remain.'); } },
                     { text: "Try to negotiate with the leaders.", hint: "(Risky: May fail or show weakness)", outcome: () => { addNotification('info', 'Negotiations Attempted', 'Envoys sent to the rebel leaders. Outcome uncertain.'); /* Could lead to another event */ } }
                 ]
             }, true); // true indicates this is a critical event modal
        }

        function startPeasantRevoltWar() {
             addNotification('danger', 'Peasant Revolt!', 'The Great Peasant Revolt has begun! Muster your forces!');
             gameData.factions['rebel_peasant'].hidden = false; // Make faction visible
             gameData.factions['rebel_peasant'].strength = 100; // Give it initial strength
             gameData.wars['peasant_revolt'].active = true;
             gameData.wars['peasant_revolt'].score = 0; // Reset score
             // Add the faction leader to the war participants dynamically if needed
             gameData.wars['peasant_revolt'].attackers = ['rebel_peasant'];
             gameData.wars['peasant_revolt'].defenders = ['player'];

             // Refresh relevant UI parts
             populateFactionList();
             populateWarLists();
        }

        // --- Notification/Alert Management ---
         function addNotification(type, title, message) {
             notificationIdCounter++;
             const id = `notif-${notificationIdCounter}`;
             const notifDiv = document.createElement('div');
             notifDiv.classList.add('notification', type);
             notifDiv.id = id;
             notifDiv.innerHTML = `
                <button class="dismiss-btn" data-target="${id}">×</button>
                <h5>${title}</h5>
                <p>${message}</p>
             `;
             notificationsContainer.insertBefore(notifDiv, notificationsContainer.children[1]);
         }

         function addAlert(id, title, message, permanent = false) {
             if (document.getElementById(id)) { // Update existing alert message if needed
                 const existingAlert = document.getElementById(id);
                 existingAlert.querySelector('p').innerHTML = message; // Use innerHTML if message contains spans
                  existingAlert.style.display = 'block'; // Ensure it's visible
                 return;
             }
             const alertDiv = document.createElement('div');
             alertDiv.classList.add('alert');
             alertDiv.id = id;
             alertDiv.innerHTML = `
                ${!permanent ? `<button class="dismiss-btn" data-target="${id}">×</button>` : ''}
                <h5>${title}</h5>
                <p>${message}</p>
             `;
             alertsContainer.insertBefore(alertDiv, alertsContainer.children[1]);
         }
         function removeAlert(id) {
              const alertElement = document.getElementById(id);
              if (alertElement) {
                   alertElement.style.opacity = '0';
                   setTimeout(() => alertElement.remove(), 300);
              }
         }


        // --- Event System ---
        const randomEvents = [
             {
                title: "A Petition from the Peasantry",
                description: "A delegation of peasants has arrived, bearing a petition requesting tax relief due to a recent poor harvest. They seem earnest but desperate.",
                options: [
                    { text: "Grant temporary tax relief.", hint: "(Costs 50 Gold, +10 Peasantry Approval)", outcome: () => { updatePeasantryApproval(10); addNotification('success', 'Tax Relief Granted', 'Peasantry approval slightly increased.'); console.log("Gold -50");} },
                    { text: "Offer stored grain instead.", hint: "(Reduces food stockpile, +5 Peasantry Approval)", outcome: () => { updatePeasantryApproval(5); addNotification('info', 'Grain Distributed', 'Peasants are somewhat appeased.'); console.log("Food stockpile reduced");} },
                    { text: "Dismiss them; the Crown needs its due.", hint: "(-15 Peasantry Approval, Risk of unrest)", outcome: () => { updatePeasantryApproval(-15); addNotification('warning', 'Petition Denied', 'Peasantry approval decreased significantly.'); } }
                ]
            },
            {
                title: "Border Dispute",
                description: "Scouts report that soldiers from the neighboring Kingdom of Aeridor have crossed the border and occupied a small, disputed village. Your ally claims it was a mistake.",
                options: [
                    { text: "Demand immediate withdrawal and compensation.", hint: "(Risks diplomatic incident, +5 Prestige)", outcome: () => { addNotification('info', 'Demand Sent', 'Aeridor notified of your displeasure. Relations -10.'); gameData.diplomacy.aeridor.relationValue -= 10; populateDiplomacy(); console.log("Prestige +5");} },
                    { text: "Send envoys to negotiate a peaceful resolution.", hint: "(May appear weak, Preserves alliance)", outcome: () => { addNotification('info', 'Negotiations Underway', 'Envoys dispatched to Aeridor.'); } },
                    { text: "Ignore it for now; the alliance is paramount.", hint: "(-10 Prestige, Aeridor opinion +5)", outcome: () => { addNotification('info', 'Incident Ignored', 'Alliance preserved, but prestige suffers.'); gameData.diplomacy.aeridor.relationValue += 5; populateDiplomacy(); console.log("Prestige -10");} }
                ]
            },
             {
                title: "Noble Squabble",
                description: "Two of your vassals, Duke Kael (placeholder ID: kael) and Countess Lyra, are engaged in a bitter feud over hunting rights in the Greenwater woods. It threatens to escalate.",
                options: [
                    { text: "Side with Duke Kael.", hint: "(Kael opinion +20, Lyra opinion -30)", outcome: () => { if(gameData.characters.kael) gameData.characters.kael.opinion += 20; gameData.characters.lyra.opinion -= 30; addNotification('info', 'Feud Resolved (Kael)', 'Duke Kael is pleased, Countess Lyra is angered.'); populateVassalList(); } },
                    { text: "Side with Countess Lyra.", hint: "(Lyra opinion +20, Kael opinion -30)", outcome: () => { if(gameData.characters.kael) gameData.characters.kael.opinion -= 30; gameData.characters.lyra.opinion += 20; addNotification('info', 'Feud Resolved (Lyra)', 'Countess Lyra is pleased, Duke Kael is angered.'); populateVassalList(); } },
                    { text: "Impose a compromise.", hint: "(Kael opinion -10, Lyra opinion -10, +5 Prestige)", outcome: () => { if(gameData.characters.kael) gameData.characters.kael.opinion -= 10; gameData.characters.lyra.opinion -= 10; addNotification('success', 'Compromise Reached', 'Order is restored, but both vassals are slightly unhappy.'); console.log("Prestige +5"); populateVassalList(); } },
                    { text: "Tell them to sort it out themselves.", hint: "(Risk of escalation, Both opinions -5)", outcome: () => { if(gameData.characters.kael) gameData.characters.kael.opinion -= 5; gameData.characters.lyra.opinion -= 5; addNotification('warning', 'Intervention Declined', 'The feud continues, weakening your authority.'); populateVassalList();} }
                ]
            },
             {
                title: "Advisor's Counsel",
                description: "Your Chancellor, Duke Borin, advises centralizing power further by revoking an old charter granted to the Free Cities, potentially boosting income but harming relations.",
                options: [
                    { text: "Heed his advice, revoke the charter.", hint: "(+10 Monthly Income, Free Cities Relations -40)", outcome: () => { gameData.diplomacy.free_cities.relationValue -= 40; addNotification('success', 'Charter Revoked', 'Income increased, but the Free Cities are furious.'); console.log("Income +10/month"); populateDiplomacy();} },
                    { text: "Thank him, but maintain the status quo.", hint: "(Chancellor opinion -5)", outcome: () => { gameData.characters.borin.opinion -= 5; addNotification('info', 'Advice Declined', 'Chancellor Borin is slightly disappointed.'); populateVassalList(); populateRulerPanel(); } },
                    { text: "Seek a different approach to increasing income.", hint: "(Opens other possibilities - simulation needed)", outcome: () => { addNotification('info', 'Seeking Alternatives', 'You task your Steward with finding other ways to bolster the treasury.'); } }
                ]
            },
            {
                title: "A Spy's Discovery",
                description: "Your Spymaster, Baroness Anais, reports discovering a plot by a minor courtier (Ser Jon) to fabricate claims on behalf of Duke Rhys.",
                options: [
                     { text: "Arrest Ser Jon immediately.", hint: "(Removes plotter, Duke Rhys opinion -15)", outcome: () => { gameData.characters.rhys.opinion -= 15; addNotification('success', 'Plotter Arrested', 'Ser Jon is imprisoned. Duke Rhys is displeased by your interference.'); populateVassalList(); } },
                     { text: "Leak the information to discredit Duke Rhys.", hint: "(Duke Rhys opinion -25, Faction strength -10%)", outcome: () => { gameData.characters.rhys.opinion -= 25; gameData.factions.independence.strength = Math.max(0, gameData.factions.independence.strength - 10); addNotification('info', 'Plot Leaked', 'Duke Rhys loses face, weakening his faction.'); populateVassalList(); populateFactionList(); } },
                     { text: "Keep the information secret and watch closely.", hint: "(+5 Intrigue Skill, Risk of plot succeeding later)", outcome: () => { addNotification('info', 'Plot Watched', 'You gain insight into court intrigue.'); console.log("Intrigue +5"); } }
                 ]
            }
        ];

        function triggerRandomEvent() {
            const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
            displayEvent(event);
        }

        function displayEvent(event, critical = false) {
            eventTitle.textContent = event.title;
            eventDescription.textContent = event.description;
            eventOptionsContainer.innerHTML = ''; // Clear previous options

            event.options.forEach(option => {
                const button = document.createElement('button');
                button.innerHTML = `${option.text} <span class="outcome-hint">${option.hint || ''}</span>`;
                button.addEventListener('click', () => {
                    option.outcome(); // Execute the outcome function
                    closeModal('event-modal-overlay'); // Hide modal
                });
                eventOptionsContainer.appendChild(button);
            });

             // Make critical event modals harder to dismiss accidentally (e.g., no background click)
             // For this mockup, we'll just ensure it shows. In a real game, disable background click dismissal.
            showModal('event-modal-overlay');
        }


        // --- Detail Modal Logic ---
         function showDetailModal(type, id) {
            let data, portraitSeed, title, description, specificHTML = '', actionsHTML = '';

            // Reset common elements
             detailPortrait.style.display = 'none';
             detailSpecificContent.innerHTML = '';
             detailActions.innerHTML = '';

             switch (type) {
                case 'character':
                    data = gameData.characters[id];
                    if (!data) return;
                    title = `${data.title || ''} ${data.name} ${data.epithet ? "'" + data.epithet + "'" : ''}`;
                    description = data.description || "No description available.";
                    portraitSeed = data.portraitSeed;
                    detailPortrait.style.display = 'flex';
                    detailPortrait.querySelector('.placeholder-initials').textContent = portraitSeed;
                    detailPortrait.style.backgroundColor = getPortraitBgColor(portraitSeed);

                     // Specific Content: Relations, History, Faction membership etc.
                    specificHTML += `<h3>Details</h3>`;
                    specificHTML += `<div class="detail-grid">`;
                    if (data.location) specificHTML += `<div class="detail-card"><h4>Location</h4><p>${data.location}</p></div>`;
                    if (data.opinion !== null) specificHTML += `<div class="detail-card"><h4>Opinion of You</h4><p><span class="opinion ${getOpinionClass(data.opinion)}">${data.opinion > 0 ? '+' : ''}${data.opinion}</span></p></div>`;
                     // Find faction membership
                     let factionMemberOf = 'None';
                     Object.values(gameData.factions).forEach(f => {
                         if (f.members.includes(id)) {
                             factionMemberOf = `<span class="clickable" data-type="faction" data-id="${Object.keys(gameData.factions).find(key => gameData.factions[key] === f)}">${f.name}</span>`;
                         }
                     });
                     specificHTML += `<div class="detail-card"><h4>Faction</h4><p>${factionMemberOf}</p></div>`;

                    if (data.relations && data.relations.length > 0) {
                        specificHTML += `<div class="detail-card"><h4>Relations</h4><ul>${data.relations.map(rel => `<li>${rel}</li>`).join('')}</ul></div>`;
                    }
                     specificHTML += `</div>`; // End grid

                     if (data.history && data.history.length > 0) {
                         specificHTML += `<h3>History</h3><ul>${data.history.map(hist => `<li>${hist}</li>`).join('')}</ul>`;
                     }

                     // Actions: Interact, Send Gift, etc.
                     actionsHTML += `<button class="generic-action-btn" data-action="char_interact" data-id="${id}">Interact (Placeholder)</button>`;
                     actionsHTML += `<button class="generic-action-btn" data-action="char_send_gift" data-id="${id}">Send Gift</button>`;
                     actionsHTML += `<button class="generic-action-btn" data-action="char_plot" data-id="${id}" style="background-color: var(--danger-hover);">Plot Against (Placeholder)</button>`;
                     break;

                 case 'faction':
                    data = gameData.factions[id];
                    if (!data) return;
                    const leader = gameData.characters[data.leader];
                    title = data.name;
                    description = `Goal: ${data.goal}. Current Strength: ${data.strength}%.`;

                     // Specific Content: Leader, Members
                     specificHTML += `<h3>Leader</h3>`;
                     if (leader) {
                         specificHTML += `<p><span class="clickable" data-type="character" data-id="${data.leader}">${leader.title} ${leader.name}</span></p>`;
                     } else {
                         specificHTML += `<p>Unknown</p>`;
                     }
                     specificHTML += `<h3>Members (${data.members.length})</h3>`;
                     specificHTML += `<ul>`;
                     data.members.forEach(memberId => {
                         const member = gameData.characters[memberId];
                         if (member) {
                             specificHTML += `<li><span class="clickable" data-type="character" data-id="${memberId}">${member.title} ${member.name}</span> (Opinion: ${member.opinion > 0 ? '+' : ''}${member.opinion})</li>`;
                         }
                     });
                     specificHTML += `</ul>`;

                     // Actions: Influence Leader, Discourage Members, etc.
                     actionsHTML += `<button class="generic-action-btn" data-action="faction_influence" data-id="${id}">Influence Leader</button>`;
                     actionsHTML += `<button class="generic-action-btn" data-action="faction_discourage" data-id="${id}">Discourage Members</button>`;
                     break;

                case 'war':
                    data = gameData.wars[id];
                    if (!data) return;
                    title = data.name;
                     const attackers = data.attackers.map(pId => pId === 'player' ? "Your Realm" : (gameData.characters[pId]?.name || gameData.diplomacy[pId]?.name || pId)).join(', ');
                     const defenders = data.defenders.map(pId => pId === 'player' ? "Your Realm" : (gameData.characters[pId]?.name || gameData.diplomacy[pId]?.name || pId)).join(', ');
                    description = `Type: ${data.type}. Current War Score: ${data.score > 0 ? '+' : ''}${data.score}% for the attackers.`;

                     specificHTML += `<h3>Participants</h3>`;
                     specificHTML += `<p><strong>Attackers:</strong> ${attackers}</p>`;
                     specificHTML += `<p><strong>Defenders:</strong> ${defenders}</p>`;
                     specificHTML += `<h3>War Goal</h3><p>${data.goal}</p>`;
                     // Add War History/Key Battles section (Placeholder)
                     specificHTML += `<h3>Key Battles (Placeholder)</h3><p>Battle of Green Ford (+15%), Siege of Edessa (-5%)</p>`;

                      // Actions: View Battle, Offer Peace, Call Allies
                     actionsHTML += `<button class="view-battle-btn" data-war-id="${id}">View Battle Simulation</button>`;
                     actionsHTML += `<button class="generic-action-btn" data-action="war_offer_peace" data-id="${id}">Offer Peace</button>`;
                     actionsHTML += `<button class="generic-action-btn" data-action="war_call_ally" data-id="${id}">Call Ally (Aeridor)</button>`;

                    break;

                 case 'diplomacy':
                     data = gameData.diplomacy[id];
                     if (!data) return;
                     title = data.name;
                     description = `${data.type}. Current relations: ${data.status} (${data.relationValue > 0 ? '+' : ''}${data.relationValue}).`;

                     // Specific Content: Alliances, Truces, Casus Belli
                     specificHTML += `<h3>Details</h3>`;
                     if (data.alliance) specificHTML += `<p><strong>Alliance:</strong> Active (${data.allianceType || 'Mutual Defense'})</p>`;
                     if (data.atWar) specificHTML += `<p><strong>Status:</strong> Currently at War!</p>`;
                      // Placeholder Casus Belli
                     specificHTML += `<p><strong>Available Casus Belli (vs Them):</strong> Conquest (Border County), De Jure Claim (Duchy of Lower Aeridor)</p>`;
                     specificHTML += `<p><strong>Available Casus Belli (vs You):</strong> Liberation (Valorian Lands)</p>`;


                     // Actions: Improve Relations, Declare War, Offer Alliance, etc.
                     actionsHTML += `<button class="generic-action-btn" data-action="diplo_improve" data-id="${id}">Improve Relations</button>`;
                     actionsHTML += `<button class="generic-action-btn" data-action="diplo_harm" data-id="${id}">Harm Relations</button>`;
                     if (!data.alliance) actionsHTML += `<button class="generic-action-btn" data-action="diplo_offer_alliance" data-id="${id}">Offer Alliance</button>`;
                     if (data.alliance) actionsHTML += `<button class="generic-action-btn" data-action="diplo_break_alliance" data-id="${id}">Break Alliance</button>`;
                     if (!data.atWar) actionsHTML += `<button class="generic-action-btn" data-action="diplo_declare_war" data-id="${id}" style="background-color: var(--danger-hover);">Declare War</button>`;
                     break;
             }

             detailTitle.textContent = title;
             detailDescription.textContent = description;
             detailSpecificContent.innerHTML = specificHTML;
             detailActions.innerHTML = actionsHTML;

             showModal('detail-modal-overlay');
         }

        // --- Battle Modal Logic ---
        function showBattleModal(warId) {
             const war = gameData.wars[warId];
             if (!war) return;
             battleTitle.textContent = `Battle Simulation: ${war.name}`;
             battleLog.innerHTML = `<p>Initiating simulation for the ${war.name}...</p>`;
             // Reset unit positions / selection (In real game, load actual battle state)
             battleMap.querySelectorAll('.battle-unit.selected').forEach(el => el.classList.remove('selected'));
             // Select first player unit by default
             const firstUnit = battleMap.querySelector('.battle-unit.player');
             if(firstUnit) {
                 firstUnit.classList.add('selected');
                  selectedUnitInfo.textContent = `${firstUnit.classList.contains('infantry') ? 'Infantry' : firstUnit.classList.contains('cavalry') ? 'Cavalry' : 'Archer'} (${firstUnit.dataset.unitId})`;
             } else {
                 selectedUnitInfo.textContent = 'None';
             }
             showModal('battle-modal-overlay');
         }

         function battleCommand(command) {
             const selectedUnit = battleMap.querySelector('.battle-unit.selected');
             const unitName = selectedUnit ? selectedUnit.dataset.unitId : "Selected units";

              switch (command) {
                 case 'select_all':
                     addBattleLogEntry("All player units selected (simulation).");
                     battleMap.querySelectorAll('.battle-unit.player').forEach(el => el.classList.add('selected')); // Visually select all
                     selectedUnitInfo.textContent = 'All Player Units';
                     break;
                 case 'attack':
                     addBattleLogEntry(`${unitName} ordered to attack! (Simulation only)`);
                     break;
                 case 'charge':
                     addBattleLogEntry(`${unitName} ordered to charge! (Simulation only)`);
                     break;
                 case 'defend':
                     addBattleLogEntry(`${unitName} ordered to defend position! (Simulation only)`);
                     break;
                 case 'formation_line':
                     addBattleLogEntry(`Units ordered into Line Formation. (Simulation only)`);
                     break;
                 case 'formation_wedge':
                      addBattleLogEntry(`Units ordered into Wedge Formation. (Simulation only)`);
                     break;
                 case 'delegate':
                      addBattleLogEntry(`Command delegated to General. Simulating outcome...`);
                      // Simulate a simple outcome after a delay
                      setTimeout(() => {
                          const outcome = Math.random();
                          if (outcome > 0.6) addBattleLogEntry("General reports minor victory! (+5% War Score)");
                          else if (outcome < 0.3) addBattleLogEntry("General reports setback! (-3% War Score)");
                          else addBattleLogEntry("General reports inconclusive skirmish.");
                      }, 2000);
                     break;
                 default:
                     addBattleLogEntry(`Unknown command: ${command}`);
             }
         }

         // --- Generic Action Handler ---
         function handleGenericAction(button) {
             const action = button.dataset.action;
             const id = button.dataset.id; // ID of the target (character, war, realm, merc etc.)
             console.log(`Action: ${action}, Target ID: ${id}`); // Log the action

             switch (action) {
                 case 'hire_mercenary':
                     const merc = gameData.mercenaries[id];
                     if (merc && merc.available) {
                         addNotification('success', 'Mercenaries Hired!', `The ${merc.name} (${merc.size} troops) have been hired for ${merc.costHire} Gold. Upkeep: ${merc.costMonth} Gold/month.`);
                         merc.available = false; // Make them unavailable after hiring (simple simulation)
                         button.textContent = 'Hired';
                         button.disabled = true;
                         button.classList.remove('hire-mercenary-btn');
                         console.log(`Gold -${merc.costHire}`);
                     }
                     break;
                 case 'char_send_gift':
                     const targetChar = gameData.characters[id];
                     if (targetChar) {
                         targetChar.opinion += 15; // Simple gift effect
                         addNotification('success', 'Gift Sent', `You sent a gift to ${targetChar.title} ${targetChar.name}. Their opinion improves by 15.`);
                         console.log("Gold -25"); // Simulate cost
                         populateVassalList(); // Refresh lists if they are a vassal
                         populateRulerPanel(); // Refresh council panel
                         // If the detail modal is open for this character, update it
                         if (detailModalOverlay.style.display === 'flex' && detailTitle.textContent.includes(targetChar.name)) {
                             showDetailModal('character', id); // Re-render the modal
                         }
                     }
                     break;
                 case 'diplo_improve':
                     const targetRealm = gameData.diplomacy[id];
                     if (targetRealm) {
                          targetRealm.relationValue += 10; // Simple improve effect
                         addNotification('success', 'Relations Improved', `Diplomatic efforts underway with ${targetRealm.name}. Relations improved slightly.`);
                          console.log("Gold -10");
                          populateDiplomacy();
                          if (detailModalOverlay.style.display === 'flex' && detailTitle.textContent.includes(targetRealm.name)) {
                             showDetailModal('diplomacy', id); // Re-render the modal
                         }
                     }
                     break;
                 case 'diplo_declare_war':
                      addNotification('danger', 'War Declared!', `You have declared war on ${gameData.diplomacy[id]?.name}! (Simulation only - No new war added)`);
                     break;
                 // Add cases for other placeholder buttons...
                 default:
                     addNotification('info', 'Action Triggered', `Action '${action}' on target '${id}' executed (Placeholder).`);
                     break;
             }
             // Optionally close the detail modal if the action originated from there
             // closeModal('detail-modal-overlay');
         }


    </script>

</body>
</html>
```