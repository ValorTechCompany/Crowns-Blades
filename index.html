<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crowns & Blades V5</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- CK3 Inspired Styling (Mostly Unchanged) --- */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap');

        :root {
            --ck3-background: #1a1a1a; /* Dark background */
            --ck3-panel-bg: #2a2a2a; /* Slightly lighter panel */
            --ck3-panel-border: #444;
            --ck3-text: #e0e0e0; /* Light text */
            --ck3-text-muted: #aaa;
            --ck3-highlight: #c8a464; /* Gold highlight */
            --ck3-accent: #8a3a3a; /* Dark red accent */
            --ck3-green: #5a8a5a;
            --ck3-blue: #4a7a9a;
            --ck3-red: #9a4a4a;
            --ck3-tyranny: #b84d4d; /* Color for tyranny/dread */
        }

        body {
            font-family: 'Lato', sans-serif;
            line-height: 1.6;
            background-color: var(--ck3-background);
            color: var(--ck3-text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column; /* Stack creator and game */
            align-items: center;
        }

        /* --- Creator Screen --- */
        #creator-container {
            display: none; /* Initially hidden, shown by JS */
            max-width: 750px;
            width: 100%;
            background-color: var(--ck3-panel-bg);
            padding: 30px;
            border-radius: 5px;
            border: 1px solid var(--ck3-panel-border);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }
        #creator-container h2 { text-align: center; margin-bottom: 25px; font-family: 'Cinzel', serif; color: var(--ck3-highlight); }
        .creator-field { margin-bottom: 15px; }
        .creator-field label, .creator-section-title { display: block; margin-bottom: 5px; color: var(--ck3-text-muted); font-family: 'Cinzel', serif; font-size: 1.1em; margin-top: 15px; }
        .creator-field input[type="text"] { width: 100%; padding: 10px; background-color: var(--ck3-background); border: 1px solid var(--ck3-panel-border); color: var(--ck3-text); border-radius: 3px; box-sizing: border-box; }
        #creator-backgrounds { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; }
        .background-card { border: 1px solid var(--ck3-panel-border); border-radius: 4px; padding: 15px; background-color: rgba(0,0,0,0.2); cursor: pointer; transition: all 0.2s ease; position: relative; /* Needed for radio positioning */}
        .background-card input[type="radio"] { /* Hide radio, but make it selectable */
             position: absolute; opacity: 0; width: 100%; height: 100%; top: 0; left: 0; cursor: pointer; margin: 0; padding: 0; z-index: 1;
        }
        .background-card h4 { margin: 0 0 8px 0; color: var(--ck3-highlight); font-family: 'Cinzel', serif; font-size: 1em; pointer-events: none; /* Let clicks pass through to label/radio */ }
        .background-card p { font-size: 0.85em; color: var(--ck3-text-muted); margin: 0; pointer-events: none; }
        .background-card.selected { border-color: var(--ck3-highlight); background-color: rgba(200, 164, 100, 0.1); box-shadow: 0 0 10px rgba(200, 164, 100, 0.3); }
        .background-card:hover { background-color: rgba(255,255,255,0.05); }
        #creator-start-btn { padding: 12px 25px; background: linear-gradient(to bottom, #7a5a2a, #6a4a1a); color: white; border: 1px solid var(--ck3-highlight); border-radius: 4px; cursor: pointer; font-size: 1.1em; font-family: 'Cinzel', serif; transition: all 0.2s ease; display: block; width: 100%; margin-top: 30px; }
        #creator-start-btn:hover { background: linear-gradient(to bottom, #8a6a3a, #7a5a2a); border-color: #fff; }
        #creator-start-btn:disabled { background: #555; border-color: #777; color: #aaa; cursor: not-allowed; }

        /* --- Main Game Container --- */
        #game-container {
            display: none; /* Initially hidden, shown by JS */
            max-width: 1300px;
            width: 100%;
            background-color: var(--ck3-panel-bg);
            padding: 25px;
            border-radius: 5px;
            border: 1px solid var(--ck3-panel-border);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 25px;
        }
        #left-column { display: flex; flex-direction: column; gap: 20px; }
        #middle-column { display: flex; flex-direction: column; gap: 20px; }
        #right-column { display: flex; flex-direction: column; gap: 20px; }

        /* --- General Elements --- */
        h2, h3 { font-family: 'Cinzel', serif; color: var(--ck3-highlight); margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid var(--ck3-panel-border); padding-bottom: 8px; }
        .info-box { border: 1px solid var(--ck3-panel-border); padding: 20px; border-radius: 4px; background-color: rgba(0,0,0,0.1); box-shadow: inset 0 0 10px rgba(0,0,0,0.3); }
        ul { list-style: none; padding: 0; margin: 0; }
        ul li { margin-bottom: 8px; color: var(--ck3-text-muted); }
        ul li strong { display: inline-block; min-width: 110px; color: var(--ck3-text); }
        ul li span:not(.trait):not(.icon):not(.vassal-opinion-val):not(.vassal-detail):not(.clickable-info):not(.cost):not(.vassal-status):not(.war-score):not(.war-goal):not(.war-participants):not(.prisoner-details) { font-weight: bold; color: var(--ck3-highlight); }
        .vassal-opinion-val.positive { color: var(--ck3-green); }
        .vassal-opinion-val.negative { color: var(--ck3-red); }
        .vassal-detail { font-size: 0.85em; color: #bbb; margin-left: 5px; }
        .vassal-status { font-size: 0.8em; color: var(--ck3-text-muted); margin-left: 5px; font-style: italic; }
        .vassal-status.imprisoned { color: var(--ck3-blue); }
        .vassal-status.rebelling { color: var(--ck3-red); font-weight: bold; }
        .icon { margin-right: 6px; color: var(--ck3-text-muted); width: 1.1em; display: inline-block; text-align: center; }
        .trait { display: inline-block; background-color: var(--ck3-panel-border); color: var(--ck3-text); padding: 3px 8px; border-radius: 10px; font-size: 0.85em; margin-right: 5px; border: 1px solid #555; white-space: nowrap; }
        .trait.positive { border-color: var(--ck3-green); color: #aaffaa; }
        .trait.negative { border-color: var(--ck3-red); color: #ffaaaa; }
        .clickable-info { color: var(--ck3-highlight); cursor: pointer; text-decoration: underline; text-decoration-style: dotted; font-weight: bold; transition: color 0.2s; }
        .clickable-info:hover { color: #fff; }
        .clickable-info.nyi { text-decoration: line-through; cursor: not-allowed; color: var(--ck3-text-muted); } /* Style for NYI clickables */

        /* --- Action Buttons --- */
        #actions button, .action-button { padding: 10px 15px; background: linear-gradient(to bottom, #7a5a2a, #6a4a1a); color: white; border: 1px solid var(--ck3-highlight); border-radius: 4px; cursor: pointer; font-size: 0.95em; font-family: 'Cinzel', serif; transition: all 0.2s ease; margin-right: 8px; margin-bottom: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.4); }
         #actions button:hover, .action-button:hover { background: linear-gradient(to bottom, #8a6a3a, #7a5a2a); box-shadow: 0 4px 8px rgba(0,0,0,0.5); border-color: #fff; }
         #actions button:active, .action-button:active { transform: translateY(1px); box-shadow: 0 1px 3px rgba(0,0,0,0.4); }
         #actions button:disabled, .action-button:disabled, button.nyi { background: #555; border-color: #777; color: #aaa; cursor: not-allowed; box-shadow: none; transform: none; }
        button.nyi::after { content: "(NYI)"; font-size: 0.7em; color: #ccc; margin-left: 5px; }
        .vassal-actions button { font-size: 0.8em; padding: 3px 8px; margin-left: 10px; margin-bottom: 0; }
        .faction-actions button { font-size: 0.8em; padding: 3px 8px; margin-left: 10px; margin-bottom: 0; } /* Style for faction buttons */

        /* --- Log Box --- */
        #log-box { max-height: 180px; overflow-y: auto; border: 1px solid var(--ck3-panel-border); padding: 15px; background-color: rgba(0,0,0,0.2); font-size: 0.9em; color: var(--ck3-text-muted); }
        #log-box p { margin: 0 0 6px 0; border-bottom: 1px dotted var(--ck3-panel-border); padding-bottom: 4px; line-height: 1.4; }
        #log-box p strong { color: var(--ck3-highlight); font-weight: normal; }
        #log-box p:last-child { border-bottom: none; }
        #log-entries { padding: 0; margin: 0; }

        /* --- New Sections Styling --- */
        .compact-list li { margin-bottom: 5px; font-size: 0.95em; }
        .compact-list li strong { min-width: 80px; }
        .sub-list { padding-left: 20px; margin-top: 5px; }
        .sub-list li { font-size: 0.9em; }
        .positive { color: var(--ck3-green); }
        .negative { color: var(--ck3-red); }
        .war-score { font-weight: bold; }
        .tyranny-gain { color: var(--ck3-tyranny); }
        .faction-strength { font-weight: bold; }
        .faction-strength.dangerous { color: var(--ck3-red); }
        .faction-strength.moderate { color: orange; }
        .faction-strength.safe { color: var(--ck3-green); }

        /* --- War Display --- */
        #active-wars-list li { border-bottom: 1px dashed var(--ck3-panel-border); padding-bottom: 5px; margin-bottom: 5px; }
        #active-wars-list li:last-child { border-bottom: none; }
        .war-details { display: block; font-size: 0.9em; margin-left: 15px; }
        .war-goal { font-style: italic; color: var(--ck3-text-muted); }
        .war-participants { font-size: 0.85em; color: #bbb; }

        /* --- Popups & Modals (Mostly Unchanged Structure, Added Content Styles) --- */
        #national-issue-popup, #faction-ultimatum-popup { /* Shared basic style */
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 550px;
            background-color: var(--ck3-panel-bg);
            border: 2px solid var(--ck3-accent);
            padding: 25px;
            border-radius: 5px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.7);
            z-index: 1001; /* Above overlay */
            color: var(--ck3-text);
         }
        #national-issue-popup h3, #faction-ultimatum-popup h3 { margin-top: 0; color: var(--ck3-highlight); text-align: center; font-size: 1.5em; }
        #national-issue-popup p, #faction-ultimatum-popup p { color: var(--ck3-text-muted); margin-bottom: 20px; }
        #national-issue-choices button, #faction-ultimatum-choices button {
            display: block; width: 100%; padding: 10px 15px; margin-bottom: 10px;
            font-family: 'Lato', sans-serif; font-size: 1em; cursor: pointer; border-radius: 4px;
            background-color: var(--ck3-panel-border); color: var(--ck3-text); border: 1px solid #555;
            transition: background-color 0.2s, border-color 0.2s; text-align: left; /* Align text left */
        }
        #national-issue-choices button:hover, #faction-ultimatum-choices button:hover { background-color: #444; border-color: var(--ck3-highlight); }
        #national-issue-choices button:last-child, #faction-ultimatum-choices button:last-child { margin-bottom: 0; }
        .choice-effects { font-size: 0.85em; color: var(--ck3-text-muted); margin-top: 4px; display: block; } /* Hint for effects */

        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75); z-index: 1000;
            justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }
        .modal-content {
            background: var(--ck3-panel-bg); border: 2px solid var(--ck3-highlight); padding: 25px 35px;
            border-radius: 5px; max-width: 600px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            color: var(--ck3-text); position: relative; max-height: 80vh; overflow-y: auto;
        }
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; color: var(--ck3-highlight); font-size: 1.6em; text-align: center; border-bottom: 1px solid var(--ck3-panel-border); padding-bottom: 10px; }
        .modal-content p { color: var(--ck3-text-muted); margin-bottom: 15px; font-size: 1.0em; line-height: 1.5; }
        .modal-content ul { margin-bottom: 15px; }
        .modal-content ul li { margin-bottom: 6px; color: var(--ck3-text); }
        .modal-content ul li strong { min-width: 90px; color: var(--ck3-text-muted); font-weight: normal; }
        .modal-content ul li span:not(.cost):not(.prisoner-details):not(.clickable-info) { color: var(--ck3-highlight); font-weight: bold; }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.8em; color: var(--ck3-text-muted); background: none; border: none; cursor: pointer; transition: color 0.2s; line-height: 1; }
        .modal-close-btn:hover { color: var(--ck3-highlight); }
        .modal-actions { margin-top: 25px; text-align: center; border-top: 1px solid var(--ck3-panel-border); padding-top: 20px; }
        .modal-actions button { display: inline-block; width: auto; padding: 10px 20px; margin: 0 10px; }
        .modal-actions button:disabled { background: #555 !important; border-color: #777 !important; color: #aaa !important; cursor: not-allowed !important; box-shadow: none !important; transform: none !important; }
        .cost-display { font-size: 0.9em; color: var(--ck3-text-muted); margin-top: 10px; display: block; text-align: center; }
        .cost-display .cost { font-weight: bold; }
        .cost-display .cost.gold { color: var(--ck3-highlight); }
        .cost-display .cost.prestige { color: goldenrod; }
        .cost-display .cost.tyranny { color: var(--ck3-tyranny); }
        .cost-display .cost.negative { color: var(--ck3-red); }
        .cost-display .cost.positive { color: var(--ck3-green); }
        #prisoner-list li { border-bottom: 1px dotted var(--ck3-panel-border); padding-bottom: 8px; margin-bottom: 8px; }
        #prisoner-list li:last-child { border-bottom: none; }
        .prisoner-details { font-size: 0.9em; color: var(--ck3-text-muted); display: block; margin-left: 10px; }
        .law-level-button { display: block; width: 100%; margin-bottom: 10px; text-align: left; }
        .law-level-button.current { border-left: 3px solid var(--ck3-highlight); background-color: rgba(200, 164, 100, 0.1); }
        .law-description { font-size: 0.9em; color: var(--ck3-text-muted); margin-top: 5px; margin-bottom: 10px; padding-left: 15px; border-left: 2px solid var(--ck3-panel-border); }

        /* Responsive adjustments (Unchanged) */
        @media (max-width: 1200px) { #game-container { grid-template-columns: 250px 1fr 250px; gap: 20px; padding: 20px; } }
        @media (max-width: 992px) { #game-container { grid-template-columns: 1fr 1fr; } #left-column { order: 1; } #middle-column { order: 3; grid-column: 1 / -1; } #right-column { order: 2; } #creator-backgrounds { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { body { padding: 10px; } #game-container { grid-template-columns: 1fr; gap: 15px; padding: 15px; } #left-column, #middle-column, #right-column { order: 0; grid-column: auto; } .info-box { padding: 15px; } h2, h3 { font-size: 1.2em; } .modal-content { padding: 20px; max-width: 95%; } .modal-content h3 { font-size: 1.4em; } }

    </style>
</head>
<body>

<!--
    **Crown & Compass v5 - Key Mechanics & NYI Status**

    **Implemented/Working (Core Loop):**
    *   Creator Screen: Basic character/realm setup, background selection affects starting stats/resources.
    *   Core Stats: Gold, Prestige, Skills, Stress, Tyranny, Health (basic).
    *   National Stats: Abstract representation of realm state (Stability, Economy etc.).
    *   Vassal Management: Display list, basic opinion, power calculation.
    *   Faction System: Vassals can join factions based on opinion/traits. Factions calculate strength relative to liege. Factions can issue ultimatums.
    *   Ultimatum Resolution: Player can accept (incurring costs/changes) or refuse (triggering civil war).
    *   Civil War: Basic war state triggered by refusing ultimatum. Abstract war calculation based on relative strength. War end conditions based on score. Basic consequences for winning/losing civil war (prestige, stability, imprison rebels, potential law changes).
    *   Laws: Crown Authority & Vassal Obligations can be changed, costing prestige and affecting opinion/stability/levies. Cooldown applies.
    *   Basic Actions: Advance Year (triggers income, stat drifts, checks), Save/Load/Reset.
    *   Vassal Actions: Improve Relations (cost, cooldown), Arrest (skill check, tyranny gain, failure consequences), View Details.
    *   Prisoner Management: Arrest success/failure adds prisoners. Can Ransom, Execute (tyranny/opinion hit), or Release (opinion gain) prisoners held by player.
    *   UI: Displays key information, updates dynamically. Clickable elements for details. Basic Modals for info/actions.
    *   Event System (Basic): National Issues (placeholder choices/effects), Faction Ultimatums.

    **Not Yet Implemented (NYI) / Simplified:**
    *   **Succession:** Still NYI. Ruler death leads to reset. No inheritance, heir system, claims, etc.
    *   **Military Detail:** War calculation is very abstract (relative strength). No tactical layer, specific MaA counters, troop movement, sieges, specific battle events, commander assignment effects beyond player martial. Levy raising is instant toggle, no muster time/cost. Men-at-Arms & Mercenaries are placeholders with no real function or hiring process. Declare War mechanism NYI.
    *   **Schemes:** Still basic placeholders. No player-initiated schemes (murder, fabricate hooks, sway, etc.). No AI schemes targeting player or others.
    *   **Diplomacy:** Alliance/Marriage/Improve Relations (General) remain NYI. No interactions with external realms. Truces are mentioned but not implemented.
    *   **Character Generation/Progression:** No dynamic character generation beyond the initial setup (births, deaths of non-player characters, courtiers). No skill progression/lifestyle focus perks. No dynamic trait acquisition/loss beyond initial setup. Dynasty members are static placeholders.
    *   **Economy/Building:** Very simplified income. No domain limit, building slots, development, or economic buildings. Vassal tax is abstract.
    *   **Events:** Limited to the few national issues and faction ultimatums. No dynamic character events, stress events, cultural/religious events, etc.
    *   **Laws Detail:** Succession laws NYI. Religious laws NYI. Vassal Contracts NYI. Law prerequisites beyond simple checks are basic.
    *   **Religion:** Placeholder stats (Fervor). No Doctrines, Sins/Virtues mechanics, Holy Sites, Head of Faith interaction, Conversion/Reformation mechanics.
    *   **Culture:** Placeholder. No cultural innovations, acceptance levels, or culture-specific mechanics.
    *   **Advanced Vassal Interaction:** Granting titles, revoking titles, vassal contracts, hooks, opinions between vassals.
    *   **Map/Provinces:** No geographical representation. All interactions are abstract lists.
    *   **AI:** Vassal AI is limited to joining factions based on simple rules. No independent AI goals, wars, schemes, or diplomacy.
-->

<!-- Creator Screen -->
<div id="creator-container">
    <h2>Create Your Legacy</h2>
    <div class="creator-field"> <label for="creator-ruler-name">Ruler Name:</label> <input type="text" id="creator-ruler-name" value="Aethelstan"> </div>
    <div class="creator-field"> <label for="creator-dynasty-name">Dynasty Name:</label> <input type="text" id="creator-dynasty-name" value="of Wessex"> </div>
    <div class="creator-field"> <label for="creator-realm-name">Realm Name:</label> <input type="text" id="creator-realm-name" value="Kingdom of England"> </div>
    <div class="creator-field"> <label for="creator-realm-title">Primary Title:</label> <input type="text" id="creator-realm-title" value="King"> </div>
    <div class="creator-field"> <label for="creator-culture-name">Culture Name:</label> <input type="text" id="creator-culture-name" value="Anglo-Saxon"> </div>
    <div class="creator-field"> <label for="creator-religion-name">Religion Name:</label> <input type="text" id="creator-religion-name" value="Catholic"> </div>
    <label class="creator-section-title">Starting Background:</label>
    <div id="creator-backgrounds">
        <!-- Background cards will be populated by JS -->
        <p style="color: var(--ck3-text-muted);">Loading backgrounds...</p>
    </div>
    <button id="creator-start-btn" disabled>Select a Background</button>
</div>

<!-- Main Game Screen -->
<div id="game-container">
    <!-- Left Column: Character & Dynasty -->
    <div id="left-column">
        <div class="info-box">
             <h2><span class="icon fa-solid fa-user-crown"></span><span id="ruler-name">Ruler Name</span></h2>
             <ul class="compact-list">
                <li><strong><span class="icon fa-solid fa-chess-king"></span>Dynasty:</strong> <span id="char-dynasty-name" class="clickable-info" data-type="dynasty" data-id="player">Dynasty</span></li>
                <li><strong><span class="icon fa-solid fa-scroll"></span>Title:</strong> <span id="char-realm-title">Primary Title</span></li>
                <li><strong><span class="icon fa-solid fa-landmark-flag"></span>Culture:</strong> <span id="char-culture" class="clickable-info" data-type="culture" data-id="player">Culture</span></li>
                <li><strong><span class="icon fa-solid fa-place-of-worship"></span>Religion:</strong> <span id="char-religion" class="clickable-info" data-type="religion" data-id="player">Religion</span></li>
                <li><strong><span class="icon fa-solid fa-heart-pulse"></span>Health:</strong> <span id="ruler-health">Healthy</span></li>
                <li><strong><span class="icon fa-solid fa-brain"></span>Stress:</strong> <span id="ruler-stress">0</span> / 100</li>
                <li><strong><span class="icon fa-solid fa-hand-holding-medical"></span>Tyranny:</strong> <span id="ruler-tyranny">0</span></li> <!-- Added Tyranny -->
                <li><strong><span class="icon fa-solid fa-star-of-life"></span>Lifestyle:</strong> <span id="ruler-lifestyle">None</span></li>
                <li><strong><span class="icon fa-solid fa-tags"></span>Traits:</strong> <span id="ruler-traits">None</span></li>
            </ul>
            <h3>Skills</h3>
            <ul class="compact-list" id="character-skills-list">
                <li><strong><span class="icon fa-solid fa-handshake-angle"></span>Diplomacy:</strong> <span id="skill-diplomacy">0</span></li>
                <li><strong><span class="icon fa-solid fa-shield-halved"></span>Martial:</strong> <span id="skill-martial">0</span></li>
                <li><strong><span class="icon fa-solid fa-coins"></span>Stewardship:</strong> <span id="skill-stewardship">0</span></li>
                <li><strong><span class="icon fa-solid fa-user-secret"></span>Intrigue:</strong> <span id="skill-intrigue">0</span></li>
                <li><strong><span class="icon fa-solid fa-book-open"></span>Learning:</strong> <span id="skill-learning">0</span></li>
            </ul>
        </div>

        <div class="info-box">
            <h2><span class="icon fa-solid fa-crown"></span>Dynasty: <span id="dynasty-name" class="clickable-info" data-type="dynasty" data-id="player">Dynasty</span></h2>
            <ul class="compact-list">
                <li><strong><span class="icon fa-solid fa-star"></span>Prestige:</strong> <span id="dynasty-prestige">0</span></li>
                 <li><strong><span class="icon fa-solid fa-sitemap"></span>Members:</strong> <span id="dynasty-members-count">1</span></li>
                 <div id="dynasty-members-list" class="sub-list"></div>
                 <li><strong><span class="icon fa-solid fa-scroll"></span>Legacies:</strong> <span id="dynasty-legacies">None</span></li>
                 <div id="dynasty-legacies-list" class="sub-list"></div>
            </ul>
        </div>
    </div>

    <!-- Middle Column: Realm, Stats, Vassals, Actions, Log -->
    <div id="middle-column">
         <div class="info-box">
             <h2><span class="icon fa-solid fa-map-location-dot"></span>Realm: <span id="realm-name">Realm Name</span></h2>
             <ul class="compact-list">
                <li><strong><span class="icon fa-solid fa-calendar-days"></span>Year:</strong> <span id="current-year">1066</span></li>
                <li><strong><span class="icon fa-solid fa-coins"></span>Gold:</strong> <span id="realm-gold">0</span></li>
                <li><strong><span class="icon fa-solid fa-landmark"></span>Classification:</strong> <span id="national-classification">Balanced Kingdom</span></li>
                <li><strong><span class="icon fa-solid fa-landmark-flag"></span>Culture:</strong> <span id="realm-culture" class="clickable-info" data-type="culture" data-id="realm">Culture</span></li>
                <li><strong><span class="icon fa-solid fa-place-of-worship"></span>Religion:</strong> <span id="realm-religion" class="clickable-info" data-type="religion" data-id="realm">Religion</span></li>
                 <li><strong><span class="icon fa-solid fa-shield-virus"></span>Active Wars:</strong> <span id="active-wars-count">0</span></li>
             </ul>
             <div id="active-wars-list" class="sub-list" style="margin-top: 10px;"></div>
        </div>

        <div id="national-stats-box" class="info-box">
             <h2><span class="icon fa-solid fa-chart-line"></span>National Overview</h2>
             <ul class="compact-list">
                <li><strong><span class="icon fa-solid fa-scale-balanced"></span>Stability:</strong> <span id="stat-stability">0</span></li>
                <li><strong><span class="icon fa-solid fa-hand-holding-dollar"></span>Economy:</strong> <span id="stat-economy">0</span></li>
                <li><strong><span class="icon fa-solid fa-users-viewfinder"></span>Vassal Opinion (Avg):</strong> <span id="stat-vassal-opinion">0</span></li>
                <li><strong><span class="icon fa-solid fa-person-military-pointing"></span>Military Strength:</strong> <span id="stat-military">0</span></li>
                 <li><strong><span class="icon fa-solid fa-heart-circle-check"></span>Social Welfare:</strong> <span id="stat-social-welfare">0</span></li>
                 <li><strong><span class="icon fa-solid fa-leaf"></span>Environment:</strong> <span id="stat-environment">0</span></li>
                 <li><strong><span class="icon fa-solid fa-person-booth"></span>Political Freedoms:</strong> <span id="stat-political-freedoms">0</span></li>
                 <li><strong><span class="icon fa-solid fa-gavel"></span>Civil Rights:</strong> <span id="stat-civil-rights">0</span></li>
             </ul>
        </div>

         <div class="info-box">
             <h2><span class="icon fa-solid fa-users"></span>Vassals (<span id="vassals-count">0</span>)</h2>
             <div id="vassals-list"><p>No major vassals.</p></div>
         </div>

         <div class="info-box">
             <h2><span class="icon fa-solid fa-fist-raised"></span>Factions (<span id="factions-count">0</span>)</h2>
              <div id="factions-list"><p>No active factions.</p></div>
              <button id="create-faction-btn" class="action-button nyi" style="font-size: 0.9em; padding: 5px 10px; margin-top: 10px;"><span class="icon fa-solid fa-plus-circle"></span> Create Faction</button>
         </div>

        <div id="actions" class="info-box">
             <h2><span class="icon fa-solid fa-cogs"></span>Realm Actions</h2>
             <button id="advance-year-btn"><span class="icon fa-solid fa-calendar-plus"></span> Advance Year</button>
             <button id="save-btn"><span class="icon fa-solid fa-save"></span> Save</button>
             <button id="load-btn"><span class="icon fa-solid fa-folder-open"></span> Load</button>
             <button id="reset-btn" style="background: linear-gradient(to bottom, #8a3a3a, #7a2a2a); border-color: #c88484;"><span class="icon fa-solid fa-trash-alt"></span> Reset</button>
        </div>

        <div id="log-box" class="info-box">
             <h2><span class="icon fa-solid fa-scroll"></span>Event Log</h2>
             <div id="log-entries"><p>Game Initialized.</p></div>
        </div>
    </div>

     <!-- Right Column: Military, Laws, Intrigue, Diplomacy -->
    <div id="right-column">
         <div class="info-box">
             <h2><span class="icon fa-solid fa-helmet-battle"></span>Military Command</h2>
              <ul class="compact-list">
                 <li><strong>Commander:</strong> <span id="assigned-general">Player</span></li>
                 <li><strong><span class="icon fa-solid fa-shield"></span>Total Levies:</strong> <span id="realm-levies">0</span></li>
                 <li><strong><span class="icon fa-solid fa-flag"></span>Raised Levies:</strong> <span id="raised-levies">0%</span></li> <!-- Added Raised % -->
                 <li><strong><span class="icon fa-solid fa-horse-head"></span>Men-at-Arms:</strong> <span id="realm-maa">None</span></li>
                 <li><strong><span class="icon fa-solid fa-money-bill-wave"></span>Mercenaries:</strong> <span id="hired-mercs-count">0</span></li>
                 <div id="hired-mercs-list" class="sub-list"></div>
             </ul>
             <button id="raise-levies-btn" class="action-button nyi"><span class="icon fa-solid fa-flag"></span> Raise/Disband Levies</button>
             <button id="hire-mercs-btn" class="action-button nyi"><span class="icon fa-solid fa-coins"></span> Hire Mercenaries</button>
             <button id="declare-war-btn" class="action-button nyi"><span class="icon fa-solid fa-scroll-torah"></span> Declare War</button>
         </div>

        <div class="info-box">
            <h2><span class="icon fa-solid fa-gavel"></span>Laws & Governance</h2>
            <ul class="compact-list" id="laws-list">
                 <li><strong>Crown Authority:</strong> <span id="law-crown-authority" class="clickable-info" data-type="law" data-id="crownAuthority">Limited</span></li>
                 <li><strong>Succession Law:</strong> <span id="law-succession" class="clickable-info nyi" data-type="law" data-id="succession">Confederate Partition</span></li>
                 <li><strong>Vassal Obligations:</strong> <span id="law-vassal-obligations" class="clickable-info" data-type="law" data-id="vassalObligations">Standard Feudal</span></li> <!-- Added -->
                 <li><strong>Religious Law:</strong> <span id="law-religious" class="clickable-info nyi" data-type="law" data-id="religiousLaws">Faith Tolerance</span></li> <!-- Added -->
            </ul>
            <button id="change-laws-btn" class="action-button"><span class="icon fa-solid fa-gavel"></span> Change Laws</button>
        </div>

         <div class="info-box">
             <h2><span class="icon fa-solid fa-handshake"></span>Diplomacy</h2>
             <ul class="compact-list">
                 <li><strong>Range:</strong> <span id="diplo-range">Adjacent Realms</span></li>
                 <li><strong><span class="icon fa-solid fa-ring"></span>Alliances:</strong> <span id="alliances-count">0</span></li>
                 <div id="alliances-list" class="sub-list"></div>
                 <li><strong><span class="icon fa-solid fa-flag-checkered"></span>Truces:</strong> <span id="truces-count">0</span></li>
             </ul>
              <button id="seek-alliance-btn" class="action-button nyi"><span class="icon fa-solid fa-ring"></span> Seek Alliance</button>
              <button id="arrange-marriage-btn" class="action-button nyi"><span class="icon fa-solid fa-venus-mars"></span> Arrange Marriage</button>
              <button id="improve-relations-btn" class="action-button nyi"><span class="icon fa-solid fa-arrow-up-right-dots"></span> Improve Relations (General)</button>
         </div>

        <div class="info-box">
             <h2><span class="icon fa-solid fa-user-secret"></span>Intrigue & Schemes</h2>
             <ul class="compact-list">
                 <li><strong>Known Schemes:</strong> <span id="schemes-count">0</span></li>
                 <li><strong>Plot Power (vs Liege):</strong> <span id="plot-power-against">N/A</span>%</li>
                 <li><strong><span class="icon fa-solid fa-lock"></span>Prisoners:</strong> <span id="prisoners-count" class="clickable-info" data-type="prisoners" data-id="player">0</span></li> <!-- Made clickable -->
             </ul>
             <button id="start-scheme-btn" class="action-button nyi"><span class="icon fa-solid fa-feather-pointed"></span> Start Scheme</button>
             <button id="manage-prisoners-btn" class="action-button"><span class="icon fa-solid fa-key"></span> Manage Prisoners</button> <!-- Made functional -->
        </div>

        <div class="info-box">
             <h2><span class="icon fa-solid fa-place-of-worship"></span>Religion</h2>
             <ul class="compact-list">
                 <li><strong>Faith:</strong> <span id="religion-name-display" class="clickable-info" data-type="religion" data-id="realm">Religion</span></li>
                 <li><strong>Head of Faith:</strong> <span id="religion-head">None</span></li>
                 <li><strong>Fervor:</strong> <span id="religion-fervor">50%</span></li>
                 <li><strong>Relations (Others):</strong> <span id="religion-relations">Tolerant</span></li>
             </ul>
              <button id="convert-province-btn" class="action-button nyi"><span class="icon fa-solid fa-cross"></span> Convert County</button>
              <button id="reform-faith-btn" class="action-button nyi"><span class="icon fa-solid fa-book-bible"></span> Reform Faith</button>
        </div>
    </div>
</div>

<!-- National Issue Popup (Unchanged Structure) -->
<div id="national-issue-popup">
     <h3>A Matter of State</h3>
     <p id="national-issue-description">Issue details...</p>
     <div id="national-issue-choices"></div>
</div>

<!-- Faction Ultimatum Popup (New) -->
<div id="faction-ultimatum-popup">
     <h3>Ultimatum Delivered!</h3>
     <p id="faction-ultimatum-description">Details...</p>
     <div id="faction-ultimatum-choices"></div>
</div>

<!-- Generic Info/Action Modal (Unchanged Structure) -->
<div id="generic-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="closeModal('generic-modal')">×</button>
        <h3 id="modal-title">Information</h3>
        <div id="modal-body">
            <p>Details will load here...</p>
        </div>
        <div id="modal-actions" class="modal-actions" style="display: none;"></div>
    </div>
</div>


<script>
    // --- Default Game State (Expanded v5) ---
    const defaultGameState = {
        setupComplete: false,
        saveVersion: 5, // Incremented version
        year: 1066,
        character: {
            id: 'player', // Added unique ID for player character
            name: "Default Ruler", title: "Chieftain", dynasty: "Default Dynasty", dynastyId: 'player_dynasty', // Link to dynasty
            culture: "Default Culture", religion: "Default Faith",
            traits: ["Ambitious", "Brave", "Wrathful"],
            health: 75, healthStatus: "Healthy", lifestyle: "Martial", stress: 10, tyranny: 0, // Added tyranny
            skills: { diplomacy: 4, martial: 8, stewardship: 3, intrigue: 5, learning: 2 },
            isImprisoned: false, jailorId: null, isRebelling: false, // Added status flags
        },
        dynasty: {
            id: 'player_dynasty', // Added unique ID
            name: "Default Dynasty", prestige: 50,
            members: [], // Player added dynamically on start
            legacies: [], nextCharId: 1,
        },
        realm: {
            name: "Default Realm", gold: 150,
            culture: "Default Culture", religion: "Default Faith",
            laws: {
                crownAuthority: "Limited", // Autonomous, Limited, High, Absolute
                succession: "Confederate Partition", // NYI - Primogeniture, Seniority, Election etc.
                vassalObligations: "Standard Feudal", // Low, Standard, High, Absolute
                religiousLaws: "Faith Tolerance", // Tolerance, Righteous, Fundamentalist (NYI)
                contracts: "Standard Feudal" // NYI - Individual Vassal Contracts
            },
            lawDefinitions: {
                 crownAuthority: [
                    { level: "Autonomous", prestigeCost: 0, opinionModVassal: +10, stabilityModYearly: -1, description: "Vassals largely govern themselves. Cannot imprison without cause.", unlockCondition: () => true, effects: {} },
                    { level: "Limited", prestigeCost: 150, opinionModVassal: 0, stabilityModYearly: 0, description: "Basic obligations enforced. Can imprison with cause.", unlockCondition: () => true, effects: {} },
                    { level: "High", prestigeCost: 500, opinionModVassal: -15, stabilityModYearly: +1, description: "Increased crown control, title revocation allowed (NYI). Easier imprisonment.", unlockCondition: () => true, effects: {} },
                    { level: "Absolute", prestigeCost: 1000, opinionModVassal: -30, stabilityModYearly: +1, description: "Total royal authority, vassals resentful. Can imprison freely (high tyranny).", unlockCondition: (gs) => gs.realm.laws.crownAuthority === 'High', effects: {} } // Example unlock condition
                ],
                succession: [ /* Definitions NYI */ ],
                vassalObligations: [
                     { level: "Scutage", prestigeCost: 100, opinionModVassal: +5, levyMod: -0.25, goldMod: +0.15, description: "Vassals pay tax instead of providing large levies.", unlockCondition: () => true, effects: {} },
                     { level: "Standard Feudal", prestigeCost: 0, opinionModVassal: 0, levyMod: 0, goldMod: 0, description: "Balanced levy and tax obligations.", unlockCondition: () => true, effects: {} },
                     { level: "High Levy", prestigeCost: 300, opinionModVassal: -10, levyMod: +0.25, goldMod: -0.10, description: "Vassals provide significantly more levies, less tax.", unlockCondition: () => true, effects: {} },
                     { level: "Absolute Control", prestigeCost: 750, opinionModVassal: -25, levyMod: +0.10, goldMod: +0.10, description: "Demands significant levy and tax. Vassal limits reduced (NYI).", unlockCondition: (gs) => gs.realm.laws.crownAuthority === 'High' || gs.realm.laws.crownAuthority === 'Absolute', effects: {} }
                 ],
                 religiousLaws: [ /* Definitions NYI */ ],
                 contracts: [ /* Definitions NYI */ ]
            },
            vassals: [ // Added more vassals with placeholder skills/dynasty links
                 { id: 'vas_0', name: "Eadric the Grasping", title: "Earl of Mercia", opinion: -25, power: 18, factionId: 'fac_1', traits: ["Greedy", "Ambitious", "Deceitful"], culture: "Anglo-Saxon", religion: "Catholic", skills: { diplomacy: 3, martial: 5, stewardship: 7, intrigue: 6, learning: 2 }, dynastyId: 'dyn_merc', isImprisoned: false, jailorId: null, isRebelling: false },
                 { id: 'vas_1', name: "Leofwine the Loyal", title: "Duke of Hwicce", opinion: 30, power: 12, factionId: null, traits: ["Loyal", "Content", "Temperate"], culture: "Anglo-Saxon", religion: "Catholic", skills: { diplomacy: 6, martial: 6, stewardship: 5, intrigue: 3, learning: 4 }, dynastyId: 'dyn_hwic', isImprisoned: false, jailorId: null, isRebelling: false },
                 { id: 'vas_2', name: "Siward the Bear", title: "Earl of Northumbria", opinion: -5, power: 20, factionId: 'fac_1', traits: ["Brave", "Wrathful", "Ambitious"], culture: "Norse", religion: "Catholic", skills: { diplomacy: 2, martial: 9, stewardship: 4, intrigue: 4, learning: 3 }, dynastyId: 'dyn_nort', isImprisoned: false, jailorId: null, isRebelling: false },
                 { id: 'vas_3', name: "Bishop Wulfstan", title: "Bishop of Worcester", opinion: 15, power: 8, factionId: null, traits: ["Pious", "Just", "Learning"], culture: "Anglo-Saxon", religion: "Catholic", skills: { diplomacy: 5, martial: 2, stewardship: 6, intrigue: 3, learning: 8 }, dynastyId: null, isImprisoned: false, jailorId: null, isRebelling: false }, // No dynasty
                 { id: 'vas_4', name: "Gruffydd the Proud", title: "Prince of Deheubarth", opinion: -10, power: 15, factionId: null, traits: ["Proud", "Brave", "Cynical"], culture: "Welsh", religion: "Catholic", skills: { diplomacy: 4, martial: 7, stewardship: 3, intrigue: 5, learning: 3 }, dynastyId: 'dyn_dehe', isImprisoned: false, jailorId: null, isRebelling: false },
                 { id: 'vas_5', name: "Aelfgar the Exile", title: "Claimant", opinion: -40, power: 5, factionId: null, traits: ["Ambitious", "Envious", "Patient"], culture: "Anglo-Saxon", religion: "Catholic", skills: { diplomacy: 5, martial: 4, stewardship: 2, intrigue: 7, learning: 4 }, dynastyId: 'dyn_exil', isImprisoned: false, jailorId: null, isRebelling: false }, // Low power claimant
            ],
            nextVassalId: 6,
            factions: [
                 { id: 'fac_0', name: "Peasant Freedom League", goal: "Lower Taxes & Obligations", members: [], type: "Populist", strength: 0, threshold: 60, ultimatumSent: false, creatorId: null, isActive: true },
                 { id: 'fac_1', name: "Independence for the North", goal: "Install Siward as King", members: ['vas_0', 'vas_2'], type: "Claimant", strength: 0, threshold: 80, ultimatumSent: false, creatorId: 'vas_2', isActive: true }
            ],
             nextFactionId: 2,
             alliances: [], nextAllianceId: 0, truces: [],
             activeWars: [], // { id: 'war_0', type: 'Civil War'|'Conquest'|..., attackers: [id,...], defenders: [id,...], warGoal: '...', score: 0, attackerLeader: id, defenderLeader: id, startYear: YYYY }
             nextWarId: 0,
             availableMercenaries: [ /* ... */ ], hiredMercenaries: [], nextMercId: 2,
             military: {
                 leviesBase: 500, // Base number before modifiers
                 leviesModifier: 1.0, // Combined modifier from laws, etc.
                 raisedLeviesPercent: 0, // 0 to 100
                 menAtArms: [],
                 generals: [] // Player is default commander if empty
             },
             intrigue: {
                 knownSchemes: [], plotPowerAgainst: null,
                 prisoners: [], // { characterId: 'vas_X' | 'dyn_Y', name: '...', reason: 'Rebellion'|'Plotting'|'Crime', jailorId: 'player' }
                 nextPrisonerId: 0 // If needed for unique prisoner record id
             },
             religionDetails: { head: "Pope", fervor: 50, relations: {} } // Catholic default head
        },
        nationalStats: {
            economy: 35, civilRights: 25, politicalFreedoms: 30, military: 40, // Military is more abstract now
            socialWelfare: 20, environment: 70, stability: 60,
        },
        log: ["Game Initialized."],
        issueCooldown: 2,
        actionCosts: {
            improveRelationsVassal: { gold: 50, prestigeBase: 25, opinionGain: 15, cooldownYears: 3 },
            changeLaw: { prestigeBase: 200, opinionModBase: -5, stabilityCheck: 50 },
            arrestVassal: { tyrannyBaseSuccess: 0, tyrannyBaseFail: 2, tyrannyNoReason: 10, prestigeCostFail: -50 },
            executePrisoner: { tyrannyGain: 20, prestigeGain: -25, stressChange: 0 }, // Stress change depends on traits
            ransomPrisoner: { goldGainBase: 50, prestigeGain: 10 },
            releasePrisoner: { opinionGainTarget: 10, prestigeGain: 5 }
        },
        actionCooldowns: {
            improveRelations: {}, // { vassalId: endYear, ... }
            changeLaw: 0, // End year when law can be changed again
        }
    };

    // --- Game State ---
    let gameState = {};
    let selectedBackground = null;

     // --- Background Options ---
     const backgroundOptions = [
         {
             id: "balanced_start", name: "Established Ruler", description: "A standard start with balanced resources and moderate skills.",
             gold: 150, prestige: 50,
             traits: ["Just", "Temperate", "Diligent"],
             skills: { diplomacy: 5, martial: 5, stewardship: 5, intrigue: 5, learning: 5 },
             stats: { economy: 40, stability: 65, military: 40, socialWelfare: 30, environment: 60, politicalFreedoms: 40, civilRights: 40 }
         },
         {
             id: "martial_focus", name: "Warlord Ascendant", description: "Focus on military might, starting with higher martial skill and levies, but less gold.",
             gold: 75, prestige: 100,
             traits: ["Brave", "Wrathful", "Ambitious"],
             skills: { diplomacy: 3, martial: 9, stewardship: 3, intrigue: 4, learning: 2 },
             stats: { economy: 25, stability: 50, military: 60, socialWelfare: 15, environment: 50, politicalFreedoms: 25, civilRights: 20 }
         },
         {
             id: "steward_focus", name: "Prosperous Realm", description: "A focus on economy and stability, starting with more gold and stewardship.",
             gold: 300, prestige: 30,
             traits: ["Diligent", "Greedy", "Patient"],
             skills: { diplomacy: 4, martial: 3, stewardship: 9, intrigue: 4, learning: 5 },
             stats: { economy: 60, stability: 70, military: 25, socialWelfare: 40, environment: 70, politicalFreedoms: 35, civilRights: 35 }
         },
         {
             id: "intrigue_focus", name: "Shadow Broker", description: "Skilled in the arts of intrigue, starting with higher intrigue but potentially lower stability.",
             gold: 120, prestige: 40,
             traits: ["Deceitful", "Patient", "Paranoid"],
             skills: { diplomacy: 4, martial: 4, stewardship: 4, intrigue: 9, learning: 4 },
             stats: { economy: 35, stability: 45, military: 35, socialWelfare: 25, environment: 65, politicalFreedoms: 30, civilRights: 30 }
         },
         {
             id: "learning_focus", name: "Scholar King", description: "Focused on learning and piety, less emphasis on martial or economic pursuits initially.",
             gold: 100, prestige: 60,
             traits: ["Learning", "Pious", "Content"],
             skills: { diplomacy: 5, martial: 2, stewardship: 5, intrigue: 3, learning: 9 },
             stats: { economy: 30, stability: 60, military: 20, socialWelfare: 35, environment: 75, politicalFreedoms: 45, civilRights: 50 }
         }
     ];

    // --- DOM References (Added/Updated) ---
    const domRefs = {
        // Creator...
        creatorContainer: document.getElementById('creator-container'),
        creatorRulerName: document.getElementById('creator-ruler-name'),
        creatorDynastyName: document.getElementById('creator-dynasty-name'),
        creatorRealmName: document.getElementById('creator-realm-name'),
        creatorRealmTitle: document.getElementById('creator-realm-title'),
        creatorCultureName: document.getElementById('creator-culture-name'),
        creatorReligionName: document.getElementById('creator-religion-name'),
        creatorBackgrounds: document.getElementById('creator-backgrounds'),
        creatorStartBtn: document.getElementById('creator-start-btn'),
        // Game Container
        gameContainer: document.getElementById('game-container'),
        // Left Column...
        rulerName: document.getElementById('ruler-name'),
        charDynastyName: document.getElementById('char-dynasty-name'),
        charRealmTitle: document.getElementById('char-realm-title'),
        charCulture: document.getElementById('char-culture'),
        charReligion: document.getElementById('char-religion'),
        rulerHealth: document.getElementById('ruler-health'),
        rulerStress: document.getElementById('ruler-stress'),
        rulerTyranny: document.getElementById('ruler-tyranny'), // Added
        rulerLifestyle: document.getElementById('ruler-lifestyle'),
        rulerTraits: document.getElementById('ruler-traits'),
        skillDiplomacy: document.getElementById('skill-diplomacy'),
        skillMartial: document.getElementById('skill-martial'),
        skillStewardship: document.getElementById('skill-stewardship'),
        skillIntrigue: document.getElementById('skill-intrigue'),
        skillLearning: document.getElementById('skill-learning'),
        dynastyName: document.getElementById('dynasty-name'),
        dynastyPrestige: document.getElementById('dynasty-prestige'),
        dynastyMembersCount: document.getElementById('dynasty-members-count'),
        dynastyMembersList: document.getElementById('dynasty-members-list'),
        dynastyLegacies: document.getElementById('dynasty-legacies'),
        dynastyLegaciesList: document.getElementById('dynasty-legacies-list'),
        // Middle Column...
        realmName: document.getElementById('realm-name'),
        currentYear: document.getElementById('current-year'),
        realmGold: document.getElementById('realm-gold'),
        nationalClassification: document.getElementById('national-classification'),
        realmCulture: document.getElementById('realm-culture'),
        realmReligion: document.getElementById('realm-religion'),
        activeWarsCount: document.getElementById('active-wars-count'),
        activeWarsList: document.getElementById('active-wars-list'),
        statEconomy: document.getElementById('stat-economy'),
        statCivilRights: document.getElementById('stat-civil-rights'),
        statPoliticalFreedoms: document.getElementById('stat-political-freedoms'),
        statMilitary: document.getElementById('stat-military'),
        statSocialWelfare: document.getElementById('stat-social-welfare'),
        statEnvironment: document.getElementById('stat-environment'),
        statStability: document.getElementById('stat-stability'),
        statVassalOpinion: document.getElementById('stat-vassal-opinion'),
        vassalsCount: document.getElementById('vassals-count'),
        vassalsList: document.getElementById('vassals-list'),
        factionsCount: document.getElementById('factions-count'),
        factionsList: document.getElementById('factions-list'),
        createFactionBtn: document.getElementById('create-faction-btn'), // Added
        advanceYearBtn: document.getElementById('advance-year-btn'),
        saveBtn: document.getElementById('save-btn'),
        loadBtn: document.getElementById('load-btn'),
        resetBtn: document.getElementById('reset-btn'),
        logEntries: document.getElementById('log-entries'),
        // Right Column...
        assignedGeneral: document.getElementById('assigned-general'),
        hiredMercsCount: document.getElementById('hired-mercs-count'),
        hiredMercsList: document.getElementById('hired-mercs-list'),
        realmLevies: document.getElementById('realm-levies'), // Now Total Levies
        raisedLevies: document.getElementById('raised-levies'), // Added
        realmMaa: document.getElementById('realm-maa'),
        hireMercsBtn: document.getElementById('hire-mercs-btn'),
        declareWarBtn: document.getElementById('declare-war-btn'),
        raiseLeviesBtn: document.getElementById('raise-levies-btn'),
        lawsList: document.getElementById('laws-list'),
        lawCrownAuthority: document.getElementById('law-crown-authority'),
        lawSuccession: document.getElementById('law-succession'),
        lawVassalObligations: document.getElementById('law-vassal-obligations'), // Added
        lawReligious: document.getElementById('law-religious'), // Added
        // lawContracts: document.getElementById('law-contracts'), // Removed contracts for now to simplify
        changeLawsBtn: document.getElementById('change-laws-btn'),
        alliancesCount: document.getElementById('alliances-count'),
        alliancesList: document.getElementById('alliances-list'),
        trucesCount: document.getElementById('truces-count'),
        diploRange: document.getElementById('diplo-range'),
        seekAllianceBtn: document.getElementById('seek-alliance-btn'),
        arrangeMarriageBtn: document.getElementById('arrange-marriage-btn'),
        improveRelationsBtn: document.getElementById('improve-relations-btn'),
        schemesCount: document.getElementById('schemes-count'),
        plotPowerAgainst: document.getElementById('plot-power-against'),
        prisonersCount: document.getElementById('prisoners-count'), // Updated ID ref
        startSchemeBtn: document.getElementById('start-scheme-btn'),
        managePrisonersBtn: document.getElementById('manage-prisoners-btn'), // Updated ID ref
        religionNameDisplay: document.getElementById('religion-name-display'),
        religionHead: document.getElementById('religion-head'),
        religionFervor: document.getElementById('religion-fervor'),
        religionRelations: document.getElementById('religion-relations'),
        convertProvinceBtn: document.getElementById('convert-province-btn'),
        reformFaithBtn: document.getElementById('reform-faith-btn'),
        // Popups
        nationalIssuePopup: document.getElementById('national-issue-popup'),
        nationalIssueTitle: document.querySelector('#national-issue-popup h3'), // More specific selector
        nationalIssueDescription: document.getElementById('national-issue-description'),
        nationalIssueChoices: document.getElementById('national-issue-choices'),
        factionUltimatumPopup: document.getElementById('faction-ultimatum-popup'), // Added
        factionUltimatumTitle: document.querySelector('#faction-ultimatum-popup h3'), // Added
        factionUltimatumDescription: document.getElementById('faction-ultimatum-description'), // Added
        factionUltimatumChoices: document.getElementById('faction-ultimatum-choices'), // Added
        // Generic Modal
        genericModal: document.getElementById('generic-modal'),
        modalTitle: document.getElementById('modal-title'),
        modalBody: document.getElementById('modal-body'),
        modalActions: document.getElementById('modal-actions'),
    };

    // --- Helper Functions (Minor additions) ---
    function getRandomSkillValue(min = 1, max = 12) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function getRandomTraits(count = 3) {
        const allTraits = ["Just", "Temperate", "Diligent", "Patient", "Brave", "Honest", "Kind", "Humble", "Pious", "Content", "Gregarious", "Chaste", "Loyal", "Generous", "Ambitious", "Wrathful", "Deceitful", "Greedy", "Lazy", "Craven", "Cruel", "Paranoid", "Cynical", "Zealous", "Lustful", "Envious", "Proud", "Gluttonous"];
        const shuffled = allTraits.sort(() => 0.5 - Math.random());
        return shuffled.slice(0, count);
     }
    function isObject(item) { return (item && typeof item === 'object' && !Array.isArray(item)); }
    function deepMerge(target, source) {
        Object.keys(source).forEach(key => {
            const targetValue = target[key];
            const sourceValue = source[key];

            if (isObject(targetValue) && isObject(sourceValue)) {
                deepMerge(targetValue, sourceValue);
            } else {
                target[key] = sourceValue;
            }
        });
        return target;
    }

    function ensureNestedKeys(targetObj, defaultObj) {
        Object.keys(defaultObj).forEach(key => {
            if (typeof defaultObj[key] === 'object' && defaultObj[key] !== null && !Array.isArray(defaultObj[key])) {
                if (targetObj[key] === undefined || targetObj[key] === null) {
                    targetObj[key] = JSON.parse(JSON.stringify(defaultObj[key])); // Deep copy defaults if missing
                } else if (typeof targetObj[key] === 'object') {
                    ensureNestedKeys(targetObj[key], defaultObj[key]); // Recurse
                }
            } else if (targetObj[key] === undefined) {
                targetObj[key] = defaultObj[key]; // Assign default for non-objects if missing
            }
        });
    }
    function getCharacterById(id) {
        if (id === 'player') return gameState.character;
        // Check dynasty members (excluding player pseudo-entry)
        let member = gameState.dynasty.members.find(m => m.id === id && id !== 'player');
        if (member) return member; // Assuming members have necessary fields like name, traits etc.
        // Check vassals (assuming vassals ARE the characters we care about)
        let vassal = gameState.realm.vassals.find(v => v.id === id);
        if (vassal) return vassal; // Vassal object often holds the relevant character info
        return null; // Not found anywhere
    }
    function getVassalById(id) { return gameState.realm.vassals.find(v => v.id === id); }
    function getFactionById(id) { return gameState.realm.factions.find(f => f.id === id); }
    function getWarById(id) { return gameState.realm.activeWars.find(w => w.id === id); }
    function getPrisonerById(characterId) { return gameState.realm.intrigue.prisoners.find(p => p.characterId === characterId); }


    // --- Creator Logic ---
    function populateBackgroundCards() {
        domRefs.creatorBackgrounds.innerHTML = ''; // Clear loading/previous cards
        backgroundOptions.forEach((bg, index) => {
            const card = document.createElement('div');
            card.classList.add('background-card');
            card.dataset.bgId = bg.id; // Store id for lookup

            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'creator-background';
            radio.id = `bg-radio-${index}`;
            radio.value = bg.id;
            // Add event listener to radio for selection logic
            radio.addEventListener('change', handleBackgroundSelection);

            const title = document.createElement('h4');
            title.textContent = bg.name;

            const desc = document.createElement('p');
            desc.textContent = bg.description;

            const details = document.createElement('p');
            details.style.fontSize = '0.8em';
            details.style.marginTop = '8px';
            details.innerHTML = `Gold: <span style="color: var(--ck3-highlight);">${bg.gold}</span>, Prestige: <span style="color: goldenrod;">${bg.prestige}</span>`;

            card.appendChild(radio); // Radio should be first for CSS positioning if needed
            card.appendChild(title);
            card.appendChild(desc);
            card.appendChild(details);
            domRefs.creatorBackgrounds.appendChild(card);
        });
    }

    function handleBackgroundSelection(event) {
        const selectedRadio = event.target;
        const selectedId = selectedRadio.value;
        selectedBackground = backgroundOptions.find(bg => bg.id === selectedId);

        // Update card styling
        document.querySelectorAll('.background-card').forEach(card => {
            card.classList.remove('selected');
            if (card.dataset.bgId === selectedId) {
                card.classList.add('selected');
            }
        });

        // Enable start button
        if (selectedBackground) {
            domRefs.creatorStartBtn.disabled = false;
            domRefs.creatorStartBtn.textContent = `Start as ${selectedBackground.name}`;
        } else {
            domRefs.creatorStartBtn.disabled = true;
            domRefs.creatorStartBtn.textContent = "Select a Background";
        }
    }

    function startGameFromCreator() {
        if (!selectedBackground) {
            alert("Please select a starting background!");
            return;
        }
        console.log("Starting game from creator with background:", selectedBackground.name);
        gameState = JSON.parse(JSON.stringify(defaultGameState)); // Deep copy default state

        // Apply creator text inputs
        gameState.character.name = domRefs.creatorRulerName.value.trim() || "Ruler";
        gameState.character.dynasty = domRefs.creatorDynastyName.value.trim() || "Dynasty";
        gameState.character.title = domRefs.creatorRealmTitle.value.trim() || "Chieftain";
        gameState.character.culture = domRefs.creatorCultureName.value.trim() || "Culture";
        gameState.character.religion = domRefs.creatorReligionName.value.trim() || "Faith";

        gameState.dynasty.name = gameState.character.dynasty;
        gameState.dynasty.id = gameState.character.dynasty.toLowerCase().replace(/\s+/g, '_') + '_dynasty'; // Generate simple dynasty ID
        gameState.character.dynastyId = gameState.dynasty.id; // Link character to dynasty

        gameState.realm.name = domRefs.creatorRealmName.value.trim() || "Realm";
        gameState.realm.culture = gameState.character.culture;
        gameState.realm.religion = gameState.character.religion;
        gameState.realm.religionDetails.head = gameState.character.religion === "Catholic" ? "Pope" : "None"; // Basic head assignment

        // Apply background settings (override defaults)
        gameState.realm.gold = selectedBackground.gold;
        gameState.dynasty.prestige = selectedBackground.prestige;
        gameState.character.traits = [...selectedBackground.traits];
        // Merge skills: Start with default, then apply background specifics
        gameState.character.skills = { ...defaultGameState.character.skills, ...selectedBackground.skills };
        // Merge national stats: Start with default, then apply background specifics
        gameState.nationalStats = { ...defaultGameState.nationalStats, ...selectedBackground.stats };

        // Add player character to dynasty members list for reference
         gameState.dynasty.members.unshift({
             id: 'player', name: gameState.character.name, relation: "Self", status: "Alive",
             culture: gameState.character.culture, religion: gameState.character.religion,
             skills: gameState.character.skills, traits: gameState.character.traits, title: gameState.character.title
         });
         // Assign random traits/skills to default vassals if they don't have them (for consistency)
         gameState.realm.vassals.forEach(v => {
            if (!v.traits) v.traits = getRandomTraits(2);
            if (!v.skills) v.skills = { diplomacy: getRandomSkillValue(), martial: getRandomSkillValue(), stewardship: getRandomSkillValue(), intrigue: getRandomSkillValue(), learning: getRandomSkillValue() };
            // Initial opinion calculation could happen here if needed
         });

        gameState.setupComplete = true; // Mark setup as complete
        gameState.log = [`${gameState.year}: The reign of ${gameState.character.title} ${gameState.character.name} ${gameState.character.dynasty} begins in the ${gameState.realm.name}.`, `Selected background: ${selectedBackground.name}.`];


        console.log("Gamestate after creation:", JSON.parse(JSON.stringify(gameState))); // Log final state for debugging
        updateUI(); // Switch to game view and display initial state
    }


    // --- Modal Helpers ---
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            // Ensure overlay style is flex for centering
            modal.style.display = 'flex';
        }
    }
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            // Clear dynamic content if needed
            if(modalId === 'generic-modal') {
                 domRefs.modalTitle.textContent = "Information";
                 domRefs.modalBody.innerHTML = "<p>Details will load here...</p>";
                 domRefs.modalActions.innerHTML = "";
                 domRefs.modalActions.style.display = "none";
            }
        }
    }

    // --- Formatting and Display Helpers ---
    function formatTraits(traitList) {
        if (!traitList || traitList.length === 0) return 'None';
        return traitList.map(trait => {
            // Add positive/negative classes based on a predefined list (expand as needed)
            const positiveTraits = ["Just", "Temperate", "Diligent", "Patient", "Brave", "Honest", "Kind", "Humble", "Pious", "Content", "Gregarious", "Chaste", "Loyal", "Generous", "Learning"];
            const negativeTraits = ["Ambitious", "Wrathful", "Deceitful", "Greedy", "Lazy", "Craven", "Cruel", "Paranoid", "Cynical", "Zealous", "Lustful", "Envious", "Proud", "Gluttonous"];
            let className = 'trait';
            if (positiveTraits.includes(trait)) className += ' positive';
            if (negativeTraits.includes(trait)) className += ' negative';
            return `<span class="${className}">${trait}</span>`;
        }).join(' ');
     }

    function showInfoPopup(type, id) {
        console.log("showInfoPopup called with type:", type, "id:", id);
        closeModal('generic-modal'); // Close any existing modal first
        domRefs.modalTitle.textContent = "Details"; // Reset title
        domRefs.modalBody.innerHTML = ""; // Clear body
        domRefs.modalActions.innerHTML = ""; // Clear actions
        domRefs.modalActions.style.display = "none"; // Hide actions by default

        let content = "";
        let actions = "";

        switch (type) {
            case 'character':
            case 'vassal': // Vassal is a type of character for display
                 const char = getCharacterById(id);
                 const isVassal = gameState.realm.vassals.some(v => v.id === id);
                 if (char) {
                    domRefs.modalTitle.textContent = `${char.title ? char.title : ''} ${char.name}`;
                    const dynastyName = char.dynastyId ? (gameState.dynasty.id === char.dynastyId ? gameState.dynasty.name : (char.dynasty || 'Unknown Dynasty')) : (char.dynasty || 'No Dynasty');
                    const dynastyClickable = char.dynastyId ? `<span class="clickable-info" data-type="dynasty" data-id="${char.dynastyId}">${dynastyName}</span>` : `<span>${dynastyName}</span>`;

                    content = `<ul>
                        <li><strong>Dynasty:</strong> ${dynastyClickable}</li>
                        <li><strong>Culture:</strong> <span class="clickable-info" data-type="culture" data-id="${id}">${char.culture}</span></li>
                        <li><strong>Religion:</strong> <span class="clickable-info" data-type="religion" data-id="${id}">${char.religion}</span></li>
                        ${id !== 'player' ? `<li><strong>Opinion of You:</strong> <span class="${char.opinion >= 0 ? 'positive' : 'negative'}">${char.opinion}</span></li>` : ''}
                        ${isVassal ? `<li><strong>Power:</strong> <span>${char.power}</span></li>` : ''}
                        ${char.factionId ? `<li><strong>Faction:</strong> <span class="clickable-info" data-type="faction" data-id="${char.factionId}">${getFactionName(char.factionId)}</span></li>` : ''}
                        ${char.isImprisoned ? `<li><strong>Status:</strong> <span class="vassal-status imprisoned">Imprisoned by ${char.jailorId === 'player' ? 'You' : char.jailorId}</span></li>` : ''}
                        ${char.isRebelling ? `<li><strong>Status:</strong> <span class="vassal-status rebelling">In Rebellion</span></li>` : ''}
                        <li><strong>Traits:</strong> ${formatTraits(char.traits)}</li>
                     </ul>
                     <h3>Skills</h3>
                     <ul class="compact-list">
                        <li><strong>Diplomacy:</strong> <span>${char.skills?.diplomacy ?? '?'}</span></li>
                        <li><strong>Martial:</strong> <span>${char.skills?.martial ?? '?'}</span></li>
                        <li><strong>Stewardship:</strong> <span>${char.skills?.stewardship ?? '?'}</span></li>
                        <li><strong>Intrigue:</strong> <span>${char.skills?.intrigue ?? '?'}</span></li>
                        <li><strong>Learning:</strong> <span>${char.skills?.learning ?? '?'}</span></li>
                     </ul>`;

                    // --- Vassal Specific Actions ---
                     if (isVassal && id !== 'player' && !char.isRebelling && !char.isImprisoned) {
                         const costs = gameState.actionCosts.improveRelationsVassal;
                         const cooldownEndYear = gameState.actionCooldowns.improveRelations?.[id] || 0;
                         const canImprove = gameState.realm.gold >= costs.gold && gameState.dynasty.prestige >= costs.prestigeBase && gameState.year >= cooldownEndYear;
                         actions += `<button class="action-button" onclick="attemptImproveRelations('${id}')" ${!canImprove ? 'disabled' : ''} title="Cost: ${costs.gold}G, ${costs.prestigeBase}P. Cooldown: ${gameState.year >= cooldownEndYear ? 'Ready' : `Ready in ${cooldownEndYear - gameState.year}y`}"><i class="fa-solid fa-arrow-up-right-dots"></i> Improve Relations</button>`;

                         // Arrest Action
                         const arrestChance = calculateArrestChance(id);
                         actions += `<button class="action-button" onclick="attemptArrestVassal('${id}')" title="Attempt to imprison this vassal. Success chance: ${arrestChance}%"><i class="fa-solid fa-user-lock"></i> Arrest</button>`;

                         actions += `<button class="action-button nyi"><i class="fa-solid fa-hand-holding-dollar"></i> Grant Title</button>`;
                         actions += `<button class="action-button nyi"><i class="fa-solid fa-scroll-torah"></i> Offer Vassalage (NYI)</button>`;

                     } else if (isVassal && id !== 'player' && char.isImprisoned && char.jailorId === 'player') {
                         // Actions if vassal is YOUR prisoner
                          actions += `<button class="action-button" onclick="managePrisonerAction('${id}', 'ransom')"><i class="fa-solid fa-coins"></i> Ransom</button>`;
                          actions += `<button class="action-button" onclick="managePrisonerAction('${id}', 'execute')" style="background: linear-gradient(to bottom, #8a3a3a, #7a2a2a); border-color: #c88484;"><i class="fa-solid fa-skull-crossbones"></i> Execute</button>`;
                          actions += `<button class="action-button" onclick="managePrisonerAction('${id}', 'release')"><i class="fa-solid fa-key"></i> Release</button>`;
                     }
                 } else { content = "<p>Character information not found.</p>"; }
                 break;

            case 'dynasty':
                 const dynastyId = id; // Could be 'player_dynasty' or 'dyn_merc' etc.
                 const isPlayerDynasty = dynastyId === gameState.dynasty.id;
                 const dynasty = isPlayerDynasty ? gameState.dynasty : { name: `Dynasty ${dynastyId}`, prestige: '?', members: [], legacies: [] }; // Placeholder for other dynasties

                 domRefs.modalTitle.textContent = `Dynasty ${dynasty.name}`;
                 // Filter members correctly: Find all vassals belonging to this dynasty
                 const dynastyVassals = gameState.realm.vassals.filter(v => v.dynastyId === dynastyId);
                 const playerMember = isPlayerDynasty ? gameState.character : null;
                 const membersList = [];
                 if (playerMember) membersList.push(`<li><span class="clickable-info" data-type="character" data-id="player">${playerMember.name}</span> (Ruler) - Alive</li>`);
                 membersList.push(...dynastyVassals.map(m => `<li><span class="clickable-info" data-type="vassal" data-id="${m.id}">${m.name}</span> (${m.title}) - Alive</li>`));
                 // Add other dynasty members if implemented later (gameState.dynasty.members)

                 content = `<ul>
                             <li><strong>Prestige:</strong> <span>${isPlayerDynasty ? gameState.dynasty.prestige : '?'}</span></li>
                             <li><strong>Members (${membersList.length}):</strong></li>
                         </ul>
                         <ul class="sub-list">
                             ${membersList.join('') || '<li>None</li>'}
                         </ul>
                         <h3>Legacies</h3>
                         <ul class="sub-list">
                            ${isPlayerDynasty && gameState.dynasty.legacies.length > 0 ? gameState.dynasty.legacies.map(l => `<li>${l}</li>`).join('') : '<li>None unlocked</li>'}
                         </ul>`;
                 if (isPlayerDynasty) {
                    actions += `<button class="action-button nyi"><i class="fa-solid fa-scroll"></i> Unlock Legacy</button>`;
                 }
                 break;

            case 'culture':
            case 'religion':
                 // Basic placeholder popups
                 const sourceId = id; // 'player', 'realm', or vassal id
                 let sourceName = "";
                 let itemValue = "";
                 const charSource = getCharacterById(sourceId);

                 if (type === 'culture') {
                    domRefs.modalTitle.textContent = "Culture Details";
                    itemValue = charSource?.culture || gameState.realm.culture;
                    sourceName = charSource ? charSource.name : gameState.realm.name;
                    content = `<p>The culture of ${sourceName} is <strong>${itemValue}</strong>.</p><p>Cultural details, innovations, and acceptance levels are not yet implemented.</p>`;
                    actions += `<button class="action-button nyi"><i class="fa-solid fa-flask"></i> Promote Culture</button>`;
                 } else { // religion
                    domRefs.modalTitle.textContent = "Religion Details";
                    itemValue = charSource?.religion || gameState.realm.religion;
                    sourceName = charSource ? charSource.name : gameState.realm.name;
                    const head = gameState.realm.religionDetails.head || 'None';
                    const fervor = gameState.realm.religionDetails.fervor || 50;
                    content = `<p>The faith of ${sourceName} is <strong>${itemValue}</strong>.</p>
                               <ul>
                                 <li><strong>Head of Faith:</strong> <span>${head}</span></li>
                                 <li><strong>Fervor:</strong> <span>${fervor}%</span></li>
                               </ul>
                               <p>Doctrines, holy sites, and religious interactions are not yet fully implemented.</p>`;
                    actions += `<button class="action-button nyi"><i class="fa-solid fa-cross"></i> Convert County</button>`;
                    actions += `<button class="action-button nyi"><i class="fa-solid fa-book-bible"></i> Reform Faith</button>`;
                 }
                break;

             case 'law': // Shows details for a specific law type
                 const lawType = id; // e.g., 'crownAuthority', 'vassalObligations'
                 const lawDefs = gameState.realm.lawDefinitions[lawType];
                 const currentLevel = gameState.realm.laws[lawType];
                 const canChange = gameState.year >= (gameState.actionCooldowns.changeLaw || 0);

                 if (lawDefs) {
                     domRefs.modalTitle.textContent = `Change Law: ${getLawDisplayName(lawType)}`;
                     content = `<p>Current Law: <strong>${currentLevel}</strong></p>`;
                     content += `<p>Select a new law level. Changes cost Prestige and may affect Vassal Opinion and Stability. ${!canChange ? `You can change laws again in ${gameState.actionCooldowns.changeLaw - gameState.year} years.` : ''}</p>`;
                     content += `<hr style="border-color: var(--ck3-panel-border); margin: 15px 0;">`;

                     lawDefs.forEach(levelDef => {
                         const isCurrent = levelDef.level === currentLevel;
                         let costText = "";
                         let effectText = "";
                         let disabledReason = "";
                         let canAfford = true;
                         let meetsCondition = true;

                         if (!isCurrent) {
                             const cost = calculateLawChangeCost(lawType, levelDef.level);
                             costText = `<span class="cost-display">Cost: <span class="cost prestige">${cost.prestige} Prestige</span></span>`;
                             if (gameState.dynasty.prestige < cost.prestige) {
                                 canAfford = false;
                                 disabledReason += "Not enough Prestige. ";
                             }
                             if (!canChange) {
                                 disabledReason += "Law change on cooldown. ";
                             }
                             if (levelDef.unlockCondition && !levelDef.unlockCondition(gameState)) {
                                 meetsCondition = false;
                                 disabledReason += "Requirements not met. "; // Add specific reason later if needed
                             }
                              effectText = `<span class="cost-display">Effects: ${levelDef.opinionModVassal ? `Vassal Opinion ${levelDef.opinionModVassal > 0 ? '+' : ''}${levelDef.opinionModVassal}, ` : ''} Stability ${cost.stabilityChange > 0 ? '+' : ''}${cost.stabilityChange}</span>`;
                         }

                         content += `
                             <div>
                                 <button
                                     class="action-button law-level-button ${isCurrent ? 'current' : ''}"
                                     onclick="attemptChangeLaw('${lawType}', '${levelDef.level}')"
                                     ${isCurrent || !canAfford || !canChange || !meetsCondition ? 'disabled' : ''}
                                     title="${isCurrent ? 'Current Law' : disabledReason || `Enact ${levelDef.level}`}"
                                 >
                                     ${levelDef.level}
                                 </button>
                                 <div class="law-description">
                                     ${levelDef.description}
                                     ${costText}
                                     ${effectText}
                                 </div>
                             </div>`;
                     });
                 } else { content = `<p>Law definition for "${lawType}" not found.</p>`; }
                 break;

            case 'faction':
                 const faction = getFactionById(id);
                 if (faction) {
                    domRefs.modalTitle.textContent = `Faction: ${faction.name}`;
                    const leader = getCharacterById(faction.creatorId) || { name: "Unknown Leader" };
                    const leaderName = leader ? `<span class="clickable-info" data-type="${leader.id === 'player' ? 'character' : 'vassal'}" data-id="${faction.creatorId}">${leader.name}</span>` : 'System/Unknown';
                    content = `<ul>
                                <li><strong>Leader:</strong> ${leaderName}</li>
                                <li><strong>Goal:</strong> <span>${faction.goal}</span></li>
                                <li><strong>Type:</strong> <span>${faction.type}</span></li>
                                <li><strong>Strength:</strong> <span class="faction-strength ${getFactionStrengthClass(faction.strength, faction.threshold)}">${faction.strength}% / ${faction.threshold}%</span></li>
                                <li><strong>Members (${faction.members.length}):</strong></li>
                             </ul>
                             <ul class="sub-list">
                                ${faction.members.map(memberId => {
                                    const member = getVassalById(memberId);
                                    return member ? `<li><span class="clickable-info" data-type="vassal" data-id="${memberId}">${member.name}</span> (P: ${member.power})</li>` : `<li>Unknown Member (${memberId})</li>`;
                                }).join('') || '<li>None (Leader Only)</li>'}
                             </ul>`;

                     // Faction Actions (Simple Join/Leave for now)
                     const playerIsMember = faction.members.includes('player'); // Need to track if player joins
                     if (!playerIsMember && faction.type !== 'Populist' && faction.creatorId !== 'player') { // Can't join peasant revolts or your own faction this way
                          actions += `<button class="action-button nyi" onclick="joinFaction('${id}')"><i class="fa-solid fa-user-plus"></i> Join Faction</button>`;
                     } else if (playerIsMember) {
                         actions += `<button class="action-button nyi" onclick="leaveFaction('${id}')"><i class="fa-solid fa-user-minus"></i> Leave Faction</button>`;
                     }
                     actions += `<button class="action-button nyi"><i class="fa-solid fa-handshake-slash"></i> Scheme to Dissuade</button>`;
                     actions += `<button class="action-button nyi"><i class="fa-solid fa-gavel"></i> Suppress Faction</button>`;

                 } else { content = "<p>Faction details not found.</p>"; }
                 break;

             case 'prisoners': // Show list of prisoners held by player
                 domRefs.modalTitle.textContent = "Manage Prisoners";
                 const prisoners = gameState.realm.intrigue.prisoners.filter(p => p.jailorId === 'player');
                 if (prisoners.length > 0) {
                     content = `<p>You hold ${prisoners.length} prisoner(s).</p>`;
                     content += `<ul id="prisoner-list">`;
                     prisoners.forEach(p => {
                         const prisonerChar = getCharacterById(p.characterId);
                         const name = prisonerChar ? prisonerChar.name : (p.name || "Unknown");
                         const title = prisonerChar ? (prisonerChar.title || '') : "";
                         const clickableName = prisonerChar ? `<span class="clickable-info" data-type="${p.characterId === 'player' ? 'character' : 'vassal'}" data-id="${p.characterId}">${name}</span>` : name;
                         content += `<li>
                                         <strong>${title} ${clickableName}</strong>
                                         <span class="prisoner-details">Reason: ${p.reason}</span>
                                         <div class="modal-actions" style="text-align: right; border-top: none; padding-top: 5px;">
                                             ${getPrisonerActionButtons(p.characterId)}
                                         </div>
                                     </li>`;
                     });
                     content += `</ul>`;
                 } else {
                     content = "<p>You currently hold no prisoners.</p>";
                 }
                 // No global actions needed here, actions are per-prisoner
                 break;

            default:
                content = `<p>Information type "${type}" is not recognized or not yet implemented.</p>`;
        }

        domRefs.modalBody.innerHTML = content;
        if (actions) {
            domRefs.modalActions.innerHTML = actions;
            domRefs.modalActions.style.display = 'block';
        }
        openModal('generic-modal');
    }

    // --- Action Button Generation ---
     function getVassalActionButtons(vassalId) {
        const vassal = getVassalById(vassalId);
        if (!vassal) return '';

        let buttons = '';
        const costs = gameState.actionCosts.improveRelationsVassal;
        const cooldownEndYear = gameState.actionCooldowns.improveRelations?.[vassalId] || 0;
        const canImprove = !vassal.isImprisoned && !vassal.isRebelling && gameState.realm.gold >= costs.gold && gameState.dynasty.prestige >= costs.prestigeBase && gameState.year >= cooldownEndYear;

        // Improve relations button
        buttons += `<button class="action-button vassal-actions" onclick="attemptImproveRelations('${vassalId}')" ${!canImprove ? 'disabled' : ''} title="Improve Relations Cost: ${costs.gold}G, ${costs.prestigeBase}P. Cooldown: ${gameState.year >= cooldownEndYear ? 'Ready' : `Ready in ${cooldownEndYear - gameState.year}y`}"><i class="fa-solid fa-arrow-up-right-dots"></i></button>`;

        // View details / more actions button
        buttons += `<button class="action-button vassal-actions" onclick="showInfoPopup('vassal', '${vassalId}')" title="View Details & Actions"><i class="fa-solid fa-eye"></i></button>`;

        // Removed arrest button from here to declutter - it's in the modal
        return buttons;
    }

     function getPrisonerActionButtons(characterId) {
        let buttons = '';
        const ransomCost = calculateRansomCost(characterId); // Function needed
        buttons += `<button class="action-button" style="font-size: 0.9em; padding: 4px 8px;" onclick="managePrisonerAction('${characterId}', 'ransom')" title="Ransom for ~${ransomCost} Gold"><i class="fa-solid fa-coins"></i> Ransom</button>`;
        buttons += `<button class="action-button" style="font-size: 0.9em; padding: 4px 8px; background: linear-gradient(to bottom, #8a3a3a, #7a2a2a); border-color: #c88484;" onclick="managePrisonerAction('${characterId}', 'execute')" title="Execute (Gain Tyranny, Lose Opinion)"><i class="fa-solid fa-skull-crossbones"></i> Execute</button>`;
        buttons += `<button class="action-button" style="font-size: 0.9em; padding: 4px 8px;" onclick="managePrisonerAction('${characterId}', 'release')" title="Release (Gain Opinion)"><i class="fa-solid fa-key"></i> Release</button>`;
        return buttons;
    }

    function getLawDisplayName(lawId) {
         switch (lawId) {
             case 'crownAuthority': return 'Crown Authority';
             case 'succession': return 'Succession Law';
             case 'vassalObligations': return 'Vassal Obligations';
             case 'religiousLaws': return 'Religious Law';
             default: return lawId;
         }
     }

    // --- Game Logic Functions ---

    function updateUI() {
        // Check if setup is complete. If not, show creator, hide game.
        if (!gameState || !gameState.setupComplete) {
            console.log("updateUI called but setup not complete. Showing creator.");
            domRefs.creatorContainer.style.display = 'block';
            domRefs.gameContainer.style.display = 'none';
            // Ensure creator elements are ready
            populateBackgroundCards(); // Make sure backgrounds are shown
            domRefs.creatorStartBtn.disabled = selectedBackground === null; // Disable button if no selection yet
            domRefs.creatorStartBtn.textContent = selectedBackground ? `Start as ${selectedBackground.name}` : "Select a Background";
            return; // Stop further UI updates
        }

        // If setup IS complete, hide creator, show game, and update game elements.
        console.log("updateUI called, setup complete. Updating game view.");
        domRefs.creatorContainer.style.display = 'none';
        domRefs.gameContainer.style.display = 'grid';

        // --- Left Column ---
        domRefs.rulerName.innerHTML = `<span class="clickable-info" data-type="character" data-id="player">${gameState.character.name}</span>`;
        domRefs.charRealmTitle.textContent = gameState.character.title;
        domRefs.charDynastyName.innerHTML = `<span class="clickable-info" data-type="dynasty" data-id="${gameState.dynasty.id}">${gameState.character.dynasty}</span>`;
        domRefs.charCulture.innerHTML = `<span class="clickable-info" data-type="culture" data-id="player">${gameState.character.culture}</span>`;
        domRefs.charReligion.innerHTML = `<span class="clickable-info" data-type="religion" data-id="player">${gameState.character.religion}</span>`;
        domRefs.rulerHealth.textContent = `${gameState.character.healthStatus} (${gameState.character.health})`;
        domRefs.rulerStress.textContent = `${gameState.character.stress} / 100`;
        domRefs.rulerTyranny.textContent = gameState.character.tyranny; // Display Tyranny
        domRefs.rulerLifestyle.textContent = gameState.character.lifestyle || 'None';
        domRefs.rulerTraits.innerHTML = formatTraits(gameState.character.traits);
        domRefs.skillDiplomacy.textContent = gameState.character.skills?.diplomacy ?? 0;
        domRefs.skillMartial.textContent = gameState.character.skills?.martial ?? 0;
        domRefs.skillStewardship.textContent = gameState.character.skills?.stewardship ?? 0;
        domRefs.skillIntrigue.textContent = gameState.character.skills?.intrigue ?? 0;
        domRefs.skillLearning.textContent = gameState.character.skills?.learning ?? 0;

        domRefs.dynastyName.innerHTML = `<span class="clickable-info" data-type="dynasty" data-id="${gameState.dynasty.id}">${gameState.dynasty.name}</span>`;
        domRefs.dynastyPrestige.textContent = gameState.dynasty.prestige;
        const actualMembers = gameState.dynasty.members.filter(m => m.id !== 'player'); // Exclude self entry
        domRefs.dynastyMembersCount.textContent = actualMembers.length;
        // Map members: link vassals via vassal type, others via character type
        domRefs.dynastyMembersList.innerHTML = actualMembers.map(m => {
            const isVassal = gameState.realm.vassals.some(v => v.id === m.id);
            const clickType = isVassal ? 'vassal' : 'character'; // Use 'vassal' if they are a current vassal
            return `<li><span class="clickable-info" data-type="${clickType}" data-id="${m.id}">${m.name}</span> (${m.relation || 'Relative'}) - ${m.status || 'Alive'}</li>`;
        }).join('');

        domRefs.dynastyLegacies.textContent = gameState.dynasty.legacies.length > 0 ? gameState.dynasty.legacies.length : "None";
        domRefs.dynastyLegaciesList.innerHTML = gameState.dynasty.legacies.map(l => `<li>${l}</li>`).join('');

        // --- Middle Column ---
        domRefs.realmName.textContent = gameState.realm.name;
        domRefs.currentYear.textContent = gameState.year;
        domRefs.realmGold.textContent = gameState.realm.gold;
        domRefs.realmCulture.innerHTML = `<span class="clickable-info" data-type="culture" data-id="realm">${gameState.realm.culture}</span>`;
        domRefs.realmReligion.innerHTML = `<span class="clickable-info" data-type="religion" data-id="realm">${gameState.realm.religion}</span>`;

        // Active Wars Display
        domRefs.activeWarsCount.textContent = gameState.realm.activeWars.length;
        domRefs.activeWarsList.innerHTML = gameState.realm.activeWars.map(w => {
            const attackerLeader = getCharacterById(w.attackerLeader);
            const defenderLeader = getCharacterById(w.defenderLeader);
            const attackerClickType = gameState.realm.vassals.some(v => v.id === w.attackerLeader) ? 'vassal' : 'character';
            const defenderClickType = w.defenderLeader === 'player' ? 'character' : (gameState.realm.vassals.some(v => v.id === w.defenderLeader) ? 'vassal' : 'character');
            return `<li>
                        <strong>${w.type}: <span class="clickable-info" data-type="${attackerClickType}" data-id="${w.attackerLeader}">${attackerLeader?.name || 'Unknown'}</span> vs <span class="clickable-info" data-type="${defenderClickType}" data-id="${w.defenderLeader}">${defenderLeader?.name || 'Unknown'}</span></strong>
                        <span class="war-details">
                            Goal: <span class="war-goal">${w.warGoal}</span> |
                            Score: <span class="war-score ${w.score === 0 ? '' : (w.score > 0 ? 'positive' : 'negative')}">${w.score}%</span>
                            <br>
                            Attackers: <span class="war-participants">${w.attackers.map(id => getCharacterById(id)?.name || id).join(', ')}</span><br>
                            Defenders: <span class="war-participants">${w.defenders.map(id => getCharacterById(id)?.name || id).join(', ')}</span>
                        </span>
                    </li>`;
        }).join('') || '<li>None</li>';


        // National Stats & Classification
        let totalVassalOpinion = 0;
        let loyalVassalCount = 0;
        gameState.realm.vassals.forEach(v => {
            if (!v.isRebelling && !v.isImprisoned) { // Only count non-rebelling, non-imprisoned vassals for average opinion
                 totalVassalOpinion += v.opinion;
                 loyalVassalCount++;
            }
        });
        const avgVassalOpinion = loyalVassalCount > 0 ? Math.round(totalVassalOpinion / loyalVassalCount) : 0;
        domRefs.statVassalOpinion.textContent = avgVassalOpinion;
        domRefs.statStability.textContent = gameState.nationalStats.stability;
        domRefs.statEconomy.textContent = gameState.nationalStats.economy;
        domRefs.statMilitary.textContent = calculateMilitaryStrength('player', null, true); // Show TOTAL potential strength here
        domRefs.statSocialWelfare.textContent = gameState.nationalStats.socialWelfare;
        domRefs.statEnvironment.textContent = gameState.nationalStats.environment;
        domRefs.statPoliticalFreedoms.textContent = gameState.nationalStats.politicalFreedoms;
        domRefs.statCivilRights.textContent = gameState.nationalStats.civilRights;
        domRefs.nationalClassification.textContent = calculateNationalClassification(gameState.nationalStats, gameState.character, avgVassalOpinion, gameState.realm.activeWars.some(w=>w.type === 'Civil War'));


        // Vassals List
        domRefs.vassalsCount.textContent = gameState.realm.vassals.length;
        if (gameState.realm.vassals.length > 0) {
            domRefs.vassalsList.innerHTML = `<ul class="compact-list">` + gameState.realm.vassals.map(v => {
                let opinionClass = v.opinion === 0 ? "" : (v.opinion > 0 ? "positive" : "negative");
                let factionInfo = v.factionId ? ` (Faction: <span class="clickable-info" data-type="faction" data-id="${v.factionId}">${getFactionName(v.factionId)}</span>)` : "";
                let details = `<span class="vassal-detail">(<span class="clickable-info" data-type="culture" data-id="${v.id}">${v.culture}</span>, <span class="clickable-info" data-type="religion" data-id="${v.id}">${v.religion}</span>)</span>`;
                let status = "";
                if (v.isImprisoned) status = `<span class="vassal-status imprisoned">(Imprisoned)</span>`;
                else if (v.isRebelling) status = `<span class="vassal-status rebelling">(Rebelling)</span>`;

                return `<li>
                            <strong>${v.title} <span class="clickable-info" data-type="vassal" data-id="${v.id}">${v.name}</span>:</strong>
                            <span class="vassal-opinion-val ${opinionClass}">${v.opinion}</span> (P: ${v.power})${factionInfo}${status}${details}
                            <span class="vassal-actions"> ${getVassalActionButtons(v.id)} </span>
                        </li>`;
            }).join('') + `</ul>`;
        } else { domRefs.vassalsList.innerHTML = `<p>No major vassals.</p>`; }

        // Factions List
        calculateFactionStrengths(); // Recalculate before display
        domRefs.factionsCount.textContent = gameState.realm.factions.filter(f => f.isActive).length;
        const activeFactions = gameState.realm.factions.filter(f => f.isActive);
        if (activeFactions.length > 0) {
            domRefs.factionsList.innerHTML = `<ul class="compact-list">` + activeFactions.map(f => {
                 let strengthClass = getFactionStrengthClass(f.strength, f.threshold);
                 const leader = getCharacterById(f.creatorId);
                 const leaderName = leader ? `<span class="clickable-info" data-type="${leader.id === 'player' ? 'character' : 'vassal'}" data-id="${f.creatorId}">${leader.name}</span>` : (f.type === 'Populist' ? 'Peasants' : 'Unknown');
                 let ultimatumIcon = f.ultimatumSent ? ` <i class="fa-solid fa-triangle-exclamation" style="color: var(--ck3-red);" title="Ultimatum Sent!"></i>` : '';
                 // Basic faction interaction buttons (could be moved to modal)
                 let factionActions = `<span class="faction-actions">
                                          <button class="action-button" onclick="showInfoPopup('faction', '${f.id}')" title="View Details"><i class="fa-solid fa-eye"></i></button>
                                      </span>`; // Keep interaction in modal for now
                return `<li><strong><span class="clickable-info" data-type="faction" data-id="${f.id}">${f.name}</span>:</strong> <span class="faction-strength ${strengthClass}">${f.strength}% / ${f.threshold}%</span>${ultimatumIcon} (Leader: ${leaderName}) ${factionActions}</li>`;
            }).join('') + `</ul>`;
        } else { domRefs.factionsList.innerHTML = `<p>No active factions.</p>`; }
        // Enable/disable create faction button (basic logic)
        domRefs.createFactionBtn.disabled = false; // Allow creation for now (NYI)

        // Log Box
        domRefs.logEntries.innerHTML = gameState.log.slice(-20).map(entry => `<p>${entry}</p>`).join('');
        domRefs.logEntries.scrollTop = domRefs.logEntries.scrollHeight;

        // --- Right Column ---
        domRefs.assignedGeneral.textContent = gameState.realm.military?.generals?.[0]?.name || gameState.character.name;
        const totalLevies = calculateTotalLevies();
        domRefs.realmLevies.textContent = totalLevies; // Show total potential levies
        domRefs.raisedLevies.textContent = `${gameState.realm.military.raisedLeviesPercent}%`; // Show raised %
        domRefs.realmMaa.textContent = gameState.realm.military?.menAtArms?.length ? gameState.realm.military.menAtArms.map(maa => `${maa.count} ${maa.type}`).join(', ') : 'None';
        domRefs.hiredMercsCount.textContent = gameState.realm.hiredMercenaries.length;
        domRefs.hiredMercsList.innerHTML = gameState.realm.hiredMercenaries.map(merc => `<li>${merc.name} (${merc.size})</li>`).join('');
        // Enable/disable Raise Levies button based on state
        // domRefs.raiseLeviesBtn.textContent = gameState.realm.military.raisedLeviesPercent > 0 ? 'Disband Levies' : 'Raise Levies';
        // domRefs.raiseLeviesBtn.disabled = false; // Keep enabled for now (NYI)
         // Assign NYI class and disable logic to the button itself
        domRefs.raiseLeviesBtn.classList.add('nyi'); // Mark as NYI visually

        // Laws
        domRefs.lawCrownAuthority.innerHTML = `<span class="clickable-info" data-type="law" data-id="crownAuthority">${gameState.realm.laws?.crownAuthority || 'Unknown'}</span>`;
        domRefs.lawSuccession.innerHTML = `<span class="clickable-info nyi" data-type="law" data-id="succession">${gameState.realm.laws?.succession || 'Unknown'}</span>`;
        domRefs.lawVassalObligations.innerHTML = `<span class="clickable-info" data-type="law" data-id="vassalObligations">${gameState.realm.laws?.vassalObligations || 'Unknown'}</span>`;
        domRefs.lawReligious.innerHTML = `<span class="clickable-info nyi" data-type="law" data-id="religiousLaws">${gameState.realm.laws?.religiousLaws || 'Unknown'}</span>`;
        domRefs.changeLawsBtn.disabled = !(gameState.realm.lawDefinitions?.crownAuthority?.length > 0) || gameState.year < (gameState.actionCooldowns.changeLaw || 0); // Check cooldown

        // Diplomacy
        domRefs.alliancesCount.textContent = gameState.realm.alliances.length;
        domRefs.alliancesList.innerHTML = gameState.realm.alliances.length > 0 ? gameState.realm.alliances.map(a => `<li><span class="icon fa-solid fa-handshake"></span> ${a.partner} (${a.type})</li>`).join('') : `<li>None</li>`;
        domRefs.trucesCount.textContent = gameState.realm.truces.length;
        domRefs.diploRange.textContent = 'Adjacent Realms'; // Placeholder

        // Intrigue
        domRefs.schemesCount.textContent = gameState.realm.intrigue?.knownSchemes?.length || 0;
        domRefs.plotPowerAgainst.textContent = gameState.realm.intrigue?.plotPowerAgainst ? `${gameState.realm.intrigue.plotPowerAgainst}%` : 'N/A';
        const prisonerCount = gameState.realm.intrigue?.prisoners?.filter(p => p.jailorId === 'player').length || 0;
        domRefs.prisonersCount.innerHTML = `<span class="clickable-info" data-type="prisoners" data-id="player">${prisonerCount}</span>`; // Make clickable
        domRefs.managePrisonersBtn.disabled = prisonerCount === 0; // Disable if no prisoners

        // Religion
        domRefs.religionNameDisplay.innerHTML = `<span class="clickable-info" data-type="religion" data-id="realm">${gameState.realm.religion}</span>`;
        domRefs.religionHead.textContent = gameState.realm.religionDetails?.head || 'None';
        domRefs.religionFervor.textContent = `${gameState.realm.religionDetails?.fervor || 50}%`;
        domRefs.religionRelations.textContent = 'Tolerant'; // Placeholder

        // Update NYI button status globally
        document.querySelectorAll('.nyi').forEach(el => {
            if (el.tagName === 'BUTTON') {
                el.disabled = true;
            } else if (el.tagName === 'SPAN' && el.classList.contains('clickable-info')) {
                 el.style.cursor = 'not-allowed';
                 el.style.textDecoration = 'line-through';
                 el.style.color = 'var(--ck3-text-muted)';
            } else if (el.tagName === 'SPAN' && !el.classList.contains('clickable-info')){
                 // If it's just a span meant to indicate NYI, style it subtly
                 el.style.color = 'var(--ck3-text-muted)';
                 el.style.fontStyle = 'italic';
            }
        });
        // Re-enable buttons that ARE implemented (overriding the global .nyi disable if needed)
        domRefs.changeLawsBtn.disabled = gameState.year < (gameState.actionCooldowns.changeLaw || 0); // Enable based on cooldown only
        domRefs.managePrisonersBtn.disabled = prisonerCount === 0; // Enable based on prisoner count
    }

    function addLog(message) {
         if (!gameState.log) gameState.log = [];
         const yearPrefix = gameState.year ? `${gameState.year}: ` : "";
         gameState.log.push(`${yearPrefix}${message}`);
         if (gameState.log.length > 100) gameState.log.shift(); // Keep log size manageable

         // Only update DOM if game screen is potentially visible
         if (gameState.setupComplete && domRefs.logEntries) {
             domRefs.logEntries.innerHTML = gameState.log.slice(-20).map(entry => `<p>${entry}</p>`).join('');
             domRefs.logEntries.scrollTop = domRefs.logEntries.scrollHeight; // Scroll to bottom
         }
     }

    // --- Stat/Resource Change Functions ---
     function calculateNationalClassification(stats, char, avgVassalOpinion, inCivilWar) {
         if (inCivilWar) return "Civil War Erupts!";
         if (stats.stability < 30) return "Collapsing Realm";
         if (avgVassalOpinion < -25) return "Fractious Kingdom";
         if (stats.military > 70 && char.lifestyle === 'Martial') return "Expansionist Regime";
         if (stats.economy > 60 && stats.stability > 65) return "Flourishing Economy";
         if (stats.politicalFreedoms < 30 && stats.stability < 50) return "Oppressive State";
         if (char.tyranny > 50) return "Tyrannical Rule";
         if (stats.learning > 60 && char.lifestyle === 'Learning') return "Enlightened Realm"; // Assuming learning skill > 8 triggers Learning lifestyle visually
         return "Balanced Kingdom";
      }
    function changeStat(stat, value) {
         if (gameState.nationalStats.hasOwnProperty(stat)) {
             const oldValue = gameState.nationalStats[stat];
             gameState.nationalStats[stat] = Math.max(0, Math.min(100, oldValue + value));
             // Optional: Log stat changes if significant
             // if (Math.abs(value) > 0) addLog(`${stat.charAt(0).toUpperCase() + stat.slice(1)} changes by ${value > 0 ? '+' : ''}${value} to ${gameState.nationalStats[stat]}.`);
         }
     }
    function changeStress(value) {
         if (!gameState.character) return;
         const oldStress = gameState.character.stress;
         gameState.character.stress = Math.max(0, Math.min(100, gameState.character.stress + value));
         const actualChange = gameState.character.stress - oldStress;
         if (actualChange > 0) addLog(`${gameState.character.name} gains ${actualChange} stress.`);
         else if (actualChange < 0) addLog(`${gameState.character.name} loses ${-actualChange} stress.`);
         // TODO: Add logic for stress breaks at thresholds (e.g., 40, 70, 100)
     }
     function changeTyranny(value, reason = "") {
        if (!gameState.character) return;
        const oldTyranny = gameState.character.tyranny;
        gameState.character.tyranny = Math.max(0, gameState.character.tyranny + value); // Tyranny doesn't usually go below 0
        const actualChange = gameState.character.tyranny - oldTyranny;
        if (actualChange !== 0) {
            const reasonText = reason ? ` (${reason})` : "";
            addLog(`Tyranny changes by ${actualChange > 0 ? '+' : ''}${actualChange} to ${gameState.character.tyranny}${reasonText}.`);
            // Tyranny increases vassal negative opinion
            if (actualChange > 0) {
                 gameState.realm.vassals.forEach(v => {
                     // More tyranny = bigger opinion hit, maybe non-linear
                     const opinionHit = Math.min(5, Math.ceil(actualChange / 5)); // Simple example: -1 opinion per 5 tyranny gained, max 5 per event
                     changeVassalOpinion(v.id, -opinionHit, "Increased Tyranny");
                 });
            }
        }
     }
    function changeHealth(value) {
         if (!gameState.character) return;
         const oldHealth = gameState.character.health;
         gameState.character.health += value;
         gameState.character.health = Math.max(0, Math.min(100, gameState.character.health)); // Clamp health 0-100
         if (gameState.character.health !== oldHealth) {
             updateHealthStatus();
             // addLog(`${gameState.character.name}'s health changes by ${value > 0 ? '+' : ''}${value} to ${gameState.character.health}.`);
             if (gameState.character.health <= 0) {
                 addLog(`${gameState.character.name} has died!`);
                 handleRulerDeath(); // Trigger game over / reset
             }
         }
      }
    function updateHealthStatus() {
         if (!gameState.character) return;
         const health = gameState.character.health;
         if (health > 80) gameState.character.healthStatus = "Robust";
         else if (health > 60) gameState.character.healthStatus = "Healthy";
         else if (health > 40) gameState.character.healthStatus = "Poor";
         else if (health > 20) gameState.character.healthStatus = "Frail";
         else if (health > 0) gameState.character.healthStatus = "Near Death";
         else gameState.character.healthStatus = "Deceased";
      }
    function changeGold(value, reason = "") {
         if (!gameState.realm) return;
         const oldGold = gameState.realm.gold;
         gameState.realm.gold += Math.round(value); // Allow fractional changes internally, round for storage/display
         gameState.realm.gold = Math.max(0, gameState.realm.gold); // Cannot go below 0
         const actualChange = gameState.realm.gold - oldGold;
         const reasonText = reason ? ` (${reason})` : "";
         // Log only non-zero changes, or maybe only significant ones?
         if (actualChange !== 0 && (Math.abs(actualChange) >= 1 || reason)) { // Log if reason provided or change is >= 1
             addLog(`Gold changes by ${actualChange > 0 ? '+' : ''}${Math.round(actualChange)} to ${gameState.realm.gold}${reasonText}.`);
         }
      }
    function changePrestige(value, reason = "") {
         if (!gameState.dynasty) return;
         const oldPrestige = gameState.dynasty.prestige;
         gameState.dynasty.prestige += Math.round(value);
         // Prestige can go negative in CK3, let's allow it here too, maybe clamp at -1000?
         gameState.dynasty.prestige = Math.max(-1000, gameState.dynasty.prestige);
         const actualChange = gameState.dynasty.prestige - oldPrestige;
         const reasonText = reason ? ` (${reason})` : "";
         if (actualChange !== 0 && (Math.abs(actualChange) >= 1 || reason)) {
             addLog(`Prestige changes by ${actualChange > 0 ? '+' : ''}${Math.round(actualChange)} to ${gameState.dynasty.prestige}${reasonText}.`);
         }
      }
    function changeVassalOpinion(vassalId, value, reason = "") {
         const vassal = getVassalById(vassalId);
         if (vassal) {
             const oldOpinion = vassal.opinion;
             vassal.opinion += Math.round(value);
             // Clamp opinion? CK3 range is -100 to 100
             vassal.opinion = Math.max(-100, Math.min(100, vassal.opinion));
             const actualChange = vassal.opinion - oldOpinion;
             if (actualChange !== 0) {
                 const reasonText = reason ? ` (${reason})` : "";
                  // Optional: Log only significant changes or specific reasons
                 if (Math.abs(actualChange) > 2 || reason) {
                     addLog(`Opinion of ${vassal.name} changes by ${actualChange > 0 ? '+' : ''}${actualChange} to ${vassal.opinion}${reasonText}.`);
                 }
             }
         }
     }

    // --- Vassal/Faction/War Logic ---
    function getVassalPower(vassalId) {
        const vassal = getVassalById(vassalId);
        if (!vassal) return 0;
         // Base power + modifier based on their levies (if implemented)
         let power = vassal.power || 10; // Base contribution
         // Add modifier based on opinion? Content vassals less likely to use power against liege?
         if (vassal.opinion > 50) power *= 0.8; // Less likely to contribute to negative factions
         if (vassal.opinion < -50) power *= 1.2; // More likely to use power against liege
         if (vassal.isImprisoned) return 0; // No power if imprisoned
         if (vassal.isRebelling) return power * 1.1; // Maybe more committed if rebelling? (already accounted for in war calc)
         return Math.max(1, Math.round(power));
     }
    function getFactionName(factionId) {
        const faction = getFactionById(factionId);
        return faction ? faction.name : "Unknown Faction";
    }
    function getFactionStrengthClass(strength, threshold) {
        if (strength >= threshold) return 'dangerous';
        if (strength >= threshold * 0.7) return 'moderate';
        return 'safe';
    }

    function calculateFactionStrengths() {
        if (!gameState.realm?.factions || !gameState.realm?.vassals) return;
        // Calculate the liege's TOTAL potential military strength (unraised)
        const playerPotentialStrength = calculateMilitaryStrength('player', null, true); // Pass true for potential strength

        gameState.realm.factions.forEach(faction => {
            if (!faction.isActive) {
                faction.strength = 0;
                return;
            }
            let factionMilitaryPower = 0;
            const involvedVassalIds = new Set();

            // Add leader's power if they are a vassal and not already in members list
            if (faction.creatorId && faction.creatorId !== 'player' && !faction.members.includes(faction.creatorId)) {
                const leaderVassal = getVassalById(faction.creatorId);
                if(leaderVassal && !leaderVassal.isImprisoned){
                    // Use the vassal's contribution to military strength directly
                    factionMilitaryPower += calculateMilitaryStrength(faction.creatorId, null, true); // Potential strength
                    involvedVassalIds.add(faction.creatorId);
                }
            }
            // Add member power
            faction.members.forEach(memberId => {
                if (!involvedVassalIds.has(memberId)) { // Avoid double counting if leader is also member
                     const memberVassal = getVassalById(memberId);
                     if (memberVassal && !memberVassal.isImprisoned) {
                         factionMilitaryPower += calculateMilitaryStrength(memberId, null, true); // Potential strength
                         involvedVassalIds.add(memberId);
                     }
                }
            });

            // Strength is faction military power relative to the liege's TOTAL potential power
            // Avoid division by zero
            faction.strength = playerPotentialStrength > 0
                ? Math.min(100, Math.round((factionMilitaryPower / playerPotentialStrength) * 100))
                : (factionMilitaryPower > 0 ? 100 : 0);

            // Check for ultimatum *after* calculation
            checkFactionUltimatum(faction);
        });
     }

    function checkVassalJoiningFaction(vassal) {
         if (!vassal || vassal.factionId || vassal.isImprisoned || vassal.isRebelling || vassal.opinion > -10) return; // Don't join if happy, imprisoned, rebelling, or already in one

         // Filter for factions the vassal *might* join (e.g., based on culture, religion, goal) - Simplified check
         const potentialFactions = gameState.realm.factions.filter(f =>
                f.isActive &&
                f.type !== 'Populist' && // Vassals don't usually join peasant revolts
                f.creatorId !== vassal.id // Can't join own faction (shouldn't happen anyway)
            );

         if (potentialFactions.length === 0) return; // No suitable factions to join

         potentialFactions.forEach(faction => {
             let joinChance = 0;
             // Base chance on negative opinion
             if (vassal.opinion < -20) joinChance += 20;
             if (vassal.opinion < -50) joinChance += 30; // 50 total
             if (vassal.opinion < -80) joinChance += 40; // 90 total for extreme hate

             // Trait influences
             if (vassal.traits.includes("Ambitious")) joinChance += 25;
             if (vassal.traits.includes("Content")) joinChance -= 50; // Less likely
             if (vassal.traits.includes("Loyal")) joinChance -= 75; // Very unlikely
             if (vassal.traits.includes("Greedy") && faction.goal.toLowerCase().includes("tax")) joinChance += 20;
             if (vassal.traits.includes("Brave") && faction.strength > 50) joinChance += 10; // More likely to join strong factions
             if (vassal.traits.includes("Craven") && faction.strength < 50) joinChance -= 20; // Less likely to join weak factions

             // Cultural/Religious differences (small influence)
             if (vassal.culture !== gameState.character.culture) joinChance += 5;
             if (vassal.religion !== gameState.character.religion) joinChance += 10;

             // Faction leader opinion/relation (NYI - Placeholder)
             const leader = getCharacterById(faction.creatorId);
             if (leader && leader.skills) {
                 // Slightly more likely if leader is diplomatic/intriguing?
                 joinChance += Math.max(0, (leader.skills.diplomacy - 5));
             }

             // Ensure chance isn't negative
             joinChance = Math.max(0, joinChance);

             // Chance per year (e.g., 10% base if conditions met) - Make it less frequent
             const effectiveChancePercent = joinChance / 20; // Divide raw score for yearly % chance (adjust divisor to tune frequency)

             if (Math.random() * 100 < effectiveChancePercent) {
                 vassal.factionId = faction.id;
                 if (!faction.members.includes(vassal.id)) {
                      faction.members.push(vassal.id);
                      addLog(`${vassal.name} has joined the ${faction.name} faction!`);
                      calculateFactionStrengths(); // Recalculate immediately
                 }
                 return; // Vassal joins only one faction per check cycle
             }
         });
     }

     function checkFactionUltimatum(faction) {
         // Only check if active, threshold met, and ultimatum NOT already sent
         if (faction.isActive && !faction.ultimatumSent && faction.strength >= faction.threshold) {
             faction.ultimatumSent = true; // Prevent multiple triggers immediately
             // Trigger immediately during the check (e.g., end of year update)
             triggerFactionUltimatum(faction);
         }
     }

    function triggerFactionUltimatum(faction) {
         addLog(`ALERT: The ${faction.name} faction (${faction.strength}%) has delivered an ultimatum!`);
         closeModal('generic-modal'); // Close other modals

         const leader = getCharacterById(faction.creatorId) || { name: "Faction Leader" };
         domRefs.factionUltimatumTitle.textContent = `Ultimatum from ${leader.name}!`;
         domRefs.factionUltimatumDescription.textContent = `The ${faction.name}, led by ${leader.name}, demands that you "${faction.goal}". Their combined strength (${faction.strength}%) challenges your rule. How do you respond?`;

         domRefs.factionUltimatumChoices.innerHTML = ''; // Clear old choices

         // Option 1: Refuse (Leads to War)
         const refuseButton = document.createElement('button');
         refuseButton.innerHTML = `Refuse their demands. (Triggers Civil War!) <span class="choice-effects">-10 Stability, +20 Stress</span>`;
         refuseButton.onclick = () => resolveFactionUltimatum(faction, 'refuse');
         domRefs.factionUltimatumChoices.appendChild(refuseButton);

         // Option 2: Accept (Apply consequences)
         const acceptButton = document.createElement('button');
         const acceptEffects = calculateFactionDemandEffects(faction);
         acceptButton.innerHTML = `Accept their demands. (${acceptEffects.text}) <span class="choice-effects">${acceptEffects.logText}</span>`;
         acceptButton.onclick = () => resolveFactionUltimatum(faction, 'accept');
         domRefs.factionUltimatumChoices.appendChild(acceptButton);

         // Option 3: Attempt Negotiation (NYI - could use diplomacy/intrigue skill check)
         const negotiateButton = document.createElement('button');
         negotiateButton.innerHTML = `Attempt to negotiate... (NYI) <span class="choice-effects">Requires high Diplomacy/Intrigue</span>`;
         negotiateButton.disabled = true; // NYI
         negotiateButton.classList.add('nyi'); // Add NYI class
         domRefs.factionUltimatumChoices.appendChild(negotiateButton);

         openModal('faction-ultimatum-popup');
         changeStress(20); // Stressful event regardless of choice
     }

    function calculateFactionDemandEffects(faction) {
        // Determine the cost/effect of ACCEPTING the ultimatum based on goal
        // This needs to be customized per faction goal! Placeholder logic:
        let effects = { gold: 0, prestige: -100, stability: -5, text: "Lose Prestige", logText: "-100 Prestige, -5 Stability" };
        const goalLower = faction.goal.toLowerCase();

        if (goalLower.includes("lower taxes") || goalLower.includes("obligations")) {
            // Example: Reduce Vassal Obligations law by one step if possible
            const lawType = 'vassalObligations';
            const currentLevel = gameState.realm.laws[lawType];
            const lawDefs = gameState.realm.lawDefinitions[lawType];
            const currentIndex = lawDefs.findIndex(l => l.level === currentLevel);
            if (currentIndex > 0) { // Can lower it
                 const newLevel = lawDefs[currentIndex - 1].level;
                 effects = { prestige: -100, stability: 0, text: `Lower Vassal Obligations to ${newLevel}, Lose Prestige`, logText: `-100 Prestige. Law lowered to ${newLevel}.` };
                 effects.changeLaw = { type: lawType, level: newLevel };
             } else { // Already at lowest
                 effects = { gold: -50, prestige: -50, stability: 0, text: "Cannot lower Obligations further, Lose Gold & Prestige", logText: "-50 Gold, -50 Prestige" };
             }
        } else if (goalLower.includes("independence")) {
             effects = { prestige: -200, stability: -10, text: "Grant Independence (NYI), Lose Prestige", logText: "-200 Prestige, -10 Stability. Independence NYI." };
             // TODO: Implement vassal becoming independent - requires major changes
             effects.nyi = true; // Mark effect as not fully implemented
        } else if (goalLower.includes("install") || goalLower.includes("claimant")) {
            effects = { prestige: -500, stability: -20, text: "Abdicate (Game Over!), Lose Prestige", logText: "-500 Prestige, -20 Stability. Abdication leads to game over." };
             // TODO: Implement claimant taking over (likely game over in this prototype)
             effects.gameOver = true; // Mark effect as game ending
        } else if (goalLower.includes("increase council power") || goalLower.includes("crown authority")) {
             // Example: Force lower Crown Authority
             const lawType = 'crownAuthority';
             const currentLevel = gameState.realm.laws[lawType];
             const lawDefs = gameState.realm.lawDefinitions[lawType];
             const currentIndex = lawDefs.findIndex(l => l.level === currentLevel);
             if (currentIndex > 0) { // Can lower it
                 const newLevel = lawDefs[currentIndex - 1].level;
                 effects = { prestige: -150, stability: 0, text: `Lower Crown Authority to ${newLevel}, Lose Prestige`, logText: `-150 Prestige. Crown Authority lowered to ${newLevel}.` };
                 effects.changeLaw = { type: lawType, level: newLevel }; // Mark law to be changed
             } else { // Already at lowest
                 effects = { prestige: -100, stability: -5, text: "Cannot lower Authority further, Lose Prestige", logText: "-100 Prestige, -5 Stability" };
             }
        }
        return effects;
    }

     function resolveFactionUltimatum(faction, choice) {
         closeModal('faction-ultimatum-popup');
         if (choice === 'accept') {
             addLog(`You chose to accept the demands of the ${faction.name}.`);
             const effects = calculateFactionDemandEffects(faction);

             if (effects.nyi) {
                 addLog(`Accepted demand "${faction.goal}", but the effects are Not Yet Implemented.`);
             }
             if (effects.gameOver) {
                  addLog(`Accepted demand "${faction.goal}". This leads to abdication and the end of your reign!`);
                  changePrestige(effects.prestige || 0); // Apply prestige hit
                  changeStat('stability', effects.stability || 0); // Apply stability hit
                  // Trigger game over sequence
                  handleRulerDeath("abdicated due to faction demands"); // Use death handler for reset
                  return; // Stop further processing
             }

             if (effects.gold) changeGold(effects.gold, `Faction Demand: ${faction.name}`);
             if (effects.prestige) changePrestige(effects.prestige, `Faction Demand: ${faction.name}`);
             if (effects.stability) changeStat('stability', effects.stability);

             // Handle specific non-standard effects
             if (effects.changeLaw) {
                  // Directly apply law change without cost/cooldown check
                  const oldLevel = gameState.realm.laws[effects.changeLaw.type];
                  gameState.realm.laws[effects.changeLaw.type] = effects.changeLaw.level;
                  addLog(`Law Changed: ${getLawDisplayName(effects.changeLaw.type)} set to ${effects.changeLaw.level} due to faction demand (was ${oldLevel}).`);
                  applyLawEffects(effects.changeLaw.type, effects.changeLaw.level, oldLevel); // Pass old level for proper diff calc
             }

             disbandFaction(faction.id); // Faction achieved its goal (for now)
         } else if (choice === 'refuse') {
             addLog(`You refused the demands of the ${faction.name}! War is inevitable!`);
             changeStat('stability', -10);
             startCivilWar(faction); // Trigger the war
         }
         updateUI();
     }

     function disbandFaction(factionId) {
        const factionIndex = gameState.realm.factions.findIndex(f => f.id === factionId);
        if (factionIndex > -1) {
             const faction = gameState.realm.factions[factionIndex];
             addLog(`The ${faction.name} faction has been disbanded.`);
             // Remove faction ID from members
             faction.members.forEach(memberId => {
                 const vassal = getVassalById(memberId);
                 if (vassal && vassal.factionId === factionId) {
                     vassal.factionId = null;
                 }
             });
             // Also check leader if they are a vassal
             const leaderVassal = getVassalById(faction.creatorId);
              if (leaderVassal && leaderVassal.factionId === factionId) {
                 leaderVassal.factionId = null;
             }

             // Remove faction from active list (or mark inactive)
             gameState.realm.factions.splice(factionIndex, 1);
            // gameState.realm.factions[factionIndex].isActive = false; // Alternative: keep history
         }
         // No need to recalculate strength here, it happens at start of next year or UI update
         // updateUI(); // Update UI might be called by the calling function already
     }

     // --- Civil War Implementation ---
     function startCivilWar(faction) {
         addLog(`Civil War! The ${faction.name} rises in rebellion!`);
         const warId = `war_${gameState.realm.nextWarId++}`;
         const playerChar = gameState.character;
         const factionLeaderId = faction.creatorId; // Leader of the faction initiates war
         const factionLeader = getCharacterById(factionLeaderId);

         // Attackers are the leader + members who are actual vassals and not imprisoned
         const attackers = [factionLeaderId, ...faction.members].filter(id => {
             const v = getVassalById(id);
             return v && !v.isImprisoned;
         });
         // Ensure leader is included only once and is valid
         const uniqueAttackers = [...new Set(attackers)];

         // Defenders are the player + all vassals NOT in the attacker list and not imprisoned
         const defenders = ['player', ...gameState.realm.vassals.filter(v => !uniqueAttackers.includes(v.id) && !v.isImprisoned).map(v => v.id)];

         if (uniqueAttackers.length === 0) {
             addLog("Rebellion failed to start: No valid participants.");
             disbandFaction(faction.id); // Disband the useless faction
             updateUI();
             return;
         }

         const newWar = {
             id: warId,
             type: 'Civil War',
             attackers: uniqueAttackers,
             defenders: defenders,
             warGoal: faction.goal, // Use faction goal as war goal
             score: 0, // Starts at 0
             attackerLeader: factionLeaderId,
             defenderLeader: 'player',
             startYear: gameState.year
         };
         gameState.realm.activeWars.push(newWar);

         // Mark rebels
         uniqueAttackers.forEach(vassalId => {
             const vassal = getVassalById(vassalId);
             if (vassal) {
                 vassal.isRebelling = true;
                 vassal.factionId = null; // Leave the faction once war starts
                 changeVassalOpinion(vassalId, -50, "Rebellion against Liege"); // Huge opinion penalty
             }
         });

         // Disband the faction that triggered the war
         disbandFaction(faction.id);


         // Raise player levies automatically? Optional.
         // changeLeviesRaised(true); // Auto-raise levies -> NYI feature

         changeStress(30);
         changeStat('stability', -20); // Big stability hit
         addLog(`War participants - Attackers: ${uniqueAttackers.map(id=>getCharacterById(id)?.name).join(', ')}, Defenders: ${defenders.map(id=>getCharacterById(id)?.name).join(', ')}`)
         updateUI();
     }

     function calculateMilitaryStrength(participantId, war = null, potential = false) {
         // participantId can be 'player' or a vassal ID
         // war is the war object if calculating for a specific war side
         // potential=true calculates total possible strength, ignoring raised levies %

         let strength = 0;
         const targetChar = getCharacterById(participantId);

         if (!targetChar || targetChar.isImprisoned) return 0;

         if (participantId === 'player') {
             const player = gameState.character;
             const baseLevies = gameState.realm.military.leviesBase;
             const commanderSkillBonus = player.skills.martial * 10; // Example bonus per martial point
             strength += baseLevies + commanderSkillBonus;
             // Add vassal contributions to player's total strength
             gameState.realm.vassals.forEach(v => {
                 // Only add contribution if vassal is loyal (in war context) or just generally (if no war context)
                 // And if they are NOT rebelling against the player
                 const isLoyalInWar = war ? war.defenders.includes(v.id) : (!v.isRebelling);
                 if (!v.isImprisoned && isLoyalInWar) {
                      strength += calculateVassalLevyContribution(v, potential);
                 }
             });
             // Add MaA strength (NYI)
             // Add Merc strength (NYI)

             // Apply raised levy percentage if calculating ACTUAL current strength
             if (!potential) {
                 strength *= (gameState.realm.military.raisedLeviesPercent / 100);
             }
         } else { // Calculating for a specific Vassal (e.g., rebel strength)
             const vassal = getVassalById(participantId);
             if (vassal) {
                 // Vassal's own 'base' strength calculation - simpler version
                 const baseVassalLevy = vassal.power * 50; // Example base levies from power
                 const commanderSkillBonus = (vassal.skills?.martial || 4) * 5; // Vassal's own martial skill bonus (less impactful than player?)
                 strength = baseVassalLevy + commanderSkillBonus;
                 // Add MaA strength (NYI)

                 // If vassal is rebelling, assume they raise 100% of *their* levies
                 // If calculating potential, use 100%
                 // This part is tricky - vassal strength is simplified for now.
             }
         }
         return Math.max(1, Math.round(strength)); // Ensure strength is at least 1
     }

     function calculateVassalLevyContribution(vassal, potential = false) {
         // Helper to calculate how many levies a specific vassal provides *to their liege*
         if (!vassal || vassal.isImprisoned || vassal.isRebelling) return 0;

         const obligationLaw = gameState.realm.laws.vassalObligations;
         const obligationDef = gameState.realm.lawDefinitions.vassalObligations.find(l => l.level === obligationLaw);
         const levyModifierFromLaw = obligationDef?.levyMod || 0; // Get the direct +/- modifier

         // Base contribution linked to 'power' stat
         const baseVassalLevy = vassal.power * 50; // Example: 1 power = 50 levies base
         // Opinion modifier affects how much they *actually* provide (even if obligated)
         const opinionModifier = Math.max(0.1, Math.min(1.0, 0.5 + (vassal.opinion / 200))); // Opinion affects how much they provide (10% to 100%)
         let finalVassalLevy = baseVassalLevy * (1 + levyModifierFromLaw) * opinionModifier;

          // Apply global realm modifiers (e.g., from Marshal skill - NYI)
         finalVassalLevy *= gameState.realm.military.leviesModifier; // Apply any general modifier

         // If calculating potential, this is it. If calculating actual, factor in liege's raised %
         // Note: Liege raising levies forces vassals to provide their share.
         if (!potential) {
             finalVassalLevy *= (gameState.realm.military.raisedLeviesPercent / 100);
         }

         return Math.round(finalVassalLevy);
     }

     function updateWarScores() {
         gameState.realm.activeWars.forEach(war => {
             if (Math.abs(war.score) >= 100) return; // War already decided

             // Get CURRENT (not potential) strength of each side
             const attackerStrength = war.attackers.reduce((sum, id) => sum + calculateMilitaryStrength(id, war, false), 0);
             const defenderStrength = war.defenders.reduce((sum, id) => sum + calculateMilitaryStrength(id, war, false), 0);

             // Add small base strength to avoid division by zero if one side is somehow 0
             const totalStrength = Math.max(1, attackerStrength) + Math.max(1, defenderStrength);

             // Simple calculation: score changes based on relative strength difference
             // More sophisticated: track battles won/lost, sieges held/lost (NYI)
             const strengthRatio = Math.max(1, attackerStrength) / totalStrength; // 0 to 1 approx

             // Score moves towards the side with higher strength proportion
             // Adjust multiplier for speed of war resolution
             let scoreChange = Math.round((strengthRatio - 0.5) * 15); // Max change ~ +/- 7 per year baseline

             // Add randomness
             scoreChange += Math.floor(Math.random() * 7) - 3; // +/- 3 random fluctuation

             // Add ticking war score based on holding war goal (NYI - simple proxy: attacker gains score if much stronger)
             if (attackerStrength > defenderStrength * 1.5) {
                  scoreChange += 2; // Small attacker advantage tick
             } else if (defenderStrength > attackerStrength * 1.5) {
                 scoreChange -= 2; // Small defender advantage tick
             }


             war.score += scoreChange;
             war.score = Math.max(-100, Math.min(100, war.score)); // Clamp score

             addLog(`War (${war.type}): Score changed by ${scoreChange > 0 ? '+' : ''}${scoreChange} to ${war.score}% (A: ${attackerStrength} vs D: ${defenderStrength})`);

             // Check for war end
             if (war.score >= 100) {
                 endWar(war, war.attackerLeader); // Attackers win
             } else if (war.score <= -100) {
                 endWar(war, war.defenderLeader); // Defenders win
             }
         });
     }

     function endWar(war, winnerId) {
         const winner = getCharacterById(winnerId);
         const loserId = winnerId === war.attackerLeader ? war.defenderLeader : war.attackerLeader;
         const loser = getCharacterById(loserId);
         addLog(`War Ended: The ${war.type} between ${getCharacterById(war.attackerLeader)?.name} and ${getCharacterById(war.defenderLeader)?.name} is over. Winner: ${winner?.name}!`);

         const playerWon = winnerId === 'player';
         const warIndex = gameState.realm.activeWars.findIndex(w => w.id === war.id);

         if (war.type === 'Civil War') {
             const rebels = war.attackers;
             if (playerWon) {
                 // Player crushes rebellion
                 addLog("The rebellion has been crushed!");
                 changePrestige(150, "Crushed Rebellion");
                 changeStat('stability', +15);
                 // Imprison rebel leaders/participants
                 rebels.forEach(rebelId => {
                     const vassal = getVassalById(rebelId);
                     if (vassal) { // Only vassals can be imprisoned this way
                         vassal.isRebelling = false;
                         changeVassalOpinion(rebelId, -25, "Crushed in Rebellion"); // Further penalty
                         if (!vassal.isImprisoned) { // Avoid double imprisonment
                             imprisonCharacter(rebelId, 'player', "Rebellion");
                         }
                     }
                 });
                 // Add truce with former rebels (NYI)
             } else {
                 // Player loses to rebellion
                 addLog("You have been defeated by the rebels!");
                 changePrestige(-200, "Lost Civil War");
                 changeStat('stability', -25);
                 changeStress(40);

                 // Enforce rebel demands (using the calculation function)
                 addLog(`The demands of the rebels ("${war.warGoal}") must be met!`);
                 const effects = calculateFactionDemandEffects({ goal: war.warGoal, type: 'Claimant' }); // Use dummy type if needed

                 if (effects.nyi) {
                    addLog(`Lost war, demands "${war.warGoal}" cannot be fully enforced (NYI).`);
                 }
                 if (effects.gameOver) {
                      addLog(`Lost war for "${war.warGoal}". Your reign ends!`);
                      // Trigger game over sequence
                      handleRulerDeath(`lost civil war and forced to abdicate`);
                      return; // Stop further processing
                 }
                 if (effects.gold) changeGold(effects.gold, `Lost War Demand: ${war.warGoal}`);
                 if (effects.prestige) changePrestige(effects.prestige, `Lost War Demand: ${war.warGoal}`);
                 if (effects.stability) changeStat('stability', effects.stability);
                 if (effects.changeLaw) {
                      const oldLevel = gameState.realm.laws[effects.changeLaw.type];
                      gameState.realm.laws[effects.changeLaw.type] = effects.changeLaw.level;
                      addLog(`Law Changed: ${getLawDisplayName(effects.changeLaw.type)} set to ${effects.changeLaw.level} due to losing war (was ${oldLevel}).`);
                      applyLawEffects(effects.changeLaw.type, effects.changeLaw.level, oldLevel);
                  }

                 // Release any prisoners *player* took from the rebel side during war? (NYI - no prisoner capture in war yet)
                 // Add truce (NYI)
             }
             // Reset rebellion status for all involved vassals after handling consequences
              [...war.attackers, ...war.defenders].forEach(id => {
                  const v = getVassalById(id);
                  if(v) v.isRebelling = false;
              });
         } else {
             // Handle other war types (Conquest, etc.) - NYI
             addLog(`Resolution for ${war.type} war NYI.`);
         }


         if (warIndex > -1) {
             gameState.realm.activeWars.splice(warIndex, 1); // Remove war from active list
         }
         // Recalculate military/factions now war is over
         calculateFactionStrengths();
         updateUI();
     }

     function handleRulerDeath(reason = "of natural causes") {
         addLog(`--- GAME OVER ---`);
         addLog(`${gameState.character.name} has died ${reason}.`);
         addLog(`Succession is not implemented. Resetting game.`);
         // In a full game, this would trigger succession logic. Here, we reset.
         alert(`Game Over!\n${gameState.character.name} died ${reason}.\nSuccession not implemented. Resetting.`);
         resetGame(true); // Force reset without confirmation prompt
     }

    // --- Imprisonment Logic ---
    function calculateArrestChance(targetVassalId) {
        const target = getVassalById(targetVassalId);
        const player = gameState.character;
        if (!target || target.isImprisoned || target.isRebelling) return 0;

        let chance = 50; // Base chance

        // Intrigue difference
        chance += (player.skills.intrigue - (target.skills?.intrigue || 4)) * 3;

        // Target Opinion (harder to arrest someone who likes you without reason)
        chance -= Math.max(0, target.opinion / 3);

        // Crown Authority
        const caLevel = gameState.realm.laws.crownAuthority;
        if (caLevel === 'High') chance += 15;
        if (caLevel === 'Absolute') chance += 30;

        // Traits (Player/Target) - examples
        if (player.traits.includes("Deceitful")) chance += 10;
        if (player.traits.includes("Just") && target.opinion > 0) chance -= 10; // Just rulers less likely to arrest liked vassals without cause
        if (target.traits.includes("Paranoid")) chance -= 15;
        if (target.traits.includes("Trusting")) chance += 10; // NYI trait

         // Justification (simple check: known plotter/criminal trait/in faction/negative opinion)
         const hasJustification = target.factionId || target.opinion < -50 || target.traits.includes("Criminal"); // Placeholder justification
         if (!hasJustification && caLevel !== 'Absolute') {
             chance -= 25; // Significant penalty for arresting without cause (unless Absolute)
         }

        return Math.max(5, Math.min(95, Math.round(chance))); // Clamp chance 5-95%
    }

    function attemptArrestVassal(targetVassalId) {
        const target = getVassalById(targetVassalId);
        const player = gameState.character;
        if (!target || target.isImprisoned || target.isRebelling) {
            addLog("Cannot arrest this vassal.");
            return;
        }
        closeModal('generic-modal'); // Close info popup

        const chance = calculateArrestChance(targetVassalId);
        const roll = Math.random() * 100;
        const costs = gameState.actionCosts.arrestVassal;
        // Check justification again for tyranny calculation
        const hasJustification = target.factionId || target.opinion < -50 || target.traits.includes("Criminal"); // Simplified justification check
        const tyrannyOnSuccess = hasJustification ? costs.tyrannyBaseSuccess : costs.tyrannyNoReason;
        const tyrannyOnFail = costs.tyrannyBaseFail + (hasJustification ? 0 : costs.tyrannyNoReason);


        addLog(`Attempting to arrest ${target.name}... (Chance: ${chance}%, Roll: ${roll.toFixed(0)})`);

        if (roll <= chance) {
            // Success!
            addLog(`Successfully arrested ${target.name}!`);
            imprisonCharacter(targetVassalId, 'player', hasJustification ? 'Suspected Treason' : 'Arbitrary Arrest');
            changeTyranny(tyrannyOnSuccess, "Arrested Vassal");
             // Opinion hit depends on justification and traits of other vassals
             gameState.realm.vassals.forEach(v => {
                 if (v.id !== targetVassalId) {
                     let opinionChange = -5; // Base hit for arresting anyone
                     if (!hasJustification) opinionChange -= 10; // Bigger hit if no reason
                     if (v.traits.includes("Just") && !hasJustification) opinionChange -= 10; // Just rulers dislike unjust arrests more
                     if (v.traits.includes("Paranoid")) opinionChange -= 5; // Paranoid rulers fear arbitrary power
                     if (v.traits.includes("Loyal") && hasJustification) opinionChange += 2; // Loyal vassals might slightly approve justified arrests
                     // TODO: Check relations between vassal v and target (friends/rivals)
                     changeVassalOpinion(v.id, opinionChange, `Liege arrested ${target.name}`);
                 }
             });

        } else {
            // Failure!
            addLog(`Failed to arrest ${target.name}! They evaded capture.`);
            changeTyranny(tyrannyOnFail, "Failed Arrest");
            changePrestige(costs.prestigeCostFail, "Failed Arrest");
            changeVassalOpinion(targetVassalId, -30, "Failed Arrest Attempt by Liege");
            changeStress(15);
             // Chance for vassal to start/join a faction or even rebel immediately?
             if (Math.random() * 100 < ((-target.opinion / 2) + (target.traits.includes("Ambitious") ? 20 : 0) + (target.traits.includes("Wrathful") ? 15 : 0))) {
                  addLog(`${target.name} is furious about the failed arrest attempt!`);
                  // Simple: If not in faction, try to join one
                  if (!target.factionId) {
                      checkVassalJoiningFaction(target); // Force an immediate check to join
                      if (!target.factionId) { // If still not in faction, maybe start one? (NYI)
                          addLog(`${target.name} considers starting a faction... (NYI)`);
                      }
                  }
                  // TODO: Small chance of immediate rebellion? (High risk)
             }
        }
        updateUI();
    }

     function imprisonCharacter(characterId, jailorId, reason = "Crime") {
         const character = getCharacterById(characterId);
         const existingPrisoner = getPrisonerById(characterId);
         if (!character || existingPrisoner) {
             addLog(`Cannot imprison ${character?.name || characterId}: Character not found or already imprisoned.`);
             return;
         }

         // Ensure the character object itself is updated
          character.isImprisoned = true;
          character.jailorId = jailorId;
          character.isRebelling = false; // Cannot be rebelling if imprisoned

          // Remove from faction if they were in one
          if (character.factionId) {
             const faction = getFactionById(character.factionId);
             if (faction) {
                 const memberIndex = faction.members.indexOf(characterId);
                 if (memberIndex > -1) {
                     faction.members.splice(memberIndex, 1);
                     addLog(`${character.name} removed from ${faction.name} due to imprisonment.`);
                 }
                 // If leader is imprisoned, disband faction? Or pass leadership? For now, just remove member.
                  if (faction.creatorId === characterId) {
                      // Simple: Disband faction if leader imprisoned
                      addLog(`Leader ${character.name} imprisoned, disbanding the ${faction.name} faction.`);
                      disbandFaction(character.factionId); // Pass ID to disband
                  } else {
                      calculateFactionStrengths(); // Recalculate strength if just a member removed
                  }
             }
             character.factionId = null; // Clear factionId on character too
          }


          // Add to global prisoner list if imprisoned by player
         if (jailorId === 'player') {
              gameState.realm.intrigue.prisoners.push({
                  characterId: characterId,
                  name: character.name, // Store name for easy display if char data changes
                  reason: reason,
                  jailorId: 'player'
              });
              addLog(`${character.name} is now imprisoned by you for ${reason}.`);
         } else {
             addLog(`${character.name} has been imprisoned by ${jailorId}.`);
         }
         // TODO: Handle AI imprisonment effects

         updateUI(); // Update UI immediately
     }

     function managePrisonerAction(characterId, action) {
         const prisonerIndex = gameState.realm.intrigue.prisoners.findIndex(p => p.characterId === characterId && p.jailorId === 'player');
         const prisonerRecord = prisonerIndex > -1 ? gameState.realm.intrigue.prisoners[prisonerIndex] : null;
         const character = getCharacterById(characterId); // Get the actual character object
         if (!prisonerRecord || !character) {
             addLog("Prisoner or character not found.");
             closeModal('generic-modal'); // Close if prisoner gone
             updateUI();
             return;
         }

         const costs = gameState.actionCosts;
         closeModal('generic-modal'); // Close prisoner list modal

         switch (action) {
             case 'ransom':
                 const ransomAmount = calculateRansomCost(characterId);
                 addLog(`Ransoming ${character.name} for ${ransomAmount} gold.`);
                 changeGold(ransomAmount, `Ransomed ${character.name}`);
                 changePrestige(costs.ransomPrisoner.prestigeGain, `Ransomed ${character.name}`);
                 // Opinion change? Maybe slight positive with the character?
                 changeVassalOpinion(characterId, 5, "Ransomed by Liege");
                 releasePrisoner(characterId, "Ransomed");
                 break;
             case 'execute':
                  addLog(`Executing ${character.name}!`);
                  changeTyranny(costs.executePrisoner.tyrannyGain, `Executed ${character.name}`);
                  changePrestige(costs.executePrisoner.prestigeGain, `Executed ${character.name}`);
                  // Stress change based on traits
                  let stressChange = 0;
                  if (gameState.character.traits.includes("Cruel") || gameState.character.traits.includes("Wrathful") || gameState.character.traits.includes("Sadistic")) stressChange = -10;
                  else if (gameState.character.traits.includes("Kind") || gameState.character.traits.includes("Just") || gameState.character.traits.includes("Compassionate")) stressChange = +25;
                  else stressChange = +10;
                  changeStress(stressChange);
                  // Huge opinion penalty with family (NYI) and general vassals
                  gameState.realm.vassals.forEach(v => {
                      if (v.id !== characterId) {
                           let opinionHit = -15;
                           // Check dynasty relationship (NYI - simplified check)
                           if (v.dynastyId === character.dynastyId && v.dynastyId !== null) opinionHit -= 20; // Big hit with same dynasty
                           if (v.traits.includes("Just") || v.traits.includes("Compassionate")) opinionHit -= 10;
                           if (v.traits.includes("Cruel")) opinionHit += 5; // Cruel vassals might approve
                           changeVassalOpinion(v.id, opinionHit, `Liege executed ${character.name}`);
                      }
                  });
                  releasePrisoner(characterId, "Executed"); // Release them from prison record
                  // TODO: Actually kill the character (mark as dead, trigger succession etc.)
                  // For now, just remove from prison and potentially vassal list if they were one?
                  const vassalIndex = gameState.realm.vassals.findIndex(v => v.id === characterId);
                  if (vassalIndex > -1) {
                      addLog(`${character.name}, formerly ${gameState.realm.vassals[vassalIndex].title}, has been executed and removed from the realm.`);
                      gameState.realm.vassals.splice(vassalIndex, 1);
                  } else {
                     addLog(`${character.name} has been executed. Their fate is sealed.`);
                  }
                  // Could trigger events like vacant titles (NYI)
                 break;
             case 'release':
                 addLog(`Releasing ${character.name}.`);
                 changePrestige(costs.releasePrisoner.prestigeGain, `Released ${character.name}`);
                 changeVassalOpinion(characterId, costs.releasePrisoner.opinionGainTarget, `Released by Liege`);
                 // Small opinion boost with other vassals?
                  gameState.realm.vassals.forEach(v => {
                      if (v.id !== characterId && (v.traits.includes("Just") || v.traits.includes("Kind"))) {
                           changeVassalOpinion(v.id, +3, `Liege released ${character.name}`);
                      }
                  });
                 releasePrisoner(characterId, "Released");
                 break;
         }
         updateUI();
     }

    function calculateRansomCost(characterId) {
         const character = getCharacterById(characterId);
         if (!character) return 10;
         let cost = 25; // Base
         // Increase based on title/rank
         const titleLower = character.title?.toLowerCase() || "";
         if (titleLower.includes('duke') || titleLower.includes('prince') || titleLower.includes('king')) cost += 75;
         else if (titleLower.includes('earl') || titleLower.includes('count')) cost += 50;
         else if (titleLower.includes('bishop')) cost += 40;
         // Increase based on skills/importance? (e.g. high stewardship/martial)
         cost += (character.skills?.stewardship || 0) * 2;
         cost += (character.skills?.martial || 0) * 1;
         // Decrease if low opinion? (Less valuable to ransom back?) - No, ransom is usually paid by family/themselves
         // Increase based on available gold of character/dynasty? (NYI)
         return Math.max(10, Math.round(cost));
    }

     function releasePrisoner(characterId, reason = "Released") {
         const prisonerIndex = gameState.realm.intrigue.prisoners.findIndex(p => p.characterId === characterId && p.jailorId === 'player');
         const character = getCharacterById(characterId); // Get vassal/character object

         if (character) {
             // Update character status ONLY IF still alive (not executed)
             if (reason !== "Executed") {
                character.isImprisoned = false;
                character.jailorId = null;
             }
         }
         // Remove from player's prisoner list regardless
         if (prisonerIndex > -1) {
             gameState.realm.intrigue.prisoners.splice(prisonerIndex, 1);
         }
         addLog(`${character ? character.name : characterId} is no longer imprisoned by you (${reason}).`);
     }

    // --- Law Logic ---
    function calculateLawChangeCost(lawType, newLevel) {
         const definition = gameState.realm.lawDefinitions[lawType]?.find(l => l.level === newLevel);
         if (!definition) return { prestige: 9999, stabilityChange: 0 };

         const baseCost = definition.prestigeCost || gameState.actionCosts.changeLaw.prestigeBase;
         // Modify cost based on ruler skills? (e.g., high diplomacy reduces prestige cost)
         const diplomacyDiscount = Math.max(0, Math.min(50, (gameState.character.skills.diplomacy - 5) * 5)); // 5% per dip point over 5, max 50%
         const prestigeCost = Math.round(baseCost * (1 - diplomacyDiscount / 100));

         // Calculate stability change (simple example: bigger jumps = more instability)
         const currentLevelIndex = gameState.realm.lawDefinitions[lawType].findIndex(l => l.level === gameState.realm.laws[lawType]);
         const newLevelIndex = gameState.realm.lawDefinitions[lawType].findIndex(l => l.level === newLevel);
         const levelChange = newLevelIndex - currentLevelIndex; // Positive if increasing level, negative if decreasing
         const stabilityChange = levelChange > 0 ? -levelChange * 3 : (levelChange === 0 ? 0 : 1); // Increasing law = stability hit, decreasing = small gain?

         return { prestige: prestigeCost, stabilityChange: stabilityChange };
    }

    function applyLawEffects(lawType, newLevel, oldLevel) {
         const definition = gameState.realm.lawDefinitions[lawType]?.find(l => l.level === newLevel);
         const oldDefinition = gameState.realm.lawDefinitions[lawType]?.find(l => l.level === oldLevel);
         if (!definition) return;

         addLog(`Applying effects for changing ${getLawDisplayName(lawType)} from ${oldLevel || '?'} to ${newLevel}.`);

         // Apply immediate effects defined in `definition.effects` (NYI structure)

         // Apply CHANGE in general opinion modifier to all vassals
         const opinionChange = (definition.opinionModVassal || 0) - (oldDefinition?.opinionModVassal || 0);
         if (opinionChange !== 0) {
             addLog(`Applying Vassal Opinion modifier change: ${opinionChange > 0 ? '+' : ''}${opinionChange}`);
             gameState.realm.vassals.forEach(v => {
                 // Consider vassal traits? Ambitious vassals might hate higher CA more. Loyal might care less.
                 let finalOpinionMod = opinionChange;
                 if (lawType === 'crownAuthority') {
                    if (v.traits.includes("Ambitious") || v.traits.includes("Independent")) finalOpinionMod *= (opinionChange < 0 ? 1.5 : 0.7); // Amplify negative, dampen positive
                    if (v.traits.includes("Loyal") || v.traits.includes("Content")) finalOpinionMod *= (opinionChange < 0 ? 0.5 : 1.3); // Dampen negative, amplify positive
                 }
                  if (lawType === 'vassalObligations') { // e.g. higher obligations are negative changes
                     if (v.traits.includes("Greedy") || v.traits.includes("Lazy")) finalOpinionMod *= (opinionChange < 0 ? 1.5 : 0.7);
                     if (v.traits.includes("Diligent") || v.traits.includes("Generous")) finalOpinionMod *= (opinionChange < 0 ? 0.5 : 1.3);
                 }
                 changeVassalOpinion(v.id, Math.round(finalOpinionMod), `Law Changed: ${newLevel} ${getLawDisplayName(lawType)}`);
             });
         }

         // Yearly stability modifier is handled in advanceYear based on the *current* law

         // Update Levy/Gold base modifiers stored in military/economy objects (if applicable)
         // Example for Vassal Obligations: Update the base levy modifier
         if (lawType === 'vassalObligations') {
             // Store the modifiers directly in the state for yearly calculations? Or recalculate each year?
             // Let's assume yearly calculation pulls from the current law definition.
             addLog(`Vassal levy contribution modifier is now ${definition.levyMod >= 0 ? '+' : ''}${definition.levyMod * 100}%.`);
             addLog(`Vassal tax contribution modifier is now ${definition.goldMod >= 0 ? '+' : ''}${definition.goldMod * 100}%.`);
             // No direct application needed here if yearly income re-calculates based on current law.
         }
         // Recalculate things affected by laws
         calculateFactionStrengths(); // Opinion changes might affect factions
         updateUI(); // Refresh UI with new law and potential opinion changes
     }

    function attemptChangeLaw(lawType, newLevel) {
         const currentLevel = gameState.realm.laws[lawType];
         if (newLevel === currentLevel) {
             addLog("This is already the current law.");
             return;
         }

         const definition = gameState.realm.lawDefinitions[lawType]?.find(l => l.level === newLevel);
         if (!definition) {
             addLog(`Error: Law definition for ${newLevel} ${lawType} not found.`);
             return;
         }

         // Check Cooldown
         const cooldownEndYear = gameState.actionCooldowns.changeLaw || 0;
         if (gameState.year < cooldownEndYear) {
             addLog(`Cannot change laws yet. Cooldown ends in ${cooldownEndYear - gameState.year} years.`);
             return;
         }

         // Check Unlock Condition
         if (definition.unlockCondition && !definition.unlockCondition(gameState)) {
              addLog(`Cannot change to ${newLevel}: Requirements not met.`);
              // TODO: Display specific requirement from definition.unlockCondition description
              return;
         }

         // Check Cost
         const cost = calculateLawChangeCost(lawType, newLevel);
         if (gameState.dynasty.prestige < cost.prestige) {
             addLog(`Cannot change to ${newLevel}: Requires ${cost.prestige} Prestige, you have ${gameState.dynasty.prestige}.`);
             return;
         }

         // Confirmation? For now, just apply it.
         addLog(`Changing ${getLawDisplayName(lawType)} from ${currentLevel} to ${newLevel}...`);
         closeModal('generic-modal');

         // Deduct Costs
         changePrestige(-cost.prestige, `Changed Law: ${newLevel} ${getLawDisplayName(lawType)}`);
         changeStat('stability', cost.stabilityChange); // Apply immediate stability hit/gain

         // Update Law State
         const oldLevel = gameState.realm.laws[lawType]; // Store old level before changing
         gameState.realm.laws[lawType] = newLevel;

         // Set Cooldown (e.g., 10 years)
         gameState.actionCooldowns.changeLaw = gameState.year + 10;

         // Apply Effects (pass old level)
         applyLawEffects(lawType, newLevel, oldLevel);

         // Log & Update (UI update is called within applyLawEffects)
         addLog(`Successfully changed ${getLawDisplayName(lawType)} to ${newLevel}.`);
     }

     // --- Relation Actions ---
     function attemptImproveRelations(vassalId) {
         const vassal = getVassalById(vassalId);
         if (!vassal) { addLog("Vassal not found."); return; }
         if (vassal.isImprisoned) { addLog(`Cannot improve relations with imprisoned ${vassal.name}.`); return; }
         if (vassal.isRebelling) { addLog(`Cannot improve relations with rebelling ${vassal.name}.`); return; }

         const costs = gameState.actionCosts.improveRelationsVassal;
         const cooldownEndYear = gameState.actionCooldowns.improveRelations?.[vassalId] || 0;

         if (gameState.realm.gold < costs.gold) { addLog("Not enough gold to improve relations."); return; }
         if (gameState.dynasty.prestige < costs.prestigeBase) { addLog("Not enough prestige to improve relations."); return; }
         if (gameState.year < cooldownEndYear) { addLog(`Cannot improve relations with ${vassal.name} yet (Cooldown ends ${cooldownEndYear}).`); return; }

         closeModal('generic-modal'); // Close modal if open
         addLog(`Attempting to improve relations with ${vassal.name}...`);

         // Deduct costs
         changeGold(-costs.gold, `Improve Relations: ${vassal.name}`);
         changePrestige(-costs.prestigeBase, `Improve Relations: ${vassal.name}`);

         // Apply opinion gain (variable based on diplomacy skill?)
         const diplomacyBonus = Math.max(0, Math.floor((gameState.character.skills.diplomacy - 5) * 1.5)); // 1.5 opinion per dip point over 5
         const opinionGain = costs.opinionGain + diplomacyBonus;
         changeVassalOpinion(vassalId, opinionGain, "Improved Relations Action");

         // Set cooldown
         if (!gameState.actionCooldowns.improveRelations) gameState.actionCooldowns.improveRelations = {}; // Initialize if needed
         gameState.actionCooldowns.improveRelations[vassalId] = gameState.year + costs.cooldownYears;

         updateUI();
     }

    // --- Military Actions ---
    function calculateTotalLevies() {
        // Calculate total potential levies for the realm (player + loyal vassals)
        let total = calculateMilitaryStrength('player', null, true); // Use the military strength function for potential player strength
        return total;
    }

     function changeLeviesRaised(raise = true) {
         // NYI Function - Placeholder Log
         addLog(`Action 'Raise/Disband Levies' is not yet implemented.`);
         // Basic toggle for now, needs costs and timers
         // if (raise && gameState.realm.military.raisedLeviesPercent < 100) {
         //     addLog("Raising levies...");
         //     gameState.realm.military.raisedLeviesPercent = 100;
         //     // TODO: Add gold cost per month while raised
         //     // TODO: Vassal opinion penalty while raised too long?
         // } else if (!raise && gameState.realm.military.raisedLeviesPercent > 0) {
         //     addLog("Disbanding levies...");
         //      // Check if at war - prevent disbanding if in critical war?
         //      const inWar = gameState.realm.activeWars.length > 0;
         //      if (inWar) {
         //          addLog("Cannot fully disband levies while at war!");
         //          // Maybe reduce percentage but not to 0? NYI
         //          // return;
         //      }
         //     gameState.realm.military.raisedLeviesPercent = 0;
         //     // TODO: Remove gold cost per month
         // }
         updateUI();
     }


    // --- Advance Year & Events ---
    function advanceYear() {
        if (!gameState || !gameState.setupComplete) return;

        // Check for game over conditions first
        if (gameState.character.health <= 0) {
            // Death is already handled by changeHealth -> handleRulerDeath
            // which currently forces a reset. So, we might not reach here if health dropped mid-year.
            // If health reaches 0 exactly at year end, handle it.
             addLog("Game Over: Ruler died at year's end.");
             handleRulerDeath("succumbed to poor health");
            return;
        }

        gameState.year++;
        addLog(`--- Year ${gameState.year} ---`);

        // 1. Income & Base Changes
        const stewardshipBonus = Math.floor((gameState.character.skills.stewardship - 5) * 1.5); // Gold per stewardship over 5
        const baseIncome = 20 + (gameState.nationalStats.economy / 5); // Base + economy stat contribution
        // Vassal Tax Contribution
        const obligationLaw = gameState.realm.laws.vassalObligations;
        const obligationDef = gameState.realm.lawDefinitions.vassalObligations.find(l => l.level === obligationLaw);
        const taxModifierFromLaw = obligationDef?.goldMod || 0;
        let vassalTax = 0;
        gameState.realm.vassals.forEach(v => {
            if (!v.isImprisoned && !v.isRebelling) {
                const baseVassalTax = v.power * 2; // Example: 1 power = 2 gold base tax
                const opinionModifier = Math.max(0.1, Math.min(1.0, 0.5 + (v.opinion / 200)));
                vassalTax += baseVassalTax * (1 + taxModifierFromLaw) * opinionModifier;
            }
        });
        // Levy Maintenance Cost (NYI)
        let maintenanceCost = 0;
        // if (gameState.realm.military.raisedLeviesPercent > 0) {
        //     maintenanceCost = Math.round(calculateTotalLevies() * 0.02 * (gameState.realm.military.raisedLeviesPercent / 100)); // Example: 2% of raised levies value per year
        //     addLog(`Levy Maintenance: -${maintenanceCost} Gold.`);
        // }

        changeGold(baseIncome + stewardshipBonus + vassalTax - maintenanceCost, "Yearly Income/Expenses");
        changePrestige(5 + Math.floor((gameState.character.skills.diplomacy - 5) * 0.5), "Yearly Gain"); // Prestige per diplomacy over 5
         // Tyranny Decay
         if (gameState.character.tyranny > 0) {
            const decay = gameState.character.traits.includes("Just") ? 2 : 1; // Just rulers lose tyranny faster
            changeTyranny(-decay, "Yearly Decay");
         }

        // 2. Passive Effects & Drifts
         // Vassal opinion drift towards 0 (or target based on traits/relations)
         gameState.realm.vassals.forEach(v => {
            if (v.opinion !== 0 && !v.isImprisoned && !v.isRebelling) {
                let targetOpinion = 0; // Base drift towards 0
                if (v.traits.includes("Loyal")) targetOpinion = 25;
                if (v.traits.includes("Content")) targetOpinion = 10;
                if (v.traits.includes("Ambitious")) targetOpinion = -15;
                if (v.traits.includes("Envious")) targetOpinion = -10;
                // Add personality clashes/synergies (NYI)

                let drift = 0;
                if (v.opinion > targetOpinion) drift = -1;
                else if (v.opinion < targetOpinion) drift = 1;

                 // High tyranny pushes opinion down regardless of target
                 if (gameState.character.tyranny > 50 && drift >= 0) drift = -1; // High tyranny forces negative drift or stops positive drift
                 if (gameState.character.tyranny > 75 && drift >= 0) drift = -2;

                 if (drift !== 0) {
                    changeVassalOpinion(v.id, drift); // Log handled internally by changeVassalOpinion if significant
                 }
            }
         });
         // Stat drift (interdependencies)
         if (gameState.nationalStats.stability < 40) changeStat('economy', -1); else if (gameState.nationalStats.stability > 70) changeStat('economy', +1);
         if (gameState.nationalStats.economy < 30) changeStat('stability', -1); else if (gameState.nationalStats.economy > 70) changeStat('stability', +1);
         // Yearly stability mod from Crown Authority
         const caDef = gameState.realm.lawDefinitions.crownAuthority.find(l => l.level === gameState.realm.laws.crownAuthority);
         if (caDef && caDef.stabilityModYearly) {
             changeStat('stability', caDef.stabilityModYearly);
             if (caDef.stabilityModYearly !== 0) { // Log only if non-zero effect
                 addLog(`${caDef.level} Crown Authority yearly stability effect: ${caDef.stabilityModYearly > 0 ? '+' : ''}${caDef.stabilityModYearly}.`);
             }
         }


        // 3. Health & Stress Checks
        // Yearly health check (more likely to decrease with age/stress/traits)
        let healthCheckRoll = Math.random();
        let healthChangeChance = 0.05 + (gameState.character.stress / 2000); // Base 5% + increase with stress
        if (gameState.character.traits.includes("Frail")) healthChangeChance += 0.1; // NYI trait example
        if (gameState.character.traits.includes("Robust")) healthChangeChance -= 0.03; // NYI trait example
        if (healthCheckRoll < healthChangeChance) {
            let healthDelta = -(Math.floor(Math.random() * 6) + 1); // Lose 1-6 health
            if (gameState.character.traits.includes("Temperate")) healthDelta = Math.round(healthDelta * 0.7); // Temperate reduces health loss slightly
            changeHealth(healthDelta);
        }
        // Passive stress changes
        if (gameState.character.traits.includes("Content") && gameState.character.stress > 0) changeStress(-5);
        if (gameState.character.traits.includes("Paranoid") && gameState.character.stress < 100) changeStress(3);
         // Stress from active wars (more severe for civil wars or losing wars)
         if (gameState.realm.activeWars.length > 0) {
             let warStress = 0;
             gameState.realm.activeWars.forEach(w => {
                 const isCivilWar = w.type === 'Civil War';
                 const isLosing = (w.defenderLeader === 'player' && w.score < -20) || (w.attackerLeader === 'player' && w.score > 20); // Assuming player is attacker/defender appropriately
                 warStress += isCivilWar ? 4 : 2;
                 if (isLosing) warStress += 3;
             });
             changeStress(warStress);
         }

         // Clean up expired cooldowns (simple check)
         Object.keys(gameState.actionCooldowns.improveRelations || {}).forEach(vassalId => {
             if (gameState.actionCooldowns.improveRelations[vassalId] <= gameState.year) {
                 delete gameState.actionCooldowns.improveRelations[vassalId];
                 // addLog(`Improve relations cooldown expired for Vassal ${vassalId}.`); // Optional log
             }
         });
         // Law change cooldown is checked directly in actions/UI

        // 4. Vassal Actions / Faction Checks
        gameState.realm.vassals.forEach(v => {
            checkVassalJoiningFaction(v); // Chance for vassals to join factions
            // Other vassal actions? Schemes? (NYI)
        });
        calculateFactionStrengths(); // Recalculate after potential joins/leaves and opinion drifts

        // 5. War Updates (Score calculation)
        updateWarScores(); // Calculate score changes for active wars

        // 6. Scheme Progress (NYI)

        // 7. Events (National Issues / Faction Ultimatums)
        // Faction ultimatums are triggered within calculateFactionStrengths if threshold met
        if (gameState.issueCooldown > 0) { gameState.issueCooldown--; }
        else { checkForNationalIssue(); } // Check for random national issue

        // 8. Update UI with all changes
        updateUI();
    }

    function checkForNationalIssue() {
         // Reduced frequency, only if stability isn't critical or too high
         if (Math.random() < 0.15 && gameState.nationalStats.stability > 30 && gameState.nationalStats.stability < 85 && gameState.realm.activeWars.length === 0) {
             triggerNationalIssue();
         }
     }
    function triggerNationalIssue() {
         addLog("A matter of state requires your attention!");
         gameState.issueCooldown = 5; // Cooldown before next issue can fire
         closeModal('generic-modal'); // Close other modals

         // Simple issue examples - replace with more varied ones
         const issues = [
             {
                 title: "Dispute Over Land",
                 description: "Two prominent vassals are arguing fiercely over the ownership of fertile border lands. Intervening could anger one or both.",
                 choices: [
                     { text: "Support Vassal A.", effects: { stability: -5, vassalOpinion: { id: 'vas_0', change: +15 }, vassalOpinion2: { id: 'vas_1', change: -20 }, log: "Supported Vassal A in the land dispute." } }, // Need dynamic vassal selection
                     { text: "Support Vassal B.", effects: { stability: -5, vassalOpinion: { id: 'vas_0', change: -20 }, vassalOpinion2: { id: 'vas_1', change: +15 }, log: "Supported Vassal B in the land dispute." } }, // Need dynamic vassal selection
                     { text: "Force them to compromise (Requires Diplomacy 6+).", condition: () => gameState.character.skills.diplomacy >= 6, effects: { stability: +5, prestige: -20, log: "Forced a compromise in the land dispute." } },
                     { text: "Let them sort it out themselves.", effects: { stability: -10, prestige: -10, log: "Allowed vassals to resolve the dispute themselves, causing instability." } }
                 ]
             },
              {
                 title: "Merchant Guild Demands",
                 description: "The burgeoning merchant guilds request reduced taxes and greater autonomy to boost trade. This could improve the economy but reduce direct income.",
                 choices: [
                     { text: "Grant tax breaks.", effects: { economy: +8, stability: +3, gold: -50, log: "Granted tax breaks to merchant guilds." } },
                     { text: "Offer limited autonomy, no tax breaks.", effects: { economy: +3, politicalFreedoms: +5, stability: -3, prestige: 15, log: "Granted limited autonomy to guilds." } },
                     { text: "Refuse their demands curtly.", effects: { economy: -5, stability: -5, gold: 20, log: "Refused merchant demands, angering them but asserting control." } },
                     { text: "Tax them even more! (Requires Stewardship 7+).", condition: () => gameState.character.skills.stewardship >= 7, effects: { economy: -10, stability: -8, gold: 100, tyranny: 5, log: "Increased taxes on merchants, gaining gold but risking unrest." } }
                 ]
             },
             {
                 title: "Petition for the Poor",
                 description: "A delegation representing the common folk pleads for aid due to a recent poor harvest. Providing help will cost gold but may improve stability.",
                 choices: [
                      { text: "Distribute grain reserves generously (-100 Gold).", effects: { gold: -100, socialWelfare: +10, stability: +8, prestige: +10, log: "Distributed grain reserves to aid the poor." } },
                      { text: "Offer limited assistance (-40 Gold).", effects: { gold: -40, socialWelfare: +4, stability: +3, log: "Offered limited aid to the poor." } },
                      { text: "Express sympathy but offer nothing.", effects: { socialWelfare: -5, stability: -5, prestige: -15, log: "Offered no aid to the suffering poor." } },
                      { text: "Blame them for their own misfortune (+5 Stress).", condition: () => gameState.character.traits.includes("Cruel") || gameState.character.traits.includes("Cynical"), effects: { stress: 5, socialWelfare: -10, stability: -10, tyranny: 3, log: "Blamed the poor for their misfortune, increasing stress and unrest." } }
                 ]
             }
         ];

         const chosenIssue = issues[Math.floor(Math.random() * issues.length)];

         domRefs.nationalIssueTitle.textContent = chosenIssue.title;
         domRefs.nationalIssueDescription.textContent = chosenIssue.description;
         domRefs.nationalIssueChoices.innerHTML = ''; // Clear previous choices

         chosenIssue.choices.forEach(choice => {
             const button = document.createElement('button');
             let disabled = false;
             let titleText = choice.text; // Default title
             if (choice.condition && !choice.condition()) {
                 disabled = true;
                 // Add reason for being disabled to title text
                 if (choice.text.includes("Requires")) { // Crude check if requirement is in text
                     titleText += ` (Requirement Not Met)`;
                 } else {
                    titleText += ` (Unavailable)`;
                 }
             }

             // Display effects hint
             let effectsHint = [];
             if (choice.effects.gold) effectsHint.push(`${choice.effects.gold > 0 ? '+' : ''}${choice.effects.gold}G`);
             if (choice.effects.prestige) effectsHint.push(`${choice.effects.prestige > 0 ? '+' : ''}${choice.effects.prestige}P`);
             if (choice.effects.stability) effectsHint.push(`${choice.effects.stability > 0 ? '+' : ''}${choice.effects.stability} Stab`);
             if (choice.effects.economy) effectsHint.push(`${choice.effects.economy > 0 ? '+' : ''}${choice.effects.economy} Econ`);
             if (choice.effects.socialWelfare) effectsHint.push(`${choice.effects.socialWelfare > 0 ? '+' : ''}${choice.effects.socialWelfare} Welfare`);
              if (choice.effects.politicalFreedoms) effectsHint.push(`${choice.effects.politicalFreedoms > 0 ? '+' : ''}${choice.effects.politicalFreedoms} Freedom`);
              if (choice.effects.tyranny) effectsHint.push(`+${choice.effects.tyranny} Tyranny`);
              if (choice.effects.stress) effectsHint.push(`${choice.effects.stress > 0 ? '+' : ''}${choice.effects.stress} Stress`);
              // Vassal opinion needs dynamic check based on ID
              if (choice.effects.vassalOpinion) {
                    const vassal = getVassalById(choice.effects.vassalOpinion.id);
                    if (vassal) effectsHint.push(`${choice.effects.vassalOpinion.change > 0 ? '+' : ''}${choice.effects.vassalOpinion.change} Op. ${vassal.name.split(' ')[0]}`);
              }
              if (choice.effects.vassalOpinion2) { // Handle second vassal opinion if present
                    const vassal = getVassalById(choice.effects.vassalOpinion2.id);
                    if (vassal) effectsHint.push(`${choice.effects.vassalOpinion2.change > 0 ? '+' : ''}${choice.effects.vassalOpinion2.change} Op. ${vassal.name.split(' ')[0]}`);
              }


             button.innerHTML = `${choice.text} <span class="choice-effects">${effectsHint.join(', ')}</span>`;
             button.disabled = disabled;
             button.title = titleText; // Add detailed title for hover, especially if disabled
             button.onclick = () => resolveNationalIssue(choice.effects);
             domRefs.nationalIssueChoices.appendChild(button);
         });

         openModal('national-issue-popup');
         changeStress(5); // Small stress just for having an issue pop up
     }

    function resolveNationalIssue(effects) {
         closeModal('national-issue-popup');
         addLog(effects.log || "You address the matter."); // Log the outcome

         // Apply effects
         if (effects.gold) changeGold(effects.gold, "National Issue");
         if (effects.prestige) changePrestige(effects.prestige, "National Issue");
         if (effects.stability) changeStat('stability', effects.stability);
         if (effects.economy) changeStat('economy', effects.economy);
         if (effects.socialWelfare) changeStat('socialWelfare', effects.socialWelfare);
         if (effects.politicalFreedoms) changeStat('politicalFreedoms', effects.politicalFreedoms);
         if (effects.tyranny) changeTyranny(effects.tyranny, "National Issue");
         if (effects.stress) changeStress(effects.stress);
         // Handle vassal opinion changes
         if (effects.vassalOpinion) {
             changeVassalOpinion(effects.vassalOpinion.id, effects.vassalOpinion.change, "National Issue Resolution");
         }
         if (effects.vassalOpinion2) {
             changeVassalOpinion(effects.vassalOpinion2.id, effects.vassalOpinion2.change, "National Issue Resolution");
         }
         // Add other potential effects here

         updateUI(); // Update display with new stats
     }

    // --- Persistence (Updated Save Key) ---
    const SAVE_KEY = 'crownCompassSave_v5'; // Use a distinct key for this version
    function saveGame() {
         if (!gameState || !gameState.setupComplete) {
             addLog("Cannot save: Game not fully initialized.");
             console.error("Attempted to save before setupComplete.");
             return;
          }
         gameState.saveVersion = 5; // Stamp version
         try {
             localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
             addLog("Game Saved.");
         } catch (e) {
              addLog("Error saving game: " + e.message);
              console.error("Save failed:", e);
              alert("Failed to save game. Local storage might be full or unavailable.");
          }
     }
    function loadGame() {
         const savedData = localStorage.getItem(SAVE_KEY);
         if (savedData) {
             try {
                 let loadedState = JSON.parse(savedData);

                 // Version Check
                 if (!loadedState.saveVersion || loadedState.saveVersion < 5) {
                     if (!confirm(`Save is from an older version (v${loadedState.saveVersion || '?'}). Loading may cause issues or missing features. Continue?`)) {
                         addLog("Load cancelled due to version mismatch.");
                         return;
                     }
                     addLog(`Loading older save (v${loadedState.saveVersion || '?'}). Some features might be missing or reset.`);
                 }

                 // Use deep merge to ensure new default keys/structures are added to the loaded state
                 let mergedState = JSON.parse(JSON.stringify(defaultGameState)); // Start with fresh defaults
                 deepMerge(mergedState, loadedState); // Merge loaded data onto defaults, loaded data takes precedence

                 // Crucially, ensure nested default structures exist if they were missing in the save
                 ensureNestedKeys(mergedState, defaultGameState);


                 mergedState.setupComplete = true; // Ensure flag is correctly set after successful load
                 gameState = mergedState;

                 addLog("Game Loaded.");
                 updateHealthStatus(); // Ensure health status string is correct after loading health value
                 updateUI(); // Update the UI with loaded state
                 // Close any modals that might be open from previous session
                 closeModal('generic-modal');
                 closeModal('national-issue-popup');
                 closeModal('faction-ultimatum-popup');

             } catch (e) {
                  addLog("Error loading saved game: " + e.message + ". Resetting to default.");
                  console.error("Load failed:", e);
                  alert("Failed to load save data. The save might be corrupted. Resetting game.");
                  resetGame(true); // Force reset on load error
              }
         } else {
              addLog("No saved game found.");
          }
     }
    function resetGame(forceConfirm = false) {
        const confirmReset = forceConfirm || confirm("Are you sure you want to reset the game? All unsaved progress will be lost.");
        if (confirmReset) {
            addLog("Resetting game...");
            localStorage.removeItem(SAVE_KEY); // Clear save data
            selectedBackground = null; // Reset background selection
            // Re-initialize the game state entirely, forcing creator screen
            initializeGame(true); // Pass true to force setup screen
        }
    }


    // --- Event Listeners ---
    // Creator Listener
    domRefs.creatorStartBtn.addEventListener('click', startGameFromCreator);
    // Use event delegation for background cards (more efficient)
    domRefs.creatorBackgrounds.addEventListener('change', function(event) {
        if (event.target.type === 'radio' && event.target.name === 'creator-background') {
            handleBackgroundSelection(event);
        }
    });


    // Game Listeners
    domRefs.advanceYearBtn.addEventListener('click', advanceYear);
    domRefs.saveBtn.addEventListener('click', saveGame);
    domRefs.loadBtn.addEventListener('click', loadGame);
    domRefs.resetBtn.addEventListener('click', () => resetGame(false));
    domRefs.raiseLeviesBtn.addEventListener('click', () => changeLeviesRaised(gameState.realm.military.raisedLeviesPercent === 0)); // Toggle raise/disband -> NYI

    domRefs.managePrisonersBtn.addEventListener('click', () => {
        if (gameState.realm.intrigue.prisoners.filter(p => p.jailorId === 'player').length > 0) {
             showInfoPopup('prisoners', 'player');
        } else {
            addLog("You have no prisoners to manage.");
        }
    });

    // Listener for the main "Change Laws" button -> Opens Law Category Selection Modal
    domRefs.changeLawsBtn.addEventListener('click', () => {
        if (gameState.year < (gameState.actionCooldowns.changeLaw || 0)) {
             addLog(`Cannot change laws yet. Cooldown ends in ${gameState.actionCooldowns.changeLaw - gameState.year} years.`);
             return;
        }

        closeModal('generic-modal');
        domRefs.modalTitle.textContent = "Select Law Category to Change";
        let bodyContent = `<p>Choose which category of laws you wish to modify.</p><ul>`;
        const availableLaws = Object.keys(gameState.realm.lawDefinitions).filter(lawId => {
            // Filter out NYI laws for now
            return lawId !== 'succession' && lawId !== 'religiousLaws' && lawId !== 'contracts';
        });

        availableLaws.forEach(lawId => {
            // Ensure the law exists in the current game state's laws object
            const currentLevelDisplay = gameState.realm.laws?.[lawId] || 'Unknown';
            bodyContent += `<li><button class="action-button" style="width: 90%; text-align: left;" onclick="showInfoPopup('law', '${lawId}')">${getLawDisplayName(lawId)} (Current: ${currentLevelDisplay})</button></li>`;
        });
        bodyContent += `</ul>`;

        domRefs.modalBody.innerHTML = bodyContent;
        domRefs.modalActions.innerHTML = ""; // No global actions here
        domRefs.modalActions.style.display = "none";
        openModal('generic-modal');
    });

    // Event Delegation for Clickable Info Spans (Game Container & Modal Body)
    // Attach to static parent elements that exist on load
    document.body.addEventListener('click', handleInfoClick); // Attach to body to catch clicks anywhere

    function handleInfoClick(event) {
        const target = event.target.closest('.clickable-info'); // Find closest clickable parent/self
        if (target && target.dataset.type && target.dataset.id) {
             event.preventDefault(); // Prevent default link behavior if it were an <a>
             event.stopPropagation(); // Prevent triggering listeners on parent elements

             if (target.classList.contains('nyi')) {
                 addLog("This feature or detail is not yet implemented.");
             } else {
                 const type = target.dataset.type;
                 const id = target.dataset.id;
                 showInfoPopup(type, id);
             }
        }
    }


    // --- Initial Game Setup ---
    function initializeGame(forceSetup = false) {
        console.log("Initializing game v5...");
        const savedState = localStorage.getItem(SAVE_KEY);

        if (savedState && !forceSetup) {
            console.log("Loading saved game on init...");
            loadGame(); // loadGame now handles merging and setting setupComplete flag
            if (!gameState.setupComplete) { // If load failed somehow (e.g., corrupted JSON), force setup
                console.warn("Load failed or save invalid, forcing creator setup.");
                 initializeGame(true); // Force setup
            }
        } else {
            console.log("No save found or reset forced. Showing creator...");
            // Reset to default state, mark setup as incomplete
            gameState = JSON.parse(JSON.stringify(defaultGameState));
            gameState.setupComplete = false;
            selectedBackground = null; // Reset background selection state
            // Clear any lingering modals
            closeModal('generic-modal');
            closeModal('national-issue-popup');
            closeModal('faction-ultimatum-popup');
            // Update UI will now show the creator screen because setupComplete is false
            updateUI();
        }
    }

    // Initialize on page load
    window.onload = () => initializeGame(false); // Attempt load first, don't force setup

</script>

</body>
</html>
```